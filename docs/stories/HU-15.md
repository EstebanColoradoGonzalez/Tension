# HU-15 â€” AnalÃ­tica y KPIs del Entrenamiento

## Requisitos relacionados

RF42, RF44, RF45, RF46, RF47, RF48, RF49, RF52

## DescripciÃ³n

Como ejecutante, quiero que el sistema calcule y presente un panel de analÃ­tica completo con mÃ©tricas de rendimiento por ejercicio (Tasa de ProgresiÃ³n y Velocidad de Carga), volumen por grupo muscular (Tonelaje Acumulado y DistribuciÃ³n), intensidad y adherencia (RIR Promedio por MÃ³dulo e Ãndice de Adherencia Semanal), tendencias de progresiÃ³n por grupo muscular a lo largo de mÃºltiples microciclos, y la evoluciÃ³n temporal del tonelaje, para entender objetivamente cÃ³mo voy, identificar desequilibrios entre grupos musculares, validar que mi intensidad estÃ¡ en la zona Ã³ptima, y tomar decisiones de programaciÃ³n informadas a nivel macro.

## Historias originales consolidadas

Esta historia consolida las siguientes historias del diseÃ±o original, que comparten la misma secciÃ³n de navegaciÃ³n, los mismos datos fuente y la misma estructura de cÃ¡lculo-presentaciÃ³n:

- **HU-19 original** â€” Calcular KPIs de rendimiento por ejercicio (RF44, RF48)
- **HU-20 original** â€” Calcular KPIs de volumen por grupo muscular (RF45, RF49)
- **HU-21 original** â€” Calcular KPIs de intensidad y adherencia (RF46, RF47)
- **HU-22 original** â€” Monitorear tendencia de progresiÃ³n por grupo muscular (RF42)
- **HU-25 original** â€” Consultar evoluciÃ³n de tonelaje por grupo muscular (RF52)

---

## Criterios de AceptaciÃ³n

### Bloque A â€” KPIs de Rendimiento por Ejercicio (RF44, RF48)

#### CA-15.01 â€” CÃ¡lculo de la Tasa de ProgresiÃ³n por Ejercicio

**Dado que** un ejercicio tiene historial de mÃºltiples sesiones registradas,
**cuando** el sistema calcula la Tasa de ProgresiÃ³n,
**entonces** aplica la fÃ³rmula: (Sesiones con progresiÃ³n positiva / Total de sesiones del ejercicio) Ã— 100, expresando el resultado como porcentaje.

#### CA-15.02 â€” PerÃ­odo de evaluaciÃ³n configurable con valor por defecto

**Dado que** el sistema calcula la Tasa de ProgresiÃ³n de un ejercicio,
**cuando** determina el rango temporal de evaluaciÃ³n,
**entonces** utiliza por defecto un perÃ­odo de 4 semanas, pero permite configurar perÃ­odos alternativos para el anÃ¡lisis.

#### CA-15.03 â€” CÃ¡lculo de la Velocidad de ProgresiÃ³n de Carga

**Dado que** un ejercicio tiene historial con al menos 2 sesiones registradas donde se utilizÃ³ carga (Peso > 0),
**cuando** el sistema calcula la Velocidad de ProgresiÃ³n de Carga,
**entonces** aplica la fÃ³rmula: (Peso actual âˆ’ Peso inicial) / NÃºmero de sesiones intermedias, expresando el resultado en Kg por sesiÃ³n.

#### CA-15.04 â€” Velocidad de ProgresiÃ³n para ejercicios sin incremento

**Dado que** un ejercicio tiene historial pero no ha incrementado carga (Peso actual = Peso inicial),
**cuando** el sistema calcula la Velocidad de ProgresiÃ³n de Carga,
**entonces** el resultado es 0 Kg/sesiÃ³n, confirmando numÃ©ricamente una meseta activa en carga.

#### CA-15.05 â€” Ejercicios de peso corporal excluidos de Velocidad de Carga

**Dado que** un ejercicio es de peso corporal (Peso = 0 Kg),
**cuando** el sistema calcula KPIs de rendimiento,
**entonces** calcula la Tasa de ProgresiÃ³n normalmente pero no calcula la Velocidad de ProgresiÃ³n de Carga (no aplica ya que no hay variaciÃ³n de peso).

#### CA-15.06 â€” PresentaciÃ³n de KPIs de rendimiento al ejecutante

**Dado que** el sistema ha calculado los KPIs de rendimiento para un ejercicio,
**cuando** el ejecutante consulta las mÃ©tricas del ejercicio,
**entonces** muestra la Tasa de ProgresiÃ³n (%) y la Velocidad de ProgresiÃ³n de Carga (Kg/sesiÃ³n) de forma clara con el perÃ­odo de evaluaciÃ³n utilizado.

### Bloque B â€” KPIs de Volumen por Grupo Muscular (RF45, RF49)

#### CA-15.07 â€” CÃ¡lculo del Tonelaje Acumulado por Grupo Muscular

**Dado que** un microciclo incluye sesiones con ejercicios registrados,
**cuando** el sistema calcula el Tonelaje Acumulado por Grupo Muscular,
**entonces** suma el producto de Peso Ã— Repeticiones de todas las series de todos los ejercicios que trabajan cada grupo muscular dentro del microciclo, expresando el resultado en kilogramos por grupo muscular.

#### CA-15.08 â€” AgrupaciÃ³n por zona muscular del Diccionario

**Dado que** el sistema calcula el tonelaje por grupo muscular,
**cuando** asocia cada ejercicio a su grupo muscular,
**entonces** utiliza la clasificaciÃ³n de zona muscular definida en el Diccionario de Ejercicios como fuente de verdad, respetando que un ejercicio puede trabajar mÃºltiples zonas musculares (ej: Sentadilla BÃºlgara = CuÃ¡driceps + GlÃºteos).

#### CA-15.09 â€” Ejercicios con mÃºltiples zonas musculares

**Dado que** un ejercicio trabaja mÃºltiples zonas musculares segÃºn el Diccionario,
**cuando** el sistema calcula el tonelaje acumulado,
**entonces** contabiliza el tonelaje de ese ejercicio en cada una de las zonas musculares asociadas.

#### CA-15.10 â€” CÃ¡lculo de la DistribuciÃ³n de Volumen por Zona Muscular

**Dado que** un microciclo tiene sesiones registradas para un mÃ³dulo,
**cuando** el sistema calcula la DistribuciÃ³n de Volumen por Zona Muscular,
**entonces** calcula el porcentaje de series totales de cada zona muscular respecto al total de series del mÃ³dulo, expresando el resultado como porcentaje por zona.

#### CA-15.11 â€” CÃ¡lculo por microciclo completado

**Dado que** el sistema calcula KPIs de volumen,
**cuando** determina el alcance temporal del cÃ¡lculo,
**entonces** lo calcula por microciclo completado, asociando los resultados al nÃºmero de microciclo correspondiente para permitir comparaciÃ³n entre microciclos.

#### CA-15.12 â€” PresentaciÃ³n de KPIs de volumen al ejecutante

**Dado que** el sistema ha calculado los KPIs de volumen,
**cuando** el ejecutante consulta las mÃ©tricas de volumen,
**entonces** muestra el Tonelaje Acumulado desglosado por grupo muscular y la DistribuciÃ³n de Volumen (%) por zona muscular, ambos referenciados al microciclo consultado.

### Bloque C â€” KPIs de Intensidad y Adherencia (RF46, RF47)

#### CA-15.13 â€” CÃ¡lculo del RIR Promedio por MÃ³dulo

**Dado que** un mÃ³dulo tiene sesiones registradas en un perÃ­odo dado,
**cuando** el sistema calcula el RIR Promedio por MÃ³dulo,
**entonces** promedia aritmÃ©ticamente todos los valores de RIR registrados en todas las series de todas las sesiones del mÃ³dulo en el perÃ­odo, expresando el resultado con un decimal.

#### CA-15.14 â€” PerÃ­odo de evaluaciÃ³n del RIR Promedio

**Dado que** el sistema calcula el RIR Promedio por MÃ³dulo,
**cuando** determina el rango temporal,
**entonces** evalÃºa por defecto las Ãºltimas 2 ejecuciones del mismo mÃ³dulo, permitiendo al ejecutante consultar perÃ­odos mÃ¡s amplios.

#### CA-15.15 â€” InterpretaciÃ³n del RIR Promedio

**Dado que** el sistema muestra el RIR Promedio de un mÃ³dulo al ejecutante,
**cuando** presenta el resultado,
**entonces** incluye una referencia de interpretaciÃ³n: RIR 2-3 = zona Ã³ptima, RIR < 1.5 = demasiado cerca del fallo (riesgo de fatiga del SNC), RIR > 3.5 = estÃ­mulo posiblemente insuficiente.

#### CA-15.16 â€” CÃ¡lculo del Ãndice de Adherencia Semanal

**Dado que** una semana natural ha transcurrido,
**cuando** el sistema calcula el Ãndice de Adherencia semanal,
**entonces** aplica la fÃ³rmula: (Sesiones completadas en la semana / Sesiones planificadas) Ã— 100, donde "sesiones planificadas" es el objetivo de frecuencia del ejecutante (entre 4 y 6), expresando el resultado como porcentaje.

#### CA-15.17 â€” Objetivo de frecuencia del ejecutante

**Dado que** el sistema calcula el Ãndice de Adherencia,
**cuando** necesita el denominador (sesiones planificadas),
**entonces** utiliza el objetivo de frecuencia definido por el ejecutante en su perfil, aceptando valores entre 4 y 6 sesiones semanales.

#### CA-15.18 â€” Sesiones contabilizadas para adherencia

**Dado que** el sistema calcula las sesiones completadas en la semana,
**cuando** contabiliza sesiones,
**entonces** incluye sesiones cerradas tanto como Completadas como Incompletas, ya que ambos tipos representan asistencia al gimnasio y ambos avanzan la rotaciÃ³n.

#### CA-15.19 â€” PresentaciÃ³n de KPIs de intensidad y adherencia al ejecutante

**Dado que** el sistema ha calculado los KPIs de intensidad y adherencia,
**cuando** el ejecutante consulta las mÃ©tricas,
**entonces** muestra el RIR Promedio por MÃ³dulo (para cada mÃ³dulo A, B, C) y el Ãndice de Adherencia semanal con el perÃ­odo evaluado y la referencia de interpretaciÃ³n.

### Bloque D â€” Tendencia de ProgresiÃ³n por Grupo Muscular (RF42)

#### CA-15.20 â€” EvaluaciÃ³n de tendencia por grupo muscular

**Dado que** el ejecutante tiene al menos 4 microciclos completados,
**cuando** el sistema evalÃºa la tendencia de progresiÃ³n de un grupo muscular,
**entonces** analiza la trayectoria del tonelaje acumulado y la tasa de progresiÃ³n de los ejercicios asociados al grupo muscular a lo largo de los Ãºltimos 4 a 6 microciclos.

#### CA-15.21 â€” ClasificaciÃ³n de la tendencia

**Dado que** el sistema analiza la tendencia de un grupo muscular,
**cuando** presenta los resultados al ejecutante,
**entonces** clasifica la tendencia como: "Ascendente" (tonelaje y/o tasa de progresiÃ³n crecientes), "Estable" (valores sin cambio significativo) o "En declive" (tonelaje y/o tasa de progresiÃ³n decrecientes).

#### CA-15.22 â€” Rango de microciclos analizado

**Dado que** el sistema evalÃºa la tendencia,
**cuando** determina el rango temporal,
**entonces** analiza por defecto los Ãºltimos 4 a 6 microciclos completados, priorizando los microciclos mÃ¡s recientes para reflejar el estado actual del ejecutante.

#### CA-15.23 â€” Datos insuficientes para tendencia

**Dado que** el ejecutante tiene menos de 4 microciclos completados,
**cuando** intenta consultar la tendencia de un grupo muscular,
**entonces** el sistema indica que no hay datos suficientes para evaluar una tendencia significativa y muestra el nÃºmero de microciclos faltantes para habilitar el anÃ¡lisis.

#### CA-15.24 â€” PresentaciÃ³n por grupo muscular

**Dado que** el sistema ha evaluado la tendencia de todos los grupos musculares con datos suficientes,
**cuando** el ejecutante consulta las tendencias,
**entonces** muestra la tendencia de cada grupo muscular de forma desglosada, permitiendo comparar el comportamiento entre grupos musculares.

### Bloque E â€” EvoluciÃ³n de Tonelaje por Grupo Muscular (RF52)

#### CA-15.25 â€” VisualizaciÃ³n del tonelaje por grupo muscular a lo largo del tiempo

**Dado que** el ejecutante tiene mÃºltiples microciclos completados,
**cuando** consulta la evoluciÃ³n de tonelaje por grupo muscular,
**entonces** el sistema muestra el tonelaje acumulado de cada grupo muscular en cada microciclo, permitiendo visualizar la trayectoria temporal.

#### CA-15.26 â€” IdentificaciÃ³n de tendencias de tonelaje

**Dado que** el sistema presenta la evoluciÃ³n del tonelaje por grupo muscular,
**cuando** el ejecutante analiza los datos,
**entonces** la presentaciÃ³n permite identificar tendencias: ascendente (volumen creciente), estable (volumen mantenido) o en caÃ­da (volumen decreciente) para cada grupo muscular.

#### CA-15.27 â€” Desglose por grupo muscular

**Dado que** el ejecutante consulta la evoluciÃ³n de tonelaje,
**cuando** visualiza los resultados,
**entonces** el sistema presenta los datos desglosados por cada grupo muscular del sistema (Pecho, Espalda, Abdomen, Hombro, TrÃ­ceps, BÃ­ceps, CuÃ¡driceps, Isquiotibiales, GlÃºteos, Aductores, Abductores, Gemelos), permitiendo anÃ¡lisis individual.

#### CA-15.28 â€” Datos insuficientes para evoluciÃ³n de tonelaje

**Dado que** el ejecutante tiene menos de 2 microciclos completados,
**cuando** consulta la evoluciÃ³n de tonelaje,
**entonces** el sistema indica que se necesitan al menos 2 microciclos para mostrar una evoluciÃ³n comparativa.

---

## AnÃ¡lisis ArquitectÃ³nico (Arquitecto)

### Decisiones de DiseÃ±o

**PatrÃ³n ArquitectÃ³nico:** MVVM con lectura analÃ­tica multicapa â€” repositorio nuevo dedicado + reglas de cÃ¡lculo puras + 3 pantallas de presentaciÃ³n (G1/G2/G3).

**JustificaciÃ³n:** HU-15 es la historia mÃ¡s amplia del sistema en superficie de datos: lee TODAS las tablas transaccionales (session, session_exercise, exercise_set, exercise_muscle_zone, exercise_progression, rotation_state, profile) para producir 6 KPIs distintos (Tasa de ProgresiÃ³n, Velocidad de Carga, Tonelaje por Grupo Muscular, DistribuciÃ³n de Volumen, RIR Promedio por MÃ³dulo, Adherencia Semanal) mÃ¡s 2 anÃ¡lisis temporales (Tendencia de ProgresiÃ³n, EvoluciÃ³n de Tonelaje). Sin embargo, es una historia de **lectura pura** â€” no modifica ningÃºn dato existente, no ejecuta lÃ³gica al cierre de sesiÃ³n, y no produce efectos colaterales. Su complejidad estÃ¡ en la derivaciÃ³n de datos y la presentaciÃ³n visual, no en la orquestaciÃ³n transaccional. Se introduce un `MetricsRepository` separado de `SessionRepository` porque la responsabilidad es ortogonal: consultas analÃ­ticas agregadas vs. operaciones transaccionales de sesiÃ³n.

### Decisiones Fundamentadas

**1. Se crea un `MetricsRepository` (interfaz + implementaciÃ³n) como el quinto repositorio del sistema.**

Los 4 repositorios existentes (`SessionRepository`, `ProfileRepository`, `ExerciseRepository`, `PlanRepository`) gestionan entidades transaccionales individuales. HU-15 requiere consultas de agregaciÃ³n complejas que cruzan mÃºltiples tablas (exercise_set â†’ session_exercise â†’ session â†’ module_version â†’ exercise â†’ exercise_muscle_zone â†’ muscle_zone). Mezclar estas consultas en `SessionRepository` (ya con 18+ mÃ©todos) violarÃ­a SRP y harÃ­a el repositorio inmanejable. `MetricsRepository` recibe inyecciÃ³n de los DAOs necesarios (SessionDao, ExerciseSetDao, SessionExerciseDao, MuscleZoneDao, ProfileDao, RotationStateDao) y expone mÃ©todos `suspend` y `Flow` orientados al cÃ¡lculo analÃ­tico.

**2. Los 6 KPIs se calculan on-demand (al abrir G1), no al cierre de sesiÃ³n.**

Las mÃ©tricas de HU-15 son costosas en lectura pero no en escritura. Calcularlas al cierre de sesiÃ³n implicarÃ­a: (a) agregar latencia al flujo crÃ­tico `closeSession()`, (b) persistir valores derivados que se invalidan con cada nueva sesiÃ³n, (c) duplicar datos (las mÃ©tricas se derivan 100% de los datos existentes). En cambio, se calculan al abrir G1 con un loading state. Dado que el volumen de datos es limitado (mÃ¡ximo ~40 ejercicios Ã— ~6 sesiones/microciclo Ã— ~20 microciclos = ~4800 filas de exercise_set en un aÃ±o), las queries de agregaciÃ³n son despreciables en dispositivos modernos. ADR-06 valida este enfoque: reglas puras + queries derivadas.

**3. La asociaciÃ³n de sesiones a microciclos se deriva del orden de cierre, no de una columna persistida.**

La tabla `session` NO tiene columna `microcycle_number`. El `rotation_state.microcycle_count` es un acumulador global. Para agrupar sesiones por microciclo: las sesiones cerradas (COMPLETED/INCOMPLETE) se ordenan por fecha+id ascendente, y cada grupo de 6 sesiones consecutivas forma un microciclo. El microciclo N corresponde a las sesiones `[(N-1)*6 + 1, N*6]` en orden cronolÃ³gico. El microciclo parcial actual (posiciones 1 a `rotation_state.microcycle_position - 1`) se incluye solo si `microcycle_position > 1`. Esta derivaciÃ³n se encapsula en un mÃ©todo `getSessionsGroupedByMicrocycle()` del `MetricsRepository` que retorna `Map<Int, List<SessionWithSets>>`. Las sesiones IN_PROGRESS se excluyen (no estÃ¡n cerradas).

**4. Cada KPI se implementa como una funciÃ³n pura en su regla correspondiente dentro de `domain/rules/`.**

Siguiendo el patrÃ³n establecido por ADR-06 (8 reglas existentes), se crean 6 reglas nuevas:

| Regla | FunciÃ³n pura | Entrada | Salida |
|---|---|---|---|
| `ProgressionRateRule` | `calculate(positiveCount, totalCount)` | Int, Int | Double (%) |
| `LoadVelocityRule` | `calculate(currentWeightKg, initialWeightKg, sessionCount)` | Double, Double, Int | Double (Kg/sesiÃ³n) |
| `TonnageRule` | `calculateForMuscleGroup(sets)` | List&lt;SetWithMuscleGroups&gt; | Map&lt;String, Double&gt; (groupâ†’kg) |
| `VolumeDistributionRule` | `calculate(setsByMuscleZone, totalSets)` | Map&lt;String, Int&gt;, Int | Map&lt;String, Double&gt; (zoneâ†’%) |
| `AvgRirRule` | `calculate(rirValues)` | List&lt;Int&gt; | Double (promedio 1 decimal) |
| `AdherenceRule` | `calculate(completedSessions, plannedSessions)` | Int, Int | Double (%) |

Las reglas de Tendencia de ProgresiÃ³n (Bloque D) y EvoluciÃ³n de Tonelaje (Bloque E) no requieren reglas propias â€” son derivaciones de la presentaciÃ³n de los datos calculados por `TonnageRule` y `ProgressionRateRule` a lo largo de microciclos.

**5. La Tendencia de ProgresiÃ³n (G3) se clasifica con un algoritmo de pendiente lineal simplificado.**

CA-15.21 requiere clasificar como "Ascendente", "Estable" o "En declive". Se implementa como `TrendClassificationRule.classify(values: List<Double>): TrendDirection` donde `values` son los tonelajes (o tasas de progresiÃ³n) de los Ãºltimos 4-6 microciclos, ordenados cronolÃ³gicamente. El algoritmo calcula la pendiente de la lÃ­nea de mejor ajuste (regresiÃ³n lineal simple) y clasifica:

- Pendiente > umbral positivo (+5% del valor medio) â†’ `ASCENDING`
- Pendiente < umbral negativo (-5% del valor medio) â†’ `DECLINING`
- Otro â†’ `STABLE`

El umbral del 5% evita clasificar ruido estadÃ­stico como tendencia. La regresiÃ³n lineal simple (slope = Î£(xi - xÌ„)(yi - È³) / Î£(xi - xÌ„)Â²) es computacionalmente trivial para 4-6 puntos y no requiere dependencias externas.

**6. El Ãndice de Adherencia usa semanas ISO 8601 (lunes a domingo) y consulta `profile.weekly_frequency`.**

CA-15.16 dice "semana natural". Se define como semana ISO (lunes=1, domingo=7) para consistencia. El query cuenta sesiones con `status IN ('COMPLETED', 'INCOMPLETE')` cuya `date` caiga en la semana ISO actual o la consultada. El denominador es `profile.weekly_frequency` (4, 5 o 6). La fÃ³rmula: `(sessionsInWeek / weeklyFrequency) * 100`, capped a 100% (si se entrena mÃ¡s del objetivo, no supera 100%). Para la vista G1, se muestra la semana actual.

**7. El RIR Promedio por MÃ³dulo filtra por las N Ãºltimas sesiones del mÃ³dulo, no por fecha.**

CA-15.14 dice "Ãºltimas 2 ejecuciones del mismo mÃ³dulo" como defecto. Esto NO es un rango de fechas â€” es un conteo de sesiones. Se consultan las Ãºltimas N sesiones (2, 4 o 6 â€” configurable en G1) del mÃ³dulo X, se obtienen todas las series (`exercise_set`) de esas sesiones, y se promedia `rir`. El query filtra por `session.module_version_id` que pertenezca al mÃ³dulo (JOIN module_version WHERE module_code = X), y ordena por `session.date DESC` / `session.id DESC`, tomando los primeros N. Se excluyen sesiones IN_PROGRESS.

**8. La Tasa de ProgresiÃ³n filtra por perÃ­odo configurable (4/8/12 semanas) usando `session.date`.**

CA-15.02 dice "perÃ­odo de 4 semanas" como defecto. El query: para cada ejercicio, contar sesiones donde `session_exercise.progression_classification = 'POSITIVE_PROGRESSION'` vs. total de sesiones (donde classification IS NOT NULL) dentro del rango de fechas. Los ejercicios sin clasificaciÃ³n (NO_HISTORY en su primera sesiÃ³n) se excluyen del cÃ³mputo. La fÃ³rmula: `positiveCount / totalWithClassification * 100`.

**9. La Velocidad de Carga se calcula como (peso mÃ¡s reciente - peso mÃ¡s antiguo) / sesiones intermedias.**

CA-15.03 define la fÃ³rmula. Para cada ejercicio estÃ¡ndar (no bodyweight, no isomÃ©trico): obtener el `AVG(weight_kg)` de las series de la primera sesiÃ³n registrada del ejercicio y el `AVG(weight_kg)` de la Ãºltima sesiÃ³n registrada. El denominador es el nÃºmero de sesiones distintas del ejercicio menos 1 (sesiones intermedias). Si solo hay 1 sesiÃ³n â†’ velocidad = 0 (CA-15.04). Si es bodyweight â†’ N/A (CA-15.05). El perÃ­odo de evaluaciÃ³n usa el mismo rango que la Tasa de ProgresiÃ³n (4/8/12 semanas) para consistencia.

**10. El Tonelaje por Grupo Muscular contabiliza ejercicios multi-zona en cada grupo al que pertenecen.**

CA-15.09 dice que un ejercicio que trabaja mÃºltiples zonas contabiliza su tonelaje en cada zona. El tonelaje de un ejercicio = Î£(weight_kg Ã— reps) de todas sus series en el microciclo. Para un ejercicio con 2 zonas (ej: Sentadilla BÃºlgara â†’ CuÃ¡driceps + GlÃºteos), ese mismo tonelaje se suma COMPLETO a ambos grupos. No se divide â€” se contabiliza al 100% en cada grupo. El query: JOIN exercise_set â†’ session_exercise â†’ exercise_muscle_zone â†’ muscle_zone, GROUP BY muscle_zone.muscle_group, SUM(weight_kg * reps).

**11. G1 (Panel de MÃ©tricas) es la pantalla que reemplaza el `PlaceholderScreen` existente en la ruta `METRICS`.**

Actualmente `NavigationRoutes.METRICS = "metrics"` ya existe y tiene un `PlaceholderScreen` registrado en `TensionNavHost`. Se reemplaza con `MetricsScreen`. La pantalla es scrollable con 4 secciones + 2 accesos rÃ¡pidos:
1. Ãndice de Adherencia (card con porcentaje + desglose)
2. RIR Promedio por MÃ³dulo (card con dropdown de perÃ­odo + 3 filas)
3. Tasa de ProgresiÃ³n (lista interactiva con dropdown de perÃ­odo + filas por ejercicio â†’ F3)
4. Velocidad de Carga (lista interactiva + filas por ejercicio â†’ F3)
5. Enlace "Volumen por Grupo Muscular â†’" (navega a G2)
6. Enlace "Tendencia de ProgresiÃ³n â†’" (navega a G3)

Sigue la estructura visual Â§G1 de la EspecificaciÃ³n Visual: `CenterAlignedTopAppBar` sin navigationIcon, Bottom Navigation con MÃ©tricas activo.

**12. G2 y G3 son pantallas independientes con sus propios ViewModels, accesibles desde G1.**

G2 (Volumen por Grupo Muscular) tiene 3 secciones: selector de microciclo (stepper â—€â–¶), tonelaje por grupo muscular (barras horizontales), distribuciÃ³n de volumen (%), y evoluciÃ³n temporal (grÃ¡fico multilÃ­nea). G3 (Tendencia de ProgresiÃ³n) es una lista simple con 12 filas (una por grupo muscular) y clasificaciÃ³n Ascendente/Estable/En declive. Ambas tienen navigationIcon ArrowBack â†’ G1 y Bottom Navigation con MÃ©tricas activo.

Se crean 3 ViewModels:
- `MetricsViewModel` â†’ carga datos para G1 (adherencia, RIR promedio, tasa de progresiÃ³n, velocidad de carga)
- `VolumeViewModel` â†’ carga datos para G2 (tonelaje por grupo, distribuciÃ³n, evoluciÃ³n)
- `TrendViewModel` â†’ carga datos para G3 (tendencia por grupo muscular)

**13. El grÃ¡fico de evoluciÃ³n temporal en G2 NO usa una librerÃ­a de charts externa.**

La EspecificaciÃ³n Visual Â§G2 describe un grÃ¡fico multilÃ­nea con leyenda y grid. Para fase MVP, se implementa como un `Canvas` Composable con draw commands bÃ¡sicos. Los puntos de datos (tonelaje por grupo por microciclo) son pocos (mÃ¡x ~12 lÃ­neas Ã— ~20 puntos) y la precisiÃ³n visual no requiere interpolaciÃ³n spline. Se dibuja: ejes (Label Small, On Surface Variant), lÃ­neas conectando puntos (Primary, Secondary, Tertiary + variantes), leyenda inferior (Label Small + punto de color). Si el equipo decide usar una librerÃ­a futura (Vico, YCharts), la interfaz de datos no cambia â€” solo el composable de renderizado.

**14. Los Use Cases orquestan Repository + Rules para cada bloque de KPIs.**

Siguiendo la convenciÃ³n `{AcciÃ³n}{Entidad}UseCase`:

| Use Case | Bloque | DescripciÃ³n |
|---|---|---|
| `GetAdherenceUseCase` | C | Obtiene sesiones de la semana + weekly_frequency â†’ `AdherenceRule.calculate()` |
| `GetAvgRirByModuleUseCase` | C | Obtiene sets de las N Ãºltimas sesiones del mÃ³dulo â†’ `AvgRirRule.calculate()` |
| `GetProgressionRateUseCase` | A | Obtiene clasificaciones por ejercicio en perÃ­odo â†’ `ProgressionRateRule.calculate()` |
| `GetLoadVelocityUseCase` | A | Obtiene peso inicial/actual por ejercicio â†’ `LoadVelocityRule.calculate()` |
| `GetTonnageByMuscleGroupUseCase` | B | Obtiene sets + muscle zones del microciclo â†’ `TonnageRule.calculateForMuscleGroup()` |
| `GetVolumeDistributionUseCase` | B | Obtiene conteo de sets por zona â†’ `VolumeDistributionRule.calculate()` |
| `GetTonnageEvolutionUseCase` | E | Obtiene tonelaje por grupo Ã— microciclo â†’ lista de snapshots |
| `GetMuscleGroupTrendUseCase` | D | Obtiene tonelaje histÃ³rico por grupo â†’ `TrendClassificationRule.classify()` |

**15. Los estados vacÃ­os y de datos insuficientes se manejan como variantes explÃ­citas del UiState.**

- G3 (Tendencia): si `microcycleCount < 4` â†’ `TrendUiState.InsufficientData(remaining = 4 - microcycleCount)` (CA-15.23)
- G2 (EvoluciÃ³n de Tonelaje): si `microcycleCount < 2` â†’ `VolumeUiState.InsufficientEvolution` (CA-15.28)
- G1 (Tasa de ProgresiÃ³n): si un ejercicio no tiene sesiones con clasificaciÃ³n en el perÃ­odo â†’ se muestra "Sin datos" en vez de 0%

**16. Las rutas de G2 y G3 se agregan a `NavigationRoutes` como destinos secundarios.**

G1 ya existe como `METRICS`. Se agregan:
- `VOLUME_BY_MUSCLE_GROUP = "volume-by-muscle-group"` â†’ G2
- `MUSCLE_GROUP_TREND = "muscle-group-trend"` â†’ G3

La navegaciÃ³n G1â†’G2 y G1â†’G3 usa `navController.navigate()` estÃ¡ndar. G2/G3 tienen ArrowBack que ejecuta `navController.popBackStack()`.

**17. La derivaciÃ³n de microciclos para agrupaciÃ³n temporal se implementa con lÃ³gica Kotlin.**

SQLite no soporta window functions robustas en todas las versiones de Android. Se opta por la lÃ³gica en Kotlin:

1. Obtener TODAS las sesiones cerradas ordenadas por (date ASC, id ASC)
2. Agrupar en bloques de 6: sesiones [0..5] = microciclo 1, [6..11] = microciclo 2, etc.
3. El bloque parcial final (< 6 sesiones) = microciclo actual en progreso
4. Retornar Map&lt;Int, List&lt;Long&gt;&gt; (microcycleNumber â†’ sessionIds)

Este mapeo se calcula una vez al abrir G2 o G3 y se cachea en el ViewModel durante la sesiÃ³n de visualizaciÃ³n. No se persiste porque es derivado puro. Las sesiones de deload participan del conteo de microciclos normalmente â€” un microciclo de deload es un microciclo vÃ¡lido (CA-14.13 ya implementado en HU-14).

**18. Los selectores de perÃ­odo en G1 (dropdown de semanas, dropdown de sesiones RIR) se implementan como `ExposedDropdownMenuBox` M3.**

EspecificaciÃ³n Visual Â§G1 define:
- Tasa de ProgresiÃ³n: opciones "4 semanas" (defecto), "8 semanas", "12 semanas"
- RIR Promedio: opciones "2 Ãºltimas sesiones" (defecto), "4 Ãºltimas sesiones", "6 Ãºltimas sesiones"

Los cambios de perÃ­odo disparan recarga del KPI correspondiente via `viewModelScope.launch`. No se persisten â€” al salir y reentrar a G1, se usan los defaults.

### Componentes Afectados

**Componentes nuevos:**

| # | Componente | Capa | Responsabilidad |
|---|---|---|---|
| 1 | `ProgressionRateRule` | Domain (rules) | FunciÃ³n pura: `calculate(positiveCount, totalCount)` â†’ porcentaje. ADR-06 |
| 2 | `LoadVelocityRule` | Domain (rules) | FunciÃ³n pura: `calculate(currentWeight, initialWeight, sessionCount)` â†’ Kg/sesiÃ³n. ADR-06 |
| 3 | `TonnageRule` | Domain (rules) | FunciÃ³n pura: `calculateForMuscleGroup(sets)` â†’ Map&lt;grupo, tonelaje&gt;. ADR-06 |
| 4 | `VolumeDistributionRule` | Domain (rules) | FunciÃ³n pura: `calculate(setsByZone, totalSets)` â†’ Map&lt;zona, %&gt;. ADR-06 |
| 5 | `AvgRirRule` | Domain (rules) | FunciÃ³n pura: `calculate(rirValues)` â†’ promedio con 1 decimal. ADR-06 |
| 6 | `AdherenceRule` | Domain (rules) | FunciÃ³n pura: `calculate(completed, planned)` â†’ porcentaje capped 100%. ADR-06 |
| 7 | `TrendClassificationRule` | Domain (rules) | FunciÃ³n pura: `classify(values)` â†’ TrendDirection (ASCENDING/STABLE/DECLINING). Pendiente lineal. ADR-06 |
| 8 | `TrendDirection` | Domain (model) | Enum: `ASCENDING`, `STABLE`, `DECLINING` |
| 9 | `MetricsRepository` | Domain (repository) | Interfaz: queries analÃ­ticas agregadas (progresiÃ³n, tonelaje, RIR, adherencia, agrupaciÃ³n por microciclo) |
| 10 | `MetricsRepositoryImpl` | Data (repository) | ImplementaciÃ³n con inyecciÃ³n de DAOs. Consultas SQL de agregaciÃ³n. Transforma DTOs â†’ modelos de dominio |
| 11 | `GetAdherenceUseCase` | Domain (usecase/metrics) | Orquesta: sesiones de la semana + weekly_frequency â†’ AdherenceRule |
| 12 | `GetAvgRirByModuleUseCase` | Domain (usecase/metrics) | Orquesta: sets de N Ãºltimas sesiones del mÃ³dulo â†’ AvgRirRule |
| 13 | `GetProgressionRateUseCase` | Domain (usecase/metrics) | Orquesta: clasificaciones por ejercicio en perÃ­odo â†’ ProgressionRateRule |
| 14 | `GetLoadVelocityUseCase` | Domain (usecase/metrics) | Orquesta: peso inicial/actual por ejercicio â†’ LoadVelocityRule |
| 15 | `GetTonnageByMuscleGroupUseCase` | Domain (usecase/metrics) | Orquesta: sets+zones del microciclo â†’ TonnageRule |
| 16 | `GetVolumeDistributionUseCase` | Domain (usecase/metrics) | Orquesta: conteo sets por zona â†’ VolumeDistributionRule |
| 17 | `GetTonnageEvolutionUseCase` | Domain (usecase/metrics) | Orquesta: tonelaje por grupo Ã— microciclos â†’ lista temporal |
| 18 | `GetMuscleGroupTrendUseCase` | Domain (usecase/metrics) | Orquesta: tonelaje histÃ³rico â†’ TrendClassificationRule.classify() |
| 19 | `MetricsUiState` | UI (metrics) | Sealed interface: Loading, Content(adherence, rirByModule, progressionRates, loadVelocities), Error |
| 20 | `MetricsViewModel` | UI (metrics) | Carga KPIs de G1, expone StateFlow&lt;MetricsUiState&gt;. Acciones: changePeriod, changeRirPeriod |
| 21 | `MetricsScreen` | UI (metrics) | Composable G1: 4 secciones + 2 accesos rÃ¡pidos + Bottom Navigation |
| 22 | `VolumeUiState` | UI (volume) | Sealed interface: Loading, Content(tonnageByGroup, distribution, evolution, microcycleCount, selectedMicrocycle), InsufficientEvolution, Error |
| 23 | `VolumeViewModel` | UI (volume) | Carga KPIs de G2. AcciÃ³n: selectMicrocycle(n) |
| 24 | `VolumeScreen` | UI (volume) | Composable G2: selector microciclo + barras + distribuciÃ³n + grÃ¡fico evoluciÃ³n |
| 25 | `TrendUiState` | UI (trend) | Sealed interface: Loading, Content(trends: List&lt;MuscleGroupTrend&gt;), InsufficientData(remaining), Error |
| 26 | `TrendViewModel` | UI (trend) | Carga tendencias de G3 |
| 27 | `TrendScreen` | UI (trend) | Composable G3: lista de 12 grupos con clasificaciÃ³n |
| 28 | `TonnageChartComposable` | UI (components) | Canvas composable reutilizable para grÃ¡fico multilÃ­nea de evoluciÃ³n de tonelaje |
| 29 | Domain models | Domain (model) | `AdherenceData`, `RirByModule`, `ExerciseProgressionRate`, `ExerciseLoadVelocity`, `MuscleGroupTonnage`, `MuscleGroupTrend`, `TonnageSnapshot`, `MicrocycleVolume` |

**Componentes modificados:**

| # | Componente | ModificaciÃ³n | Nivel |
|---|---|---|---|
| 1 | `SessionDao` | Agregar queries: `getClosedSessionsOrdered()`, `countSessionsInWeek(startDate, endDate)`, `getSessionIdsByModuleInRange(moduleCode, limit)` | Medio |
| 2 | `ExerciseSetDao` | Agregar queries: `getRirValuesBySessionIds(ids)`, `getTonnageBySessionIds(ids)`, `getFirstWeightForExercise(exerciseId, startDate)`, `getAvgWeightByExerciseAndSession(exerciseId, sessionId)` | Medio |
| 3 | `SessionExerciseDao` | Agregar queries: `countClassificationsByExercise(exerciseId, startDate)`, `getExerciseIdsWithClassificationInRange(startDate)` | Medio |
| 4 | `NavigationRoutes` | Agregar `VOLUME_BY_MUSCLE_GROUP` y `MUSCLE_GROUP_TREND` | Menor |
| 5 | `TensionNavHost` | Reemplazar `PlaceholderScreen` de METRICS con `MetricsScreen`. Registrar composables G2 y G3 | Medio |
| 6 | `RepositoryModule` | Agregar 5to binding: `MetricsRepository` â†’ `MetricsRepositoryImpl` | Menor |

### Hitos de ImplementaciÃ³n

| # | Componente(s) | DescripciÃ³n | Dependencias |
|---|---|---|---|
| 1 | Reglas puras (7) + tests | `ProgressionRateRule`, `LoadVelocityRule`, `TonnageRule`, `VolumeDistributionRule`, `AvgRirRule`, `AdherenceRule`, `TrendClassificationRule`. Tests JUnit con edge cases | Ninguna |
| 2 | DAO queries nuevos | Queries de agregaciÃ³n en SessionDao, ExerciseSetDao, SessionExerciseDao. Tests instrumentados | Ninguna |
| 3 | Domain models | `AdherenceData`, `RirByModule`, `ExerciseProgressionRate`, `ExerciseLoadVelocity`, `MuscleGroupTonnage`, `MuscleGroupTrend`, `TonnageSnapshot`, `MicrocycleVolume`, `TrendDirection` | Ninguna |
| 4 | `MetricsRepository` (interfaz + impl) | Interfaz + implementaciÃ³n con lÃ³gica de agrupaciÃ³n por microciclo | Hitos 1, 2, 3 |
| 5 | Use Cases (8) | 8 use cases orquestando repository + rules | Hito 4 |
| 6 | DI binding | `RepositoryModule` â†’ `MetricsRepository` | Hito 4 |
| 7 | G1 â€” MetricsScreen + ViewModel | Reemplazo del PlaceholderScreen. 4 secciones + 2 accesos rÃ¡pidos. Dropdowns de perÃ­odo | Hito 5 |
| 8 | G2 â€” VolumeScreen + ViewModel | Selector microciclo + barras + distribuciÃ³n + grÃ¡fico Canvas | Hito 5 |
| 9 | G3 â€” TrendScreen + ViewModel | Lista de 12 grupos + clasificaciÃ³n + estado insuficiente | Hito 5 |
| 10 | NavegaciÃ³n G2/G3 | Rutas en NavigationRoutes, composables en TensionNavHost, enlaces G1â†’G2, G1â†’G3 | Hitos 7, 8, 9 |

### ValidaciÃ³n de Impacto

**CÃ³digo real verificado (paso 1.5):**

- `NavigationRoutes.kt`: Ya tiene `METRICS = "metrics"`. Falta `VOLUME_BY_MUSCLE_GROUP` y `MUSCLE_GROUP_TREND`.
- `TensionNavHost.kt`: `composable(NavigationRoutes.METRICS) { PlaceholderScreen(...) }` â€” se reemplaza con `MetricsScreen`.
- `BottomNavigationBar.kt`: Ya tiene tab de MÃ©tricas apuntando a `METRICS`. No requiere modificaciÃ³n.
- `SessionDao.kt`: Tiene `getActiveSession()`, `getById()`, `updateStatus()`, etc. Falta queries de conteo por fecha, ordenaciÃ³n de sesiones cerradas.
- `ExerciseSetDao.kt`: Tiene `getSetsForSessionExercise()` que retorna `weightKg`, `reps`, `rir`. Falta queries de agregaciÃ³n por sesiÃ³n/mÃ³dulo. `getLastWeightForExercise()` existe (excluye deload desde HU-14).
- `SessionExerciseDao.kt`: Tiene `getSessionExercisesForProgression()` y `updateProgressionClassification()`. Falta query de conteo de clasificaciones por ejercicio en rango de fechas.
- `ProfileDao.kt`: `getProfile()` retorna `Flow<ProfileEntity?>` que incluye `weeklyFrequency`. Disponible.
- `RotationStateDao.kt`: `getRotationState()` retorna `microcycleCount` y `microcyclePosition`. Disponible.
- `MuscleZoneDao.kt`: `getAll()` retorna `Flow<List<MuscleZoneEntity>>` con `muscleGroup`. Disponible.
- `ExerciseMuscleZoneEntity.kt`: Tabla JOIN con `exerciseId` + `muscleZoneId`. No hay `ExerciseMuscleZoneDao` â€” la tabla se accede via `ExerciseDao.insertMuscleZone()` y `insertAllMuscleZones()`. Para lecturas analÃ­ticas, se necesita un query JOIN directo en `ExerciseSetDao` o en `MetricsRepositoryImpl`.
- `TensionDatabase.kt`: version=6, 16 entities. No requiere nuevo entity ni migration â€” HU-15 es lectura pura.
- `DatabaseModule.kt`: Ya provee los 15 DAOs. No se necesita nuevo DAO â€” las queries se agregan a DAOs existentes.
- `RepositoryModule.kt`: Binds 4 repositorios (`ProfileRepository`, `ExerciseRepository`, `PlanRepository`, `SessionRepository`). Se agrega el 5to: `MetricsRepository`.
- `SessionRepository.kt`: 18 mÃ©todos. No se modifica â€” HU-15 usa su propio repositorio.

**AnÃ¡lisis de dependencias:**

- HU-15 depende de: HU-01 (profile.weekly_frequency para adherencia), HU-05 (session + session_exercise â€” datos base), HU-06 (exercise_set â€” datos de series), HU-09 (rotation_state.microcycle_count â€” agrupaciÃ³n temporal), HU-10 (progression_classification â€” fuente de Tasa de ProgresiÃ³n), HU-14 (session.deload_id â€” sesiones de deload participan en microciclos normalmente).
- HU-15 alimenta: HU-17 (alertas â€” los KPIs de HU-15 son los que disparan alertas de tasa baja, RIR fuera de rango, adherencia baja, tonelaje en caÃ­da; HU-17 necesita las mismas queries/reglas para calcular los datos de la alerta en H2).
- HU-15 NO modifica componentes de otras HUs â€” es lectura pura.

**Impacto en performance:**

- Todas las queries son de LECTURA sobre datos cerrados (sesiones COMPLETED/INCOMPLETE).
- `countClassificationsByExercise`: GROUP BY con COUNT sobre session_exercise filtrado por date range. Con Ã­ndices en `exercise_id` y `session_id`, O(n) donde n = sesiones del ejercicio.
- `getRirValuesBySessionIds`: JOIN exercise_set â†’ session_exercise filtrado por session IDs. Con IN clause. O(sets Ã— sessions).
- `getTonnageBySessionIds`: JOIN con SUM(weight_kg * reps) GROUP BY muscle_group. O(sets Ã— sessions Ã— exercises).
- Peor caso estimado: 20 microciclos Ã— 6 sesiones Ã— 8 ejercicios Ã— 4 sets = 3,840 filas de exercise_set total. Consultas < 50ms en dispositivo moderno.
- El grÃ¡fico Canvas de G2 renderiza mÃ¡ximo 12 lÃ­neas Ã— 20 puntos = 240 draw calls. Trivial.

### Notas TÃ©cnicas

**Nota 1 â€” La agrupaciÃ³n por microciclo asume sesiones consecutivas de 6.**

Si la rotaciÃ³n se ha reiniciado manualmente o hay sesiones corruptas, la agrupaciÃ³n podrÃ­a desalinearse. Sin embargo, el sistema no permite reiniciar la rotaciÃ³n (la tabla `rotation_state` es de fila Ãºnica inmutable excepto por `advanceRotation()`). Las sesiones IN_PROGRESS se excluyen del conteo. Las sesiones INCOMPLETE sÃ­ cuentan como cierre vÃ¡lido (ya avanzan la rotaciÃ³n â€” CA-09.05).

**Nota 2 â€” Las sesiones de deload sÃ­ se incluyen en cÃ¡lculos de tonelaje pero se excluyen de Tasa de ProgresiÃ³n y Velocidad de Carga.**

Un microciclo de deload tiene tonelaje reducido (cargas al 60%). Esto es correcto â€” la "EvoluciÃ³n temporal" en G2 deberÃ­a mostrar la caÃ­da de tonelaje durante el deload y la recuperaciÃ³n post-deload. El ejecutante debe poder visualizar este patrÃ³n. HU-17 (alertas de tonelaje) verificarÃ¡ si la caÃ­da es por "descarga planificada" antes de emitir alerta. En la Tasa de ProgresiÃ³n, las sesiones de deload no deberÃ­an penalizar al ejercicio â€” durante deload, `resolveNewProgressionState()` retorna IN_DELOAD sin cambiar el estado, y la `classification` se sigue asignando normalmente pero con cargas reducidas artificialmente (posiblemente REGRESSION comparado con pre-deload). **SoluciÃ³n: excluir sesiones con `session.deload_id IS NOT NULL` del cÃ¡lculo de Tasa de ProgresiÃ³n y Velocidad de Carga** â€” estas mÃ©tricas deben reflejar el rendimiento real, no el perÃ­odo de recuperaciÃ³n deliberada.

**Nota 3 â€” El grÃ¡fico de evoluciÃ³n temporal (G2) es un Canvas composable custom, no una librerÃ­a externa.**

Se evita dependencia externa para fase MVP. El componente recibe `List<TonnageSnapshot>` (microcycleNumber, Map&lt;group, tonnage&gt;) y dibuja:
- Eje X: microciclos (Label Small)
- Eje Y: tonelaje en Kg (Label Small, auto-scaled)
- LÃ­neas: una por grupo muscular, colores diferenciados segÃºn Â§G2 EspecVis (Primary #8B1A1A, Secondary #6B4F4F, Tertiary #5C6B4F + variantes)
- Leyenda inferior: Label Small + punto de color + nombre grupo

**Nota 4 â€” No hay tabla nueva ni migraciÃ³n de base de datos.**

HU-15 es 100% lectura sobre datos existentes. No se crea ninguna entidad Room nueva, no se modifica ninguna tabla, no se requiere migration. El Ãºnico cambio en la capa de datos son queries adicionales en DAOs existentes.

**Nota 5 â€” Para Velocidad de Carga, el "peso inicial" es el AVG(weight_kg) de las series de la primera sesiÃ³n del ejercicio en el perÃ­odo.**

No el peso de la primera serie. Se usa el promedio para suavizar variaciones intra-sesiÃ³n (warming up, fatigue drops). El "peso actual" es el AVG(weight_kg) de las series de la Ãºltima sesiÃ³n del ejercicio. Ambos queries usan el mismo rango de fechas que la Tasa de ProgresiÃ³n para consistencia.

**Nota 6 â€” Los accesos F3 (toque en ejercicio en G1) ya estÃ¡n implementados.**

`NavigationRoutes.EXERCISE_HISTORY = "exercise-history/{exerciseId}"` ya existe. La navegaciÃ³n G1â†’F3 usa `navController.navigate("exercise-history/$exerciseId")`. El composable `ExerciseHistoryScreen` ya estÃ¡ registrado en `TensionNavHost`.

**Nota 7 â€” La DistribuciÃ³n de Volumen (CA-15.10) se calcula sobre el microciclo completo.**

CA-15.10 dice "porcentaje de series totales de cada zona muscular respecto al total de series del mÃ³dulo". El Wireframe G2 muestra "DistribuciÃ³n de series por zona muscular vs. total del mÃ³dulo" sin especificar si es un mÃ³dulo individual o todos. Se interpreta como: la distribuciÃ³n se calcula sobre TODAS las sesiones del microciclo seleccionado (los 3 mÃ³dulos), con el desglose por zona mostrando quÃ© porcentaje del volumen total del microciclo recibe cada zona.

**Nota 8 â€” Query de Tasa de ProgresiÃ³n excluye sesiones de deload.**

El query debe incluir el filtro `AND s.deload_id IS NULL` para que las clasificaciones durante sesiones de deload no contaminen el cÃ¡lculo de la tasa de rendimiento real del ejecutante.

### VerificaciÃ³n Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-15.01 | ðŸ”¨ Por implementar | `ProgressionRateRule.calculate(positiveCount, totalCount)` â†’ porcentaje | HU-15 (Rule + UseCase) |
| CA-15.02 | ðŸ”¨ Por implementar | Dropdown en G1 (4/8/12 semanas). Defecto 4. Recalcula al cambiar | HU-15 (MetricsScreen + ViewModel) |
| CA-15.03 | ðŸ”¨ Por implementar | `LoadVelocityRule.calculate(current, initial, sessions)` â†’ Kg/sesiÃ³n | HU-15 (Rule + UseCase) |
| CA-15.04 | ðŸ”¨ Por implementar | Si `current == initial` â†’ velocidad = 0. Edge case en `LoadVelocityRule` | HU-15 (Rule) |
| CA-15.05 | ðŸ”¨ Por implementar | Guard: `if (isBodyweight)` â†’ excluir de Velocidad de Carga. Mostrar "N/A" | HU-15 (UseCase + UI) |
| CA-15.06 | ðŸ”¨ Por implementar | G1 Secciones 3+4: lista por ejercicio con % y Kg/sesiÃ³n | HU-15 (MetricsScreen) |
| CA-15.07 | ðŸ”¨ Por implementar | `TonnageRule.calculateForMuscleGroup(sets)` â†’ SUM(weight Ã— reps) agrupado por muscle_group | HU-15 (Rule + UseCase) |
| CA-15.08 | ðŸ”¨ Por implementar | JOIN exercise_muscle_zone â†’ muscle_zone. Usa `muscle_zone.muscle_group` como fuente de verdad | HU-15 (DAO query) |
| CA-15.09 | ðŸ”¨ Por implementar | Tonelaje se contabiliza al 100% en CADA grupo del ejercicio multi-zona | HU-15 (TonnageRule) |
| CA-15.10 | ðŸ”¨ Por implementar | `VolumeDistributionRule.calculate(setsByZone, totalSets)` â†’ porcentaje por zona | HU-15 (Rule + UseCase) |
| CA-15.11 | ðŸ”¨ Por implementar | AgrupaciÃ³n por microciclo: bloques de 6 sesiones cerradas consecutivas. Selector en G2 | HU-15 (MetricsRepository) |
| CA-15.12 | ðŸ”¨ Por implementar | G2: barras tonelaje + distribuciÃ³n % + referencia al microciclo seleccionado | HU-15 (VolumeScreen) |
| CA-15.13 | ðŸ”¨ Por implementar | `AvgRirRule.calculate(rirValues)` â†’ promedio aritmÃ©tico 1 decimal | HU-15 (Rule + UseCase) |
| CA-15.14 | ðŸ”¨ Por implementar | Dropdown en G1 (2/4/6 Ãºltimas sesiones del mÃ³dulo). Defecto 2 | HU-15 (MetricsScreen + ViewModel) |
| CA-15.15 | ðŸ”¨ Por implementar | Badges coloreados: 2-3=ðŸŸ¢ (verde), <1.5=ðŸ”´ (rojo/riesgo), >3.5=ðŸŸ¡ (Ã¡mbar). Referencia textual | HU-15 (MetricsScreen) |
| CA-15.16 | ðŸ”¨ Por implementar | `AdherenceRule.calculate(completed, planned)` â†’ porcentaje capped 100% | HU-15 (Rule + UseCase) |
| CA-15.17 | ðŸ”¨ Por implementar | Denominador: `profile.weekly_frequency` (4, 5 o 6) via `ProfileDao.getProfile()` | HU-15 (UseCase) |
| CA-15.18 | ðŸ”¨ Por implementar | Conteo incluye COMPLETED + INCOMPLETE. Excluye IN_PROGRESS | HU-15 (DAO query) |
| CA-15.19 | ðŸ”¨ Por implementar | G1 Secciones 1+2: Adherencia card + RIR por mÃ³dulo card con badges | HU-15 (MetricsScreen) |
| CA-15.20 | ðŸ”¨ Por implementar | `GetMuscleGroupTrendUseCase`: tonelaje + tasa progresiÃ³n Ãºltimos 4-6 microciclos | HU-15 (UseCase) |
| CA-15.21 | ðŸ”¨ Por implementar | `TrendClassificationRule.classify(values)` â†’ ASCENDING/STABLE/DECLINING (pendiente lineal) | HU-15 (Rule) |
| CA-15.22 | ðŸ”¨ Por implementar | Defecto: 4-6 Ãºltimos microciclos. Priorizando recientes | HU-15 (UseCase) |
| CA-15.23 | ðŸ”¨ Por implementar | Guard: `if (microcycleCount < 4)` â†’ InsufficientData(remaining). Mostrar "Faltan N microciclos" | HU-15 (TrendViewModel + TrendScreen) |
| CA-15.24 | ðŸ”¨ Por implementar | G3: lista de 12 grupos con tendencia desglosada | HU-15 (TrendScreen) |
| CA-15.25 | ðŸ”¨ Por implementar | G2 EvoluciÃ³n: tonelaje por grupo Ã— microciclo en grÃ¡fico multilÃ­nea Canvas | HU-15 (TonnageChartComposable) |
| CA-15.26 | ðŸ”¨ Por implementar | GrÃ¡fico permite visualizar tendencias ascendente/estable/caÃ­da por grupo | HU-15 (TonnageChartComposable) |
| CA-15.27 | ðŸ”¨ Por implementar | Desglose por 12 grupos: Pecho, Espalda, Abdomen, Hombro, TrÃ­ceps, BÃ­ceps, CuÃ¡driceps, Isquiotibiales, GlÃºteos, Aductores, Abductores, Gemelos | HU-15 (VolumeScreen + TrendScreen) |
| CA-15.28 | ðŸ”¨ Por implementar | Guard: `if (microcycleCount < 2)` â†’ "Se necesitan al menos 2 microciclos" | HU-15 (VolumeViewModel + VolumeScreen) |

### Referencias y ValidaciÃ³n

**DocumentaciÃ³n consultada:**

- Manifiesto de Dominio SistÃ©mico Â§7 â€” KPIs 1-6 (Tasa de ProgresiÃ³n, Tonelaje, RIR Promedio, Adherencia, Velocidad de Carga, DistribuciÃ³n de Volumen)
- Manifiesto de Dominio SistÃ©mico Â§7.B â€” Umbrales de Tolerancia (alertas de tasa baja, RIR fuera de rango, adherencia baja, caÃ­da de tonelaje)
- Modelo de Datos Â§3.2 (muscle_zone â€” 15 zonas, 12 grupos), Â§3.5 (exercise_muscle_zone), Â§3.8 (profile.weekly_frequency), Â§3.10 (session.date, session.status), Â§3.11 (session_exercise.progression_classification), Â§3.12 (exercise_set.weight_kg, reps, rir), Â§3.14 (rotation_state.microcycle_count)
- ADR-06 â€” Motor de reglas Kotlin puro
- Arquitectura TÃ©cnica Â§5.2 â€” Naming: `MetricsScreen`, `MetricsViewModel`, `ProgressionRateRule`, etc.
- Wireframes G1 â€” Panel de MÃ©tricas (4 secciones + 2 accesos rÃ¡pidos + Bottom Navigation)
- Wireframes G2 â€” Volumen por Grupo Muscular (selector microciclo + barras + distribuciÃ³n + evoluciÃ³n temporal)
- Wireframes G3 â€” Tendencia de ProgresiÃ³n (lista 12 grupos + clasificaciÃ³n + estado insuficiente)
- EspecificaciÃ³n Visual Â§G1 â€” CenterAlignedTopAppBar, Filled Card Secondary Container, ExposedDropdownMenuBox, ListItem M3, badges coloreados
- EspecificaciÃ³n Visual Â§G2 â€” ArrowBack, Selector microciclo con IconButtons, barras horizontales, Canvas multilÃ­nea, colores Primary/Secondary/Tertiary
- EspecificaciÃ³n Visual Â§G3 â€” ListItem M3 56dp, colores verde/Ã¡mbar/rojo para tendencias, emojis ðŸ“ˆðŸ“ŠðŸ“‰
- Mapa de NavegaciÃ³n Â§G â€” G1â†’G2, G1â†’G3, G1â†’F3, G2â†G1, G3â†G1
- Requerimientos RF42, RF44, RF45, RF46, RF47, RF48, RF49, RF52

**Historias relacionadas:**

- HU-01: Establece `profile.weekly_frequency` â€” denominador del Ãndice de Adherencia (CA-15.17).
- HU-05: Crea sesiones y session_exercises â€” datos base para todos los KPIs.
- HU-06: Registra exercise_sets (weight_kg, reps, rir) â€” datos atÃ³micos de tonelaje, RIR, progresiÃ³n de carga.
- HU-09: Gestiona rotaciÃ³n y cierre de sesiÃ³n. `rotation_state.microcycle_count` es el acumulador de microciclos usado para agrupaciÃ³n temporal.
- HU-10: Asigna `progression_classification` en session_exercise al cierre â€” fuente directa de Tasa de ProgresiÃ³n.
- HU-14: Define sesiones de deload (`session.deload_id`). Las sesiones de deload participan en el conteo de microciclos pero se excluyen de Tasa de ProgresiÃ³n y Velocidad de Carga (Nota 2).
- HU-17 (futuro): Sistema de Alertas â€” usa los mismos KPIs (tasa < 40%, RIR fuera de rango, adherencia < 60%, tonelaje en caÃ­da) para generar alertas automÃ¡ticas. Los Use Cases y Rules de HU-15 serÃ¡n reutilizados por HU-17.

**Validado por:** esteban.colorado | **Fecha:** 2026-02-18 | **Enfoque:** Exploratorio
