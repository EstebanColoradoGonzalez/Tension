# HU-13 ‚Äî Mostrar resumen post-sesi√≥n con se√±ales de acci√≥n

## Requisitos relacionados

RF59, RNF05

## Descripci√≥n

Como ejecutante, quiero ver un resumen claro e inmediato al cerrar mi sesi√≥n con el tonelaje, la clasificaci√≥n de progresi√≥n por ejercicio y las se√±ales de acci√≥n para la pr√≥xima sesi√≥n, para saber en ese mismo momento qu√© hice bien, d√≥nde retroced√≠ y qu√© ajustar la pr√≥xima vez.

## Criterios de Aceptaci√≥n

### CA-13.01 ‚Äî Presentaci√≥n autom√°tica del resumen al cerrar

**Dado que** el ejecutante cierra una sesi√≥n (Completada o Incompleta),
**cuando** el sistema completa el procesamiento de cierre (c√°lculo de tonelaje, evaluaci√≥n de progresi√≥n, actualizaci√≥n de rotaci√≥n),
**entonces** presenta autom√°ticamente un resumen de la sesi√≥n al ejecutante sin requerir navegaci√≥n adicional.

### CA-13.02 ‚Äî Contenido del resumen: tonelaje total

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra el tonelaje total de la sesi√≥n (Œ£ Peso √ó Repeticiones de todas las series registradas), expresado en kilogramos.

### CA-13.03 ‚Äî Contenido del resumen: ejercicios completados

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra la cantidad de ejercicios completados (4 series registradas) respecto al total de ejercicios de la sesi√≥n (ej: "8/11 ejercicios completados").

### CA-13.04 ‚Äî Contenido del resumen: clasificaci√≥n de progresi√≥n por ejercicio

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra para cada ejercicio registrado en la sesi√≥n su clasificaci√≥n de progresi√≥n: "Progresi√≥n positiva", "Mantenimiento" o "Regresi√≥n", junto con el nombre del ejercicio.

### CA-13.05 ‚Äî Contenido del resumen: se√±ales de acci√≥n

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra para cada ejercicio la se√±al de acci√≥n para la pr√≥xima sesi√≥n: "Subir carga" (si cumpli√≥ Doble Umbral), "Mantener carga" (si no cumpli√≥) o "Considerar descarga" (si se detect√≥ regresi√≥n o fatiga acumulada).

### CA-13.06 ‚Äî Se√±ales visualmente distinguibles

**Dado que** el resumen muestra clasificaciones de progresi√≥n y se√±ales de acci√≥n,
**cuando** el ejecutante visualiza el resumen,
**entonces** las se√±ales de progresi√≥n (‚Üë Progresi√≥n, = Mantenimiento, ‚Üì Regresi√≥n) son visualmente distinguibles mediante colores e iconograf√≠a diferenciada, sin depender √∫nicamente del texto para transmitir su significado.

### CA-13.07 ‚Äî Resumen de sesi√≥n incompleta

**Dado que** el ejecutante cierra una sesi√≥n como "Incompleta",
**cuando** el sistema presenta el resumen,
**entonces** muestra el estado "Incompleta", el tonelaje parcial calculado con las series registradas, la clasificaci√≥n de progresi√≥n solo para los ejercicios que tienen registros, y las se√±ales de acci√≥n correspondientes.

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** MVVM de solo lectura con derivaci√≥n de se√±ales en el dominio.

**Justificaci√≥n:** HU-13 es una historia 100% de lectura ‚Äî no escribe datos. Toda la informaci√≥n que necesita E5 ya fue persistida por las HUs predecesoras: HU-09 (cierre de sesi√≥n y tonelaje), HU-10 (clasificaci√≥n de progresi√≥n en `session_exercise.progression_classification`), HU-11 (carga prescrita en `exercise_progression.prescribed_load_kg`), HU-12 (alertas de meseta y descarga en tabla `alert`). El flujo es lineal: queries agregadas en Data ‚Üí enriquecimiento con l√≥gica de se√±ales en Domain ‚Üí presentaci√≥n visual en UI. La pieza arquitect√≥nicamente m√°s relevante es la regla pura `ActionSignalRule` que encapsula la derivaci√≥n de se√±ales de acci√≥n, incluyendo la ruta de "Considerar descarga" definida en HU-12 Decisi√≥n 13.

### Decisiones Fundamentadas

**1. HU-13 es una historia de lectura pura ‚Äî no modifica ning√∫n dato.**

E5 se presenta despu√©s del cierre de sesi√≥n (`closeSession()` de HU-09). En ese punto, todos los datos ya fueron persistidos: `session.status` (HU-09), `session_exercise.progression_classification` (HU-10), `exercise_progression.prescribed_load_kg` (HU-11), alertas en tabla `alert` (HU-12). HU-13 solo los lee, enriquece con la regla `ActionSignalRule` y los presenta visualmente. No inserta, actualiza ni elimina registros.

**2. El tonelaje se calcula en la query, no se almacena.**

El Modelo de Datos ¬ß3.10 establece expl√≠citamente: "El tonelaje total de la sesi√≥n no se almacena ‚Äî se calcula como `SUM(exercise_set.weight_kg * exercise_set.reps)` desde las series asociadas v√≠a `session_exercise`." La query `getSessionSummaryInfo()` computa el tonelaje como agregaci√≥n SQL, evitando una columna derivada en la tabla `session`.

**3. `ActionSignalRule` es una funci√≥n pura en `domain/rules/` siguiendo ADR-06.**

Encapsula siete variantes de se√±al (sealed interface `ActionSignal`) con l√≥gica determinista, m√°s un caso edge para ejercicios sin historial (`FirstSession`). La regla recibe `classification: ProgressionClassification?`, `prescribedLoadKg: Double?`, `avgWeightKg: Double`, `moduleRequiresDeload: Boolean`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `totalReps: Int`, `previousTotalReps: Int?`, `setCount: Int`, `isMastered: Boolean`.

**Variantes para ejercicios est√°ndar (con peso):**
- **`IncreaseLoad(targetKg)`** ‚Äî DU cumplido: `prescribedLoadKg > avgWeightKg`. Texto: "Subir carga ‚Üí X Kg".
- **`ProgressInReps`** ‚Äî DU NO cumplido + clasificaci√≥n `POSITIVE_PROGRESSION`. Texto: "Progresar en reps (misma carga)" (RF27). Distingue progresi√≥n de reps sin haber alcanzado DU.
- **`MaintainLoad`** ‚Äî DU NO cumplido + clasificaci√≥n `MAINTENANCE` o `REGRESSION` aislada (sin alerta de m√≥dulo). Texto: "Mantener carga ‚Äî progresar en reps" (si MAINTENANCE) o "Mantener carga" (si REGRESSION aislada).
- **`ConsiderDeload`** ‚Äî DU NO cumplido + clasificaci√≥n `REGRESSION` **Y** alerta activa `MODULE_REQUIRES_DELOAD` para el m√≥dulo. Texto: "Considerar descarga". **Solo aplica a ejercicios est√°ndar** ‚Äî para bodyweight/isom√©tricos con regresi√≥n, las se√±ales tipo-espec√≠ficas se mantienen y el alerta MODULE_REQUIRES_DELOAD se surfacea v√≠a H1/H2.

**Variantes para ejercicios de peso corporal:**
- **`BodyweightSignal(totalReps, diff)`** ‚Äî Texto: "N reps totales (+diferencia)" / "(=)" / "(‚àídiferencia)" seg√∫n clasificaci√≥n.

**Variantes para ejercicios isom√©tricos:**
- **`IsometricSignal(setCount, avgSeconds, mastered)`** ‚Äî Texto: "{setCount}√ó{avgSeconds}s ‚Äî Progresando/Manteniendo/Regresando". `avgSeconds = totalReps / setCount`.
- **`IsometricMastered`** ‚Äî Texto: "4√ó45s ‚Äî üèÜ Dominado". Cuando `isMastered == true` (CA-08.07: `exercise_progression.status == 'MASTERED'`).

La regla no depende de Android ‚Äî es testeable con JUnit puro (RNF29, RNF30).

**Pseudoc√≥digo de `ActionSignalRule.resolve()`:**

```
Si classification == null ‚Üí FirstSession ("Primera sesi√≥n ‚Äî sin referencia")

Si isIsometric:
  Si isMastered ‚Üí IsometricMastered
  Else ‚Üí IsometricSignal(setCount, avgSeconds = totalReps/setCount, mastered=false)

Si isBodyweight:
  ‚Üí BodyweightSignal(totalReps, diff = totalReps - previousTotalReps)

Si est√°ndar:
  Si prescribedLoadKg > avgWeightKg ‚Üí IncreaseLoad(prescribedLoadKg)
  Si classification == REGRESSION && moduleRequiresDeload ‚Üí ConsiderDeload
  Si classification == POSITIVE_PROGRESSION ‚Üí ProgressInReps
  Si classification == MAINTENANCE ‚Üí MaintainLoad (texto: "Mantener carga ‚Äî progresar en reps")
  Si classification == REGRESSION (aislada) ‚Üí MaintainLoad (texto: "Mantener carga")
```

**4. La derivaci√≥n de "Considerar descarga" consume datos de HU-12 sin recalcular y solo aplica a ejercicios est√°ndar.**

HU-12 Decisi√≥n 13 establece la ruta: E5 muestra "Considerar descarga" cuando `session_exercise.progression_classification == 'REGRESSION'` **Y** `alertDao.existsActiveByModule(moduleCode, "MODULE_REQUIRES_DELOAD")` retorna `true`. HU-13 encapsula esta l√≥gica en `ActionSignalRule.resolve()` que recibe un boolean `moduleRequiresDeload` ya resuelto por la query. **Esta se√±al solo aplica a ejercicios est√°ndar (con peso).** Para ejercicios de peso corporal con regresi√≥n, E5 muestra "N reps totales (‚àídiferencia)"; para isom√©tricos con regresi√≥n, E5 muestra "N√óXs ‚Äî Regresando" ‚Äî en ambos casos, la se√±al tipo-espec√≠fica se mantiene independientemente del estado MODULE_REQUIRES_DELOAD del m√≥dulo. El alerta de m√≥dulo se surfacea al ejecutante v√≠a las pantallas de alertas (H1/H2, HU-17), no v√≠a las se√±ales individuales de bodyweight/isom√©tricos en E5. Si solo hay regresi√≥n aislada sin alerta de m√≥dulo en un ejercicio est√°ndar, E5 muestra "‚Üì Regresi√≥n" con se√±al "Mantener carga", no "Considerar descarga". Fuente de verdad: Especificaci√≥n Visual ¬ßE5 tabla "Se√±ales de acci√≥n por tipo".

**5. Solo se muestran ejercicios con al menos 1 serie registrada.**

CA-13.07 especifica: "clasificaci√≥n de progresi√≥n solo para los ejercicios que tienen registros". La query filtra con `HAVING completedSets > 0`. Los ejercicios sin series no aparecen en la lista ‚Äî no hay datos para calcular progresi√≥n ni se√±ales. El wireframe E5 confirma: "Los ejercicios sin ning√∫n registro no aparecen en la lista".

**6. `ProgressionIndicator` es un composable reutilizable para E5, F2 y F3.**

La combinaci√≥n √≠cono (‚Üë/=/‚Üì) + color sem√°ntico + texto clasificaci√≥n se repite en tres pantallas (E5, F2, F3). Se extrae como componente `ProgressionIndicator` en `ui/components/` que recibe la clasificaci√≥n como par√°metro y renderiza la tr√≠ada visual correcta. Los colores se toman de `LocalTensionSemanticColors.current` (ya definidos en `Color.kt` y expuestos en `Theme.kt`).

**7. La navegaci√≥n E5 ‚Üí F3 (historial de ejercicio) se condiciona a la existencia de la ruta.**

F3 pertenece a HU-16 que a√∫n no est√° implementada. La ruta `exercise-history/{exerciseId}` ya existe en `NavigationRoutes.kt`. El click en cada ejercicio intenta navegar a F3; si la pantalla a√∫n no tiene composable registrado, se mantiene como placeholder. No se bloquea la funcionalidad de E5 por dependencia de F3.

**8. `SessionSummaryViewModel` recibe `sessionId` via `SavedStateHandle`.**

El `sessionId` se pasa como argumento de navegaci√≥n en la ruta `session-summary/{sessionId}`. El ViewModel lo extrae de `SavedStateHandle` (patr√≥n est√°ndar en el proyecto, usado en `ActiveSessionViewModel`). Esto evita pasar el ID manualmente y soporta process death/recreation.

**9. La sesi√≥n con 0 ejercicios registrados se maneja como edge case.**

Si una sesi√≥n se cierra como "Incompleta" sin ninguna serie registrada (caso extremo pero posible), E5 muestra: Card de estado "Incompleta ‚ö†Ô∏è", tonelaje 0 Kg, "0/N ejercicios", y lista vac√≠a. No se muestra mensaje de error ‚Äî es un resumen leg√≠timo de una sesi√≥n vac√≠a.

**10. E5 no tiene Bottom Navigation ni bot√≥n de retorno.**

Wireframe E5 y Especificaci√≥n Visual ¬ßE5 confirman: `CenterAlignedTopAppBar` sin `navigationIcon` (no hay retorno), sin Bottom Navigation. La √∫nica salida es el bot√≥n "Ir al Inicio" que navega a B1 con `popUpTo(HOME) { inclusive = true }`, limpiando el back stack del flujo de sesi√≥n.

**Componentes Afectados:**

**Componentes nuevos:**

| # | Componente | Capa | Responsabilidad |
|---|---|---|---|
| 1 | `ActionSignal` | Domain (model) | Sealed interface con 7 variantes de se√±al de acci√≥n: `IncreaseLoad`, `ProgressInReps`, `MaintainLoad`, `ConsiderDeload`, `BodyweightSignal`, `IsometricSignal`, `IsometricMastered` + caso `FirstSession` para ejercicios sin historial |
| 2 | `ActionSignalRule` | Domain (rules) | Funci√≥n pura `resolve()`: recibe clasificaci√≥n + tipo de ejercicio + carga prescrita + estado de m√≥dulo ‚Üí retorna `ActionSignal`. Discrimina por tipo (bodyweight/isometric/standard) y luego por clasificaci√≥n + condici√≥n DU |
| 3 | `SessionSummary` | Domain (model) | Data class: metadata de sesi√≥n + lista de `ExerciseSummaryItem` |
| 4 | `ExerciseSummaryItem` | Domain (model) | Data class: nombre, clasificaci√≥n, se√±al de acci√≥n, peso/reps, tipo, mastered |
| 5 | `GetSessionSummaryUseCase` | Domain (usecase/session) | Orquesta Repository + `ActionSignalRule` por ejercicio ‚Üí `SessionSummary` |
| 6 | `SessionSummaryViewModel` | UI (session) | Carga datos v√≠a UseCase, expone `StateFlow<SessionSummaryUiState>` |
| 7 | `SessionSummaryUiState` | UI (session) | Sealed interface: `Loading`, `Success(summary)`, `Error(message)` |
| 8 | `SessionSummaryScreen` | UI (session) | Composable E5 completo: Card estado/tonelaje + lista de progresi√≥n + bot√≥n "Ir al Inicio" |
| 9 | `ProgressionIndicator` | UI (components) | Composable reutilizable: √≠cono + color + texto de clasificaci√≥n |

**Componentes modificados:**

| # | Componente | Modificaci√≥n | Nivel |
|---|---|---|---|
| 1 | `SessionRepository` | Agregar `getSessionSummaryData(sessionId): SessionSummaryData` | Menor |
| 2 | `SessionRepositoryImpl` | Implementar `getSessionSummaryData()`: combina queries de sesi√≥n, ejercicios, alerta MODULE_REQUIRES_DELOAD | Mayor |
| 3 | `SessionDao` | Agregar DTO `SessionSummaryInfo` + query `getSessionSummaryInfo(sessionId)`: status, m√≥dulo, versi√≥n, tonelaje, conteos de ejercicios | Menor |
| 4 | `SessionExerciseDao` | Agregar DTO `ExerciseSummaryDto` + query `getExercisesForSummary(sessionId)`: nombre, clasificaci√≥n, flags, carga prescrita, peso/reps actuales y previas | Mayor |
| 5 | `TensionNavHost` | Registrar composable E5 en ruta `session-summary/{sessionId}`, reemplazar TODO con navegaci√≥n real | Menor |

**Hitos de Implementaci√≥n:**

| # | Componente(s) | Descripci√≥n | Dependencias |
|---|---|---|---|
| 1 | Domain models + `ActionSignalRule` | `ActionSignal` (sealed interface: 5 variantes), `ExerciseSummaryItem`, `SessionSummary`, `ActionSignalRule` (object con funci√≥n `resolve()`) | Ninguna ‚Äî funciones puras sin dependencias externas |
| 2 | DAOs: DTOs y queries | `SessionSummaryInfo` DTO + `getSessionSummaryInfo()` en `SessionDao`, `ExerciseSummaryDto` + `getExercisesForSummary()` en `SessionExerciseDao` | Ninguna ‚Äî queries sobre tablas existentes |
| 3 | Repository + UseCase | Interfaz `SessionRepository.getSessionSummaryData()`, implementaci√≥n en `SessionRepositoryImpl`, `GetSessionSummaryUseCase` que aplica `ActionSignalRule` por ejercicio | Hitos 1 y 2 |
| 4 | ViewModel + UiState | `SessionSummaryUiState` (sealed), `SessionSummaryViewModel` con `SavedStateHandle` + `viewModelScope.launch` | Hito 3 |
| 5 | UI: Screen + componentes | `ProgressionIndicator` (reutilizable), `SessionSummaryScreen` (E5 completo con colores sem√°nticos) | Hito 4 |
| 6 | Navegaci√≥n | Actualizar `TensionNavHost`: registrar composable E5, reemplazar TODO con `navController.navigate(sessionSummaryRoute(sessionId))`, agregar click ‚Üí F3 | Hito 5 |

### Validaci√≥n de Impacto

**C√≥digo real verificado (paso 1.5):**

- `SessionRepositoryImpl.kt`: Ya inyecta `AlertDao` (HU-12). No necesita inyecci√≥n adicional. Constructor actual (l√≠nea 41-50) tiene todos los DAOs necesarios: `sessionDao`, `sessionExerciseDao`, `exerciseProgressionDao`, `alertDao`.
- `SessionDao.kt`: Tiene `getActiveSessionWithModuleVersion()` con DTO `ActiveSessionInfo` que incluye `moduleCode`, `versionNumber`, `totalExercises`, `completedExercises`. Se necesita una query similar pero para sesiones cerradas (por `sessionId` en vez de `status = 'IN_PROGRESS'`), con tonelaje agregado.
- `SessionExerciseDao.kt`: Tiene `getBySessionIdWithDetails()` que devuelve `SessionExerciseWithDetails` con `prescribedLoadKg`, `isBodyweight`, `isIsometric` ‚Äî pero NO incluye `progression_classification` ni reps previas. Se necesita una query nueva orientada al resumen.
- `ExerciseSetDao.kt`: Tiene `getLastHistoricalSets()` para obtener sets de la sesi√≥n anterior. Esta query se usar√° como subquery en la nueva query del resumen para obtener `previousTotalReps`.
- `AlertDao.kt`: Tiene `existsActiveByModule(moduleCode, type)` ‚Äî exactamente lo que necesita la derivaci√≥n de "Considerar descarga". No requiere modificaci√≥n.
- `NavigationRoutes.kt`: `SESSION_SUMMARY = "session-summary/{sessionId}"` ya definida (l√≠nea 20). `sessionSummaryRoute(sessionId)` helper ya existe (l√≠nea 28).
- `TensionNavHost.kt`: L√≠nea 264-267 tiene el TODO con navegaci√≥n temporal a HOME. Se reemplaza por la navegaci√≥n real y el composable.
- `ActiveSessionViewModel.kt`: `navigateToSessionSummary` emite `sessionId` al cerrar sesi√≥n exitosamente (l√≠nea 104). El event ya fluye correctamente.
- `Color.kt`: Todos los colores sem√°nticos necesarios ya definidos: `ProgressionPositiveLight/Dark`, `MaintenanceLight/Dark`, `RegressionLight/Dark`, `SessionCompletedLight/Dark`, `SessionIncompleteLight/Dark`.
- `Theme.kt`: `TensionSemanticColors` expone `progressionPositive`, `maintenance`, `regression`, `sessionCompleted`, `sessionIncomplete` via `LocalTensionSemanticColors`.
- `ProgressionClassification.kt`: Enum con `POSITIVE_PROGRESSION`, `MAINTENANCE`, `REGRESSION` ‚Äî ya implementado.

**An√°lisis de dependencias:**

- HU-13 depende de: HU-09 (sesi√≥n cerrada con status), HU-10 (clasificaci√≥n en `session_exercise.progression_classification`), HU-11 (carga prescrita en `exercise_progression.prescribed_load_kg`), HU-12 (alerta `MODULE_REQUIRES_DELOAD` en tabla `alert`).
- HU-13 alimenta: HU-16 (F3 ‚Äî click en ejercicio desde E5 navega a historial), HU-17 (patr√≥n de `ProgressionIndicator` reutilizable).
- HU-13 no modifica la base de datos ‚Äî solo lee datos ya persistidos por HUs 09-12.

**Impacto en performance:**

- `getSessionSummaryInfo()`: 1 SELECT con 2 subqueries de agregaci√≥n sobre m√°ximo 11 session_exercises y 44 exercise_sets. Despreciable.
- `getExercisesForSummary()`: JOIN triple con 2 subqueries anidadas por fila. M√°ximo 11 filas √ó 2 subqueries = 22 operaciones m√≠nimas sobre tablas indexadas. Despreciable para SQLite.
- `existsActiveByModule()`: Ya indexado por `is_active` (HU-12). Operaci√≥n O(1).
- Total: 3 queries en secuencia, todo fuera del hilo principal (coroutines). No bloquea UI.

**Cadena de invocaci√≥n:**

```
ActiveSessionViewModel.onCloseSessionConfirmed()
  ‚Üí closeSessionUseCase(sessionId)        [ya implementado]
  ‚Üí _navigateToSessionSummary.emit(id)    [ya implementado]
  ‚Üí TensionNavHost: navController.navigate(sessionSummaryRoute(id))  [HU-13: implementar]
  ‚Üí SessionSummaryScreen(sessionId)                                  [HU-13: nuevo]
    ‚Üí SessionSummaryViewModel.init { loadSummary(sessionId) }        [HU-13: nuevo]
      ‚Üí getSessionSummaryUseCase(sessionId)                          [HU-13: nuevo]
        ‚Üí sessionRepository.getSessionSummaryData(sessionId)         [HU-13: nuevo]
          ‚Üí sessionDao.getSessionSummaryInfo(sessionId)              [HU-13: nuevo query]
          ‚Üí sessionExerciseDao.getExercisesForSummary(sessionId)     [HU-13: nuevo query]
          ‚Üí alertDao.existsActiveByModule(moduleCode, "MODULE_...")   [ya existe, HU-12]
        ‚Üí ActionSignalRule.resolve(dto, moduleRequiresDeload)         [HU-13: nuevo]
```

### Notas T√©cnicas

**Nota 1 ‚Äî La query de `previousTotalReps` reutiliza el patr√≥n de `getLastHistoricalSets()`.**

`ExerciseSetDao.getLastHistoricalSets()` (HU-10) usa la misma subquery para encontrar la sesi√≥n anterior de un ejercicio: `SELECT se2.id FROM session_exercise se2 INNER JOIN session s2 ... WHERE se2.exercise_id = ? AND s2.id != ? AND s2.status IN ('COMPLETED', 'INCOMPLETE') ORDER BY s2.date DESC, s2.id DESC LIMIT 1`. La query del resumen reutiliza este patr√≥n como subquery anidada para obtener `SUM(reps)` de la sesi√≥n anterior, evitando una llamada separada por ejercicio.

**Nota 2 ‚Äî `SessionSummaryData` es un modelo intermedio entre Data y Domain.**

El Repository retorna `SessionSummaryData` con DTOs crudos (strings para clasificaci√≥n, nullable para prescribed_load). El `GetSessionSummaryUseCase` lo transforma a `SessionSummary` con domain models (enum para clasificaci√≥n, sealed `ActionSignal`). Esta separaci√≥n permite que el Repository permanezca agn√≥stico a la l√≥gica de se√±ales y que la regla sea testeable independientemente.

**Nota 3 ‚Äî El √≠cono `‚Üë`/`=`/`‚Üì` no es un emoji ‚Äî es un car√°cter Unicode literal.**

La Especificaci√≥n Visual ¬ßE5 define los √≠conos como caracteres de texto 24dp con color sem√°ntico, no como `Icon()` de Material. Se implementan como `Text("‚Üë", fontSize = 24.sp, color = semanticColors.progressionPositive)` dentro de un `Box(modifier = Modifier.size(24.dp))` como `leadingContent` del `ListItem`.

**Nota 4 ‚Äî El formato de tonelaje usa separador de miles (ej: "12,450 Kg").**

La Especificaci√≥n Visual ¬ßE5 muestra "12,450 Kg" con separador de miles. Se formatea con `NumberFormat.getIntegerInstance(Locale("es", "ES"))`. El tonelaje es `Double` (puede tener decimales si `weight_kg` tiene decimales), pero se muestra como entero redondeado para legibilidad.

**Nota 5 ‚Äî Se√±ales de acci√≥n para ejercicios sin historial previo (`classification == null`).**

`session_exercise.progression_classification` es `NULL` cuando el ejercicio no tiene historial previo (primera sesi√≥n del ejercicio). CA-10.07 establece: "Sin Historial ‚Üí no se emite clasificaci√≥n". Para estos ejercicios, E5 muestra: sin √≠cono de clasificaci√≥n, sin color sem√°ntico, se√±al de acci√≥n "Primera sesi√≥n ‚Äî sin referencia". Esto cubre el edge case del primer uso del sistema.

**Nota 6 ‚Äî Diferencia entre `avgWeightKg` y `prescribedLoadKg` para derivar "Subir carga".**

La se√±al "Subir carga ‚Üí X Kg" se muestra cuando `prescribedLoadKg > avgWeightKg` (la carga prescrita por el Doble Umbral es superior a la carga actual). Si `prescribedLoadKg == avgWeightKg` o `prescribedLoadKg` es `null`, la se√±al es "Mantener carga". La comparaci√≥n se hace con tolerancia de 0.01 Kg (misma `WEIGHT_TOLERANCE` de `ProgressionClassificationRule`).

**Nota 7 ‚Äî Se√±ales para peso corporal e isom√©tricos no incluyen carga prescrita.**

Para ejercicios de peso corporal (`isBodyweight = true`), `exercise_progression.prescribed_load_kg` es `NULL` (nunca se prescribe carga ‚Äî Regla 6 del MDS). La se√±al muestra "N reps totales (+diferencia)" donde `diferencia = totalReps - previousTotalReps`. Para isom√©tricos (`isIsometric = true`), la se√±al muestra "{setCount}√ó{avgSeconds}s" (ej: "4√ó42s ‚Äî Progresando") donde `avgSeconds = totalReps / setCount` (porque `exercise_set.reps` almacena segundos para isom√©tricos ‚Äî Modelo de Datos ¬ß3.12). Cuando `exercise_progression.status == 'MASTERED'` (CA-08.07 de HU-08, implementado en HU-10), E5 muestra el badge "üèÜ Dominado" como un `AssistChip` M3 con `containerColor: Tertiary Container (#E0EEDD)` junto al nombre del ejercicio (Especificaci√≥n Visual ¬ßE5). La se√±al "Considerar descarga" NO se aplica a bodyweight ni isom√©tricos ‚Äî estos tipos mantienen sus se√±ales espec√≠ficas incluso cuando MODULE_REQUIRES_DELOAD est√° activo para el m√≥dulo (ver Decisi√≥n 4).

### Verificaci√≥n Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-13.01 | üî® Por implementar | `ActiveSessionViewModel.navigateToSessionSummary` ‚Üí `TensionNavHost` ‚Üí `SessionSummaryScreen` | HU-13 (Navegaci√≥n + Screen) |
| CA-13.02 | üî® Por implementar | `SessionDao.getSessionSummaryInfo()` ‚Üí `SUM(weight_kg * reps)` ‚Üí `SessionSummary.totalTonnageKg` | HU-13 (DAO + Screen) |
| CA-13.03 | üî® Por implementar | `SessionDao.getSessionSummaryInfo()` ‚Üí `completedExercises` / `totalExercises` | HU-13 (DAO + Screen) |
| CA-13.04 | üî® Por implementar | `SessionExerciseDao.getExercisesForSummary()` ‚Üí `progression_classification` ‚Üí `ProgressionIndicator` | HU-13 (DAO + Screen) |
| CA-13.05 | üî® Por implementar | `ActionSignalRule.resolve()` ‚Üí sealed `ActionSignal` ‚Üí texto de se√±al en `SessionSummaryScreen` | HU-13 (Rule + Screen) |
| CA-13.06 | üî® Por implementar | `ProgressionIndicator`: ‚Üë verde (#2E7D32/#81C784), = √°mbar (#8D6E00/#FFD54F), ‚Üì rojo (#C62828/#EF9A9A) + √≠cono + texto | HU-13 (Screen + Component) |
| CA-13.07 | üî® Por implementar | Query con `HAVING completedSets > 0`, Card estado "Incompleta ‚ö†Ô∏è", tonelaje parcial | HU-13 (DAO + Screen) |

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Manifiesto de Dominio Sist√©mico ¬ß6-A ‚Äî Reglas R1 (Doble Umbral), R6 (Peso Corporal), R7 (Isom√©tricos)
- Modelo de Datos ¬ß3.10 (session ‚Äî tonelaje calculado), ¬ß3.11 (session_exercise ‚Äî progression_classification), ¬ß3.12 (exercise_set), ¬ß3.13 (exercise_progression ‚Äî prescribed_load_kg, status), ¬ß3.16 (alert ‚Äî MODULE_REQUIRES_DELOAD)
- ADR-06 ‚Äî Motor de reglas Kotlin puro en `domain/rules/`
- Arquitectura T√©cnica ¬ß5.2 ‚Äî Naming `{Nombre}Rule`, `{Feature}Screen`, `{Feature}ViewModel`, `{Feature}UiState`
- Wireframes E5 ‚Äî Estructura visual, elementos, estados, se√±ales por tipo de ejercicio
- Especificaci√≥n Visual ¬ßE5 ‚Äî Componentes M3, colores sem√°nticos, tipograf√≠a, dimensiones
- Mapa de Navegaci√≥n ¬ß4 ‚Äî E4 ‚Üí E5, E5 ‚Üí B1, E5 ‚Üí F3
- Requerimientos ‚Äî RF59, RNF05

**Historias relacionadas:**

- HU-09: Establece `closeSession()` y evento de navegaci√≥n `navigateToSessionSummary` ‚Äî trigger directo de E5
- HU-10: Produce `session_exercise.progression_classification` y `exercise_progression.status/sessionsWithoutProgression` ‚Äî datos base que E5 lee
- HU-11: Produce `exercise_progression.prescribed_load_kg` ‚Äî dato usado por `ActionSignalRule` para derivar "Subir carga"
- HU-12: Produce alertas `PLATEAU` y `MODULE_REQUIRES_DELOAD` en tabla `alert` ‚Äî dato consumido por `ActionSignalRule` para derivar "Considerar descarga" (Decisi√≥n 13)
- HU-16: Destino de navegaci√≥n F3 al hacer click en un ejercicio desde E5 ‚Äî a√∫n no implementada
- HU-17: Consumir√° `ProgressionIndicator` como componente reutilizable en H1/H2

**Validado por:** esteban.colorado | **Fecha:** 2026-02-16 | **Enfoque:** Exploratorio
