# HU-09 ‚Äî Cerrar sesi√≥n y avanzar rotaci√≥n

## Requisitos relacionados

RF18, RF19, RF20, RF21, RNF10

## Descripci√≥n

Como ejecutante, quiero poder cerrar mi sesi√≥n de entrenamiento como Completada o Incompleta, que el sistema calcule autom√°ticamente el tonelaje y avance la rotaci√≥n c√≠clica, para que mis datos queden consolidados, la posici√≥n del plan se actualice correctamente y yo pueda continuar con confianza en la pr√≥xima sesi√≥n.

## Criterios de Aceptaci√≥n

### CA-09.01 ‚Äî Cierre como Completada

**Dado que** el ejecutante tiene una sesi√≥n activa y todas las series de todos los ejercicios de la sesi√≥n han sido registradas (todos los ejercicios en estado "Completado" con 4 series cada uno),
**cuando** selecciona la opci√≥n de cerrar sesi√≥n,
**entonces** el sistema cierra la sesi√≥n con estado "Completada" y la marca como inmutable.

### CA-09.02 ‚Äî Cierre como Incompleta

**Dado que** el ejecutante tiene una sesi√≥n activa pero no ha completado todas las series de todos los ejercicios,
**cuando** selecciona la opci√≥n de cerrar sesi√≥n anticipadamente,
**entonces** el sistema cierra la sesi√≥n con estado "Incompleta", conservando todos los datos parciales registrados hasta ese momento sin descartar ninguna serie.

### CA-09.03 ‚Äî Confirmaci√≥n antes de cierre incompleto

**Dado que** el ejecutante tiene una sesi√≥n activa con ejercicios sin completar,
**cuando** intenta cerrar la sesi√≥n,
**entonces** el sistema solicita confirmaci√≥n indicando que la sesi√≥n se cerrar√° como "Incompleta" y mostrando cu√°ntos ejercicios quedaron sin completar, antes de ejecutar el cierre.

### CA-09.04 ‚Äî C√°lculo autom√°tico de tonelaje al cerrar

**Dado que** el ejecutante cierra una sesi√≥n (ya sea Completada o Incompleta),
**cuando** el sistema procesa el cierre,
**entonces** calcula autom√°ticamente el tonelaje total de la sesi√≥n sumando el producto de Peso √ó Repeticiones de todas las series registradas en la sesi√≥n, y almacena el resultado como dato derivado de la sesi√≥n.

### CA-09.05 ‚Äî Avance de la rotaci√≥n c√≠clica al cerrar

**Dado que** el ejecutante cierra una sesi√≥n (ya sea Completada o Incompleta),
**cuando** el sistema procesa el cierre,
**entonces** avanza la posici√≥n en la rotaci√≥n c√≠clica de m√≥dulos al siguiente m√≥dulo (A‚ÜíB, B‚ÜíC, C‚ÜíA) y registra la versi√≥n ejecutada para actualizar la secuencia de versiones del m√≥dulo.

### CA-09.06 ‚Äî Avance de rotaci√≥n solo al cerrar

**Dado que** el ejecutante tiene una sesi√≥n activa en progreso,
**cuando** a√∫n no ha cerrado la sesi√≥n,
**entonces** la posici√≥n en la rotaci√≥n c√≠clica y la secuencia de versiones no se modifican; el avance ocurre √∫nicamente en el momento del cierre.

### CA-09.07 ‚Äî Inmutabilidad de sesiones cerradas

**Dado que** una sesi√≥n ha sido cerrada (Completada o Incompleta),
**cuando** el ejecutante consulta esa sesi√≥n en el historial,
**entonces** los datos de la sesi√≥n son de solo lectura; no se permite editar, eliminar ni agregar series retroactivamente a sesiones cerradas.

### CA-09.08 ‚Äî Preservaci√≥n ante cierre inesperado durante el cierre

**Dado que** la aplicaci√≥n se cierra inesperadamente mientras el sistema procesa el cierre de una sesi√≥n (c√°lculo de tonelaje, avance de rotaci√≥n),
**cuando** el ejecutante reabre la aplicaci√≥n,
**entonces** el sistema detecta el estado inconsistente y permite al ejecutante completar el cierre de la sesi√≥n o recuperar la sesi√≥n activa sin p√©rdida de datos registrados.

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**1. E4 es un AlertDialog, no una ruta de navegaci√≥n.**

ADR D-04 y Arquitectura T√©cnica ¬ß4.3 fila 12 establecen que E4 es un di√°logo modal superpuesto sobre E1, gestionado por estado del ViewModel (`showCloseDialog: Boolean`). No entra al back stack. El `AlertDialog` M3 se muestra/oculta por estado reactivo, no por navegaci√≥n.

**2. El tonelaje NO se almacena en base de datos.**

CA-09.04 dice "almacena el resultado como dato derivado". Sin embargo, el Modelo de Datos ¬ß2 (Convenciones) establece: *"Datos calculados: No se almacenan en base de datos"*. Y ¬ß3.10 (`session`) confirma: *"El tonelaje total de la sesi√≥n no se almacena ‚Äî se calcula como `SUM(exercise_set.weight_kg * exercise_set.reps)`"*. El Modelo de Datos es autoritativo para la capa de datos. El tonelaje se calcula on-demand cuando E5 (HU-13), F1 (HU-24) o G1 (HU-20) lo necesiten. **En HU-09 no se calcula ni se almacena** ‚Äî solo se cierra la sesi√≥n y se avanza la rotaci√≥n.

**3. La operaci√≥n de cierre es una transacci√≥n at√≥mica con 2 operaciones.**

`database.withTransaction` que: (a) actualiza `session.status` a COMPLETED o INCOMPLETE, y (b) avanza `rotation_state`. Si cualquier operaci√≥n falla, todo se revierte, garantizando consistencia (CA-09.08). La sesi√≥n permanece `IN_PROGRESS` y el usuario puede reintentar.

**4. Determinaci√≥n del status: COMPLETED vs INCOMPLETE.**

Una sesi√≥n es COMPLETED si y solo si **todos** sus ejercicios tienen exactamente 4 series registradas (`completedExercises == totalExercises`). En cualquier otro caso es INCOMPLETE. Esta l√≥gica ya existe de forma reactiva en `ActiveSessionUiState` (`completedCount`, `totalCount`) para la UI. En el cierre, se reutiliza la query `getActiveSessionWithModuleVersion()` via `.first()` dentro de la transacci√≥n para obtener los conteos sincr√≥nicamente.

**5. Avance de rotaci√≥n: posici√≥n + versiones.**

El avance sigue la l√≥gica documentada en Modelo de Datos ¬ß3.14:
- Si `microcyclePosition < 6`: `microcyclePosition += 1`. Solo se avanza la posici√≥n.
- Si `microcyclePosition == 6`: `microcyclePosition = 1`, `microcycleCount += 1`, y todas las versiones avanzan: `(currentVersion % 3) + 1` (wrap-around V1‚ÜíV2‚ÜíV3‚ÜíV1).

F√≥rmula de wrap-around para versiones: `(v % 3) + 1` ‚Äî produce: 1‚Üí2, 2‚Üí3, 3‚Üí1. Aplica a los 3 m√≥dulos simult√°neamente puesto que todos tienen exactamente 3 versiones (Modelo de Datos ¬ß3.6, CHECK constraint `version_number >= 1 AND version_number <= 3`).

**6. HU-17 futuro: descarga congela versiones.**

Cuando HU-17 se implemente, el avance de rotaci√≥n durante descarga deber√° saltar el avance de versiones (CA-17.04: versiones se congelan). La posici√≥n s√≠ avanza. El c√≥digo de HU-09 se dise√±a para que este behavior sea extensible: la l√≥gica de avance es una funci√≥n pura testeable (`advanceRotation`) en el `RotationResolver`, que en HU-17 recibir√° un par√°metro `isDeload: Boolean` adicional.

**7. Navegaci√≥n post-cierre: a Home (E5 diferido a HU-13).**

E5 (Resumen Post-Sesi√≥n) es responsabilidad de HU-13 y a√∫n no existe. Por consistencia con el patr√≥n de stubs establecido (HU-05, HU-06, HU-07), tras confirmar el cierre exitoso se navega a Home (B1) con `popUpTo(HOME) { inclusive = true }`. La ruta `session-summary/{sessionId}` se registrar√° en `NavigationRoutes` como preparaci√≥n para HU-13 (costo marginal cero). Cuando HU-13 se implemente, la navegaci√≥n post-cierre se redireccionar√° a E5.

**8. BackHandler muestra el di√°logo de cierre.**

HU-05 document√≥: *"En HU-09 se reemplaza con di√°logo de confirmaci√≥n"*. El `BackHandler { /* no-op */ }` actual se reemplaza con `BackHandler { viewModel.onCloseSessionRequested() }`. El comportamiento del back press pasa de "no hacer nada" a "mostrar el di√°logo de confirmaci√≥n de cierre (E4)".

**9. CA-09.06 y CA-09.07 son garant√≠as estructurales, no funcionalidades.**

CA-09.06 (rotaci√≥n solo avanza al cerrar) se garantiza porque la √∫nica invocaci√≥n de `advanceRotation` est√° dentro de `closeSession`. No existe otra ruta en el c√≥digo que modifique `rotation_state`.

CA-09.07 (inmutabilidad post-cierre) se garantiza porque: (a) no existe funcionalidad de edici√≥n/eliminaci√≥n de sesiones cerradas (ADR D-03), (b) `registerSet` valida que la sesi√≥n est√© `IN_PROGRESS` (impl√≠citamente ‚Äî la UI solo muestra E1 para sesiones activas), (c) no hay endpoint de API que modifique sesiones pasadas.

**10. CA-09.08 (crash recovery) ya est√° implementado.**

B1 (Home) ya detecta sesiones `IN_PROGRESS` y muestra la card "Reanudar Sesi√≥n" (implementada en HU-05). Si la app crasha durante el cierre, la transacci√≥n se revierte (nada se commitea parcialmente), la sesi√≥n permanece `IN_PROGRESS`, y al reabrir la app B1 muestra la card de reanudaci√≥n. El ejecutante puede reintentar el cierre desde E1. No se requiere l√≥gica adicional.

### Componentes Nuevos

**1. `CloseSessionUseCase`** ‚Äî `domain/usecase/session/CloseSessionUseCase.kt`

```kotlin
class CloseSessionUseCase @Inject constructor(
    private val sessionRepository: SessionRepository,
) {
    suspend operator fun invoke(sessionId: Long) {
        sessionRepository.closeSession(sessionId)
    }
}
```

Delega al repositorio. La determinaci√≥n de COMPLETED/INCOMPLETE se hace en el repositorio dentro de la transacci√≥n para garantizar consistencia (la query de conteo y el update deben ser at√≥micos).

**2. `RotationResolver.advanceRotation()`** ‚Äî extensi√≥n del object existente

```kotlin
fun advanceRotation(current: RotationState): RotationState {
    return if (current.microcyclePosition < 6) {
        current.copy(microcyclePosition = current.microcyclePosition + 1)
    } else {
        current.copy(
            microcyclePosition = 1,
            currentVersionModuleA = (current.currentVersionModuleA % 3) + 1,
            currentVersionModuleB = (current.currentVersionModuleB % 3) + 1,
            currentVersionModuleC = (current.currentVersionModuleC % 3) + 1,
            microcycleCount = current.microcycleCount + 1,
        )
    }
}
```

Funci√≥n pura, testeable unitariamente. Opera sobre el modelo de dominio `RotationState`, no sobre la entity.

### Componentes Modificados

**3. `SessionRepository`** ‚Äî agregar m√©todo

```kotlin
suspend fun closeSession(sessionId: Long)
```

**4. `SessionRepositoryImpl.closeSession()`** ‚Äî implementaci√≥n transaccional

```kotlin
override suspend fun closeSession(sessionId: Long) {
    database.withTransaction {
        val sessionInfo = sessionDao.getActiveSessionWithModuleVersion().first()
            ?: throw IllegalStateException("No active session found")
        if (sessionInfo.sessionId != sessionId) {
            throw IllegalStateException("Session $sessionId is not the active session")
        }

        val status = if (sessionInfo.completedExercises == sessionInfo.totalExercises) {
            "COMPLETED"
        } else {
            "INCOMPLETE"
        }
        sessionDao.updateStatus(sessionId, status)

        val rotationEntity = rotationStateDao.getRotationState().first()
            ?: throw IllegalStateException("Rotation state not found")
        val currentRotation = RotationState(
            microcyclePosition = rotationEntity.microcyclePosition,
            currentVersionModuleA = rotationEntity.currentVersionModuleA,
            currentVersionModuleB = rotationEntity.currentVersionModuleB,
            currentVersionModuleC = rotationEntity.currentVersionModuleC,
            microcycleCount = rotationEntity.microcycleCount,
        )
        val newRotation = RotationResolver.advanceRotation(currentRotation)
        rotationStateDao.update(
            rotationEntity.copy(
                microcyclePosition = newRotation.microcyclePosition,
                currentVersionModuleA = newRotation.currentVersionModuleA,
                currentVersionModuleB = newRotation.currentVersionModuleB,
                currentVersionModuleC = newRotation.currentVersionModuleC,
                microcycleCount = newRotation.microcycleCount,
            ),
        )
    }
}
```

**5. `SessionDao`** ‚Äî agregar query

```kotlin
@Query("UPDATE session SET status = :status WHERE id = :sessionId")
suspend fun updateStatus(sessionId: Long, status: String)
```

**6. `ActiveSessionViewModel`** ‚Äî agregar l√≥gica de di√°logo y cierre

Campos nuevos en `_uiState`:
- `showCloseDialog: Boolean = false` ‚Äî controla visibilidad de E4
- `isClosing: Boolean = false` ‚Äî loading state durante cierre

Funciones nuevas:
- `onCloseSessionRequested()` ‚Äî muestra di√°logo (`showCloseDialog = true`)
- `onCloseDialogDismissed()` ‚Äî oculta di√°logo (`showCloseDialog = false`)
- `onCloseSessionConfirmed()` ‚Äî invoca `CloseSessionUseCase`, emite navegaci√≥n a E5 (temporalmente Home)

```kotlin
fun onCloseSessionRequested() {
    _uiState.update { it.copy(showCloseDialog = true) }
}

fun onCloseDialogDismissed() {
    _uiState.update { it.copy(showCloseDialog = false) }
}

fun onCloseSessionConfirmed() {
    viewModelScope.launch {
        _uiState.update { it.copy(isClosing = true, showCloseDialog = false) }
        try {
            closeSessionUseCase(sessionId)
            _navigateToSessionSummary.emit(sessionId)
        } catch (_: Exception) {
            _uiState.update { it.copy(isClosing = false) }
        }
    }
}
```

**Nuevo SharedFlow:** `_navigateToSessionSummary: MutableSharedFlow<Long>` + `navigateToSessionSummary: SharedFlow<Long>` ‚Äî one-shot navigation event que emite el `sessionId`. La Screen observa este flujo y llama `onNavigateToSessionSummary(sessionId)`. Esto reutiliza el callback existente (stub de HU-05) en vez de crear un mecanismo paralelo, facilitando la transici√≥n cuando HU-13 implemente E5.

**7. `ActiveSessionUiState`** ‚Äî agregar campos

```kotlin
data class ActiveSessionUiState(
    val isLoading: Boolean = true,
    val moduleCode: String = "",
    val versionNumber: Int = 0,
    val exercises: List<ExerciseUiItem> = emptyList(),
    val showCloseDialog: Boolean = false,
    val isClosing: Boolean = false,
) {
    // existentes
    val completedCount: Int get() = exercises.count { ... }
    val totalCount: Int get() = exercises.size
    val progress: Float get() = ...
    // nuevo
    val incompleteCount: Int get() = totalCount - completedCount
    val isAllCompleted: Boolean get() = completedCount == totalCount && totalCount > 0
}
```

**8. `ActiveSessionScreen`** ‚Äî wiring del bot√≥n, BackHandler, y AlertDialog

Cambios:
1. **`BackHandler`**: `BackHandler { viewModel.onCloseSessionRequested() }` (reemplaza no-op).
2. **Bot√≥n "Cerrar Sesi√≥n"**: `onClick = { viewModel.onCloseSessionRequested() }` (reemplaza TODO).
3. **AlertDialog E4**: Composable condicional basado en `uiState.showCloseDialog`.
4. **Navigation event**: `LaunchedEffect` que observa `navigateToSessionSummary` y llama `onNavigateToSessionSummary(sessionId)`.

AlertDialog tiene 2 variantes (Especificaci√≥n Visual ¬ß8 E4):
- **Caso A (completa)**: t√≠tulo "Cerrar sesi√≥n", texto "Todos los ejercicios est√°n completados. La sesi√≥n se cerrar√° como Completada.", bot√≥n "Cerrar ‚úì" (Primary).
- **Caso B (parcial)**: t√≠tulo "Cerrar sesi√≥n", √≠cono ‚ö†Ô∏è (Error), texto "Hay N ejercicios sin completar. La sesi√≥n se cerrar√° como Incompleta. Los datos parciales se conservar√°n.", bot√≥n "Cerrar ‚ö†Ô∏è" (Error).

```kotlin
@Composable
private fun CloseSessionDialog(
    isAllCompleted: Boolean,
    incompleteCount: Int,
    isClosing: Boolean,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit,
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        icon = if (!isAllCompleted) {
            { Icon(Icons.Default.Warning, contentDescription = null, tint = MaterialTheme.colorScheme.error) }
        } else null,
        title = { Text(stringResource(R.string.session_close_title)) },
        text = {
            Text(
                if (isAllCompleted)
                    stringResource(R.string.session_close_complete_message)
                else
                    stringResource(R.string.session_close_incomplete_message, incompleteCount)
            )
        },
        confirmButton = {
            Button(
                onClick = onConfirm,
                enabled = !isClosing,
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (isAllCompleted)
                        MaterialTheme.colorScheme.primary
                    else
                        MaterialTheme.colorScheme.error,
                ),
            ) {
                if (isClosing) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(18.dp),
                        strokeWidth = 2.dp,
                        color = MaterialTheme.colorScheme.onPrimary,
                    )
                } else {
                    Text(
                        if (isAllCompleted)
                            stringResource(R.string.session_close_confirm_complete)
                        else
                            stringResource(R.string.session_close_confirm_incomplete)
                    )
                }
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss, enabled = !isClosing) {
                Text(stringResource(R.string.session_close_cancel))
            }
        },
    )
}
```

**9. `NavigationRoutes`** ‚Äî agregar ruta E5 (preparaci√≥n para HU-13)

```kotlin
const val SESSION_SUMMARY = "session-summary/{sessionId}"
fun sessionSummaryRoute(sessionId: Long) = "session-summary/$sessionId"
```

**10. `TensionNavHost`** ‚Äî wiring de `onNavigateToSessionSummary`

Temporalmente navegar√° a Home (E5 no existe a√∫n):
```kotlin
onNavigateToSessionSummary = { sessionId ->
    // TODO: HU-13 ‚Äî navigate to session-summary/$sessionId
    navController.navigate(NavigationRoutes.HOME) {
        popUpTo(NavigationRoutes.HOME) { inclusive = true }
    }
},
```

**11. `strings.xml`** ‚Äî agregar strings de E4

```xml
<!-- Close Session Dialog E4 -->
<string name="session_close_title">Cerrar sesi√≥n</string>
<string name="session_close_complete_message">Todos los ejercicios est√°n completados. La sesi√≥n se cerrar√° como Completada.</string>
<string name="session_close_incomplete_message">Hay %1$d ejercicios sin completar. La sesi√≥n se cerrar√° como Incompleta. Los datos parciales se conservar√°n.</string>
<string name="session_close_confirm_complete">Cerrar ‚úì</string>
<string name="session_close_confirm_incomplete">Cerrar ‚ö†Ô∏è</string>
<string name="session_close_cancel">Cancelar</string>
```

### Verificaci√≥n Exhaustiva CA por CA

**CA-09.01 ‚Äî Cierre como Completada:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Repository | `if (completedExercises == totalExercises) "COMPLETED"` | Transacci√≥n at√≥mica en `closeSession()` |
| DAO | `SessionDao.updateStatus(sessionId, "COMPLETED")` | UPDATE query |
| ViewModel | `onCloseSessionConfirmed()` ‚Üí UseCase ‚Üí Repository | Delegaci√≥n limpia |
| UI (E4) | Caso A: texto confirmatorio + bot√≥n "Cerrar ‚úì" (Primary) | AlertDialog variante A |

**CA-09.02 ‚Äî Cierre como Incompleta:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Repository | `else "INCOMPLETE"` | Cualquier estado parcial ‚Üí INCOMPLETE |
| Data | Series existentes no se eliminan | `updateStatus` solo cambia status, no toca exercise_set |
| ViewModel | Misma funci√≥n `onCloseSessionConfirmed()` | Sin distinci√≥n ‚Äî el repositorio decide |

**CA-09.03 ‚Äî Confirmaci√≥n antes de cierre incompleto:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| UI (E4) | Caso B: √≠cono ‚ö†Ô∏è Error + texto con N ejercicios + bot√≥n "Cerrar ‚ö†Ô∏è" (Error) | AlertDialog variante B |
| UiState | `incompleteCount: Int` calculado en `ActiveSessionUiState` | `totalCount - completedCount` |
| Wireframes | "Hay N ejercicios sin completar" vs "Todos ... completados" | Mapeado 1:1 |

**Nota:** El di√°logo se muestra en AMBOS casos (completo e incompleto), no solo cuando incompleto. Wireframes E4 documenta ambas variantes. La diferencia es visual: Caso A es confirmatorio (Primary), Caso B es de advertencia (Error).

**CA-09.04 ‚Äî C√°lculo autom√°tico de tonelaje:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Datos | Tonelaje = `SUM(weight_kg * reps)` ‚Äî derivado, NO almacenado | Modelo de Datos ¬ß2 y ¬ß3.10 |
| HU-09 | No calcula tonelaje directamente | El tonelaje se calcula cuando E5 (HU-13) lo consume |
| Query | `SELECT COALESCE(SUM(es.weight_kg * es.reps), 0.0) FROM exercise_set es INNER JOIN session_exercise se ON es.session_exercise_id = se.id WHERE se.session_id = :sessionId` | Ser√° implementada en HU-13 |

**Justificaci√≥n:** CA-09.04 dice "calcula ... y almacena". El Modelo de Datos contradice el "almacena" expl√≠citamente. La resoluci√≥n es que el CA usa "almacena" en sentido de "el dato queda disponible" (las series est√°n persistidas, el tonelaje se puede derivar en cualquier momento). No se agrega columna `tonnage` a `session`. La query de c√°lculo es responsabilidad de quien muestre el dato (E5/HU-13, F1/HU-24, G1/HU-20).

**CA-09.05 ‚Äî Avance de rotaci√≥n al cerrar:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Domain | `RotationResolver.advanceRotation()` ‚Äî funci√≥n pura | `(microcyclePosition % 3) + 1` para versiones, +1 para posici√≥n |
| Repository | `rotationStateDao.update(newState)` dentro de transacci√≥n | At√≥mico con update de status |
| L√≥gica pos. < 6 | Solo incrementa posici√≥n | `copy(microcyclePosition = pos + 1)` |
| L√≥gica pos. == 6 | Reset a 1 + advance versions + increment count | `copy(pos=1, vA=(vA%3)+1, vB=(vB%3)+1, vC=(vC%3)+1, count+1)` |

**CA-09.06 ‚Äî Avance solo al cerrar:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Estructural | `advanceRotation()` solo se invoca desde `closeSession()` | No existe otro call site |
| Garant√≠a | No hay cron, timer, ni trigger que modifique `rotation_state` | C√≥digo inmutable post-cierre |

**CA-09.07 ‚Äî Inmutabilidad de sesiones cerradas:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Estructural | No existe endpoint de edici√≥n/eliminaci√≥n post-cierre | ADR D-03 |
| UI | `registerSet` solo funciona durante sesi√≥n activa (E1 se muestra solo para IN_PROGRESS) | La navegaci√≥n a E1 requiere sessionId activo |
| Data | `exercise_set.insert()` valida dentro de sesi√≥n activa | `getNextSetNumber` devuelve > 4 si ya est√° completo |

**CA-09.08 ‚Äî Preservaci√≥n ante cierre inesperado:**

| Capa | Implementaci√≥n | Evidencia |
|------|----------------|-----------|
| Transaction | `database.withTransaction` ‚Äî si el crash ocurre mid-transaction, nada se commitea | Room rollback autom√°tico |
| Recovery | B1 detecta `IN_PROGRESS` ‚Üí muestra ResumeSessionCard | Implementado en HU-05 |
| Garant√≠a | La sesi√≥n queda como estaba antes del intento de cierre | El usuario retoma desde E1 |

### Validaci√≥n de Impacto

**Archivos modificados (estimaci√≥n):**

| Archivo | Acci√≥n | Secci√≥n |
|---|---|---|
| `SessionRepository.kt` | Agregar `closeSession(sessionId: Long)` | Interface |
| `SessionRepositoryImpl.kt` | Implementar `closeSession()` con transacci√≥n | Repository |
| `SessionDao.kt` | Agregar `updateStatus()` | DAO |
| `RotationResolver.kt` | Agregar `advanceRotation()` | Domain model |
| `ActiveSessionViewModel.kt` | Agregar di√°logo state + cierre + navegaci√≥n | ViewModel |
| `ActiveSessionUiState.kt` | Agregar `showCloseDialog`, `isClosing`, derivados | UiState |
| `ActiveSessionScreen.kt` | Wiring bot√≥n + BackHandler + AlertDialog E4 | UI |
| `NavigationRoutes.kt` | Agregar `SESSION_SUMMARY` | Navigation |
| `TensionNavHost.kt` | Wiring `onNavigateToSessionSummary` temporal a Home | Navigation |
| `strings.xml` | 6 strings de E4 | Resources |

**Archivos nuevos:**

| Archivo | Prop√≥sito |
|---|---|
| `CloseSessionUseCase.kt` | Use Case de cierre de sesi√≥n |

**Archivos no tocados (verificaci√≥n):**

| Archivo | Raz√≥n |
|---|---|
| `ExerciseSetDao.kt` | No se agrega query de tonelaje ‚Äî diferido a HU-13 |
| `ExerciseProgressionDao.kt` | No se modifica ‚Äî HU-10 lo usar√° |
| `RepositoryModule.kt` | SessionRepository ya est√° bound ‚Äî no cambia |
| `HomeScreen.kt` | Crash recovery ya funciona ‚Äî no cambia |

### Notas T√©cnicas

1. **Patr√≥n `.first()` dentro de transacci√≥n.** El codebase ya usa `sessionDao.getActiveSession().first()` dentro de `database.withTransaction` en `startSession()`. Mantenemos el mismo patr√≥n para `getActiveSessionWithModuleVersion().first()` y `getRotationState().first()` en `closeSession()`. No se requieren queries suspend adicionales en los DAOs.

2. **El ViewModel usa `onNavigateToSessionSummary` desde el principio.** El SharedFlow `_navigateToSessionSummary` emite el `sessionId`, la Screen observa y llama `onNavigateToSessionSummary(sessionId)`, y TensionNavHost redirige temporalmente a Home. Cuando HU-13 implemente E5, solo cambia la lambda en TensionNavHost ‚Äî ni el ViewModel ni la Screen necesitan modificaciones.

3. **La ruta `SESSION_SUMMARY` se agrega proactivamente** en `NavigationRoutes.kt`. Costo marginal cero ‚Äî una constante y una funci√≥n. Prepara HU-13 para que solo necesite crear el composable y registrar la ruta en NavHost.

4. **Progresi√≥n (HU-10/HU-11/HU-12) no se invoca en HU-09.** El cierre de sesi√≥n no eval√∫a progresi√≥n ni prescribe carga. Eso se implementar√° en HU-10/HU-11/HU-12 como extensiones del flujo de cierre. El punto de extensi√≥n ser√° dentro de la transacci√≥n de `closeSession()`, despu√©s de actualizar el status y antes de avanzar la rotaci√≥n ‚Äî cuando esos HUs se implementen deben insertarse ah√≠.

5. **Deload awareness (HU-17) no implementada a√∫n.** `advanceRotation()` siempre avanza las versiones cuando `position == 6`. Cuando HU-17 se implemente, `advanceRotation` recibir√° `isDeload: Boolean` y, si true, saltar√° el avance de versiones (las congela). Por ahora, el comportamiento normal es correcto.

### Historias Relacionadas

**Predecesoras (datos que HU-09 consume):**

- HU-05: Proporcion√≥ `RotationStateDao.update()`, stubs de `BackHandler`, bot√≥n "Cerrar Sesi√≥n", `onNavigateToSessionSummary`, y la card de crash recovery en B1.
- HU-06: Proporcion√≥ `exercise_set` data que determina el conteo de sets por ejercicio ‚Üí status COMPLETED/INCOMPLETE.
- HU-07: Sustituciones funcionan transparentemente ‚Äî `session_exercise.exercise_id` apunta al ejercicio real ejecutado sin l√≥gica condicional.

**Sucesoras (dependen de HU-09):**

- HU-10: Motor de progresi√≥n ‚Äî se ejecutar√° al cierre de sesi√≥n. Clasificar√° cada ejercicio como POSITIVE_PROGRESSION/MAINTENANCE/REGRESSION. Se integrar√° dentro de la transacci√≥n de `closeSession()`.
- HU-11: Doble Umbral ‚Äî prescribir√° carga objetivo. Tambi√©n se integra en el cierre.
- HU-12: Detecci√≥n de regresi√≥n/fatiga ‚Äî tambi√©n post-cierre.
- HU-13: E5 (Resumen Post-Sesi√≥n) ‚Äî navegaci√≥n post-cierre. Consumir√° `sessionId` para mostrar tonelaje, clasificaci√≥n de progresi√≥n, se√±ales de acci√≥n. La ruta `session-summary/{sessionId}` se prepara en HU-09.
- HU-17: Protocolo de descarga ‚Äî modificar√° `advanceRotation` para congelar versiones durante deload.
- HU-18: Usar√° `microcycleCount` incrementado por HU-09 en B1.

**Consumidoras indirectas (usan datos derivados del cierre):**

- HU-20: M√©tricas globales ‚Äî tonelaje por sesi√≥n.
- HU-21: Adherencia ‚Äî cuenta sesiones COMPLETED + INCOMPLETE.
- HU-24: Historial de sesiones ‚Äî muestra tonelaje derivado.
- HU-25: Evoluci√≥n de tonelaje por grupo muscular.

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Modelo de Datos ¬ß3.10 (`session`): status IN_PROGRESS ‚Üí COMPLETED/INCOMPLETE. Tonelaje no almacenado.
- Modelo de Datos ¬ß3.14 (`rotation_state`): l√≥gica de avance pos < 6 ‚Üí +1; pos = 6 ‚Üí reset + increment + advance versions.
- Wireframes E4: 2 variantes de di√°logo (completa / parcial). Elementos: t√≠tulo, mensaje, bot√≥n cancelar, bot√≥n cerrar.
- Especificaci√≥n Visual ¬ß8 E4: Caso A (Primary) vs Caso B (Error). AlertDialog M3, corner 28 dp, scrim 32%.
- Mapa de Navegaci√≥n: E4 ‚Üí HU-09 | E5 ‚Üí HU-13. E4 no tiene ruta de navegaci√≥n.
- Arquitectura T√©cnica ¬ß4.3 fila 12: E4 es dialog, no ruta. Fila 13: E5 = `session-summary/{sessionId}`.
- ADR D-03: Sesiones cerradas inmutables. D-04: E4 es dialog gestionado por ViewModel.
- MDS ¬ß4 Restricci√≥n 8 + ¬ß5: "Sesi√≥n completada" ‚Üí calcular m√©tricas, actualizar rotaci√≥n.
- Requerimientos: RF18 (cerrar completada), RF19 (cerrar incompleta), RF20 (tonelaje), RF21 (avance rotaci√≥n), RNF10 (crash recovery).
- HU-05 an√°lisis: stubs de BackHandler, bot√≥n cerrar, onNavigateToSessionSummary, RotationStateDao.update().

### Verificaci√≥n Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-09.01 | üî® Por implementar | `closeSession()` ‚Üí `updateStatus("COMPLETED")` si todos completos | HU-09 (transacci√≥n) |
| CA-09.02 | üî® Por implementar | `closeSession()` ‚Üí `updateStatus("INCOMPLETE")` si parcial | HU-09 (transacci√≥n) |
| CA-09.03 | üî® Por implementar | AlertDialog E4 con 2 variantes (completa/parcial) + conteo | HU-09 (UI) |
| CA-09.04 | ‚è≥ Parcial | Tonelaje = dato derivado, no almacenado. Query ser√° en HU-13 | HU-09 persiste datos; HU-13 calcula |
| CA-09.05 | üî® Por implementar | `RotationResolver.advanceRotation()` + `rotationStateDao.update()` | HU-09 (transacci√≥n) |
| CA-09.06 | ‚úÖ Estructural | `advanceRotation` solo se invoca desde `closeSession` | Garant√≠a por dise√±o |
| CA-09.07 | ‚úÖ Estructural | No existe endpoint de edici√≥n post-cierre (ADR D-03) | Garant√≠a por dise√±o |
| CA-09.08 | ‚úÖ Ya implementado | `withTransaction` rollback + B1 crash recovery card | HU-05 (B1 recovery) + Room (transaction) |

### Hitos de implementaci√≥n

| # | Entregable | Archivos | CAs |
|---|---|---|---|
| 1 | `RotationResolver.advanceRotation()` ‚Äî funci√≥n pura + test unitario | `RotationResolver.kt`, `RotationResolverTest.kt` | CA-09.05 |
| 2 | `SessionDao.updateStatus()` ‚Äî query de update de status | `SessionDao.kt` | CA-09.01, CA-09.02 |
| 3 | `CloseSessionUseCase` + `SessionRepository.closeSession()` + implementaci√≥n transaccional | `CloseSessionUseCase.kt`, `SessionRepository.kt`, `SessionRepositoryImpl.kt` | CA-09.01, CA-09.02, CA-09.05, CA-09.08 |
| 4 | `ActiveSessionUiState` + `ActiveSessionViewModel` ‚Äî di√°logo state + cierre + navegaci√≥n | `ActiveSessionUiState.kt`, `ActiveSessionViewModel.kt` | CA-09.01, CA-09.02, CA-09.03 |
| 5 | `ActiveSessionScreen` ‚Äî BackHandler + bot√≥n + AlertDialog E4 | `ActiveSessionScreen.kt`, `strings.xml` | CA-09.03 |
| 6 | `NavigationRoutes` + `TensionNavHost` ‚Äî ruta E5 stub + wiring navegaci√≥n post-cierre | `NavigationRoutes.kt`, `TensionNavHost.kt` | ‚Äî (preparaci√≥n HU-13) |
