# HU-03 — Consultar y gestionar Diccionario de Ejercicios con media visual

## Requisitos relacionados

RF04, RF07, RF61, RF62, RNF24

## Descripción

Como ejecutante, quiero consultar el Diccionario de Ejercicios con filtros por módulo, tipo de equipo y zona muscular, ver una imagen de la ejecución correcta de cada ejercicio, y poder crear nuevos ejercicios que se integren al catálogo, para conocer los movimientos disponibles en mi plan, verificar la técnica adecuada, personalizar mi repertorio y tomar decisiones informadas sobre sustituciones.

## Criterios de Aceptación

### CA-03.01 — Diccionario precargado y completo

**Dado que** el ejecutante abre la aplicación,
**cuando** accede al Diccionario de Ejercicios,
**entonces** el sistema muestra los 43 ejercicios precargados (y los ejercicios creados por el ejecutante, si los hubiera), cada uno clasificado por su módulo (A, B o C), tipo de equipo y zona muscular, sin requerir carga de datos externa ni conexión a internet.

### CA-03.02 — Información visible por ejercicio

**Dado que** el ejecutante consulta el Diccionario de Ejercicios,
**cuando** visualiza un ejercicio en el listado,
**entonces** el sistema muestra para cada ejercicio como mínimo: nombre del ejercicio, módulo al que pertenece (A, B o C), tipo de equipo (Máquina, Mancuerna, Barra de Pesas, Cuerpo, Polea, Pesa, Mancuernas, Mancuerna o Pesa Rusa, Máquina Multiestación) y zona muscular objetivo.

### CA-03.03 — Filtro por módulo

**Dado que** el ejecutante está consultando el Diccionario de Ejercicios,
**cuando** aplica un filtro por módulo (A, B o C),
**entonces** el sistema muestra únicamente los ejercicios que pertenecen al módulo seleccionado, excluyendo los demás.

### CA-03.04 — Filtro por tipo de equipo

**Dado que** el ejecutante está consultando el Diccionario de Ejercicios,
**cuando** aplica un filtro por tipo de equipo,
**entonces** el sistema muestra únicamente los ejercicios que utilizan el tipo de equipo seleccionado.

### CA-03.05 — Filtro por zona muscular

**Dado que** el ejecutante está consultando el Diccionario de Ejercicios,
**cuando** aplica un filtro por zona muscular,
**entonces** el sistema muestra únicamente los ejercicios que trabajan la zona muscular seleccionada.

### CA-03.06 — Combinación de filtros

**Dado que** el ejecutante está consultando el Diccionario de Ejercicios,
**cuando** aplica múltiples filtros simultáneamente (módulo, tipo de equipo y/o zona muscular),
**entonces** el sistema muestra únicamente los ejercicios que cumplen todos los filtros aplicados simultáneamente.

### CA-03.07 — Media visual por ejercicio en el Diccionario

**Dado que** el ejecutante consulta el detalle de un ejercicio en el Diccionario,
**cuando** visualiza el ejercicio,
**entonces** el sistema muestra una imagen estática (PNG 3D minimalista con fondo blanco) que ilustra la ejecución correcta del movimiento, permitiendo al ejecutante verificar la técnica adecuada. En futuras iteraciones, la imagen podrá ser reemplazada por video o animación (GIF u otro formato) sin cambios en la arquitectura.

### CA-03.08 — Media visual accesible durante sesión activa

**Dado que** el ejecutante está registrando series de un ejercicio durante una sesión activa,
**cuando** consulta la media visual del ejercicio en ejecución,
**entonces** el sistema muestra la imagen de ejecución correcta del ejercicio sin interrumpir ni cerrar la sesión activa.

### CA-03.09 — Assets multimedia optimizados

**Dado que** la aplicación incluye assets multimedia (imágenes PNG) para los 43 ejercicios precargados del Diccionario,
**cuando** se genera el APK de la aplicación,
**entonces** los assets deben estar optimizados para dispositivos móviles y el tamaño total del APK no debe exceder los 150 MB.

### CA-03.10 — Crear nuevo ejercicio

**Dado que** el ejecutante quiere agregar un ejercicio que no existe en el Diccionario,
**cuando** accede a la función de crear ejercicio desde el Diccionario (D1) tocando el FAB,
**entonces** el sistema navega a la pantalla de creación de ejercicio (D5) que presenta un formulario con: imagen del ejercicio (opcional, seleccionable desde la galería del dispositivo), nombre del ejercicio (obligatorio), módulo al que pertenece (A, B o C, obligatorio), tipo de equipo (seleccionable de los 9 tipos existentes, obligatorio), zona(s) muscular(es) objetivo (seleccionable de las 15 zonas existentes, al menos una obligatoria), condiciones especiales (peso corporal, isométrico, al fallo técnico — checkboxes opcionales). Si el ejecutante selecciona una imagen, esta se persiste en el almacenamiento interno de la app (`filesDir/exercise_images/`) y se almacena la ruta absoluta en `media_resource`. Si no selecciona imagen, `media_resource = NULL`. Al confirmar, el ejercicio se persiste con `is_custom = 1`, queda disponible en el Diccionario, en las sustituciones de sesión (HU-07) y para asignación a versiones del plan (HU-04). Se valida que la combinación (nombre, tipo de equipo) no exista previamente.

### CA-03.11 — Placeholder visual e imagen editable para ejercicios

**Dado que** el ejecutante visualiza un ejercicio que no tiene imagen asociada (ya sea un ejercicio custom recién creado o cualquier ejercicio sin `media_resource`),
**cuando** visualiza el detalle del ejercicio (D2),
**entonces** el sistema muestra el logo de la aplicación como placeholder junto con un ícono de cámara y texto "Toca para agregar imagen", indicando que puede agregar una imagen. Al tocar la zona de imagen, se abre el selector de galería del dispositivo. La imagen seleccionada se persiste en almacenamiento interno y se actualiza el campo `media_resource` del ejercicio. Esta funcionalidad de cambio de imagen está disponible para TODOS los ejercicios del diccionario (precargados y custom).

---

## Análisis Arquitectónico

> HU-03 es la tercera historia en implementarse. Introduce el catálogo de datos estáticos del dominio (módulos, zonas musculares, tipos de equipo, ejercicios y su relación N:M con zonas) y el sistema de seed data con `RoomDatabase.Callback.onCreate()`. Construye las vistas D1 (Diccionario) y D2 (Detalle de Ejercicio) con el sistema de tabs compartido con D3, que queda como stub para HU-04. Esta es la historia con mayor volumen de entidades nuevas (5 tablas + 1 join table) y seed data (43 + 15 + 9 + 3 + 9 + 93 + 48 = 220 filas).

### Patrón arquitectónico

MVVM con capa Domain explícita (4 capas: UI → ViewModel → Domain → Data), según ADR-05. Mismo patrón establecido en HU-01/HU-02.

### Componentes afectados

#### 1. Data Layer — Entities del catálogo (Nuevo)

Mapeo 1:1 de las tablas del Modelo de Datos §3.1 a §3.5. Paquete: `data.local.entity`.

- **`ModuleEntity`**: Tabla `module`. PK natural `code: TEXT` ("A", "B", "C"). Columnas: `name` (TEXT, NOT NULL), `group_description` (TEXT, NOT NULL), `load_increment_kg` (REAL, NOT NULL). `CHECK(code IN ('A', 'B', 'C'))`. Solo 3 filas, inmutables.
- **`MuscleZoneEntity`**: Tabla `muscle_zone`. PK autoincrement. Columnas: `name` (TEXT, NOT NULL, UNIQUE), `muscle_group` (TEXT, NOT NULL). Índice en `muscle_group`. 15 filas inmutables.
- **`EquipmentTypeEntity`**: Tabla `equipment_type`. PK autoincrement. Columnas: `name` (TEXT, NOT NULL, UNIQUE). 9 filas inmutables.
- **`ExerciseEntity`**: Tabla `exercise`. PK autoincrement. Columnas: `name` (TEXT, NOT NULL), `module_code` (TEXT, FK → `module(code)`, ON DELETE RESTRICT), `equipment_type_id` (INTEGER, FK → `equipment_type(id)`, ON DELETE RESTRICT), `is_bodyweight` (INTEGER, NOT NULL, DEFAULT 0), `is_isometric` (INTEGER, NOT NULL, DEFAULT 0), `is_to_technical_failure` (INTEGER, NOT NULL, DEFAULT 0), `is_custom` (INTEGER, NOT NULL, DEFAULT 0), `media_resource` (TEXT, NULL). UNIQUE(`name`, `equipment_type_id`). Índices en `module_code` y `equipment_type_id`. 43 filas seed + filas dinámicas creadas por el ejecutante (RF62).
- **`ExerciseMuscleZoneEntity`**: Tabla `exercise_muscle_zone`. PK compuesta (`exercise_id`, `muscle_zone_id`). FKs a `exercise(id)` y `muscle_zone(id)`, ambas ON DELETE RESTRICT. 48 filas (38 ejercicios × 1 zona + 5 ejercicios × 2 zonas).

#### 2. Data Layer — Entities auxiliares del plan (Nuevo)

Aunque HU-04 implementará las vistas D3/D4, las entidades `module_version` y `plan_assignment` se crean en HU-03 porque: (a) el seed data debe ir completo en una única transacción atómica (ADR-11), y (b) `module_version` es referenciada por `session` y `rotation_state` en historias posteriores (HU-05+). Paquete: `data.local.entity`.

- **`ModuleVersionEntity`**: Tabla `module_version`. PK autoincrement. Columnas: `module_code` (TEXT, FK → `module(code)`), `version_number` (INTEGER, NOT NULL). UNIQUE(`module_code`, `version_number`). `CHECK(version_number >= 1 AND version_number <= 3)`. 9 filas.
- **`PlanAssignmentEntity`**: Tabla `plan_assignment`. PK compuesta (`module_version_id`, `exercise_id`). FKs a `module_version(id)` y `exercise(id)`. Columnas: `sets` (INTEGER, NOT NULL), `reps` (TEXT, NOT NULL). `CHECK(sets > 0)`, `CHECK(reps IN ('8-12', 'TO_TECHNICAL_FAILURE', '30-45_SEC'))`. 93 filas.

#### 3. Data Layer — DAOs del catálogo (Nuevo)

Paquete: `data.local.dao`.

- **`ExerciseDao`**: Queries para el Diccionario D1, el Detalle D2 y la creación de ejercicios D5.
  - `getAll(): Flow<List<ExerciseWithDetails>>` — query con JOIN a `equipment_type`, `module` y a `exercise_muscle_zone`+`muscle_zone` para obtener nombre de equipo, nombre de módulo y lista de zonas musculares en una sola consulta. Devuelve la lista completa para filtrado en memoria (43 ejercicios es un dataset trivial).
  - `getById(exerciseId: Long): Flow<ExerciseWithDetails?>` — mismo JOIN pero filtrado por ID. Usado por D2.
  - `insert(exercise: ExerciseEntity): Long` — inserta un ejercicio custom y retorna el ID generado.
  - `insertMuscleZone(zone: ExerciseMuscleZoneEntity)` — inserta una relación ejercicio-zona muscular.
  - `insertAllMuscleZones(zones: List<ExerciseMuscleZoneEntity>)` — inserta múltiples relaciones ejercicio-zona muscular en lote.
  - `insertExerciseWithMuscleZones(exercise: ExerciseEntity, muscleZones: List<ExerciseMuscleZoneEntity>): Long` — método `@Transaction` que inserta el ejercicio y sus zonas musculares de forma atómica, retorna el ID generado.
  - `updateMediaResource(exerciseId: Long, mediaResource: String?)` — actualiza la imagen de un ejercicio.
  - `countByNameAndEquipment(name: String, equipmentTypeId: Long): Int` — verifica unicidad nombre+equipo.
- **`ModuleDao`**: `getAll(): Flow<List<ModuleEntity>>` — los 3 módulos. Usado para poblar opciones del dropdown de filtro por módulo en D1.
- **`EquipmentTypeDao`**: `getAll(): Flow<List<EquipmentTypeEntity>>` — los 9 tipos de equipo. Usado para opciones del dropdown de filtro por equipo.
- **`MuscleZoneDao`**: `getAll(): Flow<List<MuscleZoneEntity>>` — las 15 zonas musculares. Usado para opciones del dropdown de filtro por zona.
- **`ModuleVersionDao`**: `getAll(): Flow<List<ModuleVersionEntity>>` — las 9 versiones. Provisorio para HU-04.
- **`PlanAssignmentDao`**: `getByModuleVersionId(id: Long): Flow<List<PlanAssignmentWithExercise>>` — ejercicios asignados a una versión. Provisorio para HU-04.

**Nota sobre `ExerciseWithDetails`:** Data class intermedia (no `@Entity`) usada como resultado de query manual con JOIN. Contiene: `id: Long`, `name: String`, `moduleCode: String`, `moduleName: String`, `equipmentTypeName: String`, `isBodyweight: Int`, `isIsometric: Int`, `isToTechnicalFailure: Int`, `isCustom: Int`, `mediaResource: String?`, `muscleZones: String?` (resultado de `GROUP_CONCAT`, nullable cuando el ejercicio no tiene zonas asignadas). El repository transforma `muscleZones` a `List<String>` mediante `split(", ")` y filtra blancos.

#### 4. Data Layer — Seed Data (Nuevo)

Paquete: `data.local.seed`. Según ADR-11, se usa `RoomDatabase.Callback.onCreate()` con patrón Facade.

- **`PrepopulateCallback`**: Implementa `RoomDatabase.Callback`. En `onCreate()` ejecuta `PrepopulateFacade.populate(db)` dentro de una transacción.
- **`PrepopulateFacade`**: Orquesta la inserción secuencial delegando en 3 seeders temáticos, alineados con ADR-11: (1) `ModuleSeeder`, (2) `ExerciseSeeder`, (3) `PlanSeeder`. El orden respeta las dependencias FK. **No incluye `RotationSeeder`** — el estado de rotación se inicializa en `ProfileRepositoryImpl.createProfile()` (HU-01), no en el seed de catálogo, porque es estado de usuario que solo existe cuando hay perfil (Modelo de Datos §3.14: *"Se crea junto con el perfil"*).
- **`ModuleSeeder`**: Inserta datos de las 3 tablas de catálogo base en orden: (a) 3 filas en `module` (Modelo de Datos §3.1), (b) 15 filas en `muscle_zone` (§3.2), (c) 9 filas en `equipment_type` (§3.3). Agrupa las entidades de referencia sin dependencias cruzadas.
- **`ExerciseSeeder`**: Inserta datos de ejercicios y su relación N:M: (a) 43 filas en `exercise` — cada ejercicio incluye `media_resource` con el nombre normalizado del ejercicio + tipo de equipo (RF61, ver convención de naming en §16 Assets Multimedia), los valores de `is_bodyweight`, `is_isometric`, `is_to_technical_failure` se toman del seed data §3.4; (b) 48 filas en `exercise_muscle_zone` — los 5 ejercicios multi-zona del Módulo C (Sentadilla de Sumo, Sentadilla Búlgara Dividida, Subir Escalones, Zancada hacia atrás, Avanzada de Zancadas) generan 2 filas cada uno.
- **`PlanSeeder`**: Inserta datos del plan de entrenamiento: (a) 9 filas en `module_version` (Modelo de Datos §3.6), (b) 93 filas en `plan_assignment` (Plan de Entrenamiento completo). Mapea `reps` según tipo de ejercicio: `"8-12"` para estándar, `"TO_TECHNICAL_FAILURE"` para Flexiones, `"30-45_SEC"` para Plancha/Plancha Lateral.

#### 5. Data Layer — Database (Modificación)

- **`TensionDatabase`**: Agregar las 7 nuevas entidades al array `entities = [...]`. Versión incrementa a 2 (se mantiene `fallbackToDestructiveMigration()` durante desarrollo). Exponer los 6 nuevos DAOs: `exerciseDao()`, `moduleDao()`, `equipmentTypeDao()`, `muscleZoneDao()`, `moduleVersionDao()`, `planAssignmentDao()`. Registrar `PrepopulateCallback` en el builder con `.addCallback(PrepopulateCallback(...))`.

#### 6. Data Layer — Repository (Nuevo)

Paquete: `data.repository`.

- **`ExerciseRepositoryImpl`**: Implementa `ExerciseRepository`. Inyecta `ExerciseDao`, `ModuleDao`, `EquipmentTypeDao`, `MuscleZoneDao`. Métodos:
  - `getAllExercises(): Flow<List<Exercise>>` — mapea `ExerciseWithDetails` a modelo de dominio `Exercise`.
  - `getExerciseById(id: Long): Flow<Exercise?>` — para D2.
  - `getAllModules(): Flow<List<Module>>` — para opciones del dropdown de filtro por módulo.
  - `getAllEquipmentTypes(): Flow<List<EquipmentType>>` — para opciones del dropdown de filtro por equipo.
  - `getAllMuscleZones(): Flow<List<MuscleZone>>` — para opciones del dropdown de filtro por zona.
  - `createExercise(name, moduleCode, equipmentTypeId, muscleZoneIds, isBodyweight, isIsometric, isToTechnicalFailure, mediaResource): Long` — crea un ejercicio custom (`is_custom = 1`) con sus zonas musculares usando `ExerciseDao.insertExerciseWithMuscleZones()` (`@Transaction` atómico).
  - `updateExerciseImage(exerciseId, mediaResource)` — actualiza la imagen de cualquier ejercicio.
  - `exerciseExistsByNameAndEquipment(name, equipmentTypeId): Boolean` — validación de unicidad.

#### 6b. Data Layer — ImageStorageHelper (Nuevo)

Paquete: `data.local.storage`.

- **`ImageStorageHelper`**: `@Singleton`. Inyecta `@ApplicationContext context: Context`. Centraliza la gestión de imágenes de ejercicios en almacenamiento interno. Usado por `CreateExerciseViewModel` y `ExerciseDetailViewModel`. Métodos:
  - `saveImageToInternal(uri: Uri): String?` — copia la imagen del URI (galería) al directorio `filesDir/exercise_images/exercise_{UUID}.jpg`. Usa `use {}` para cerrar streams correctamente. Retorna la ruta absoluta del archivo o `null` en caso de error.
  - `deleteImageIfInternal(mediaResource: String?)` — elimina el archivo de imagen anterior si existe y está dentro del directorio `exercise_images/`. Operación best-effort (ignora errores silenciosamente). Previene acumulación de archivos huérfanos cuando el usuario cambia la imagen de un ejercicio.

#### 7. Domain Layer — Models del catálogo (Nuevo)

Paquete: `domain.model`. Kotlin puro, sin dependencias de Room.

- **`Module`**: Data class — `code: String`, `name: String`, `groupDescription: String`, `loadIncrementKg: Double`.
- **`MuscleZone`**: Data class — `id: Long`, `name: String`, `muscleGroup: String`.
- **`EquipmentType`**: Data class — `id: Long`, `name: String`.
- **`Exercise`**: Data class — `id: Long`, `name: String`, `moduleCode: String`, `moduleName: String`, `equipmentTypeName: String`, `muscleZones: List<String>`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isToTechnicalFailure: Boolean`, `isCustom: Boolean`, `mediaResource: String?`. El campo `isCustom` indica si el ejercicio fue creado por el ejecutante (RF62). El campo `mediaResource` es nullable: para ejercicios seed contiene el nombre normalizado para resolver el asset, para ejercicios custom puede contener la ruta absoluta de una imagen seleccionada desde la galería (CA-03.11), o `null` si no se seleccionó imagen.

#### 8. Domain Layer — Repository Interface (Nuevo)

Paquete: `domain.repository`.

- **`ExerciseRepository`**: Interfaz Kotlin puro. Contratos:
  - `fun getAllExercises(): Flow<List<Exercise>>`
  - `fun getExerciseById(id: Long): Flow<Exercise?>`
  - `fun getAllModules(): Flow<List<Module>>`
  - `fun getAllEquipmentTypes(): Flow<List<EquipmentType>>`
  - `fun getAllMuscleZones(): Flow<List<MuscleZone>>`
  - `suspend fun createExercise(name: String, moduleCode: String, equipmentTypeId: Long, muscleZoneIds: List<Long>, isBodyweight: Boolean, isIsometric: Boolean, isToTechnicalFailure: Boolean, mediaResource: String?): Long`
  - `suspend fun updateExerciseImage(exerciseId: Long, mediaResource: String?)`
  - `suspend fun exerciseExistsByNameAndEquipment(name: String, equipmentTypeId: Long): Boolean`

#### 9. Domain Layer — Use Cases (Nuevo)

Paquete: `domain.usecase.catalog`.

- **`GetExercisesUseCase`**: Invoca `ExerciseRepository.getAllExercises()`. Retorna `Flow<List<Exercise>>`. Lectura pura, sin validación.
- **`GetExerciseDetailUseCase`**: Invoca `ExerciseRepository.getExerciseById(id)`. Retorna `Flow<Exercise?>`. Lectura pura.
- **`GetFilterOptionsUseCase`**: Invoca `ExerciseRepository.getAllModules()`, `.getAllEquipmentTypes()`, `.getAllMuscleZones()` en paralelo usando `combine()`. Retorna `Flow<FilterOptions>` con las 3 listas para los dropdowns de filtro. Esto centraliza la obtención de opciones de filtro en un solo Use Case.
- **`CreateExerciseUseCase`**: Invoca `ExerciseRepository.createExercise()` con validación previa: nombre no vacío, al menos una zona muscular, unicidad (nombre, equipmentTypeId) vía `exerciseExistsByNameAndEquipment()`. Retorna `Long` (ID del ejercicio creado). Lanza `IllegalArgumentException` si la validación falla.
- **`UpdateExerciseImageUseCase`**: Invoca `ExerciseRepository.updateExerciseImage(exerciseId, mediaResource)`. Permite actualizar la imagen de cualquier ejercicio (seed o custom).

#### 10. UI Layer — D1 Diccionario de Ejercicios (Nuevo)

Paquete: `ui.catalog`.

- **`ExerciseDictionaryScreen`**: Composable de nivel pantalla. Estructura según Wireframes D1 y Especificación Visual §8 D1:
  - **Top Bar**: `CenterAlignedTopAppBar` sin retorno. Título "Diccionario". `TabRow` M3 (Primary Tabs) debajo con 2 tabs: "Ejercicios" (activo) y "Plan" (navega a D3). Tab activo: texto Primary (`#8B1A1A`), indicador inferior Primary (3 dp). Tab inactivo: texto On Surface Variant.
  - **Filtros**: 3 `ExposedDropdownMenuBox` M3 compactos en una única fila horizontal (`Row`). Dropdown 1: Módulo (label "Módulo", opciones: "Todos", "A", "B", "C"). Dropdown 2: Equipo (label "Equipo", opciones: "Todos" + 9 tipos). Dropdown 3: Zona muscular (label "Zona", opciones: "Todos" + zonas únicas). Cada dropdown: `OutlinedTextField` read-only con label flotante, trailing icon flecha desplegable, texto valor 13 sp, singleLine, borde Outline Variant. Cada uno con `weight(1f)`, spacing 8 dp entre dropdowns. Padding horizontal 16 dp, vertical 8 dp.
  - **Contador**: `Text` Body Small, On Surface Variant. "Mostrando N de T ejercicios" (T = total en diccionario, incluye precargados + creados). Padding top 12 dp, bottom 8 dp.
  - **Lista**: `LazyColumn` con `ListItem` M3 de 72 dp por ejercicio. `headlineContent`: Title Medium, On Surface (nombre). `supportingContent`: Body Medium, On Surface Variant ("Módulo A · Máquina · Pecho Medio", separados por " · "). Para ejercicios con `isCustom = true`, mostrar badge "Personalizado" (Label Small, On Tertiary Container, fondo Tertiary Container, corner 4 dp). Divider 1 dp Outline Variant entre filas. Clickable → navega a D2 con `exerciseId`.
  - **FAB crear ejercicio** (CA-03.10): `FloatingActionButton` M3, ícono Add (24 dp), containerColor Primary Container, contentColor On Primary Container, posición bottom-end margin 16 dp. Alineado con Wireframes D1 #8 y Especificación Visual §8 D1. Al tocar → navega a D5 (Crear Ejercicio).
  - **Estado sin resultados**: Column centrada. Body Large, On Surface Variant. "No hay ejercicios que coincidan con los filtros seleccionados." Padding vertical 48 dp.
  - **Bottom Navigation**: Visible, Diccionario activo.
  - **Filtrado en memoria** — Los 43 ejercicios son un dataset trivial. El ViewModel filtra localmente en la lista completa, sin queries adicionales a Room. CA-03.03 a CA-03.06 se cumplen filtrando por `moduleCode`, `equipmentTypeName` y `muscleZones` (si alguna zona del ejercicio coincide con el filtro seleccionado).

**Firma:**

```kotlin
@Composable
fun ExerciseDictionaryScreen(
    onNavigateToExerciseDetail: (Long) -> Unit,
    onNavigateToTrainingPlan: () -> Unit,
    onNavigateToCreateExercise: () -> Unit,
    viewModel: ExerciseDictionaryViewModel = hiltViewModel(),
)
```

- **`ExerciseDictionaryViewModel`**: `@HiltViewModel`. Inyecta `GetExercisesUseCase` y `GetFilterOptionsUseCase`. Estado: `StateFlow<ExerciseDictionaryUiState>`. Usa `combine()` entre el Flow de ejercicios, el Flow de opciones de filtro y los filtros seleccionados (StateFlow internos) para producir la lista filtrada reactivamente. Funciones: `onModuleFilterSelected(code: String?)`, `onEquipmentFilterSelected(name: String?)`, `onMuscleZoneFilterSelected(name: String?)`.

- **`ExerciseDictionaryUiState`**: Data class con campos: `isLoading: Boolean`, `exercises: List<ExerciseItem>` (lista filtrada), `totalCount: Int` (total dinámico: precargados + creados por el ejecutante), `filterOptions: FilterOptions`, `selectedModule: String?` (null = Todos), `selectedEquipment: String?`, `selectedMuscleZone: String?`.

- **`ExerciseItem`**: Data class para la UI — `id: Long`, `name: String`, `moduleCode: String`, `equipmentTypeName: String`, `muscleZonesSummary: String` (zonas concatenadas con ", ").

- **`FilterOptions`**: Data class — `modules: List<String>`, `equipmentTypes: List<String>`, `muscleZones: List<String>`.

#### 11. UI Layer — D2 Detalle de Ejercicio (Nuevo)

Paquete: `ui.catalog`.

- **`ExerciseDetailScreen`**: Composable de nivel pantalla. Recibe `exerciseId` como argumento de navegación. Estructura según Wireframes D2 y Especificación Visual §8 D2:
  - **Top Bar**: `CenterAlignedTopAppBar` con `←` retorno + título dinámico (nombre del ejercicio).
  - **Media visual**: `Image` (PNG) en `Box`. Height 240 dp, full width, `ContentScale.Crop`, corner radius top 12 dp, bottom 0. **Lógica de carga:** Si `mediaResource` no es null, primero intenta como ruta de archivo absoluta (imágenes custom en almacenamiento interno), si falla intenta como ruta de asset `assets/exercises/module-{code}/{mediaResource}.png`. Si `mediaResource` es null o todas las cargas fallan, muestra el logo de la app como placeholder con ícono `AddAPhoto` y texto "Toca para agregar imagen" (CA-03.11). **La imagen es clickable** en todos los casos: al tocar, abre el selector de galería del dispositivo (`ActivityResultContracts.GetContent` con `image/*`). La imagen seleccionada se copia al almacenamiento interno (`filesDir/exercise_images/exercise_{UUID}.jpg`) y se actualiza `media_resource` vía `UpdateExerciseImageUseCase`. Esta funcionalidad aplica tanto a ejercicios seed como custom.
  - **Información textual**: 4 campos con `overlineContent` (Label Medium, On Surface Variant) + `headlineContent` (Body Large, On Surface): "Nombre" → nombre, "Módulo" → "A — Superior" / "B — Superior" / "C — Inferior", "Tipo de equipo" → valor, "Zona muscular" → zonas concatenadas.
  - **Enlace**: Text Button "Ver historial de este ejercicio →", color Primary, margin top 24 dp. Navega a F3 (stub — se implementa en HU-23). Solo visible si hay historial futuro (por ahora el enlace navega al stub).
  - **Bottom Navigation**: Condicional según origen (Arquitectura Técnica §4.5.1 y §4.7). Para HU-03, D2 solo se accede desde D1, por lo que la Bottom Nav es siempre visible con Diccionario activo. En historias futuras, cuando D2 sea accesible desde E1 (sesión activa), la visibilidad de la Bottom Nav se determinará evaluando si la entry anterior en el back stack pertenece al `session-graph` — si pertenece, se oculta. Esta lógica condicional se preparará como extensible pero solo se activará cuando E1→D2 se integre.

**Firma:**

```kotlin
@Composable
fun ExerciseDetailScreen(
    onNavigateBack: () -> Unit,
    onNavigateToExerciseHistory: (Long) -> Unit,
    viewModel: ExerciseDetailViewModel = hiltViewModel(),
)
```

- **`ExerciseDetailViewModel`**: `@HiltViewModel`. Recibe `exerciseId` via `SavedStateHandle`. Inyecta `GetExerciseDetailUseCase`, `UpdateExerciseImageUseCase` e `ImageStorageHelper` (singleton que centraliza la copia y eliminación de imágenes en almacenamiento interno). Estado: `StateFlow<ExerciseDetailUiState>`. Función `onImageSelected(uri: Uri?)`: usa `ImageStorageHelper.saveImageToInternal(uri)` para copiar la imagen al directorio `filesDir/exercise_images/exercise_{UUID}.jpg`, elimina la imagen anterior si existía vía `deleteImageIfInternal()`, luego invoca `updateExerciseImageUseCase(exerciseId, savedPath)`. El Flow reactivo de `getExerciseDetailUseCase` actualiza el UI automáticamente tras el cambio en BD.

- **`ExerciseDetailUiState`**: Sealed interface con `Loading`, `Success(exercise: ExerciseDetail)`, `Error(message: String)`.

- **`ExerciseDetail`**: Data class para la UI — `id: Long`, `name: String`, `moduleCode: String`, `moduleName: String`, `equipmentTypeName: String`, `muscleZones: String` (concatenadas con ", "), `isCustom: Boolean`, `mediaResource: String?`. El `moduleCode` se requiere para construir la ruta del asset: `"exercises/module-${moduleCode.lowercase()}/${mediaResource}.png"`. Si `mediaResource` es null, se muestra el logo de la app como placeholder con ícono `AddAPhoto` y texto para agregar imagen (CA-03.11). Si `mediaResource` es una ruta absoluta (imagen custom almacenada en `filesDir`), se carga desde el sistema de archivos.

#### 12. UI Layer — D5 Crear Ejercicio (Nuevo)

Paquete: `ui.catalog`.

- **`CreateExerciseScreen`**: Composable de nivel pantalla. Estructura: Scaffold con `TensionTopAppBar` (retorno + título "Crear ejercicio"), Snackbar para errores, body scrollable con:
  - **Imagen** (opcional): `Box` 240 dp clickable que abre selector de galería (`ActivityResultContracts.GetContent` con `image/*`). Si hay imagen seleccionada, la muestra con `ContentScale.Crop`. Si no, muestra `ExerciseImagePlaceholder` (composable compartido en `ui.components`: logo de la app + ícono `AddAPhoto` + texto "Toca para agregar imagen"). La imagen se copia al almacenamiento interno (`filesDir/exercise_images/exercise_{UUID}.jpg`) vía `ImageStorageHelper`.
  - **Texto** "La imagen es opcional. Puedes agregarla después."
  - **Nombre**: `OutlinedTextField` obligatorio con validación.
  - **Módulo**: `ExposedDropdownMenuBox` con los 3 módulos (A, B, C).
  - **Tipo de equipo**: `ExposedDropdownMenuBox` con los 9 tipos de equipo.
  - **Zonas musculares**: `FlowRow` de `FilterChip` multi-select con las 15 zonas.
  - **Condiciones especiales**: 3 `Checkbox` (Peso corporal, Isométrico, Al fallo técnico).
  - **Botón Crear**: `Button` full-width, disabled hasta que todos los campos obligatorios estén completos. Muestra `CircularProgressIndicator` durante guardado.
  - Al éxito, navega automáticamente de vuelta al Diccionario (D1).

**Firma:**

```kotlin
@Composable
fun CreateExerciseScreen(
    onNavigateBack: () -> Unit,
    viewModel: CreateExerciseViewModel = hiltViewModel(),
)
```

- **`CreateExerciseViewModel`**: `@HiltViewModel`. Inyecta `GetFilterOptionsUseCase`, `CreateExerciseUseCase` e `ImageStorageHelper`. Estado: `StateFlow<CreateExerciseUiState>`. En `init`, carga opciones de módulo, equipo y zonas vía `getFilterOptionsUseCase().first()`. Funciones: `onNameChanged`, `onModuleSelected`, `onEquipmentTypeSelected`, `onMuscleZoneToggled`, `onBodyweightChanged`, `onIsometricChanged`, `onToTechnicalFailureChanged`, `onImageSelected(uri: Uri?)` (usa `ImageStorageHelper` para copiar imagen a internal storage, elimina imagen previa si el usuario re-selecciona), `onSave` (valida y ejecuta `createExerciseUseCase`), `onDismissSaveError`.

- **`CreateExerciseUiState`**: Data class con campos: `isLoading: Boolean`, `name: String`, `modules: List<Module>`, `selectedModuleCode: String?`, `equipmentTypes: List<EquipmentType>`, `selectedEquipmentTypeId: Long?`, `muscleZones: List<MuscleZone>`, `selectedMuscleZoneIds: Set<Long>`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isToTechnicalFailure: Boolean`, `imageUri: String?` (ruta interna de la imagen seleccionada), `isSaving: Boolean`, `nameError: String?`, `moduleError: String?`, `equipmentError: String?`, `muscleZoneError: String?`, `saveSuccess: Boolean`, `saveError: String?`. Computed properties: `selectedModuleName`, `selectedEquipmentName`, `canSave`.

#### 12. UI Layer — D3 Stub (Nuevo)

Paquete: `ui.catalog`.

- **`TrainingPlanScreen`**: Composable stub mínimo. `CenterAlignedTopAppBar` con "Diccionario" + `TabRow` (tab "Plan" activo). Body con texto placeholder "Próximamente". Bottom Navigation con Diccionario activo. La lógica completa se implementa en HU-04.

**Firma:**

```kotlin
@Composable
fun TrainingPlanScreen(
    onNavigateToExerciseDictionary: () -> Unit,
    onNavigateToPlanVersionDetail: (Long) -> Unit,
)
```

#### 13. UI Layer — F3 Stub (Nuevo)

Paquete: `ui.history`.

- **`ExerciseHistoryScreen`**: Composable stub mínimo. `CenterAlignedTopAppBar` con `←` retorno + título placeholder "Historial de Ejercicio". Body con texto placeholder. Bottom Navigation visible. La lógica completa se implementa en HU-23.

#### 14. UI Layer — Navegación (Modificación)

- **`NavigationRoutes`**: Agregar constantes: `EXERCISE_DETAIL = "exercise-detail/{exerciseId}"`, `TRAINING_PLAN = "training-plan"`, `CREATE_EXERCISE = "create-exercise"`, `EXERCISE_HISTORY = "exercise-history/{exerciseId}"`. La ruta `EXERCISE_DICTIONARY` ya existe como placeholder.
- **`TensionNavHost`**: Reemplazar el `PlaceholderScreen` de `exercise-dictionary` con `ExerciseDictionaryScreen`. Agregar composables para `exercise-detail/{exerciseId}` (D2, con argumento `NavType.LongType`), `create-exercise` (D5), `training-plan` (D3 stub) y `exercise-history/{exerciseId}` (F3 stub). D2 recibe `exerciseId` de la ruta. El retorno de D2 y D5 usa `popBackStack()`.
- **`BottomNavigationBar`**: Agregar `childRoutes = setOf("training-plan", "create-exercise")` al ítem Diccionario para que el tab se marque como activo en D3 y D5. Las rutas D2 y D4 también son hijas va `childRoutePrefixes` con evaluación `startsWith()`.

#### 15. DI Layer — Módulos (Modificación + Nuevo)

- **`DatabaseModule`**: Agregar providers para los 6 nuevos DAOs (`exerciseDao()`, `moduleDao()`, `equipmentTypeDao()`, `muscleZoneDao()`, `moduleVersionDao()`, `planAssignmentDao()`). Agregar provider para `PrepopulateCallback`.
- **`RepositoryModule`**: Agregar binding `ExerciseRepository` ↔ `ExerciseRepositoryImpl` con `@Binds @Singleton`.

#### 16. Assets Multimedia (Nuevo)

- **43 archivos PNG** en `assets/exercises/`, organizados en 3 subdirectorios por módulo: `module-a/` (15 imágenes), `module-b/` (14 imágenes), `module-c/` (14 imágenes). Imágenes 3D minimalistas con fondo blanco que ilustran la ejecución correcta de cada movimiento. Ubicación: `assets/exercises/` (no `res/drawable`) porque Android no soporta subdirectorios dentro de `res/drawable/` (AAPT2 los rechaza). El directorio `assets/` sí soporta estructura arbitraria de carpetas.

**Convención de naming:** Cada archivo se nombra con el nombre del ejercicio + tipo de equipo, normalizado: lowercase → strip acentos (á→a, é→e, í→i, ó→o, ú→u) → espacios a underscores → eliminar paréntesis y caracteres especiales. Extensión `.png`. Ejemplo: "Press de banca" + "Máquina" → `press_de_banca_maquina.png`.

**Tabla completa de 43 archivos y su `media_resource`:**

| # | Ejercicio (Modelo de Datos) | Equipo | Archivo | `media_resource` |
|---|---|---|---|---|
| | **module-a/** (15 archivos) | | | |
| 1 | Press de banca | Máquina | `press_de_banca_maquina.png` | `press_de_banca_maquina` |
| 2 | Press de mancuerna | Mancuernas | `press_de_mancuerna_mancuernas.png` | `press_de_mancuerna_mancuernas` |
| 3 | Press de banca inclinada | Máquina | `press_de_banca_inclinada_maquina.png` | `press_de_banca_inclinada_maquina` |
| 4 | Flexiones | Cuerpo | `flexiones_cuerpo.png` | `flexiones_cuerpo` |
| 5 | Cruce en polea alta | Máquina | `cruce_en_polea_alta_maquina.png` | `cruce_en_polea_alta_maquina` |
| 6 | Apertura de pecho sentado | Máquina | `apertura_de_pecho_sentado_maquina.png` | `apertura_de_pecho_sentado_maquina` |
| 7 | Apertura de pecho inclinado | Máquina | `apertura_de_pecho_inclinado_maquina.png` | `apertura_de_pecho_inclinado_maquina` |
| 8 | Remo con Inclinación | Barra de Pesas | `remo_con_inclinacion_barra_de_pesas.png` | `remo_con_inclinacion_barra_de_pesas` |
| 9 | Remo con un solo brazo doblado | Mancuerna | `remo_con_un_solo_brazo_doblado_mancuerna.png` | `remo_con_un_solo_brazo_doblado_mancuerna` |
| 10 | Tiro de dorsales (Agarre ancho) | Máquina | `tiro_de_dorsales_agarre_ancho_maquina.png` | `tiro_de_dorsales_agarre_ancho_maquina` |
| 11 | Abdominales | Cuerpo | `abdominales_cuerpo.png` | `abdominales_cuerpo` |
| 12 | Escalador | Cuerpo | `escalador_cuerpo.png` | `escalador_cuerpo` |
| 13 | Giro Ruso | Cuerpo | `giro_ruso_cuerpo.png` | `giro_ruso_cuerpo` |
| 14 | Plancha | Cuerpo | `plancha_cuerpo.png` | `plancha_cuerpo` |
| 15 | Plancha Lateral | Cuerpo | `plancha_lateral_cuerpo.png` | `plancha_lateral_cuerpo` |
| | **module-b/** (14 archivos) | | | |
| 16 | Curl de bíceps | Mancuerna | `curl_de_biceps_mancuerna.png` | `curl_de_biceps_mancuerna` |
| 17 | Curl de bíceps | Polea | `curl_de_biceps_polea.png` | `curl_de_biceps_polea` |
| 18 | Curl de martillo cruzado | Mancuerna | `curl_de_martillo_cruzado_mancuerna.png` | `curl_de_martillo_cruzado_mancuerna` |
| 19 | Curl de martillo | Mancuerna | `curl_de_martillo_mancuerna.png` | `curl_de_martillo_mancuerna` |
| 20 | Curl de Contracción | Mancuerna | `curl_de_contraccion_mancuerna.png` | `curl_de_contraccion_mancuerna` |
| 21 | Dominada de tríceps banco | Pesa | `dominada_de_triceps_banco_pesa.png` | `dominada_de_triceps_banco_pesa` |
| 22 | Extensión de tríceps por encima de la cabeza | Mancuerna | `extension_de_triceps_por_encima_de_la_cabeza_mancuerna.png` | `extension_de_triceps_por_encima_de_la_cabeza_mancuerna` |
| 23 | Flexión de tríceps con cuerda | Máquina | `flexion_de_triceps_con_cuerda_maquina.png` | `flexion_de_triceps_con_cuerda_maquina` |
| 24 | Elevación frontal | Mancuerna | `elevacion_frontal_mancuerna.png` | `elevacion_frontal_mancuerna` |
| 25 | Elevación lateral | Mancuerna | `elevacion_lateral_mancuerna.png` | `elevacion_lateral_mancuerna` |
| 26 | Elevación de hombros con mancuernas | Mancuerna | `elevacion_de_hombros_con_mancuernas_mancuerna.png` | `elevacion_de_hombros_con_mancuernas_mancuerna` |
| 27 | Press de elevación sentado | Mancuerna | `press_de_elevacion_sentado_mancuerna.png` | `press_de_elevacion_sentado_mancuerna` |
| 28 | Remo vertical | Barra de Pesas | `remo_vertical_barra_de_pesas.png` | `remo_vertical_barra_de_pesas` |
| 29 | Remo vertical con cable | Máquina | `remo_vertical_con_cable_maquina.png` | `remo_vertical_con_cable_maquina` |
| | **module-c/** (14 archivos) | | | |
| 30 | Extensión de Cuádriceps | Máquina | `extension_de_cuadriceps_maquina.png` | `extension_de_cuadriceps_maquina` |
| 31 | Curl Femoral Tumbado | Máquina | `curl_femoral_tumbado_maquina.png` | `curl_femoral_tumbado_maquina` |
| 32 | Aductor de Cadera | Máquina | `aductor_de_cadera_maquina.png` | `aductor_de_cadera_maquina` |
| 33 | Abductor de Cadera | Máquina | `abductor_de_cadera_maquina.png` | `abductor_de_cadera_maquina` |
| 34 | Elevación de Gemelos Sentado | Máquina | `elevacion_de_gemelos_sentado_maquina.png` | `elevacion_de_gemelos_sentado_maquina` |
| 35 | Empuje de Cadera | Máquina | `empuje_de_cadera_maquina.png` | `empuje_de_cadera_maquina` |
| 36 | Sentadilla de Sumo | Mancuerna o Pesa Rusa | `sentadilla_de_sumo_mancuerna_o_pesa_rusa.png` | `sentadilla_de_sumo_mancuerna_o_pesa_rusa` |
| 37 | Sentadilla | Cuerpo | `sentadilla_cuerpo.png` | `sentadilla_cuerpo` |
| 38 | Sentadilla Búlgara Dividida | Mancuernas | `sentadilla_bulgara_dividida_mancuernas.png` | `sentadilla_bulgara_dividida_mancuernas` |
| 39 | Sentadilla | Máquina Multiestación | `sentadilla_maquina_multiestacion.png` | `sentadilla_maquina_multiestacion` |
| 40 | Subir Escalones | Máquina | `subir_escalones_maquina.png` | `subir_escalones_maquina` |
| 41 | Zancada hacia atrás | Mancuernas | `zancada_hacia_atras_mancuernas.png` | `zancada_hacia_atras_mancuernas` |
| 42 | Avanzada de Zancadas | Mancuernas | `avanzada_de_zancadas_mancuernas.png` | `avanzada_de_zancadas_mancuernas` |
| 43 | Press de Pierna | Máquina | `press_de_pierna_maquina.png` | `press_de_pierna_maquina` |

**Reglas de normalización (implementar en `ExerciseSeeder`):**
1. Tomar `name` + `"_"` + `equipmentType.name` del Modelo de Datos §3.4
2. Lowercase: `"Press de banca"` → `"press de banca"`
3. Strip acentos: `á→a, é→e, í→i, ó→o, ú→u`
4. Espacios a underscores: `"press de banca"` → `"press_de_banca"`
5. Eliminar paréntesis: `"(Agarre ancho)"` → `"agarre_ancho"`
6. Resultado para DB: `media_resource = "press_de_banca_maquina"` (sin extensión)
7. Ruta en assets: `assets/exercises/module-{code}/{media_resource}.png`

Optimizados para móvil: resolución ≤ 720px de ancho, compresión PNG optimizada. El APK total no debe exceder 150 MB (RNF24, CA-03.09). En futuras iteraciones, las imágenes podrán ser reemplazadas por videos/GIFs.
- **Placeholder** para ejercicios sin imagen: composable compartido `ExerciseImagePlaceholder` (en `ui.components`) que muestra el logo de la app + ícono `AddAPhoto` + texto "Toca para agregar imagen". Usado tanto en D2 como en D5. Toda la zona de imagen es clickable para agregar una imagen desde la galería del dispositivo.

#### 17. Recursos (Modificación)

- **`strings.xml`**: Agregar strings para D1 ("Diccionario", "Ejercicios", "Plan", "Todos", "Mostrando %1$d de %2$d ejercicios", "No hay ejercicios que coincidan con los filtros seleccionados", "Módulo %s" para formato de supportingContent), D2 ("Nombre", "Módulo", "Tipo de equipo", "Zona muscular", "Ver historial de este ejercicio →"), D3 stub, F3 stub. **Corrección:** Cambiar el string existente `nav_dictionary` de "Ejercicios" a "Diccionario" para alinear con Especificación Visual §7.2 y Arquitectura Técnica §4.5 que definen el label del Bottom Nav como "Diccionario". El tab dentro de D1 mantiene su propio label "Ejercicios".

### Integraciones

| Interfaz / Contrato | Productor | Consumidor | Descripción |
| --- | --- | --- | --- |
| `ExerciseRepository` | `ExerciseRepositoryImpl` (Data) | Use Cases de catálogo (Domain) | Contrato de acceso al catálogo de ejercicios, módulos, equipos y zonas. Definido en Domain, implementado en Data, inyectado por Hilt |
| `PrepopulateCallback` | `data.local.seed` | `TensionDatabase` builder | Callback que ejecuta seed data al crear la BD por primera vez. 220 inserciones en transacción atómica vía 3 Seeders (`ModuleSeeder`, `ExerciseSeeder`, `PlanSeeder`) alineados con ADR-11 |
| `StateFlow<ExerciseDictionaryUiState>` | `ExerciseDictionaryViewModel` | `ExerciseDictionaryScreen` | Lista de ejercicios filtrada + opciones de filtro + filtros seleccionados |
| `StateFlow<ExerciseDetailUiState>` | `ExerciseDetailViewModel` | `ExerciseDetailScreen` | Datos completos del ejercicio incluyendo media resource |
| `SavedStateHandle` | Navigation Compose | `ExerciseDetailViewModel` | `exerciseId: Long` extraído de la ruta `exercise-detail/{exerciseId}` |

### Riesgos

| Riesgo | Probabilidad | Impacto | Mitigación |
| --- | --- | --- | --- |
| Tamaño del APK excede 150 MB por assets PNG de 43 ejercicios | Baja | Medio | Imágenes PNG estáticas son significativamente más livianas que GIFs animados. Los 43 assets ya existen en `assets/exercises/`. Medir tamaño del APK actual con los 43 assets. Optimizar: resolución ≤ 720px de ancho, compresión PNG. Si aún excede, considerar WebP estático (20-30% más liviano) |
| Seed data con 220 inserciones falla parcialmente | Baja | Alto | Toda la prepopulación se ejecuta dentro de una transacción atómica en `onCreate()` — si falla, se revierte todo. `fallbackToDestructiveMigration()` permite recrear la BD limpia |
| Filtrado en memoria con 43 ejercicios causa frame drops | Muy baja | Bajo | 43 elementos es trivial. El filtrado se hace en el ViewModel, no en recomposición. Si fuera necesario, `distinctUntilChanged()` en el StateFlow |
| Versión de BD necesita migración de 1 a 2 al agregar entities | Baja | Medio | `fallbackToDestructiveMigration()` activo durante desarrollo elimina el problema. Los datos de perfil/peso se pierden al cambiar versión, pero es aceptable en fase de desarrollo |
| Bottom Navigation no marca Diccionario como activo en D2/D4 (rutas con argumentos) | Certeza | Bajo | Extender lógica de `selected` en `BottomNavigationBar` para evaluar prefijo de ruta: `currentRoute?.startsWith("exercise-detail") == true` o `currentRoute?.startsWith("training-plan") == true`. Patrón ya establecido con `childRoutes` en HU-02 |
| Label Bottom Nav "Ejercicios" confunde con tab "Ejercicios" de D1 | Certeza | Medio | Corregir `nav_dictionary` de "Ejercicios" a "Diccionario" en `strings.xml`. Confirmado por Especificación Visual §7.2 y Arquitectura Técnica §4.5 |

### Hitos de implementación

| Hito | Contenido | Dependencias |
| --- | --- | --- |
| 1 | Data Layer — Entities: `ModuleEntity`, `MuscleZoneEntity`, `EquipmentTypeEntity`, `ExerciseEntity`, `ExerciseMuscleZoneEntity`, `ModuleVersionEntity`, `PlanAssignmentEntity` | — |
| 2 | Data Layer — DAOs: `ExerciseDao`, `ModuleDao`, `EquipmentTypeDao`, `MuscleZoneDao`, `ModuleVersionDao`, `PlanAssignmentDao` | Hito 1 |
| 3 | Data Layer — Seed: `PrepopulateCallback`, `PrepopulateFacade`, 3 Seeders (`ModuleSeeder`, `ExerciseSeeder`, `PlanSeeder`) — 220 filas totales | Hito 1, Hito 2 |
| 4 | Data Layer — Database: actualizar `TensionDatabase` (7 entities, 6 DAOs, callback). DI: actualizar `DatabaseModule` y `RepositoryModule` | Hito 1, Hito 2, Hito 3 |
| 5 | Domain Layer: modelos (`Module`, `MuscleZone`, `EquipmentType`, `Exercise`), `ExerciseRepository` interfaz (con `createExercise`, `updateExerciseImage`, `exerciseExistsByNameAndEquipment`), 5 Use Cases (`GetExercisesUseCase`, `GetExerciseDetailUseCase`, `GetFilterOptionsUseCase`, `CreateExerciseUseCase`, `UpdateExerciseImageUseCase`) | — (Kotlin puro) |
| 6 | Data Layer — Repository: `ExerciseRepositoryImpl` (con `createExercise`, `updateExerciseImage`, `exerciseExistsByNameAndEquipment`) | Hito 2, Hito 5 |
| 7 | Assets: 43 imágenes PNG (3D minimalistas, fondo blanco) ya existentes en `assets/exercises/` con subdirectorios `module-a/`, `module-b/`, `module-c/`. Verificar naming y optimización | — (independiente) |
| 8 | UI — D1: `ExerciseDictionaryScreen`, `ExerciseDictionaryViewModel`, `ExerciseDictionaryUiState` + D3 stub + D5: `CreateExerciseScreen`, `CreateExerciseViewModel`, `CreateExerciseUiState` | Hito 5, Hito 6 |
| 9 | UI — D2: `ExerciseDetailScreen`, `ExerciseDetailViewModel` (con `UpdateExerciseImageUseCase`), `ExerciseDetailUiState` + F3 stub | Hito 5, Hito 6, Hito 7 |
| 10 | Navegación: actualizar `NavigationRoutes` (+ `CREATE_EXERCISE`), `TensionNavHost` (+ D5 composable), `BottomNavigationBar` (+ `create-exercise` en childRoutes) + `strings.xml` | Hito 8, Hito 9 |

### Notas de auditoría

1. **CA-03.01 (precargado completo) se cumple mediante ADR-11.** `PrepopulateCallback.onCreate()` inserta 220 filas en transacción atómica usando el patrón Facade con 3 Seeders (`ModuleSeeder`, `ExerciseSeeder`, `PlanSeeder`). Los 43 ejercicios están disponibles desde la primera apertura de la app, sin conexión a internet ni carga externa.
2. **Seeders alineados con ADR-11.** ADR-11 nombra 4 seeders: `ModuleSeeder`, `ExerciseSeeder`, `PlanSeeder`, `RotationSeeder`. El `RotationSeeder` no se incluye en el `PrepopulateFacade` porque el estado de rotación se inicializa en `ProfileRepositoryImpl.createProfile()` (implementado en HU-01, Modelo de Datos §3.14: *"Se crea junto con el perfil"*). Los 3 seeders restantes agrupan entidades por dependencia: `ModuleSeeder` (module + muscle_zone + equipment_type), `ExerciseSeeder` (exercise + exercise_muscle_zone), `PlanSeeder` (module_version + plan_assignment).
3. **CA-03.02 (información visible por ejercicio) requiere JOIN multi-tabla.** El `ExerciseDao.getAll()` debe resolver nombre de módulo (`module.name`), nombre de equipo (`equipment_type.name`) y lista de zonas musculares (`muscle_zone.name` via `exercise_muscle_zone`) en una sola consulta. Se usa `ExerciseWithDetails` como clase intermedia de resultado.
4. **CA-03.03 a CA-03.06 (filtros) se implementan en memoria.** Los 43 ejercicios se cargan completos y el ViewModel filtra reactivamente según los 3 criterios. No se necesitan queries parametrizadas a Room — el dataset es trivial. El filtro de zona muscular debe verificar si ALGUNA zona del ejercicio coincide (ejercicios multi-zona como Sentadilla Búlgara tienen 2 zonas: Cuádriceps + Glúteos). Cumple RNF06 (experiencia fluida).
5. **CA-03.07 (media visual) depende de `media_resource` en la entity.** El campo almacena: para ejercicios seed, el nombre normalizado del ejercicio + equipo (ej: `"press_de_banca_maquina"`); para ejercicios custom, la ruta absoluta del archivo en almacenamiento interno (`filesDir/exercise_images/exercise_{UUID}.jpg`). El composable `rememberExerciseBitmap` en D2 usa doble estrategia: primero intenta cargar como ruta absoluta de archivo (`File(mediaResource).exists()`), si no existe, construye la ruta `"exercises/module-${moduleCode.lowercase()}/${mediaResource}.png"` y carga desde `assets/`. Si `mediaResource` es null, se muestra `ExerciseImagePlaceholder` (logo + `AddAPhoto` + texto "Toca para agregar imagen"). Toda la zona de imagen es clickable para agregar o cambiar la imagen desde la galería del dispositivo (aplica a todos los ejercicios, seed y custom).
6. **CA-03.08 (media accesible durante sesión activa) es responsabilidad de E1 (HU-05/HU-06).** D2 es una vista reutilizable accesible desde E1. Cuando el origen es E1, la Bottom Nav se oculta (§4.5.1: se evalúa si la entry anterior del back stack pertenece al `session-graph`) y el retorno vuelve a E1. Esta historia prepara D2 como reutilizable; la integración desde E1 se completa en su historia correspondiente.
7. **CA-03.09 (APK ≤ 150 MB) es un riesgo bajo con PNG.** 43 imágenes PNG estáticas son significativamente más livianas que 43 GIFs animados. Se requiere medición temprana para confirmar. Cumple RNF24 y RNF31 (seed data versionado: assets en `assets/exercises/` rastreados por Git). En futuras iteraciones, si se migra a video/GIF, el riesgo de tamaño aumentará y se necesitará optimización.
8. **Tabs D1 ↔ D3 comparten TopAppBar.** Ambas pantallas usan `CenterAlignedTopAppBar` con título "Diccionario" + `TabRow`. La navegación lateral entre tabs usa `launchSingleTop = true` y `restoreState = true` sin apilamiento de back stack (Arquitectura Técnica §4.8).
9. **Las 7 entities de seed data se incluyen todas en HU-03** aunque `module_version` y `plan_assignment` son consumidas principalmente por HU-04 (D3/D4) y HU-05 (sesión). Esto garantiza atomicidad del seed (ADR-11: una única transacción en `onCreate()`) y evita migraciones intermedias.
10. **`BottomNavigationBar` requiere extensión de la lógica de selección** para rutas con argumentos. Las rutas `exercise-detail/{exerciseId}` y futuros `plan-version-detail/{moduleVersionId}` no coinciden con `currentRoute == item.route`. Se necesita evaluación por prefijo o registro de prefijos en `childRoutes`.
11. **Corrección de label Bottom Nav: "Ejercicios" → "Diccionario".** El string actual `nav_dictionary = "Ejercicios"` contradice Especificación Visual §7.2 y Arquitectura Técnica §4.5, que definen el label como "Diccionario". El tab dentro de D1 tiene su propio label "Ejercicios" — no confundir con el Bottom Nav.
12. **Especificación Visual D1 tipos de equipo — corregido.** La Especificación Visual §8 D1 originalmente decía *"Todos + 10 tipos de equipo"*. Ya fue corregido a *"Todos + 9 tipos de equipo"*, alineado con el Modelo de Datos §3.3 (9 tipos) y el wireframe D1 #4. Las opciones del dropdown de equipo son: "Todos" + 9 tipos = 10 opciones total.
13. **Compatibilidad futura con HU-07 (sustitución) verificada.** HU-07 necesita listar ejercicios del mismo módulo como candidatos a sustituto. `ExerciseDao` con filtro por `module_code` (ya tiene índice) lo soporta. No se necesita ajuste ahora, pero el `ExerciseRepository` puede extenderse en HU-07 con `getExercisesByModule(moduleCode: String)`.
14. **Compatibilidad futura con HU-20 (tonelaje por grupo muscular) verificada.** La tabla `exercise_muscle_zone` y el campo `muscle_group` en `muscle_zone` son la base para la agregación de KPIs. Se implementan en HU-03 aunque se consumen en HU-20.
15. **Seeders usan tildes del Modelo de Datos §3.4.** Los nombres de ejercicios en el seed se toman del Modelo de Datos (fuente autoritativa, con acentos normalizados: "Extensión de Cuádriceps", "Sentadilla Búlgara Dividida"), no del Diccionario de Ejercicios original.
16. **El supportingContent de D1 antepone "Módulo" al código.** Según wireframes D1: *"Módulo A · Máquina · Pecho Medio"*. La UI construye el texto con formato `"Módulo %s · %s · %s"` (código, equipo, zonas). Para ejercicios multi-zona, las zonas se concatenan con ", " dentro del segmento: *"Módulo C · Mancuernas · Cuádriceps, Glúteos"*.
17. **Ejercicios seed se insertan con `is_custom = 0` (DEFAULT).** Los 43 ejercicios precargados usan el valor DEFAULT del campo `is_custom` (INTEGER, NOT NULL, DEFAULT 0). No es necesario establecerlo explícitamente en el `ExerciseSeeder`, pero se documenta para claridad: todo ejercicio seed es `is_custom = 0` y tiene `media_resource` poblado (nombre normalizado para resolver asset en `assets/exercises/`). Los ejercicios custom (RF62) se crean con `is_custom = 1` y `media_resource` puede ser la ruta absoluta de una imagen seleccionada desde la galería o `NULL` si el usuario no selecciona imagen (en cuyo caso se muestra `ExerciseImagePlaceholder`).
18. **Assets multimedia ya existen en disco.** Los 43 archivos PNG están en `app/src/main/assets/exercises/` (15 en `module-a/`, 14 en `module-b/`, 14 en `module-c/`), nombrados según la convención de §16. No es necesario crear ni agregar archivos durante el desarrollo de HU-03 — solo verificar naming y optimización.
19. **CA-03.10 (crear ejercicio) y CA-03.11 (imagen/placeholder) están IMPLEMENTADOS.** Componentes implementados: `CreateExerciseUseCase` (validación nombre + unicidad + zonas), `UpdateExerciseImageUseCase`, `ExerciseRepository.createExercise()` y `updateExerciseImage()`, `ExerciseDao.insert()`, `insertExerciseWithMuscleZones()` (`@Transaction` atómico), `insertAllMuscleZones()`, `updateMediaResource()`, `countByNameAndEquipment()`, `ImageStorageHelper` (singleton `@Singleton` en `data.local.storage` para copia y eliminación de imágenes en almacenamiento interno), pantalla D5 `CreateExerciseScreen` con formulario completo (imagen opcional galería, nombre, módulo dropdown, equipo dropdown, zonas FilterChip, checkboxes condiciones especiales), `CreateExerciseViewModel` con `ImageStorageHelper` para persistencia de imagen y limpieza de archivos huérfanos, `ExerciseImagePlaceholder` (composable compartido en `ui.components` usado por D2 y D5). La ruta `CREATE_EXERCISE = "create-exercise"` está registrada en `NavigationRoutes` y `TensionNavHost`. El FAB de D1 navega directamente a D5. En D2, la imagen es clickable para cambiarla (galería → `ImageStorageHelper` → almacenamiento interno → `updateMediaResource`). Cuando `mediaResource == null`, se muestra `ExerciseImagePlaceholder` (logo + `AddAPhoto` + texto "Toca para agregar imagen").

---

## Refinamiento Técnico (Developer)

<!-- SECCIÓN AGREGADA POR: Workflow refinamiento-tecnico -->
<!-- ETAPA: Refinamiento Técnico -->
<!-- RESPONSABLE: Developer -->
<!-- BASE: Análisis Arquitectónico (Arquitecto) - Ver sección arriba -->
<!-- FECHA: 2026-02-13 -->
<!-- ESTADO: Listo para Desarrollo -->
<!-- AUDITORÍA: Completada 2026-02-13 — Auditoría profunda: cruce exhaustivo contra Modelo de Datos §3.1-§3.7, Especificación Visual §7.2/§8, Wireframes D1/D2, Arquitectura Técnica §4.3-§4.8/§5.1-§5.4, ADR-05/ADR-11/ADR-18, Mapa de Navegación §D1/D2/D3/F3, Requerimientos RF04/RF07/RF61/RNF06/RNF24/RNF31, Manifiesto de Dominio Sistémico, Plan de Entrenamiento (93 filas), Diccionario de Ejercicios (43 ejercicios), 32 HUs completas, y código HU-01/HU-02 implementado (9/9 claims verificados). 0 conflictos, 14 dependencias downstream confirmadas. Correcciones aplicadas: media_resource migrado de .gif a .png (imágenes 3D minimalistas con fondo blanco), assets ubicados en assets/exercises/ con subdirectorios module-a/module-b/module-c/ (Android no soporta subdirs en res/drawable), naming por nombre+equipo normalizado (43 archivos mapeados explícitamente), insert methods en DAOs para seed. Documentación transversal actualizada: Requerimientos (RF61, RNF24), Modelo de Datos §3.4, Especificación Visual §8 D2, Wireframes D2, Mapa de Navegación D2, Mapa de Historias, ADR-13. Actualización 2026-02-13: Curl de Contracción añadido al Módulo B, B×2→B×3, 41→42 ejercicios, 82→93 asignaciones, 8→9 versiones. Actualización 2026-02-13: Elevación de hombros con mancuernas añadida al Módulo B, 42→43 ejercicios, Hombro con rotación ampliada (6 ej, 4 por versión). Corrección 2026-02-13: "Dominada de tríceps en banco con pesa en las piernas" eliminada por ser duplicado de "Dominada de tríceps banco", Módulo B 15→14 ejercicios, Tríceps fijo (3 ej en toda versión). Total: 43 ejercicios, 220 filas seed. -->

### Consideraciones Generales

**Basado en análisis arquitectónico:**
Análisis Arquitectónico de HU-03 con 10 hitos, 17 componentes, 5 integraciones y 6 riesgos identificados. Patrón MVVM con capa Domain explícita (ADR-05). Tercera historia — es la historia con mayor volumen de entidades nuevas (7 tablas) y seed data (220 filas). Infraestructura base ya existe gracias a HU-01/HU-02.

**Nivel de complejidad:**
ALTA — Esta historia introduce 7 entidades Room nuevas, 6 DAOs nuevos, sistema de prepopulación con 220 filas (ADR-11), 4 modelos de dominio, 1 repositorio nuevo, 3 Use Cases, 4 pantallas (D1, D2, D3 stub, F3 stub), 2 ViewModels, navegación con argumentos tipados, sistema de tabs compartido, sistema de filtrado en memoria, carga de imágenes PNG desde `assets/exercises/` (ya existentes en disco, organizadas por módulo), y extensión del `BottomNavigationBar` para rutas con argumentos.

**Riesgos técnicos conocidos:**

1. Tamaño del APK puede exceder 150 MB con 43 PNGs (ya existentes en `assets/exercises/`) — medir APK actual, optimizar con WebP estático si necesario. Riesgo bajo comparado con GIFs.
2. Seed data con 220 inserciones en transacción atómica — `fallbackToDestructiveMigration()` en desarrollo.
3. Bottom Navigation no marca Diccionario como activo en D2 (ruta con argumentos) — extender lógica con evaluación por prefijo.
4. Label Bottom Nav "Ejercicios" debería ser "Diccionario" — corregir `nav_dictionary` en strings.xml.

**Patrones y convenciones del equipo (establecidos en HU-01/HU-02):**

- Código fuente en inglés, UI y datos de dominio en español (Arquitectura Técnica §5.1)
- Naming: `{Feature}Screen`, `{Feature}ViewModel`, `{Acción}{Entidad}UseCase`, `{Entidad}Entity`, `{Entidad}Dao`, `{Entidad}Seeder` (§5.2)
- Estructura Composable: `hiltViewModel()` + `collectAsStateWithLifecycle()` + `LaunchedEffect` para eventos (§5.3)
- Estructura ViewModel: `_uiState MutableStateFlow` / `uiState StateFlow` (§5.4)
- `operator fun invoke()` en Use Cases
- Callbacks en Composables con prefijo `on` (`onNavigateBack`)
- `childRoutes` en `BottomNavItem` para rutas hijas (patrón establecido en HU-02)

**Dependencias nuevas a instalar:**
Ninguna. Las imágenes PNG se cargan desde `assets/` via `context.assets.open()` + `BitmapFactory.decodeStream()` + `asImageBitmap()` — APIs nativas de Android, no se requieren librerías adicionales. Se creará una función helper `@Composable rememberAssetBitmapPainter(path: String)` para encapsular la carga. En futuras iteraciones, si se migra a GIF/video, se evaluará `coil-gif` o `coil-compose`.

**Estrategia de testing:**
JUnit 4 (ADR-18) + MockK + kotlinx-coroutines-test | Tests unitarios para los 3 Use Cases (domain): `GetExercisesUseCase`, `GetExerciseDetailUseCase`, `GetFilterOptionsUseCase` | Cobertura: 100% Use Cases

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**
HU-02 — Se reutiliza patrón `BottomNavItem.childRoutes` para marcar tab activo en rutas hijas. `WeightHistoryViewModel` sirve como referencia para `ExerciseDictionaryViewModel` (patrón Flow → StateFlow).

**Patrones de código reutilizados:**

- `TensionTopAppBar` con variante sin retorno (D1/D3) y con retorno (D2/F3)
- `BottomNavigationBar` con `childRoutes` (HU-02) — se extiende para soportar rutas con argumentos via prefijo
- `PlaceholderScreen` pattern del NavHost para stubs (D3, F3)
- Scaffold de `TensionNavHost` con Bottom Nav condicional ya existente

**HUs futuras que dependen del seed data de HU-03:**

- HU-04: Consultar Plan de Entrenamiento → consume `module_version`, `plan_assignment`, D3/D4
- HU-05: Iniciar sesión de entrenamiento → consume `module_version`, `exercise`, `plan_assignment`
- HU-06: Registrar series → consume `exercise`
- HU-07: Sustitución de ejercicios → consume `exercise` filtrado por `module_code`
- HU-08: Ejercicios peso corporal/isométricos → consume flags `is_bodyweight`, `is_isometric`, `is_to_technical_failure`
- HU-20: Tonelaje por grupo muscular → consume `exercise_muscle_zone` + `muscle_zone.muscle_group`
- HU-23: Historial de ejercicio → consume `exercise` para F3
- HU-31/HU-32: Backup/Restore → incluyen todas las tablas del catálogo

### Código existente verificado (HU-01 + HU-02 implementados)

| Componente | Archivo | Estado |
| --- | --- | --- |
| `TensionDatabase` | `data/local/database/TensionDatabase.kt` | ✅ Existe — versión 1, 3 entities, 3 DAOs. Se modifica: +7 entities, +6 DAOs, +callback, versión → 2 |
| `DatabaseModule` | `di/DatabaseModule.kt` | ✅ Existe — provee DB + 3 DAOs. Se modifica: +6 DAOs, +PrepopulateCallback |
| `RepositoryModule` | `di/RepositoryModule.kt` | ✅ Existe — binds ProfileRepository. Se modifica: +ExerciseRepository |
| `NavigationRoutes` | `ui/navigation/NavigationRoutes.kt` | ✅ Existe — 8 rutas. Se modifica: +EXERCISE_DETAIL, +TRAINING_PLAN, +EXERCISE_HISTORY |
| `TensionNavHost` | `ui/navigation/TensionNavHost.kt` | ✅ Existe — placeholder en EXERCISE_DICTIONARY. Se modifica: reemplazar placeholder + agregar D2, D3, F3 |
| `BottomNavigationBar` | `ui/components/BottomNavigationBar.kt` | ✅ Existe — `childRoutes` en Settings. Se modifica: +childRoutes en Diccionario + lógica prefijo para rutas con args |
| `TensionTopAppBar` | `ui/components/TensionTopAppBar.kt` | ✅ Existe — variantes retorno y cierre. No se modifica |
| `strings.xml` | `res/values/strings.xml` | ✅ Existe — `nav_dictionary = "Ejercicios"`. Se modifica: corregir a "Diccionario" + agregar strings D1/D2/D3/F3 |
| `assets/exercises/` | ✅ Existe — 3 subdirectorios (`module-a/`, `module-b/`, `module-c/`) con 43 PNGs ya presentes, nombrados según convención de §16 | Verificar naming y optimización |

---

## Tareas de Implementación (Developer)

### Fase 1: Data Layer — Entities (7 nuevas)

> Basado en Hito #1 del Análisis Arquitectónico

#### 📦 Entities del catálogo

- [ ] **Crear ModuleEntity** (AC: 03.01)
  - [ ] `@Entity(tableName = "module")`. PK natural `code: String` (TEXT). Columnas: `name` (TEXT, NOT NULL), `groupDescription` (TEXT, NOT NULL, columnInfo name = "group_description"), `loadIncrementKg` (REAL, NOT NULL, columnInfo name = "load_increment_kg"). 3 filas inmutables — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ModuleEntity.kt`

- [ ] **Crear MuscleZoneEntity** (AC: 03.01, 03.05)
  - [ ] `@Entity(tableName = "muscle_zone")`. PK autoincrement `id: Long`. Columnas: `name` (TEXT, NOT NULL, UNIQUE), `muscleGroup` (TEXT, NOT NULL, columnInfo name = "muscle_group"). Index en `muscle_group`. 15 filas inmutables — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/MuscleZoneEntity.kt`

- [ ] **Crear EquipmentTypeEntity** (AC: 03.01, 03.04)
  - [ ] `@Entity(tableName = "equipment_type")`. PK autoincrement `id: Long`. Columnas: `name` (TEXT, NOT NULL, UNIQUE). 9 filas inmutables — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/EquipmentTypeEntity.kt`

- [ ] **Crear ExerciseEntity** (AC: 03.01, 03.02, 03.10)
  - [ ] `@Entity(tableName = "exercise")`. PK autoincrement `id: Long`. FKs: `moduleCode` → `module(code)` ON DELETE RESTRICT, `equipmentTypeId` → `equipment_type(id)` ON DELETE RESTRICT. Columnas: `name`, `moduleCode` (column = "module_code"), `equipmentTypeId` (column = "equipment_type_id"), `isBodyweight` (column = "is_bodyweight", default 0), `isIsometric` (column = "is_isometric", default 0), `isToTechnicalFailure` (column = "is_to_technical_failure", default 0), `isCustom` (column = "is_custom", default 0), `mediaResource` (column = "media_resource", nullable). UNIQUE(name, equipmentTypeId). Indices en `module_code`, `equipment_type_id`. 43 filas seed + filas dinámicas creadas por el ejecutante (RF62) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ExerciseEntity.kt`

- [ ] **Crear ExerciseMuscleZoneEntity** (AC: 03.01, 03.05)
  - [ ] `@Entity(tableName = "exercise_muscle_zone", primaryKeys = ["exercise_id", "muscle_zone_id"])`. FKs: `exerciseId` → `exercise(id)`, `muscleZoneId` → `muscle_zone(id)`, ambas ON DELETE RESTRICT. 48 filas (38 × 1 zona + 5 × 2 zonas) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ExerciseMuscleZoneEntity.kt`

#### 📦 Entities auxiliares del plan

- [ ] **Crear ModuleVersionEntity** (AC: 03.01 indirect — seed atomicidad)
  - [ ] `@Entity(tableName = "module_version")`. PK autoincrement `id: Long`. FK `moduleCode` → `module(code)` ON DELETE RESTRICT. Columnas: `moduleCode` (column = "module_code"), `versionNumber` (column = "version_number", INTEGER NOT NULL). UNIQUE(module_code, version_number). 9 filas — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ModuleVersionEntity.kt`

- [ ] **Crear PlanAssignmentEntity** (AC: 03.01 indirect — seed atomicidad)
  - [ ] `@Entity(tableName = "plan_assignment", primaryKeys = ["module_version_id", "exercise_id"])`. FKs: `moduleVersionId` → `module_version(id)`, `exerciseId` → `exercise(id)`, ambas ON DELETE RESTRICT. Columnas: `moduleVersionId` (column = "module_version_id"), `exerciseId` (column = "exercise_id"), `sets` (INTEGER NOT NULL), `reps` (TEXT NOT NULL). 93 filas — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/PlanAssignmentEntity.kt`

### Fase 2: Data Layer — DAOs (6 nuevos)

> Basado en Hito #2 del Análisis Arquitectónico

- [ ] **Crear ExerciseDao** (AC: 03.02, 03.07)
  - [ ] `@Dao`. Queries: `getAll(): Flow<List<ExerciseWithDetails>>` — query con JOIN a `module`, `equipment_type` y sub-query/GROUP_CONCAT para zonas musculares vía `exercise_muscle_zone` + `muscle_zone`. `getById(exerciseId: Long): Flow<ExerciseWithDetails?>` para D2. Inserts para seed: `insertAll(exercises: List<ExerciseEntity>)`, `insertAllMuscleZones(zones: List<ExerciseMuscleZoneEntity>)`. Se necesita definir `ExerciseWithDetails` como data class intermedia (no @Entity) con campos: `id`, `name`, `moduleCode`, `moduleName`, `equipmentTypeName`, `isBodyweight`, `isIsometric`, `isToTechnicalFailure`, `isCustom`, `mediaResource` (nullable), `muscleZones` (String concatenado con GROUP_CONCAT). Room no soporta `@Relation` con muchos-a-muchos de forma limpia, por lo que se usa `@RawQuery` o query manual con GROUP_CONCAT — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ExerciseDao.kt`

- [ ] **Crear ModuleDao** (AC: 03.03)
  - [ ] `@Dao`. Queries: `getAll(): Flow<List<ModuleEntity>>` — los 3 módulos para opciones del dropdown de filtro en D1. Insert: `insertAll(modules: List<ModuleEntity>)` para seed — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ModuleDao.kt`

- [ ] **Crear EquipmentTypeDao** (AC: 03.04)
  - [ ] `@Dao`. Query: `getAll(): Flow<List<EquipmentTypeEntity>>` — los 9 tipos para opciones del dropdown de filtro. Insert: `insertAll(types: List<EquipmentTypeEntity>)` para seed — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/EquipmentTypeDao.kt`

- [ ] **Crear MuscleZoneDao** (AC: 03.05)
  - [ ] `@Dao`. Query: `getAll(): Flow<List<MuscleZoneEntity>>` — las 15 zonas para opciones del dropdown de filtro. Insert: `insertAll(zones: List<MuscleZoneEntity>)` para seed — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/MuscleZoneDao.kt`

- [ ] **Crear ModuleVersionDao** (provisorio para HU-04+)
  - [ ] `@Dao`. Query: `getAll(): Flow<List<ModuleVersionEntity>>`. Insert: `insertAll(versions: List<ModuleVersionEntity>)` para seed — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ModuleVersionDao.kt`

- [ ] **Crear PlanAssignmentDao** (provisorio para HU-04+)
  - [ ] `@Dao`. Query: `getByModuleVersionId(id: Long): Flow<List<PlanAssignmentEntity>>`. Insert: `insertAll(assignments: List<PlanAssignmentEntity>)` para seed. Nota: HU-04 extenderá este DAO con query JOIN que retorne `PlanAssignmentWithExercise` (ejercicio + zona + equipo) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/PlanAssignmentDao.kt`

### Fase 3: Data Layer — Seed Data (ADR-11)

> Basado en Hito #3 del Análisis Arquitectónico

- [ ] **Crear ModuleSeeder** (AC: 03.01)
  - [ ] Inserta en orden: (a) 3 filas en `module` (Modelo de Datos §3.1 seed data), (b) 15 filas en `muscle_zone` (§3.2 seed data), (c) 9 filas en `equipment_type` (§3.3 seed data). Usa DAOs inyectados. Todos los datos literales en español con acentos (fuente: Modelo de Datos) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/ModuleSeeder.kt`

- [ ] **Crear ExerciseSeeder** (AC: 03.01, 03.02)
  - [ ] Inserta: (a) 43 filas en `exercise` (Modelo de Datos §3.4 seed data) con `media_resource` = nombre normalizado del ejercicio + equipo (ver tabla completa en §16 Assets Multimedia, ej: `"press_de_banca_maquina"` para "Press de banca" + "Máquina"). Implementar función de normalización: lowercase → strip acentos → espacios a underscores → eliminar paréntesis. Flags booleanos según tabla, referenciando module_code y equipment_type_id correctos; (b) 48 filas en `exercise_muscle_zone` (§3.5). Los 5 ejercicios multi-zona del Módulo C generan 2 filas cada uno. **Los IDs deben coincidir con la posición de inserción ya que Room usa AUTOINCREMENT**. Ejercicios bodyweight: Flexiones (is_bodyweight=1, is_to_technical_failure=1), Abdominales/Escalador/Giro Ruso/Sentadilla Cuerpo (is_bodyweight=1), Plancha/Plancha Lateral (is_bodyweight=1, is_isometric=1). Nombres con acentos normalizados del Modelo de Datos: "Curl de bíceps", "Dominada de tríceps banco", "Elevación frontal", "Sentadilla Búlgara Dividida", "Zancada hacia atrás" — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/ExerciseSeeder.kt`

- [ ] **Crear PlanSeeder** (AC: 03.01 indirect — atomicidad ADR-11)
  - [ ] Inserta: (a) 9 filas en `module_version` (§3.6), (b) 93 filas en `plan_assignment` (Plan de Entrenamiento completo). Mapea `reps`: `"8-12"` estándar, `"TO_TECHNICAL_FAILURE"` para Flexiones, `"30-45_SEC"` para Plancha/Plancha Lateral. `sets` siempre = 4 — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/PlanSeeder.kt`

- [ ] **Crear PrepopulateFacade** (AC: 03.01)
  - [ ] Orquesta la invocación secuencial: (1) `ModuleSeeder`, (2) `ExerciseSeeder`, (3) `PlanSeeder`. Respeta dependencias FK. No incluye `RotationSeeder` (se inicializa con el perfil en HU-01) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/PrepopulateFacade.kt`

- [ ] **Crear PrepopulateCallback** (AC: 03.01)
  - [ ] Implementa `RoomDatabase.Callback`. En `onCreate(db)` ejecuta `PrepopulateFacade.populate()` dentro de una transacción atómica (`withTransaction`). Si falla, se revierte todo — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/PrepopulateCallback.kt`

### Fase 4: Data Layer — Database y DI

> Basado en Hito #4 del Análisis Arquitectónico

- [ ] **Actualizar TensionDatabase** (AC: 03.01)
  - [ ] Agregar 7 entities al array: `ModuleEntity`, `MuscleZoneEntity`, `EquipmentTypeEntity`, `ExerciseEntity`, `ExerciseMuscleZoneEntity`, `ModuleVersionEntity`, `PlanAssignmentEntity`. Incrementar `version = 2`. Exponer 6 DAOs abstractos: `exerciseDao()`, `moduleDao()`, `equipmentTypeDao()`, `muscleZoneDao()`, `moduleVersionDao()`, `planAssignmentDao()`. Se mantiene `fallbackToDestructiveMigration()` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/database/TensionDatabase.kt`

- [ ] **Actualizar DatabaseModule** (AC: 03.01)
  - [ ] Agregar `@Provides` para los 6 nuevos DAOs. Agregar `@Provides @Singleton` para `PrepopulateCallback`. Modificar `provideTensionDatabase()` para recibir `PrepopulateCallback` y registrarlo con `.addCallback(callback)` en el builder — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/di/DatabaseModule.kt`

- [ ] **Actualizar RepositoryModule** (AC: 03.02)
  - [ ] Agregar `@Binds @Singleton abstract fun bindExerciseRepository(impl: ExerciseRepositoryImpl): ExerciseRepository` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/di/RepositoryModule.kt`

### Fase 5: Domain Layer — Models, Repo Interface, Use Cases

> Basado en Hito #5 del Análisis Arquitectónico

#### 📦 Models

- [ ] **Crear Module** (AC: 03.03)
  - [ ] Data class: `code: String`, `name: String`, `groupDescription: String`, `loadIncrementKg: Double`. Kotlin puro — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/Module.kt`

- [ ] **Crear MuscleZone** (AC: 03.05)
  - [ ] Data class: `id: Long`, `name: String`, `muscleGroup: String`. Kotlin puro — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/MuscleZone.kt`

- [ ] **Crear EquipmentType** (AC: 03.04)
  - [ ] Data class: `id: Long`, `name: String`. Kotlin puro — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/EquipmentType.kt`

- [ ] **Crear Exercise** (AC: 03.02, 03.07)
  - [ ] Data class: `id: Long`, `name: String`, `moduleCode: String`, `moduleName: String`, `equipmentTypeName: String`, `muscleZones: List<String>`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isToTechnicalFailure: Boolean`, `isCustom: Boolean`, `mediaResource: String?`. Kotlin puro. `mediaResource` es nullable porque los ejercicios custom no tienen asset multimedia (CA-03.11) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/Exercise.kt`

#### 📦 Repository Interface

- [ ] **Crear ExerciseRepository** (AC: 03.02, 03.03, 03.04, 03.05, 03.07, 03.10, 03.11)
  - [ ] Interfaz Kotlin puro. 5 contratos de lectura: `getAllExercises(): Flow<List<Exercise>>`, `getExerciseById(id: Long): Flow<Exercise?>`, `getAllModules(): Flow<List<Module>>`, `getAllEquipmentTypes(): Flow<List<EquipmentType>>`, `getAllMuscleZones(): Flow<List<MuscleZone>>`. 3 contratos de escritura: `suspend fun createExercise(name: String, moduleCode: String, equipmentTypeId: Long, muscleZoneIds: List<Long>, isBodyweight: Boolean, isIsometric: Boolean, isToTechnicalFailure: Boolean, mediaResource: String?): Long`, `suspend fun updateExerciseImage(exerciseId: Long, mediaResource: String?)`, `suspend fun exerciseExistsByNameAndEquipment(name: String, equipmentTypeId: Long): Boolean` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/repository/ExerciseRepository.kt`

#### 📦 Use Cases

- [ ] **Crear GetExercisesUseCase** (AC: 03.02, 03.03, 03.04, 03.05, 03.06)
  - [ ] Inyecta `ExerciseRepository`. `operator fun invoke(): Flow<List<Exercise>>`. Delega a `exerciseRepository.getAllExercises()`. Lectura pura — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetExercisesUseCase.kt`
  - [ ] Test unitario: verifica delegación al repositorio, caso con lista completa, caso vacío — Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetExercisesUseCaseTest.kt`

- [ ] **Crear GetExerciseDetailUseCase** (AC: 03.07)
  - [ ] Inyecta `ExerciseRepository`. `operator fun invoke(exerciseId: Long): Flow<Exercise?>`. Delega a `exerciseRepository.getExerciseById(exerciseId)`. Lectura pura — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetExerciseDetailUseCase.kt`
  - [ ] Test unitario: verifica delegación, caso ejercicio encontrado, caso null — Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetExerciseDetailUseCaseTest.kt`

- [ ] **Crear GetFilterOptionsUseCase** (AC: 03.03, 03.04, 03.05)
  - [ ] Inyecta `ExerciseRepository`. `operator fun invoke(): Flow<FilterOptions>`. Usa `combine()` de `getAllModules()`, `getAllEquipmentTypes()`, `getAllMuscleZones()` para producir `FilterOptions(modules: List<Module>, equipmentTypes: List<EquipmentType>, muscleZones: List<MuscleZone>)`. `FilterOptions` se define como data class dentro del paquete `domain.model`. El ViewModel es responsable de transformar los modelos de dominio a listas de nombres (`List<String>`) para la UI — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetFilterOptionsUseCase.kt`
  - [ ] Test unitario: verifica combine de los 3 Flows — Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/catalog/GetFilterOptionsUseCaseTest.kt`

### Fase 6: Data Layer — Repository Implementation

> Basado en Hito #6 del Análisis Arquitectónico

- [ ] **Crear ExerciseRepositoryImpl** (AC: 03.02, 03.03, 03.04, 03.05, 03.07)
  - [ ] `@Inject constructor`. Inyecta `ExerciseDao`, `ModuleDao`, `EquipmentTypeDao`, `MuscleZoneDao`. Implementa `ExerciseRepository`. Mapea `ExerciseWithDetails` → `Exercise` (domain model). Para `muscleZones`: si DAO retorna GROUP_CONCAT, split por ", ". `getAllModules()` mapea `ModuleEntity` → `Module`. `getAllEquipmentTypes()` mapea `EquipmentTypeEntity` → `EquipmentType`. `getAllMuscleZones()` mapea `MuscleZoneEntity` → `MuscleZone` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/repository/ExerciseRepositoryImpl.kt`

### Fase 7: Assets Multimedia (43 PNGs)

> Basado en Hito #7 del Análisis Arquitectónico

- [ ] **Verificar assets existentes en assets/exercises/** (AC: 03.07, 03.09)
  - [ ] Los 43 archivos PNG ya existen en disco en `app/src/main/assets/exercises/` (15 en `module-a/`, 14 en `module-b/`, 14 en `module-c/`), nombrados según la convención de §16 (nombre + equipo normalizado). **No es necesario crear ni agregar archivos — ya están en el repositorio.** Verificar: (a) que los 43 archivos coincidan exacto con la tabla de §16 (nombres y ubicación por módulo), (b) que la resolución sea ≤ 720px de ancho, (c) que la compresión PNG esté optimizada para móvil. Medir tamaño del APK total — debe ser ≤ 150 MB (RNF24, CA-03.09). Si supera ~100 MB, considerar conversión a WebP estático — Directorio: `app/src/main/assets/exercises/`

### Fase 8: UI Layer — D1 Diccionario de Ejercicios + D3 Stub

> Basado en Hitos #8 del Análisis Arquitectónico

#### 📦 UiState

- [ ] **Crear ExerciseDictionaryUiState, ExerciseItem** (AC: 03.02, 03.03, 03.04, 03.05, 03.06)
  - [ ] `ExerciseDictionaryUiState`: data class con `isLoading: Boolean = true`, `exercises: List<ExerciseItem> = emptyList()` (lista filtrada), `totalCount: Int = 0` (total dinámico: precargados + creados por el ejecutante), `moduleOptions: List<String> = emptyList()` (códigos de módulo: "A", "B", "C"), `equipmentOptions: List<String> = emptyList()` (nombres de equipo), `muscleZoneOptions: List<String> = emptyList()` (nombres de zona), `selectedModule: String? = null` (null = Todos), `selectedEquipment: String? = null`, `selectedMuscleZone: String? = null`. `ExerciseItem`: data class con `id: Long`, `name: String`, `moduleCode: String`, `equipmentTypeName: String`, `muscleZonesSummary: String` (zonas concatenadas con ", "), `isCustom: Boolean` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDictionaryUiState.kt`

#### 📦 ViewModel

- [ ] **Crear ExerciseDictionaryViewModel** (AC: 03.02, 03.03, 03.04, 03.05, 03.06)
  - [ ] `@HiltViewModel`. Inyecta `GetExercisesUseCase`, `GetFilterOptionsUseCase`. En `init`, usa `combine()` entre el Flow de ejercicios, Flow de opciones de filtro, y 3 `MutableStateFlow<String?>` internos para los filtros seleccionados, para producir `ExerciseDictionaryUiState` reactivamente. El filtrado en memoria: filtra `exercises` por `moduleCode == selectedModule` (si no null), por `equipmentTypeName == selectedEquipment` (si no null), y por `muscleZones.any { it == selectedMuscleZone }` (si no null). CA-03.06 se cumple porque los 3 filtros son AND. Funciones: `onModuleFilterSelected(code: String?)`, `onEquipmentFilterSelected(name: String?)`, `onMuscleZoneFilterSelected(name: String?)` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDictionaryViewModel.kt`

#### 📦 Screen D1

- [ ] **Crear ExerciseDictionaryScreen** (AC: 03.01, 03.02, 03.03, 03.04, 03.05, 03.06)
  - [ ] Composable de nivel pantalla. Firma: `fun ExerciseDictionaryScreen(onNavigateToExerciseDetail: (Long) -> Unit, onNavigateToTrainingPlan: () -> Unit, onNavigateToCreateExercise: () -> Unit, viewModel: ExerciseDictionaryViewModel = hiltViewModel())`. Recolecta `uiState` con `collectAsStateWithLifecycle()`. Estructura según Wireframes D1 y Especificación Visual §8 D1:
    - **Scaffold con TopBar**: `CenterAlignedTopAppBar` sin retorno. Título "Diccionario" (Title Large, On Surface). Debajo: `TabRow` M3 (Primary Tabs) con 2 tabs: "Ejercicios" (activo, selectedTabIndex = 0) y "Plan" (onClick -> `onNavigateToTrainingPlan()`). Tab activo: texto Primary, indicador inferior Primary 3dp. Tab inactivo: texto On Surface Variant. Fondo TabRow: Surface Container Lowest.
    - **3 dropdowns de filtro en 1 fila**: `Row` con 3 × `ExposedDropdownMenuBox` M3. Dropdown 1 — Módulo: label "Módulo", opciones "Todos" + "A", "B", "C". Dropdown 2 — Equipo: label "Equipo", opciones "Todos" + 9 tipos. Dropdown 3 — Zona muscular: label "Zona", opciones "Todos" + zonas del `filterOptions`. Cada dropdown: `OutlinedTextField` read-only con label flotante, trailing icon flecha desplegable, texto valor 13 sp, singleLine, borde Outline Variant. Cada uno con `weight(1f)`, spacing 8 dp. Padding horizontal 16 dp, vertical 8 dp.
    - **Contador**: `Text` Body Small, On Surface Variant: "Mostrando N de T ejercicios" (T = total en diccionario, dinámico). Padding top 12dp, bottom 8dp.
    - **Lista**: `LazyColumn`. Cada fila: `ListItem` M3 72dp. `headlineContent`: Title Medium, On Surface (nombre). `supportingContent`: Body Medium, On Surface Variant — formato "Módulo X · EquipoName · Zona1, Zona2". Para ejercicios con `isCustom = true`, mostrar badge "Personalizado" (Label Small, On Tertiary Container, fondo Tertiary Container, corner 4 dp) junto al nombre. `HorizontalDivider` 1dp Outline Variant. Clickable → `onNavigateToExerciseDetail(exercise.id)`.
    - **FAB crear ejercicio** (CA-03.10 — IMPLEMENTADO): `FloatingActionButton` M3, ícono Add (24 dp), containerColor Primary Container, contentColor On Primary Container, posición bottom-end margin 16 dp. El FAB navega a D5 (`CreateExerciseScreen`) vía `onNavigateToCreateExercise`. Alineado con Wireframes D1 #8 y Especificación Visual §8 D1.
    - **Estado sin resultados**: Column centrada. Body Large, On Surface Variant. "No hay ejercicios que coincidan con los filtros seleccionados." Padding vertical 48dp.
    - Sin Bottom Nav (ya en Scaffold del NavHost).
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDictionaryScreen.kt`

#### 📦 D3 Stub

- [ ] **Crear TrainingPlanScreen stub** (para navegación tabs D1 ↔ D3)
  - [ ] Composable stub. Firma: `fun TrainingPlanScreen(onNavigateToExerciseDictionary: () -> Unit, onNavigateToPlanVersionDetail: (Long) -> Unit)`. Same TopBar structure as D1 but with "Plan" tab active (selectedTabIndex = 1). Body: placeholder text "Próximamente". Sin Bottom Nav (ya en NavHost) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/TrainingPlanScreen.kt`

#### 📦 D5 — Crear Ejercicio

- [ ] **Crear CreateExerciseUiState** (AC: 03.10)
  - [ ] Data class con campos: `isLoading`, `name`, `modules: List<Module>`, `selectedModuleCode`, `equipmentTypes: List<EquipmentType>`, `selectedEquipmentTypeId`, `muscleZones: List<MuscleZone>`, `selectedMuscleZoneIds: Set<Long>`, `isBodyweight`, `isIsometric`, `isToTechnicalFailure`, `imageUri: String?`, `isSaving`, `nameError`, `moduleError`, `equipmentError`, `muscleZoneError`, `saveSuccess`, `saveError`. Computed: `selectedModuleName`, `selectedEquipmentName`, `canSave` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/CreateExerciseUiState.kt`

- [ ] **Crear CreateExerciseViewModel** (AC: 03.10, 03.11)
  - [ ] `@HiltViewModel`. Inyecta `GetFilterOptionsUseCase`, `CreateExerciseUseCase`, `ImageStorageHelper`. Carga opciones via `getFilterOptionsUseCase().first()`. Funciones: `onNameChanged`, `onModuleSelected`, `onEquipmentTypeSelected`, `onMuscleZoneToggled`, `onBodyweightChanged`, `onIsometricChanged`, `onToTechnicalFailureChanged`, `onImageSelected(uri: Uri?)` (usa `ImageStorageHelper.saveImageToInternal()`, elimina imagen previa vía `deleteImageIfInternal()`), `onSave` (valida y ejecuta `createExerciseUseCase`), `onDismissSaveError` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/CreateExerciseViewModel.kt`

- [ ] **Crear CreateExerciseScreen** (AC: 03.10, 03.11)
  - [ ] Composable con formulario completo: imagen opcional (galería, logo placeholder), nombre, módulo dropdown, equipo dropdown, zonas musculares FlowRow de FilterChip, condiciones especiales (3 checkboxes), botón Crear. Al éxito → `onNavigateBack()` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/CreateExerciseScreen.kt`

### Fase 9: UI Layer — D2 Detalle de Ejercicio + F3 Stub

> Basado en Hito #9 del Análisis Arquitectónico

#### 📦 UiState D2

- [ ] **Crear ExerciseDetailUiState** (AC: 03.07, 03.11)
  - [ ] Sealed interface: `Loading`, `Success(exercise: ExerciseDetailItem)`, `Error(message: String)`. `ExerciseDetailItem`: data class con `id: Long`, `name: String`, `moduleCode: String`, `moduleName: String` (formato "A — Superior"), `equipmentTypeName: String`, `muscleZones: String` (concatenadas con ", "), `isCustom: Boolean`, `mediaResource: String?`. El `moduleCode` se requiere para construir la ruta del asset en `assets/exercises/module-{code}/`. Si `mediaResource` es null, se muestra el logo de la app como placeholder con ícono `AddAPhoto` y texto "Toca para agregar imagen" (CA-03.11) — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDetailUiState.kt`

#### 📦 ViewModel D2

- [ ] **Crear ExerciseDetailViewModel** (AC: 03.07, 03.11)
  - [ ] `@HiltViewModel`. Recibe `exerciseId: Long` via `SavedStateHandle`. Inyecta `GetExerciseDetailUseCase`, `UpdateExerciseImageUseCase`, `ImageStorageHelper`. En `init`, recolecta Flow y transforma a `ExerciseDetailUiState`. Función `onImageSelected(uri: Uri?)`: usa `ImageStorageHelper.saveImageToInternal()` para copiar imagen, elimina imagen anterior vía `deleteImageIfInternal()`, luego invoca `updateExerciseImageUseCase(exerciseId, savedPath)`. El Flow reactivo actualiza el UI automáticamente tras el cambio en BD. Expone `val uiState: StateFlow<ExerciseDetailUiState>`. Estado inicial: `Loading` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDetailViewModel.kt`

#### 📦 Screen D2

- [ ] **Crear ExerciseDetailScreen** (AC: 03.07, 03.08, 03.11)
  - [ ] Composable. Firma: `fun ExerciseDetailScreen(onNavigateBack: () -> Unit, onNavigateToExerciseHistory: (Long) -> Unit, viewModel: ExerciseDetailViewModel = hiltViewModel())`. Recolecta `uiState`. Crea `imagePickerLauncher` via `rememberLauncherForActivityResult(GetContent) { viewModel.onImageSelected(it) }`. Estructura según Wireframes D2 y Especificación Visual §8 D2:
    - **TopBar**: `TensionTopAppBar` con retorno + título dinámico (nombre del ejercicio).
    - **Media visual**: `Box` clickable (al tocar → `imagePickerLauncher.launch("image/*")`) con height 240dp, full width. **Lógica de carga** en `@Composable rememberExerciseBitmap(moduleCode, mediaResource)`: Si `mediaResource` no es null, primero intenta como ruta de archivo absoluta (imágenes custom en almacenamiento interno); si falla, intenta como ruta de asset `assets/exercises/module-{code}/{mediaResource}.png`. Si `mediaResource` es null o la carga falla: muestra el logo de la app como placeholder con ícono `AddAPhoto` 24dp y texto "Toca para agregar imagen" (CA-03.11). **Overlay ícono**: en esquina inferior derecha, ícono `AddAPhoto` 24dp semi-transparente (alpha 0.7) para indicar que la imagen es editable. ContentScale.Crop, corner radius top 12dp, bottom 0.
    - **4 campos informativos**: Column con padding horizontal 16dp. Cada campo: `overlineContent` Label Medium, On Surface Variant + `headlineContent` Body Large, On Surface.
    - **Enlace F3**: Text Button "Ver historial de este ejercicio →", color Primary, margin top 24dp. onClick → `onNavigateToExerciseHistory(exerciseId)`.
    - Sin Bottom Nav dentro del Screen (ya en NavHost).
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/catalog/ExerciseDetailScreen.kt`

#### 📦 F3 Stub

- [ ] **Crear ExerciseHistoryScreen stub** (AC: 03.08 — preparar ruta para HU-23)
  - [ ] Composable stub. `TensionTopAppBar` con retorno + título "Historial de Ejercicio". Body placeholder "Próximamente". La lógica completa se implementa en HU-23 — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/history/ExerciseHistoryScreen.kt`

### Fase 10: Navigation + BottomNavigationBar + Strings

> Basado en Hito #10 del Análisis Arquitectónico

#### 📦 NavigationRoutes

- [ ] **Agregar rutas nuevas** (AC: 03.02, 03.07)
  - [ ] Agregar constantes: `EXERCISE_DETAIL = "exercise-detail/{exerciseId}"`, `TRAINING_PLAN = "training-plan"`, `EXERCISE_HISTORY = "exercise-history/{exerciseId}"`. Helper functions opcionales para construir rutas con argumentos: `fun exerciseDetailRoute(id: Long) = "exercise-detail/$id"`, `fun exerciseHistoryRoute(id: Long) = "exercise-history/$id"` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/navigation/NavigationRoutes.kt`

#### 📦 TensionNavHost

- [ ] **Actualizar NavHost** (AC: 03.02, 03.07)
  - [ ] Reemplazar `PlaceholderScreen` de `EXERCISE_DICTIONARY` con `ExerciseDictionaryScreen(onNavigateToExerciseDetail, onNavigateToTrainingPlan, onNavigateToCreateExercise)`. Agregar composable para `EXERCISE_DETAIL` con argumento. Agregar composable para `CREATE_EXERCISE` → `CreateExerciseScreen(onNavigateBack = { navController.popBackStack() })`. Agregar composable para `TRAINING_PLAN`. Agregar composable para `EXERCISE_HISTORY` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/navigation/TensionNavHost.kt`

#### 📦 BottomNavigationBar

- [ ] **Extender lógica de selección para rutas con argumentos** (AC: 03.02, 03.10)
  - [ ] Para el ítem Diccionario: `childRoutes = setOf("training-plan", "create-exercise")` + `childRoutePrefixes = setOf("exercise-detail", "exercise-history", "plan-version-detail")`. La evaluación `selected` queda: `currentRoute == item.route || currentRoute in item.childRoutes || item.childRoutePrefixes.any { prefix -> currentRoute?.startsWith(prefix) == true }` — Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/components/BottomNavigationBar.kt`

#### 📦 Strings

- [ ] **Actualizar strings.xml** (AC: 03.01, 03.02, 03.07, 03.10, 03.11)
  - [ ] **Corregir**: `nav_dictionary` de "Ejercicios" a "Diccionario". **Corregir**: `nav_settings` de "Ajustes" a "Configuración".
  - [ ] **Agregar sección D1**: `dictionary_title`, `tab_exercises`, `tab_plan`, `filter_all`, `filter_module`, `filter_equipment`, `filter_muscle_zone`, `exercise_count_format`, `no_exercises_match`, `exercise_supporting_format`, `badge_custom`, `fab_create_exercise`
  - [ ] **Agregar sección D2**: `exercise_field_name`, `exercise_field_module`, `exercise_field_equipment`, `exercise_field_muscle_zone`, `exercise_history_link`, `exercise_media_description`, `change_image_description`, `add_image_description`, `tap_to_add_image`
  - [ ] **Agregar sección D5**: `create_exercise_title`, `create_exercise_button`, `image_optional_hint`, `special_conditions_label`, `bodyweight_label`, `isometric_label`, `technical_failure_label`
  - [ ] **Agregar sección F3 stub**: `exercise_history_title`
  - Archivo: `app/src/main/res/values/strings.xml`

### Fase 11: QA y Deployment

#### 📦 Code Quality

- [ ] **Ejecutar Agente Peer Review** — MANUAL
- [ ] **Resolver incidentes del Peer Review** (condicional) — MANUAL

#### 📦 Deployment DEV

- [ ] **Crear Pull Request** — MANUAL
- [ ] **Ejecutar pipeline deployment DEV** — MANUAL

#### 📦 Testing Manual

- [ ] **Diseñar set de pruebas manuales** — MANUAL
- [ ] **Ejecutar pruebas manuales** — MANUAL

---

**Notas sobre vinculación con Criterios de Aceptación:**

- CA-03.01 → Fases 1, 2, 3, 4 (Entities + DAOs + Seed 220 filas + Database/DI)
- CA-03.02 → Fases 5, 6, 8, 10 (Models + Repo + D1 Screen con exercise info + NavHost)
- CA-03.03 → Fase 8 (ViewModel filtro por módulo con chips "Todos"/"A"/"B"/"C")
- CA-03.04 → Fase 8 (ViewModel filtro por equipo con chips "Todos" + 9 tipos)
- CA-03.05 → Fase 8 (ViewModel filtro por zona con chips "Todos" + 15 zonas)
- CA-03.06 → Fase 8 (ViewModel `combine` de 3 filtros = AND lógico)
- CA-03.07 → Fases 7, 9 (43 PNGs en assets/exercises/ + D2 Screen con media visual)
- CA-03.08 → Fase 9 (D2 es reutilizable; integración desde E1 se completa en HU-05/HU-06)
- CA-03.09 → Fase 7 (verificación de PNGs existentes, APK ≤ 150 MB)
- CA-03.10 → Fases 2, 5, 6, 8, 10 (DAO insert/countByNameAndEquipment + CreateExerciseUseCase + ExerciseRepository.createExercise + D5 CreateExerciseScreen + Navigation CREATE_EXERCISE)
- CA-03.11 → Fases 5, 6, 9 (UpdateExerciseImageUseCase + ExerciseRepository.updateExerciseImage + D2 image picker con logo placeholder + D5 imagen opcional)
