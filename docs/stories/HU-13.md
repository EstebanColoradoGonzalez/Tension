# HU-13 ‚Äî Mostrar resumen post-sesi√≥n con se√±ales de acci√≥n

## Requisitos relacionados

RF59, RNF05

## Descripci√≥n

Como ejecutante, quiero ver un resumen claro e inmediato al cerrar mi sesi√≥n con el tonelaje, la clasificaci√≥n de progresi√≥n por ejercicio y las se√±ales de acci√≥n para la pr√≥xima sesi√≥n, para saber en ese mismo momento qu√© hice bien, d√≥nde retroced√≠ y qu√© ajustar la pr√≥xima vez.

## Criterios de Aceptaci√≥n

### CA-13.01 ‚Äî Presentaci√≥n autom√°tica del resumen al cerrar

**Dado que** el ejecutante cierra una sesi√≥n (Completada o Incompleta),
**cuando** el sistema completa el procesamiento de cierre (c√°lculo de tonelaje, evaluaci√≥n de progresi√≥n, actualizaci√≥n de rotaci√≥n),
**entonces** presenta autom√°ticamente un resumen de la sesi√≥n al ejecutante sin requerir navegaci√≥n adicional.

### CA-13.02 ‚Äî Contenido del resumen: tonelaje total

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra el tonelaje total de la sesi√≥n (Œ£ Peso √ó Repeticiones de todas las series registradas), expresado en kilogramos.

### CA-13.03 ‚Äî Contenido del resumen: ejercicios completados

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra la cantidad de ejercicios completados (4 series registradas) respecto al total de ejercicios de la sesi√≥n (ej: "8/11 ejercicios completados").

### CA-13.04 ‚Äî Contenido del resumen: clasificaci√≥n de progresi√≥n por ejercicio

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra para cada ejercicio registrado en la sesi√≥n su clasificaci√≥n de progresi√≥n: "Progresi√≥n positiva", "Mantenimiento" o "Regresi√≥n", junto con el nombre del ejercicio.

### CA-13.05 ‚Äî Contenido del resumen: se√±ales de acci√≥n

**Dado que** el resumen post-sesi√≥n se presenta al ejecutante,
**cuando** el ejecutante visualiza el resumen,
**entonces** muestra para cada ejercicio la se√±al de acci√≥n para la pr√≥xima sesi√≥n: "Subir carga" (si cumpli√≥ Doble Umbral), "Mantener carga" (si no cumpli√≥) o "Considerar descarga" (si se detect√≥ regresi√≥n o fatiga acumulada).

### CA-13.06 ‚Äî Se√±ales visualmente distinguibles

**Dado que** el resumen muestra clasificaciones de progresi√≥n y se√±ales de acci√≥n,
**cuando** el ejecutante visualiza el resumen,
**entonces** las se√±ales de progresi√≥n (‚Üë Progresi√≥n, = Mantenimiento, ‚Üì Regresi√≥n) son visualmente distinguibles mediante colores e iconograf√≠a diferenciada, sin depender √∫nicamente del texto para transmitir su significado.

### CA-13.07 ‚Äî Resumen de sesi√≥n incompleta

**Dado que** el ejecutante cierra una sesi√≥n como "Incompleta",
**cuando** el sistema presenta el resumen,
**entonces** muestra el estado "Incompleta", el tonelaje parcial calculado con las series registradas, la clasificaci√≥n de progresi√≥n solo para los ejercicios que tienen registros, y las se√±ales de acci√≥n correspondientes.

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** MVVM de solo lectura con derivaci√≥n de se√±ales en el dominio.

**Justificaci√≥n:** HU-13 es una historia 100% de lectura ‚Äî no escribe datos. Toda la informaci√≥n que necesita E5 ya fue persistida por las HUs predecesoras: HU-09 (cierre de sesi√≥n y tonelaje), HU-10 (clasificaci√≥n de progresi√≥n en `session_exercise.progression_classification`), HU-11 (carga prescrita en `exercise_progression.prescribed_load_kg`), HU-12 (alertas de meseta y descarga en tabla `alert`). El flujo es lineal: queries agregadas en Data ‚Üí enriquecimiento con l√≥gica de se√±ales en Domain ‚Üí presentaci√≥n visual en UI. La pieza arquitect√≥nicamente m√°s relevante es la regla pura `ActionSignalRule` que encapsula la derivaci√≥n de se√±ales de acci√≥n, incluyendo la ruta de "Considerar descarga" definida en HU-12 Decisi√≥n 13.

### Decisiones Fundamentadas

**1. HU-13 es una historia de lectura pura ‚Äî no modifica ning√∫n dato.**

E5 se presenta despu√©s del cierre de sesi√≥n (`closeSession()` de HU-09). En ese punto, todos los datos ya fueron persistidos: `session.status` (HU-09), `session_exercise.progression_classification` (HU-10), `exercise_progression.prescribed_load_kg` (HU-11), alertas en tabla `alert` (HU-12). HU-13 solo los lee, enriquece con la regla `ActionSignalRule` y los presenta visualmente. No inserta, actualiza ni elimina registros.

**2. El tonelaje se calcula en la query, no se almacena.**

El Modelo de Datos ¬ß3.10 establece expl√≠citamente: "El tonelaje total de la sesi√≥n no se almacena ‚Äî se calcula como `SUM(exercise_set.weight_kg * exercise_set.reps)` desde las series asociadas v√≠a `session_exercise`." La query `getSessionSummaryInfo()` computa el tonelaje como agregaci√≥n SQL, evitando una columna derivada en la tabla `session`.

**3. `ActionSignalRule` es una funci√≥n pura en `domain/rules/` siguiendo ADR-06.**

Encapsula siete variantes de se√±al (sealed interface `ActionSignal`) con l√≥gica determinista, m√°s un caso edge para ejercicios sin historial (`FirstSession`). La regla recibe `classification: ProgressionClassification?`, `prescribedLoadKg: Double?`, `avgWeightKg: Double`, `moduleRequiresDeload: Boolean`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `totalReps: Int`, `previousTotalReps: Int?`, `setCount: Int`, `isMastered: Boolean`.

**Variantes para ejercicios est√°ndar (con peso):**
- **`IncreaseLoad(targetKg)`** ‚Äî DU cumplido: `prescribedLoadKg > avgWeightKg`. Texto: "Subir carga ‚Üí X Kg".
- **`ProgressInReps`** ‚Äî DU NO cumplido + clasificaci√≥n `POSITIVE_PROGRESSION`. Texto: "Progresar en reps (misma carga)" (RF27). Distingue progresi√≥n de reps sin haber alcanzado DU.
- **`MaintainLoad`** ‚Äî DU NO cumplido + clasificaci√≥n `MAINTENANCE` o `REGRESSION` aislada (sin alerta de m√≥dulo). Texto: "Mantener carga ‚Äî progresar en reps" (si MAINTENANCE) o "Mantener carga" (si REGRESSION aislada).
- **`ConsiderDeload`** ‚Äî DU NO cumplido + clasificaci√≥n `REGRESSION` **Y** alerta activa `MODULE_REQUIRES_DELOAD` para el m√≥dulo. Texto: "Considerar descarga". **Solo aplica a ejercicios est√°ndar** ‚Äî para bodyweight/isom√©tricos con regresi√≥n, las se√±ales tipo-espec√≠ficas se mantienen y el alerta MODULE_REQUIRES_DELOAD se surfacea v√≠a H1/H2.

**Variantes para ejercicios de peso corporal:**
- **`BodyweightSignal(totalReps, diff)`** ‚Äî Texto: "N reps totales (+diferencia)" / "(=)" / "(‚àídiferencia)" seg√∫n clasificaci√≥n.

**Variantes para ejercicios isom√©tricos:**
- **`IsometricSignal(setCount, avgSeconds, mastered)`** ‚Äî Texto: "{setCount}√ó{avgSeconds}s ‚Äî Progresando/Manteniendo/Regresando". `avgSeconds = totalReps / setCount`.
- **`IsometricMastered`** ‚Äî Texto: "4√ó45s ‚Äî üèÜ Dominado". Cuando `isMastered == true` (CA-08.07: `exercise_progression.status == 'MASTERED'`).

La regla no depende de Android ‚Äî es testeable con JUnit puro (RNF29, RNF30).

**Pseudoc√≥digo de `ActionSignalRule.resolve()`:**

```
Si classification == null ‚Üí FirstSession ("Primera sesi√≥n ‚Äî sin referencia")

Si isIsometric:
  Si isMastered ‚Üí IsometricMastered
  Else ‚Üí IsometricSignal(setCount, avgSeconds = totalReps/setCount, mastered=false)

Si isBodyweight:
  ‚Üí BodyweightSignal(totalReps, diff = totalReps - previousTotalReps)

Si est√°ndar:
  Si prescribedLoadKg > avgWeightKg ‚Üí IncreaseLoad(prescribedLoadKg)
  Si classification == REGRESSION && moduleRequiresDeload ‚Üí ConsiderDeload
  Si classification == POSITIVE_PROGRESSION ‚Üí ProgressInReps
  Si classification == MAINTENANCE ‚Üí MaintainLoad (texto: "Mantener carga ‚Äî progresar en reps")
  Si classification == REGRESSION (aislada) ‚Üí MaintainLoad (texto: "Mantener carga")
```

**4. La derivaci√≥n de "Considerar descarga" consume datos de HU-12 sin recalcular y solo aplica a ejercicios est√°ndar.**

HU-12 Decisi√≥n 13 establece la ruta: E5 muestra "Considerar descarga" cuando `session_exercise.progression_classification == 'REGRESSION'` **Y** `alertDao.existsActiveByModule(moduleCode, "MODULE_REQUIRES_DELOAD")` retorna `true`. HU-13 encapsula esta l√≥gica en `ActionSignalRule.resolve()` que recibe un boolean `moduleRequiresDeload` ya resuelto por la query. **Esta se√±al solo aplica a ejercicios est√°ndar (con peso).** Para ejercicios de peso corporal con regresi√≥n, E5 muestra "N reps totales (‚àídiferencia)"; para isom√©tricos con regresi√≥n, E5 muestra "N√óXs ‚Äî Regresando" ‚Äî en ambos casos, la se√±al tipo-espec√≠fica se mantiene independientemente del estado MODULE_REQUIRES_DELOAD del m√≥dulo. El alerta de m√≥dulo se surfacea al ejecutante v√≠a las pantallas de alertas (H1/H2, HU-17), no v√≠a las se√±ales individuales de bodyweight/isom√©tricos en E5. Si solo hay regresi√≥n aislada sin alerta de m√≥dulo en un ejercicio est√°ndar, E5 muestra "‚Üì Regresi√≥n" con se√±al "Mantener carga", no "Considerar descarga". Fuente de verdad: Especificaci√≥n Visual ¬ßE5 tabla "Se√±ales de acci√≥n por tipo".

**5. Solo se muestran ejercicios con al menos 1 serie registrada.**

CA-13.07 especifica: "clasificaci√≥n de progresi√≥n solo para los ejercicios que tienen registros". La query filtra con `HAVING completedSets > 0`. Los ejercicios sin series no aparecen en la lista ‚Äî no hay datos para calcular progresi√≥n ni se√±ales. El wireframe E5 confirma: "Los ejercicios sin ning√∫n registro no aparecen en la lista".

**6. `ProgressionIndicator` es un composable reutilizable para E5, F2 y F3.**

La combinaci√≥n √≠cono (‚Üë/=/‚Üì) + color sem√°ntico + texto clasificaci√≥n se repite en tres pantallas (E5, F2, F3). Se extrae como componente `ProgressionIndicator` en `ui/components/` que recibe la clasificaci√≥n como par√°metro y renderiza la tr√≠ada visual correcta. Los colores se toman de `LocalTensionSemanticColors.current` (ya definidos en `Color.kt` y expuestos en `Theme.kt`).

**7. La navegaci√≥n E5 ‚Üí F3 (historial de ejercicio) se condiciona a la existencia de la ruta.**

F3 pertenece a HU-16 que a√∫n no est√° implementada. La ruta `exercise-history/{exerciseId}` ya existe en `NavigationRoutes.kt`. El click en cada ejercicio intenta navegar a F3; si la pantalla a√∫n no tiene composable registrado, se mantiene como placeholder. No se bloquea la funcionalidad de E5 por dependencia de F3.

**8. `SessionSummaryViewModel` recibe `sessionId` via `SavedStateHandle`.**

El `sessionId` se pasa como argumento de navegaci√≥n en la ruta `session-summary/{sessionId}`. El ViewModel lo extrae de `SavedStateHandle` (patr√≥n est√°ndar en el proyecto, usado en `ActiveSessionViewModel`). Esto evita pasar el ID manualmente y soporta process death/recreation.

**9. La sesi√≥n con 0 ejercicios registrados se maneja como edge case.**

Si una sesi√≥n se cierra como "Incompleta" sin ninguna serie registrada (caso extremo pero posible), E5 muestra: Card de estado "Incompleta ‚ö†Ô∏è", tonelaje 0 Kg, "0/N ejercicios", y lista vac√≠a. No se muestra mensaje de error ‚Äî es un resumen leg√≠timo de una sesi√≥n vac√≠a.

**10. E5 no tiene Bottom Navigation ni bot√≥n de retorno.**

Wireframe E5 y Especificaci√≥n Visual ¬ßE5 confirman: `CenterAlignedTopAppBar` sin `navigationIcon` (no hay retorno), sin Bottom Navigation. La √∫nica salida es el bot√≥n "Ir al Inicio" que navega a B1 con `popUpTo(HOME) { inclusive = true }`, limpiando el back stack del flujo de sesi√≥n.

**Componentes Afectados:**

**Componentes nuevos:**

| # | Componente | Capa | Responsabilidad |
|---|---|---|---|
| 1 | `ActionSignal` | Domain (model) | Sealed interface con 7 variantes de se√±al de acci√≥n: `IncreaseLoad`, `ProgressInReps`, `MaintainLoad`, `ConsiderDeload`, `BodyweightSignal`, `IsometricSignal`, `IsometricMastered` + caso `FirstSession` para ejercicios sin historial |
| 2 | `ActionSignalRule` | Domain (rules) | Funci√≥n pura `resolve()`: recibe clasificaci√≥n + tipo de ejercicio + carga prescrita + estado de m√≥dulo ‚Üí retorna `ActionSignal`. Discrimina por tipo (bodyweight/isometric/standard) y luego por clasificaci√≥n + condici√≥n DU |
| 3 | `SessionSummary` | Domain (model) | Data class: metadata de sesi√≥n + lista de `ExerciseSummaryItem` |
| 4 | `ExerciseSummaryItem` | Domain (model) | Data class: nombre, clasificaci√≥n, se√±al de acci√≥n, peso/reps, tipo, mastered |
| 5 | `GetSessionSummaryUseCase` | Domain (usecase/session) | Orquesta Repository + `ActionSignalRule` por ejercicio ‚Üí `SessionSummary` |
| 6 | `SessionSummaryViewModel` | UI (session) | Carga datos v√≠a UseCase, expone `StateFlow<SessionSummaryUiState>` |
| 7 | `SessionSummaryUiState` | UI (session) | Sealed interface: `Loading`, `Success(summary)`, `Error(message)` |
| 8 | `SessionSummaryScreen` | UI (session) | Composable E5 completo: Card estado/tonelaje + lista de progresi√≥n + bot√≥n "Ir al Inicio" |
| 9 | `ProgressionIndicator` | UI (components) | Composable reutilizable: √≠cono + color + texto de clasificaci√≥n |

**Componentes modificados:**

| # | Componente | Modificaci√≥n | Nivel |
|---|---|---|---|
| 1 | `SessionRepository` | Agregar `getSessionSummaryData(sessionId): SessionSummaryData` | Menor |
| 2 | `SessionRepositoryImpl` | Implementar `getSessionSummaryData()`: combina queries de sesi√≥n, ejercicios, alerta MODULE_REQUIRES_DELOAD | Mayor |
| 3 | `SessionDao` | Agregar DTO `SessionSummaryInfo` + query `getSessionSummaryInfo(sessionId)`: status, m√≥dulo, versi√≥n, tonelaje, conteos de ejercicios | Menor |
| 4 | `SessionExerciseDao` | Agregar DTO `ExerciseSummaryDto` + query `getExercisesForSummary(sessionId)`: nombre, clasificaci√≥n, flags, carga prescrita, peso/reps actuales y previas | Mayor |
| 5 | `TensionNavHost` | Registrar composable E5 en ruta `session-summary/{sessionId}`, reemplazar TODO con navegaci√≥n real | Menor |

**Hitos de Implementaci√≥n:**

| # | Componente(s) | Descripci√≥n | Dependencias |
|---|---|---|---|
| 1 | Domain models + `ActionSignalRule` | `ActionSignal` (sealed interface: 5 variantes), `ExerciseSummaryItem`, `SessionSummary`, `ActionSignalRule` (object con funci√≥n `resolve()`) | Ninguna ‚Äî funciones puras sin dependencias externas |
| 2 | DAOs: DTOs y queries | `SessionSummaryInfo` DTO + `getSessionSummaryInfo()` en `SessionDao`, `ExerciseSummaryDto` + `getExercisesForSummary()` en `SessionExerciseDao` | Ninguna ‚Äî queries sobre tablas existentes |
| 3 | Repository + UseCase | Interfaz `SessionRepository.getSessionSummaryData()`, implementaci√≥n en `SessionRepositoryImpl`, `GetSessionSummaryUseCase` que aplica `ActionSignalRule` por ejercicio | Hitos 1 y 2 |
| 4 | ViewModel + UiState | `SessionSummaryUiState` (sealed), `SessionSummaryViewModel` con `SavedStateHandle` + `viewModelScope.launch` | Hito 3 |
| 5 | UI: Screen + componentes | `ProgressionIndicator` (reutilizable), `SessionSummaryScreen` (E5 completo con colores sem√°nticos) | Hito 4 |
| 6 | Navegaci√≥n | Actualizar `TensionNavHost`: registrar composable E5, reemplazar TODO con `navController.navigate(sessionSummaryRoute(sessionId))`, agregar click ‚Üí F3 | Hito 5 |

### Validaci√≥n de Impacto

**C√≥digo real verificado (paso 1.5):**

- `SessionRepositoryImpl.kt`: Ya inyecta `AlertDao` (HU-12). No necesita inyecci√≥n adicional. Constructor actual (l√≠nea 41-50) tiene todos los DAOs necesarios: `sessionDao`, `sessionExerciseDao`, `exerciseProgressionDao`, `alertDao`.
- `SessionDao.kt`: Tiene `getActiveSessionWithModuleVersion()` con DTO `ActiveSessionInfo` que incluye `moduleCode`, `versionNumber`, `totalExercises`, `completedExercises`. Se necesita una query similar pero para sesiones cerradas (por `sessionId` en vez de `status = 'IN_PROGRESS'`), con tonelaje agregado.
- `SessionExerciseDao.kt`: Tiene `getBySessionIdWithDetails()` que devuelve `SessionExerciseWithDetails` con `prescribedLoadKg`, `isBodyweight`, `isIsometric` ‚Äî pero NO incluye `progression_classification` ni reps previas. Se necesita una query nueva orientada al resumen.
- `ExerciseSetDao.kt`: Tiene `getLastHistoricalSets()` para obtener sets de la sesi√≥n anterior. Esta query se usar√° como subquery en la nueva query del resumen para obtener `previousTotalReps`.
- `AlertDao.kt`: Tiene `existsActiveByModule(moduleCode, type)` ‚Äî exactamente lo que necesita la derivaci√≥n de "Considerar descarga". No requiere modificaci√≥n.
- `NavigationRoutes.kt`: `SESSION_SUMMARY = "session-summary/{sessionId}"` ya definida (l√≠nea 20). `sessionSummaryRoute(sessionId)` helper ya existe (l√≠nea 28).
- `TensionNavHost.kt`: L√≠nea 264-267 tiene el TODO con navegaci√≥n temporal a HOME. Se reemplaza por la navegaci√≥n real y el composable.
- `ActiveSessionViewModel.kt`: `navigateToSessionSummary` emite `sessionId` al cerrar sesi√≥n exitosamente (l√≠nea 104). El event ya fluye correctamente.
- `Color.kt`: Todos los colores sem√°nticos necesarios ya definidos: `ProgressionPositiveLight/Dark`, `MaintenanceLight/Dark`, `RegressionLight/Dark`, `SessionCompletedLight/Dark`, `SessionIncompleteLight/Dark`.
- `Theme.kt`: `TensionSemanticColors` expone `progressionPositive`, `maintenance`, `regression`, `sessionCompleted`, `sessionIncomplete` via `LocalTensionSemanticColors`.
- `ProgressionClassification.kt`: Enum con `POSITIVE_PROGRESSION`, `MAINTENANCE`, `REGRESSION` ‚Äî ya implementado.

**An√°lisis de dependencias:**

- HU-13 depende de: HU-09 (sesi√≥n cerrada con status), HU-10 (clasificaci√≥n en `session_exercise.progression_classification`), HU-11 (carga prescrita en `exercise_progression.prescribed_load_kg`), HU-12 (alerta `MODULE_REQUIRES_DELOAD` en tabla `alert`).
- HU-13 alimenta: HU-16 (F3 ‚Äî click en ejercicio desde E5 navega a historial), HU-17 (patr√≥n de `ProgressionIndicator` reutilizable).
- HU-13 no modifica la base de datos ‚Äî solo lee datos ya persistidos por HUs 09-12.

**Impacto en performance:**

- `getSessionSummaryInfo()`: 1 SELECT con 2 subqueries de agregaci√≥n sobre m√°ximo 11 session_exercises y 44 exercise_sets. Despreciable.
- `getExercisesForSummary()`: JOIN triple con 2 subqueries anidadas por fila. M√°ximo 11 filas √ó 2 subqueries = 22 operaciones m√≠nimas sobre tablas indexadas. Despreciable para SQLite.
- `existsActiveByModule()`: Ya indexado por `is_active` (HU-12). Operaci√≥n O(1).
- Total: 3 queries en secuencia, todo fuera del hilo principal (coroutines). No bloquea UI.

**Cadena de invocaci√≥n:**

```
ActiveSessionViewModel.onCloseSessionConfirmed()
  ‚Üí closeSessionUseCase(sessionId)        [ya implementado]
  ‚Üí _navigateToSessionSummary.emit(id)    [ya implementado]
  ‚Üí TensionNavHost: navController.navigate(sessionSummaryRoute(id))  [HU-13: implementar]
  ‚Üí SessionSummaryScreen(sessionId)                                  [HU-13: nuevo]
    ‚Üí SessionSummaryViewModel.init { loadSummary(sessionId) }        [HU-13: nuevo]
      ‚Üí getSessionSummaryUseCase(sessionId)                          [HU-13: nuevo]
        ‚Üí sessionRepository.getSessionSummaryData(sessionId)         [HU-13: nuevo]
          ‚Üí sessionDao.getSessionSummaryInfo(sessionId)              [HU-13: nuevo query]
          ‚Üí sessionExerciseDao.getExercisesForSummary(sessionId)     [HU-13: nuevo query]
          ‚Üí alertDao.existsActiveByModule(moduleCode, "MODULE_...")   [ya existe, HU-12]
        ‚Üí ActionSignalRule.resolve(dto, moduleRequiresDeload)         [HU-13: nuevo]
```

### Notas T√©cnicas

**Nota 1 ‚Äî La query de `previousTotalReps` reutiliza el patr√≥n de `getLastHistoricalSets()`.**

`ExerciseSetDao.getLastHistoricalSets()` (HU-10) usa la misma subquery para encontrar la sesi√≥n anterior de un ejercicio: `SELECT se2.id FROM session_exercise se2 INNER JOIN session s2 ... WHERE se2.exercise_id = ? AND s2.id != ? AND s2.status IN ('COMPLETED', 'INCOMPLETE') ORDER BY s2.date DESC, s2.id DESC LIMIT 1`. La query del resumen reutiliza este patr√≥n como subquery anidada para obtener `SUM(reps)` de la sesi√≥n anterior, evitando una llamada separada por ejercicio.

**Nota 2 ‚Äî `SessionSummaryData` es un modelo intermedio entre Data y Domain.**

El Repository retorna `SessionSummaryData` con DTOs crudos (strings para clasificaci√≥n, nullable para prescribed_load). El `GetSessionSummaryUseCase` lo transforma a `SessionSummary` con domain models (enum para clasificaci√≥n, sealed `ActionSignal`). Esta separaci√≥n permite que el Repository permanezca agn√≥stico a la l√≥gica de se√±ales y que la regla sea testeable independientemente.

**Nota 3 ‚Äî El √≠cono `‚Üë`/`=`/`‚Üì` no es un emoji ‚Äî es un car√°cter Unicode literal.**

La Especificaci√≥n Visual ¬ßE5 define los √≠conos como caracteres de texto 24dp con color sem√°ntico, no como `Icon()` de Material. Se implementan como `Text("‚Üë", fontSize = 24.sp, color = semanticColors.progressionPositive)` dentro de un `Box(modifier = Modifier.size(24.dp))` como `leadingContent` del `ListItem`.

**Nota 4 ‚Äî El formato de tonelaje usa separador de miles (ej: "12,450 Kg").**

La Especificaci√≥n Visual ¬ßE5 muestra "12,450 Kg" con separador de miles. Se formatea con `NumberFormat.getIntegerInstance(Locale("es", "ES"))`. El tonelaje es `Double` (puede tener decimales si `weight_kg` tiene decimales), pero se muestra como entero redondeado para legibilidad.

**Nota 5 ‚Äî Se√±ales de acci√≥n para ejercicios sin historial previo (`classification == null`).**

`session_exercise.progression_classification` es `NULL` cuando el ejercicio no tiene historial previo (primera sesi√≥n del ejercicio). CA-10.07 establece: "Sin Historial ‚Üí no se emite clasificaci√≥n". Para estos ejercicios, E5 muestra: sin √≠cono de clasificaci√≥n, sin color sem√°ntico, se√±al de acci√≥n "Primera sesi√≥n ‚Äî sin referencia". Esto cubre el edge case del primer uso del sistema.

**Nota 6 ‚Äî Diferencia entre `avgWeightKg` y `prescribedLoadKg` para derivar "Subir carga".**

La se√±al "Subir carga ‚Üí X Kg" se muestra cuando `prescribedLoadKg > avgWeightKg` (la carga prescrita por el Doble Umbral es superior a la carga actual). Si `prescribedLoadKg == avgWeightKg` o `prescribedLoadKg` es `null`, la se√±al es "Mantener carga". La comparaci√≥n se hace con tolerancia de 0.01 Kg (misma `WEIGHT_TOLERANCE` de `ProgressionClassificationRule`).

**Nota 7 ‚Äî Se√±ales para peso corporal e isom√©tricos no incluyen carga prescrita.**

Para ejercicios de peso corporal (`isBodyweight = true`), `exercise_progression.prescribed_load_kg` es `NULL` (nunca se prescribe carga ‚Äî Regla 6 del MDS). La se√±al muestra "N reps totales (+diferencia)" donde `diferencia = totalReps - previousTotalReps`. Para isom√©tricos (`isIsometric = true`), la se√±al muestra "{setCount}√ó{avgSeconds}s" (ej: "4√ó42s ‚Äî Progresando") donde `avgSeconds = totalReps / setCount` (porque `exercise_set.reps` almacena segundos para isom√©tricos ‚Äî Modelo de Datos ¬ß3.12). Cuando `exercise_progression.status == 'MASTERED'` (CA-08.07 de HU-08, implementado en HU-10), E5 muestra el badge "üèÜ Dominado" como un `AssistChip` M3 con `containerColor: Tertiary Container (#E0EEDD)` junto al nombre del ejercicio (Especificaci√≥n Visual ¬ßE5). La se√±al "Considerar descarga" NO se aplica a bodyweight ni isom√©tricos ‚Äî estos tipos mantienen sus se√±ales espec√≠ficas incluso cuando MODULE_REQUIRES_DELOAD est√° activo para el m√≥dulo (ver Decisi√≥n 4).

### Verificaci√≥n Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-13.01 | üî® Por implementar | `ActiveSessionViewModel.navigateToSessionSummary` ‚Üí `TensionNavHost` ‚Üí `SessionSummaryScreen` | HU-13 (Navegaci√≥n + Screen) |
| CA-13.02 | üî® Por implementar | `SessionDao.getSessionSummaryInfo()` ‚Üí `SUM(weight_kg * reps)` ‚Üí `SessionSummary.totalTonnageKg` | HU-13 (DAO + Screen) |
| CA-13.03 | üî® Por implementar | `SessionDao.getSessionSummaryInfo()` ‚Üí `completedExercises` / `totalExercises` | HU-13 (DAO + Screen) |
| CA-13.04 | üî® Por implementar | `SessionExerciseDao.getExercisesForSummary()` ‚Üí `progression_classification` ‚Üí `ProgressionIndicator` | HU-13 (DAO + Screen) |
| CA-13.05 | üî® Por implementar | `ActionSignalRule.resolve()` ‚Üí sealed `ActionSignal` ‚Üí texto de se√±al en `SessionSummaryScreen` | HU-13 (Rule + Screen) |
| CA-13.06 | üî® Por implementar | `ProgressionIndicator`: ‚Üë verde (#2E7D32/#81C784), = √°mbar (#8D6E00/#FFD54F), ‚Üì rojo (#C62828/#EF9A9A) + √≠cono + texto | HU-13 (Screen + Component) |
| CA-13.07 | üî® Por implementar | Query con `HAVING completedSets > 0`, Card estado "Incompleta ‚ö†Ô∏è", tonelaje parcial | HU-13 (DAO + Screen) |

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Manifiesto de Dominio Sist√©mico ¬ß6-A ‚Äî Reglas R1 (Doble Umbral), R6 (Peso Corporal), R7 (Isom√©tricos)
- Modelo de Datos ¬ß3.10 (session ‚Äî tonelaje calculado), ¬ß3.11 (session_exercise ‚Äî progression_classification), ¬ß3.12 (exercise_set), ¬ß3.13 (exercise_progression ‚Äî prescribed_load_kg, status), ¬ß3.16 (alert ‚Äî MODULE_REQUIRES_DELOAD)
- ADR-06 ‚Äî Motor de reglas Kotlin puro en `domain/rules/`
- Arquitectura T√©cnica ¬ß5.2 ‚Äî Naming `{Nombre}Rule`, `{Feature}Screen`, `{Feature}ViewModel`, `{Feature}UiState`
- Wireframes E5 ‚Äî Estructura visual, elementos, estados, se√±ales por tipo de ejercicio
- Especificaci√≥n Visual ¬ßE5 ‚Äî Componentes M3, colores sem√°nticos, tipograf√≠a, dimensiones
- Mapa de Navegaci√≥n ¬ß4 ‚Äî E4 ‚Üí E5, E5 ‚Üí B1, E5 ‚Üí F3
- Requerimientos ‚Äî RF59, RNF05

**Historias relacionadas:**

- HU-09: Establece `closeSession()` y evento de navegaci√≥n `navigateToSessionSummary` ‚Äî trigger directo de E5
- HU-10: Produce `session_exercise.progression_classification` y `exercise_progression.status/sessionsWithoutProgression` ‚Äî datos base que E5 lee
- HU-11: Produce `exercise_progression.prescribed_load_kg` ‚Äî dato usado por `ActionSignalRule` para derivar "Subir carga"
- HU-12: Produce alertas `PLATEAU` y `MODULE_REQUIRES_DELOAD` en tabla `alert` ‚Äî dato consumido por `ActionSignalRule` para derivar "Considerar descarga" (Decisi√≥n 13)
- HU-16: Destino de navegaci√≥n F3 al hacer click en un ejercicio desde E5 ‚Äî a√∫n no implementada
- HU-17: Consumir√° `ProgressionIndicator` como componente reutilizable en H1/H2

**Validado por:** esteban.colorado | **Fecha:** 2026-02-16 | **Enfoque:** Exploratorio
---

## Refinamiento T√©cnico (Developer)

<!-- ============================================================================ -->
<!-- SECCI√ìN AGREGADA POR: Workflow refinamiento-tecnico                         -->
<!-- ETAPA: Refinamiento T√©cnico                                                  -->
<!-- RESPONSABLE: Developer                                                       -->
<!-- BASE: An√°lisis Arquitect√≥nico (Arquitecto) - Ver secci√≥n arriba             -->
<!-- FECHA: 2026-02-17                                                            -->
<!-- ESTADO: Refinado (Developer) - Basado en An√°lisis Arquitect√≥nico             -->
<!-- ============================================================================ -->

### Consideraciones Generales

**Basado en an√°lisis arquitect√≥nico:**
An√°lisis Arquitect√≥nico de HU-13 con 10 decisiones de dise√±o, 6 hitos de implementaci√≥n, 14 componentes (9 nuevos + 5 modificados). Hallazgos principales: (1) HU-13 es 100% lectura ‚Äî no escribe datos, solo lee lo que HU-09/HU-10/HU-11/HU-12 persistieron. (2) `ActionSignalRule` es la pieza central: regla pura con sealed interface `ActionSignal` de 8 variantes (7 se√±ales + `FirstSession`) que discrimina por tipo de ejercicio (est√°ndar/bodyweight/isom√©trico) y clasificaci√≥n + condici√≥n DU. (3) "Considerar descarga" solo aplica a ejercicios est√°ndar con `REGRESSION` + alerta activa `MODULE_REQUIRES_DELOAD`. (4) Tonelaje siempre computado por SQL (`SUM(weight_kg * reps)`), nunca almacenado. (5) E5 no tiene Bottom Navigation ni bot√≥n de retorno ‚Äî √∫nica salida "Ir al Inicio" ‚Üí B1. (6) `ProgressionIndicator` es reutilizable (E5, F2, F3 futuras). (7) `SessionSummaryViewModel` recibe `sessionId` via `SavedStateHandle`. (8) La se√±al "Subir carga ‚Üí X Kg" compara `prescribedLoadKg > avgWeightKg` con tolerancia 0.01 Kg. (9) Para bodyweight, se√±al es "N reps totales (+/-/= diferencia)"; para isom√©tricos, "N√óXs ‚Äî Progresando/Manteniendo/Regresando". (10) `FirstSession` cubre el edge case `classification == null` (primer uso del ejercicio).

**Nivel de complejidad:**
MEDIA ‚Äî HU-13 toca 14 archivos (9 nuevos + 5 modificados) con l√≥gica distribuida en 6 capas (domain model ‚Üí domain rules ‚Üí domain usecase ‚Üí data DAO ‚Üí data repository ‚Üí UI). La regla `ActionSignalRule` tiene 8 variantes y ~13 ramas l√≥gicas, pero son individualmente simples sin efectos secundarios. Las 2 queries DAO nuevas son JOINs complejos pero sobre m√°ximo 11 filas. El componente UI m√°s grande es `SessionSummaryScreen` con Card + ListItem adaptivo a 3 tipos de ejercicio. No hay migraci√≥n de BD, no hay escritura de datos, no hay transacciones complejas. El total de tests unitarios estimados es ~19 escenarios (solo `ActionSignalRule`).

**Riesgos t√©cnicos conocidos:**

1. **Query `getExercisesForSummary` con subquery de reps previas:** La subquery para obtener `previousTotalReps` repite el patr√≥n de `getLastHistoricalSets()` como subquery anidada. Con m√°ximo 11 ejercicios √ó 1 subquery cada uno, el costo es despreciable. Sin embargo, si la tabla `session` crece, el `ORDER BY s2.date DESC, s2.id DESC LIMIT 1` debe mantenerse eficiente gracias al √≠ndice en `session.date`.
2. **`showBottomBar` no excluye `session-summary`:** Actualmente el Bottom Navigation se muestra en todas las rutas excepto `active-session`, `register-set`, `substitute-exercise`. E5 especifica "Sin Bottom Navigation" ‚Äî falta agregar la exclusi√≥n `!currentRoute.startsWith("session-summary")`.
3. **`WEIGHT_TOLERANCE` de `ProgressionClassificationRule` es `private`:** `ActionSignalRule` necesita comparar `prescribedLoadKg > avgWeightKg` con tolerancia 0.01 Kg. Opciones: (A) duplicar la constante en `ActionSignalRule`, (B) hacer `WEIGHT_TOLERANCE` internal/public en `ProgressionClassificationRule`. Se opta por (A) ‚Äî duplicar como `private const val WEIGHT_TOLERANCE = 0.01` en `ActionSignalRule` para independencia de la regla (ADR-06: cada regla es un archivo independiente).
4. **Navegaci√≥n E5 ‚Üí F3 pre-HU-16:** La ruta `exercise-history/{exerciseId}` ya existe en `NavigationRoutes.kt` pero no tiene composable registrado. El click navega a una ruta sin contenido ‚Äî el sistema mostrar√° pantalla vac√≠a. Forward-compatible: cuando HU-16 registre el composable, la navegaci√≥n funcionar√°.

**Patrones y convenciones del equipo (establecidos en HU-01‚ÄîHU-12):**

- C√≥digo fuente en ingl√©s, UI y datos de dominio en espa√±ol (Arquitectura T√©cnica ¬ß5.1)
- Naming: `{Nombre}Rule` para reglas (¬ß5.2), `{Feature}Screen` para composables, `{Feature}ViewModel` para VMs, `{Feature}UiState` para estados
- `object` singleton para reglas puras (patr√≥n `ProgressionClassificationRule`, `ModuleFatigueRule`)
- `sealed interface` para variantes tipadas (patr√≥n `ExerciseDetailUiState: Loading | Success | Error`)
- `@HiltViewModel` con `SavedStateHandle` para extraer argumentos de navegaci√≥n (patr√≥n `ActiveSessionViewModel`)
- `UseCase` con `@Inject constructor` + `operator fun invoke()` (patr√≥n `CloseSessionUseCase`)
- DAOs: DTOs como `data class` fuera de la interfaz `@Dao`, queries con JOINs complejos (patr√≥n `getBySessionIdWithDetails()`)
- Repository: interface en `domain/repository/`, implementaci√≥n en `data/repository/` (patr√≥n `SessionRepository`/`SessionRepositoryImpl`)
- Tests: JUnit 4, helpers factories, sin mocks para reglas puras
- `composable()` con `navArgument("sessionId") { type = NavType.LongType }` (patr√≥n `ACTIVE_SESSION`)
- `hiltViewModel()` dentro del composable (patr√≥n `ActiveSessionScreen`)
- `LocalTensionSemanticColors.current` para colores sem√°nticos

**Dependencias nuevas a instalar:**
Ninguna.

**Estrategia de testing:**
JUnit 4 (sin MockK ‚Äî funciones puras) | 1 archivo de test: `ActionSignalRuleTest` (~19 escenarios). Cubre las 8 variantes del sealed interface √ó condiciones boundary (DU cumplido/no cumplido, regresi√≥n aislada vs con alerta m√≥dulo, bodyweight con/sin historial previo, isom√©trico progresi√≥n/mantenimiento/regresi√≥n/dominado, edge cases `classification == null` y `exercisesWithRecords == 0`). Las queries DAO no se testean unitariamente (requieren instrumentaci√≥n Room ‚Äî validaci√≥n manual o tests instrumentados en Fase N). Los composables se validan visualmente en Fase N.

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**

- HU-10 (`ProgressionClassificationRule`) ‚Äî Implement√≥ `classify()` con sealed return, `resolveNewProgressionState()` con status/counter, `WEIGHT_TOLERANCE = 0.01`. HU-13 lee los outputs de HU-10: `session_exercise.progression_classification` y `exercise_progression.status/sessionsWithoutProgression/prescribedLoadKg`. HU-13 NO reimplementa l√≥gica de clasificaci√≥n ‚Äî solo consume resultados.
- HU-11 (`DoubleThresholdRule`) ‚Äî Implement√≥ `prescribeLoad()` que escribe `exercise_progression.prescribed_load_kg`. HU-13 lee `prescribedLoadKg` para derivar "Subir carga ‚Üí X Kg" cuando `prescribedLoadKg > avgWeightKg`.
- HU-12 (`ModuleFatigueRule`, `DeloadNeedRule`, `AlertEntity/AlertDao`) ‚Äî Implement√≥ la infraestructura de alertas y la detecci√≥n de `MODULE_REQUIRES_DELOAD`. HU-13 lee `alertDao.existsActiveByModule(moduleCode, "MODULE_REQUIRES_DELOAD")` para derivar "Considerar descarga" en ejercicios est√°ndar.
- HU-09 (`closeSession()`, `navigateToSessionSummary`) ‚Äî Implement√≥ la transacci√≥n de cierre y el evento de navegaci√≥n `_navigateToSessionSummary.emit(sessionId)`. HU-13 conecta este evento con la pantalla E5 real, reemplazando el TODO actual que navega a HOME.
- HU-05 (alert badge, colores sem√°nticos) ‚Äî Implement√≥ `alertCount = 0` placeholder y los colores sem√°nticos en `Color.kt`/`Theme.kt` que E5 consume.

**Patrones de c√≥digo reutilizados:**

- `sealed interface` con `data class`/`data object` variantes ‚Üí `ActionSignal` (8 variantes)
- `sealed interface UiState` con `Loading | Success | Error` ‚Üí `SessionSummaryUiState`
- `@HiltViewModel` + `SavedStateHandle` ‚Üí `SessionSummaryViewModel` (patr√≥n `ActiveSessionViewModel`)
- `UseCase` con `@Inject constructor` + `operator fun invoke()` ‚Üí `GetSessionSummaryUseCase`
- `object` singleton con funci√≥n pura ‚Üí `ActionSignalRule`
- DTO + query DAO con JOINs ‚Üí `SessionSummaryInfo`, `ExerciseSummaryDto`
- `composable(route, arguments)` + `hiltViewModel()` ‚Üí registro E5

**Mejores pr√°cticas aplicadas:**

- Separaci√≥n lectura/escritura: HU-13 es 100% lectura, HU-09/10/11/12 son escritura. Sin coupling bidireccional.
- Domain Rule pura: `ActionSignalRule.resolve()` recibe primitivos y enums, retorna `ActionSignal`. Sin acceso a Room, SharedPreferences, Android.
- Repository como orquestador de datos: `getSessionSummaryData()` combina 3 queries y retorna un modelo intermedio que el UseCase transforma con la regla.
- ProgressionIndicator reutilizable: `@Composable` standalone sin dependencia de pantalla ‚Äî reutilizable en F2, F3, H1 (futuras HUs).

---

## Tareas de Implementaci√≥n (Developer)

### Fase 1: Domain ‚Äî Modelos + ActionSignalRule + tests

<!-- Basado en Hito #1 del An√°lisis Arquitect√≥nico -->

#### üì¶ Domain Models

- [ ] **Crear `ActionSignal`** (AC: 5)
  - [ ] Crear archivo: `domain/model/ActionSignal.kt`
  - [ ] `sealed interface ActionSignal` con 8 variantes:
    - `data class IncreaseLoad(val targetKg: Double) : ActionSignal` ‚Äî DU cumplido, est√°ndar
    - `data object ProgressInReps : ActionSignal` ‚Äî DU NO cumplido + `POSITIVE_PROGRESSION`, est√°ndar
    - `data class MaintainLoad(val message: String) : ActionSignal` ‚Äî DU NO cumplido + `MAINTENANCE`/`REGRESSION` aislada, est√°ndar
    - `data object ConsiderDeload : ActionSignal` ‚Äî `REGRESSION` + alerta MODULE_REQUIRES_DELOAD, est√°ndar
    - `data class BodyweightSignal(val totalReps: Int, val diff: Int?) : ActionSignal` ‚Äî peso corporal
    - `data class IsometricSignal(val setCount: Int, val avgSeconds: Int) : ActionSignal` ‚Äî isom√©trico no dominado
    - `data object IsometricMastered : ActionSignal` ‚Äî isom√©trico dominado (4√ó45s)
    - `data object FirstSession : ActionSignal` ‚Äî sin historial previo (`classification == null`)
- [ ] **Crear `ExerciseSummaryItem`** (AC: 4, 5, 6)
  - [ ] Crear archivo: `domain/model/ExerciseSummaryItem.kt`
  - [ ] Data class: `exerciseId: Long`, `name: String`, `classification: ProgressionClassification?`, `signal: ActionSignal`, `weightKg: Double`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isMastered: Boolean`
- [ ] **Crear `SessionSummary`** (AC: 1, 2, 3, 4)
  - [ ] Crear archivo: `domain/model/SessionSummary.kt`
  - [ ] Data class: `status: String`, `moduleCode: String`, `versionNumber: Int`, `totalTonnageKg: Double`, `completedExercises: Int`, `totalExercises: Int`, `exercises: List<ExerciseSummaryItem>`

#### üì¶ Domain Rule

- [ ] **Crear `ActionSignalRule`** (AC: 5)
  - [ ] Crear archivo: `domain/rules/ActionSignalRule.kt`
  - [ ] `object ActionSignalRule` con `private const val WEIGHT_TOLERANCE = 0.01`
  - [ ] `fun resolve(classification: ProgressionClassification?, prescribedLoadKg: Double?, avgWeightKg: Double, moduleRequiresDeload: Boolean, isBodyweight: Boolean, isIsometric: Boolean, totalReps: Int, previousTotalReps: Int?, setCount: Int, isMastered: Boolean): ActionSignal`
  - [ ] L√≥gica de branching:
    1. `classification == null` ‚Üí `FirstSession`
    2. `isIsometric && isMastered` ‚Üí `IsometricMastered`
    3. `isIsometric` ‚Üí `IsometricSignal(setCount, avgSeconds = totalReps / setCount)`
    4. `isBodyweight` ‚Üí `BodyweightSignal(totalReps, diff = if (previousTotalReps != null) totalReps - previousTotalReps else null)`
    5. Est√°ndar: `prescribedLoadKg != null && prescribedLoadKg - avgWeightKg > WEIGHT_TOLERANCE` ‚Üí `IncreaseLoad(prescribedLoadKg)`
    6. Est√°ndar: `classification == REGRESSION && moduleRequiresDeload` ‚Üí `ConsiderDeload`
    7. Est√°ndar: `classification == POSITIVE_PROGRESSION` ‚Üí `ProgressInReps`
    8. Est√°ndar: `classification == MAINTENANCE` ‚Üí `MaintainLoad("Mantener carga ‚Äî progresar en reps")`
    9. Est√°ndar: `classification == REGRESSION` (aislada) ‚Üí `MaintainLoad("Mantener carga")`
- [ ] **Test unitario `ActionSignalRuleTest`** (~19 escenarios)
  - [ ] Crear archivo: `src/test/java/com/estebancoloradogonzalez/tension/domain/rules/ActionSignalRuleTest.kt`
  - [ ] Escenario 1: `classification == null` ‚Üí `FirstSession`
  - [ ] Escenario 2: isom√©trico dominado (`isMastered = true`) ‚Üí `IsometricMastered`
  - [ ] Escenario 3: isom√©trico progresi√≥n (`POSITIVE_PROGRESSION`) ‚Üí `IsometricSignal(4, 42)` (totalReps=168, setCount=4)
  - [ ] Escenario 4: isom√©trico mantenimiento ‚Üí `IsometricSignal(4, 40)`
  - [ ] Escenario 5: isom√©trico regresi√≥n ‚Üí `IsometricSignal(4, 35)`
  - [ ] Escenario 6: bodyweight progresi√≥n con historial ‚Üí `BodyweightSignal(48, +3)` (previousTotalReps=45)
  - [ ] Escenario 7: bodyweight mantenimiento ‚Üí `BodyweightSignal(45, 0)`
  - [ ] Escenario 8: bodyweight regresi√≥n ‚Üí `BodyweightSignal(40, -5)`
  - [ ] Escenario 9: bodyweight sin historial previo ‚Üí `BodyweightSignal(48, null)`
  - [ ] Escenario 10: est√°ndar DU cumplido (`prescribedLoadKg=62.5, avgWeightKg=60.0`) ‚Üí `IncreaseLoad(62.5)`
  - [ ] Escenario 11: est√°ndar DU NO cumplido + progresi√≥n ‚Üí `ProgressInReps`
  - [ ] Escenario 12: est√°ndar DU NO cumplido + mantenimiento ‚Üí `MaintainLoad("Mantener carga ‚Äî progresar en reps")`
  - [ ] Escenario 13: est√°ndar regresi√≥n + `moduleRequiresDeload = true` ‚Üí `ConsiderDeload`
  - [ ] Escenario 14: est√°ndar regresi√≥n aislada (`moduleRequiresDeload = false`) ‚Üí `MaintainLoad("Mantener carga")`
  - [ ] Escenario 15: est√°ndar DU cumplido con tolerancia boundary (`prescribedLoadKg=60.01, avgWeightKg=60.0`) ‚Üí `IncreaseLoad(60.01)` (diferencia = 0.01 = WEIGHT_TOLERANCE, NO se cumple `> TOLERANCE`)
  - [ ] Escenario 16: est√°ndar `prescribedLoadKg == null` + mantenimiento ‚Üí `MaintainLoad("Mantener carga ‚Äî progresar en reps")`
  - [ ] Escenario 17: est√°ndar `prescribedLoadKg == avgWeightKg` (sin incremento) + progresi√≥n ‚Üí `ProgressInReps`
  - [ ] Escenario 18: isom√©trico con `classification == null` ‚Üí `FirstSession` (prioridad de null sobre tipo)
  - [ ] Escenario 19: bodyweight regresi√≥n + `moduleRequiresDeload = true` ‚Üí `BodyweightSignal(40, -5)` (NO ConsiderDeload ‚Äî Decisi√≥n 4: bodyweight mantiene se√±al tipo-espec√≠fica)

### Fase 2: Data ‚Äî Queries DAO (DTOs + queries nuevas)

<!-- Basado en Hito #2 del An√°lisis Arquitect√≥nico -->

#### üì¶ Data Layer (DAOs)

- [ ] **Modificar `SessionDao`** (AC: 2, 3)
  - [ ] Agregar DTO `SessionSummaryInfo` fuera de la interfaz: `status: String`, `moduleCode: String`, `versionNumber: Int`, `totalTonnageKg: Double`, `totalExercises: Int`, `completedExercises: Int`
  - [ ] Agregar query `getSessionSummaryInfo(sessionId: Long): SessionSummaryInfo`:
    ```sql
    SELECT
        s.status,
        mv.module_code AS moduleCode,
        mv.version_number AS versionNumber,
        COALESCE(
            (SELECT SUM(es.weight_kg * es.reps)
             FROM exercise_set es
             INNER JOIN session_exercise se ON es.session_exercise_id = se.id
             WHERE se.session_id = s.id),
            0.0
        ) AS totalTonnageKg,
        (SELECT COUNT(*) FROM session_exercise WHERE session_id = s.id) AS totalExercises,
        (SELECT COUNT(*) FROM session_exercise se2
         INNER JOIN (
             SELECT session_exercise_id, COUNT(*) AS cnt
             FROM exercise_set GROUP BY session_exercise_id HAVING cnt >= 4
         ) completed ON se2.id = completed.session_exercise_id
         WHERE se2.session_id = s.id
        ) AS completedExercises
    FROM session s
    INNER JOIN module_version mv ON s.module_version_id = mv.id
    WHERE s.id = :sessionId
    ```
- [ ] **Modificar `SessionExerciseDao`** (AC: 4, 5, 7)
  - [ ] Agregar DTO `ExerciseSummaryDto` fuera de la interfaz: `exerciseId: Long`, `exerciseName: String`, `classification: String?`, `isBodyweight: Int`, `isIsometric: Int`, `prescribedLoadKg: Double?`, `avgWeightKg: Double`, `totalReps: Int`, `setCount: Int`, `isMastered: Int`, `moduleCode: String`, `previousTotalReps: Int?`
  - [ ] Agregar query `getExercisesForSummary(sessionId: Long): List<ExerciseSummaryDto>`:
    ```sql
    SELECT
        se.exercise_id AS exerciseId,
        e.name AS exerciseName,
        se.progression_classification AS classification,
        e.is_bodyweight AS isBodyweight,
        e.is_isometric AS isIsometric,
        ep.prescribed_load_kg AS prescribedLoadKg,
        COALESCE(
            (SELECT AVG(es.weight_kg) FROM exercise_set es WHERE es.session_exercise_id = se.id),
            0.0
        ) AS avgWeightKg,
        COALESCE(
            (SELECT SUM(es.reps) FROM exercise_set es WHERE es.session_exercise_id = se.id),
            0
        ) AS totalReps,
        (SELECT COUNT(*) FROM exercise_set es WHERE es.session_exercise_id = se.id) AS setCount,
        CASE WHEN ep.status = 'MASTERED' THEN 1 ELSE 0 END AS isMastered,
        e.module_code AS moduleCode,
        (SELECT SUM(es3.reps)
         FROM exercise_set es3
         WHERE es3.session_exercise_id = (
             SELECT se3.id
             FROM session_exercise se3
             INNER JOIN session s3 ON se3.session_id = s3.id
             WHERE se3.exercise_id = se.exercise_id
               AND s3.id != :sessionId
               AND s3.status IN ('COMPLETED', 'INCOMPLETE')
             ORDER BY s3.date DESC, s3.id DESC
             LIMIT 1
         )
        ) AS previousTotalReps
    FROM session_exercise se
    INNER JOIN exercise e ON se.exercise_id = e.id
    LEFT JOIN exercise_progression ep ON e.id = ep.exercise_id
    WHERE se.session_id = :sessionId
    GROUP BY se.id
    HAVING setCount > 0
    ORDER BY e.name ASC
    ```
  - [ ] **NOTAS IMPORTANTES sobre esta query:**
    - La subquery `previousTotalReps` usa patr√≥n nested: primero encuentra el `session_exercise_id` de la sesi√≥n anterior del mismo ejercicio (`ORDER BY s3.date DESC, s3.id DESC LIMIT 1`), luego suma sus reps. Este patr√≥n reutiliza exactamente el de `ExerciseSetDao.getLastHistoricalSets()` (HU-10).
    - `GROUP BY se.id` es **obligatorio** antes del `HAVING` ‚Äî sin `GROUP BY`, SQLite colapsa todas las filas en un solo grupo. Mismo patr√≥n que `getBySessionIdWithDetails()` en `SessionExerciseDao`.
    - `LEFT JOIN exercise_progression` cubre ejercicios que a√∫n no tienen registro de progresi√≥n (`prescribed_load_kg = NULL`, `status = NULL ‚Üí isMastered = 0`).

### Fase 3: Data ‚Äî Repository + Domain UseCase

<!-- Basado en Hito #3 del An√°lisis Arquitect√≥nico -->

#### üì¶ Data Layer (modelos intermedios + repository)

- [ ] **Crear `SessionSummaryData`** (modelo intermedio data ‚Üí domain)
  - [ ] Crear directorio: `data/repository/model/` (no existe actualmente ‚Äî `data/repository/` solo contiene archivos `*RepositoryImpl.kt`)
  - [ ] Crear archivo: `data/repository/model/SessionSummaryData.kt`
  - [ ] Data class: `info: SessionSummaryInfo`, `exercises: List<ExerciseSummaryDto>`, `moduleRequiresDeload: Boolean`
- [ ] **Modificar `SessionRepository`** (interface, AC: 1, 2, 3, 4, 5)
  - [ ] Agregar: `suspend fun getSessionSummaryData(sessionId: Long): SessionSummaryData`
  - [ ] Agregar import de `SessionSummaryData`
- [ ] **Modificar `SessionRepositoryImpl`** (AC: 1, 2, 3, 4, 5)
  - [ ] Implementar `getSessionSummaryData(sessionId: Long): SessionSummaryData`:
    1. `val info = sessionDao.getSessionSummaryInfo(sessionId)`
    2. `val exercises = sessionExerciseDao.getExercisesForSummary(sessionId)`
    3. `val moduleRequiresDeload = alertDao.existsActiveByModule(info.moduleCode, "MODULE_REQUIRES_DELOAD")`
    4. `return SessionSummaryData(info, exercises, moduleRequiresDeload)`
  - [ ] NO requiere inyecci√≥n de nuevos DAOs ‚Äî `sessionDao`, `sessionExerciseDao`, `alertDao` ya est√°n en el constructor

#### üì¶ Domain Layer (UseCase)

- [ ] **Crear `GetSessionSummaryUseCase`** (AC: 1, 2, 3, 4, 5)
  - [ ] Crear archivo: `domain/usecase/session/GetSessionSummaryUseCase.kt`
  - [ ] `class GetSessionSummaryUseCase @Inject constructor(private val sessionRepository: SessionRepository)`
  - [ ] `suspend operator fun invoke(sessionId: Long): SessionSummary`
  - [ ] L√≥gica:
    1. `val data = sessionRepository.getSessionSummaryData(sessionId)`
    2. Para cada `dto` en `data.exercises`, invocar `ActionSignalRule.resolve(classification = dto.classification?.let { ProgressionClassification.valueOf(it) }, prescribedLoadKg = dto.prescribedLoadKg, avgWeightKg = dto.avgWeightKg, moduleRequiresDeload = data.moduleRequiresDeload, isBodyweight = dto.isBodyweight == 1, isIsometric = dto.isIsometric == 1, totalReps = dto.totalReps, previousTotalReps = dto.previousTotalReps, setCount = dto.setCount, isMastered = dto.isMastered == 1)`
    3. Construir `ExerciseSummaryItem(exerciseId = dto.exerciseId, name = dto.exerciseName, classification = classification, signal = signal, weightKg = dto.avgWeightKg, isBodyweight = dto.isBodyweight == 1, isIsometric = dto.isIsometric == 1, isMastered = dto.isMastered == 1)`
    4. Retornar `SessionSummary(status = data.info.status, moduleCode = data.info.moduleCode, versionNumber = data.info.versionNumber, totalTonnageKg = data.info.totalTonnageKg, completedExercises = data.info.completedExercises, totalExercises = data.info.totalExercises, exercises = items)`

### Fase 4: UI ‚Äî ViewModel + UiState

<!-- Basado en Hito #4 del An√°lisis Arquitect√≥nico -->

#### üì¶ UI Layer (estado + VM)

- [ ] **Crear `SessionSummaryUiState`** (AC: 1)
  - [ ] Crear archivo: `ui/session/SessionSummaryUiState.kt`
  - [ ] `sealed interface SessionSummaryUiState`
  - [ ] `data object Loading : SessionSummaryUiState`
  - [ ] `data class Success(val summary: SessionSummary) : SessionSummaryUiState`
  - [ ] `data class Error(val message: String) : SessionSummaryUiState`
- [ ] **Crear `SessionSummaryViewModel`** (AC: 1)
  - [ ] Crear archivo: `ui/session/SessionSummaryViewModel.kt`
  - [ ] `@HiltViewModel class SessionSummaryViewModel @Inject constructor(private val getSessionSummaryUseCase: GetSessionSummaryUseCase, savedStateHandle: SavedStateHandle)`
  - [ ] Extraer `sessionId` de `savedStateHandle.get<Long>("sessionId")`
  - [ ] `private val _uiState = MutableStateFlow<SessionSummaryUiState>(SessionSummaryUiState.Loading)`
  - [ ] `val uiState: StateFlow<SessionSummaryUiState> = _uiState.asStateFlow()`
  - [ ] `init { viewModelScope.launch { try { val summary = getSessionSummaryUseCase(sessionId); _uiState.value = SessionSummaryUiState.Success(summary) } catch (e: Exception) { _uiState.value = SessionSummaryUiState.Error(e.message ?: "Error desconocido") } } }`

### Fase 5: UI ‚Äî Screen + componente reutilizable

<!-- Basado en Hito #5 del An√°lisis Arquitect√≥nico -->

#### üì¶ UI Layer (composables)

- [ ] **Crear `ProgressionIndicator`** (AC: 6)
  - [ ] Crear archivo: `ui/components/ProgressionIndicator.kt`
  - [ ] `@Composable fun ProgressionIndicator(classification: ProgressionClassification?)`
  - [ ] `when (classification)`:
    - `POSITIVE_PROGRESSION` ‚Üí Text("‚Üë", 24.sp, color = semanticColors.progressionPositive)
    - `MAINTENANCE` ‚Üí Text("=", 24.sp, color = semanticColors.maintenance)
    - `REGRESSION` ‚Üí Text("‚Üì", 24.sp, color = semanticColors.regression)
    - `null` ‚Üí Box vac√≠o (sin √≠cono para primera sesi√≥n)
  - [ ] Dentro de `Box(modifier = Modifier.size(24.dp), contentAlignment = Alignment.Center)`
  - [ ] Colores de `LocalTensionSemanticColors.current`
- [ ] **Crear `SessionSummaryScreen`** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Crear archivo: `ui/session/SessionSummaryScreen.kt`
  - [ ] `@Composable fun SessionSummaryScreen(onNavigateToHome: () -> Unit, onNavigateToExerciseHistory: (Long) -> Unit)`
  - [ ] `val viewModel: SessionSummaryViewModel = hiltViewModel()`
  - [ ] `val uiState by viewModel.uiState.collectAsStateWithLifecycle()`
  - [ ] Estructura (seg√∫n Wireframe E5 y Especificaci√≥n Visual ¬ßE5):
    - `Scaffold` con `CenterAlignedTopAppBar`: title = "Resumen de Sesi√≥n" (TitleLarge), subtitle = "M√≥dulo {code} ‚Äî V{number}" (TitleSmall, onSurfaceVariant). Sin `navigationIcon`.
    - Estado `Loading` ‚Üí `CircularProgressIndicator` centrado
    - Estado `Error` ‚Üí texto de error centrado
    - Estado `Success` ‚Üí `LazyColumn` con:
      1. **Card** (Filled Card M3, cornerRadius 12.dp, padding 16.dp):
         - Background: si `status == "COMPLETED"` ‚Üí `colorScheme.primaryContainer`; si `"INCOMPLETE"` ‚Üí `colorScheme.errorContainer`
         - Row: estado badge ("Completada ‚úÖ" o "Incompleta ‚ö†Ô∏è", TitleMedium) + spacer
         - Tonelaje: HeadlineLarge 32.sp, color Primary. Formateado con `NumberFormat.getIntegerInstance(Locale("es", "ES"))` + " Kg"
         - Ejercicios completados: BodyMedium, onPrimaryContainer. "N/M ejercicios completados"
      2. **Divider** (M3)
      3. **Lista de ejercicios** ‚Äî `items(summary.exercises)` ‚Üí cada `ExerciseSummaryItem` renderizado como `ListItem M3 (80.dp)`:
         - `leadingContent`: `ProgressionIndicator(classification)`
         - `headlineContent`: nombre del ejercicio (TitleMedium, onSurface). Si `isMastered` ‚Üí agregar `AssistChip("üèÜ Dominado", containerColor = TertiaryContainer)` junto al nombre
         - `supportingContent`:
           - L√≠nea 1 (BodyMedium, color sem√°ntico): texto de clasificaci√≥n + contexto de peso seg√∫n tipo:
             - Est√°ndar: "Progresi√≥n positiva ¬∑ {weightKg} Kg" / "Mantenimiento ¬∑ {weightKg} Kg" / "Regresi√≥n ¬∑ {weightKg} Kg"
             - Bodyweight: "Progresi√≥n positiva ¬∑ Peso corporal" / etc.
             - Isom√©trico: "Progresi√≥n positiva ¬∑ Isom√©trico" / etc.
             - `null`: sin l√≠nea 1 (primera sesi√≥n)
           - L√≠nea 2 (BodySmall, onSurfaceVariant): texto de se√±al de acci√≥n seg√∫n `ActionSignal`:
             - `IncreaseLoad(targetKg)` ‚Üí "Subir carga ‚Üí {targetKg} Kg"
             - `ProgressInReps` ‚Üí "Progresar en reps (misma carga)"
             - `MaintainLoad(message)` ‚Üí `message` directo
             - `ConsiderDeload` ‚Üí "Considerar descarga"
             - `BodyweightSignal(totalReps, diff)` ‚Üí "N reps totales (+diff)" / "(=)" / "(‚àídiff)" / solo "N reps totales" si diff=null
             - `IsometricSignal(setCount, avgSeconds)` ‚Üí "{setCount}√ó{avgSeconds}s ‚Äî Progresando/Manteniendo/Regresando" (seg√∫n clasificaci√≥n)
             - `IsometricMastered` ‚Üí "4√ó45s ‚Äî üèÜ Dominado"
             - `FirstSession` ‚Üí "Primera sesi√≥n ‚Äî sin referencia"
         - `Modifier.clickable { onNavigateToExerciseHistory(item.exerciseId) }`
      4. **Spacer** (24.dp)
      5. **Button** ("Ir al Inicio", Filled Button fullWidth, containerColor = Primary) ‚Üí `onNavigateToHome()`

### Fase 6: Navegaci√≥n ‚Äî TensionNavHost

<!-- Basado en Hito #6 del An√°lisis Arquitect√≥nico -->

#### üì¶ Navigation

- [ ] **Modificar `TensionNavHost`** (AC: 1)
  - [ ] Agregar `!currentRoute.startsWith("session-summary")` a la condici√≥n `showBottomBar` (E5 no tiene Bottom Navigation)
  - [ ] Reemplazar el TODO en `onNavigateToSessionSummary`:
    ```kotlin
    onNavigateToSessionSummary = { sessionId ->
        navController.navigate(NavigationRoutes.sessionSummaryRoute(sessionId)) {
            popUpTo(NavigationRoutes.HOME) { inclusive = false }
        }
    },
    ```
  - [ ] Registrar composable E5 despu√©s del bloque `SUBSTITUTE_EXERCISE`:
    ```kotlin
    composable(
        route = NavigationRoutes.SESSION_SUMMARY,
        arguments = listOf(
            navArgument("sessionId") { type = NavType.LongType },
        ),
    ) {
        SessionSummaryScreen(
            onNavigateToHome = {
                navController.navigate(NavigationRoutes.HOME) {
                    popUpTo(NavigationRoutes.HOME) { inclusive = true }
                }
            },
            onNavigateToExerciseHistory = { exerciseId ->
                navController.navigate(
                    NavigationRoutes.exerciseHistoryRoute(exerciseId),
                )
            },
        )
    }
    ```

### Fase N: QA y Deployment

- [ ] **Ejecutar Agente Peer Review** (MANUAL)
- [ ] **Resolver incidentes del Peer Review** (MANUAL, condicional)
- [ ] **Crear Pull Request** (MANUAL)
- [ ] **Ejecutar pipeline deployment DEV** (MANUAL)
- [ ] **Dise√±ar set de pruebas manuales** (MANUAL)
- [ ] **Ejecutar pruebas manuales** (MANUAL)

---

**Notas sobre vinculaci√≥n con Criterios de Aceptaci√≥n:**

**CA-13.01 ‚Äî Presentaci√≥n autom√°tica del resumen al cerrar:**
‚Üí Fase 4 (`SessionSummaryViewModel` init carga datos autom√°ticamente) + Fase 6 (`TensionNavHost` TODO reemplazado con navegaci√≥n real). La cadena completa: `ActiveSessionViewModel.onCloseSessionConfirmed()` ‚Üí `closeSessionUseCase(sessionId)` ‚Üí `_navigateToSessionSummary.emit(sessionId)` ‚Üí `TensionNavHost` navega a `session-summary/$sessionId` ‚Üí `SessionSummaryScreen` renderiza autom√°ticamente.

**CA-13.02 ‚Äî Tonelaje total:**
‚Üí Fase 2 (`SessionDao.getSessionSummaryInfo()` con `SUM(weight_kg * reps)` como subquery SQL). Tonelaje nunca almacenado ‚Äî siempre computado (Modelo de Datos ¬ß3.10).

**CA-13.03 ‚Äî Ejercicios completados:**
‚Üí Fase 2 (`SessionDao.getSessionSummaryInfo()` con `completedExercises` subquery ‚Äî COUNT de session_exercises con 4 sets). Formato: "N/M ejercicios completados" en Fase 5.

**CA-13.04 ‚Äî Clasificaci√≥n de progresi√≥n por ejercicio:**
‚Üí Fase 2 (`SessionExerciseDao.getExercisesForSummary()` lee `progression_classification`) + Fase 5 (`ProgressionIndicator` + l√≠nea 1 del `ListItem`).

**CA-13.05 ‚Äî Se√±ales de acci√≥n:**
‚Üí Fase 1 (`ActionSignalRule.resolve()` con 8 variantes) + Fase 3 (`GetSessionSummaryUseCase` aplica la regla por ejercicio) + Fase 5 (l√≠nea 2 del `ListItem` muestra texto de se√±al).

**CA-13.06 ‚Äî Se√±ales visualmente distinguibles:**
‚Üí Fase 5 (`ProgressionIndicator`: ‚Üë verde `#2E7D32`/`#81C784`, = √°mbar `#8D6E00`/`#FFD54F`, ‚Üì rojo `#C62828`/`#EF9A9A`). Colores ya definidos en `Color.kt` y expuestos via `LocalTensionSemanticColors`.

**CA-13.07 ‚Äî Sesi√≥n incompleta:**
‚Üí Fase 2 (`getExercisesForSummary` con `HAVING setCount > 0` filtra ejercicios sin registros) + Fase 5 (Card con background `errorContainer`, badge "Incompleta ‚ö†Ô∏è", tonelaje parcial). Ejercicios sin series no aparecen.

<!-- AUDITOR√çA PROFUNDA (2026-02-17):

=== SCOPE ===
6 docs arquitectura + 5 docs business + 18 HUs + Mapa de Historias + 14 archivos de c√≥digo fuente verificados.

=== BLOQUE 1: DOCUMENTOS DE ARQUITECTURA (6 archivos) ===

Modelo de Datos:
- ¬ß3.10 session: status TEXT NOT NULL DEFAULT 'IN_PROGRESS', module_version_id INTEGER NOT NULL FK. Tonelaje NO almacenado ‚Äî SUM(weight_kg * reps) ‚úÖ
- ¬ß3.11 session_exercise: progression_classification TEXT NULL CHECK IN (3 values) OR NULL ‚úÖ
- ¬ß3.12 exercise_set: weight_kg REAL NOT NULL CHECK >= 0, reps INTEGER NOT NULL CHECK >= 1 ‚úÖ
- ¬ß3.13 exercise_progression: prescribed_load_kg REAL NULL, status TEXT NOT NULL (5 values) ‚úÖ
- ¬ß3.16 alert: module_code TEXT NULL, type TEXT NOT NULL, is_active INTEGER NOT NULL DEFAULT 1 ‚úÖ

ADR-06: reglas puras en domain.rules, cada una archivo independiente ‚úÖ
ADR-18: JUnit 4 para tests del motor de reglas ‚úÖ

Arquitectura T√©cnica:
- ¬ß5.1 idioma: c√≥digo ingl√©s, UI espa√±ol ‚úÖ
- ¬ß5.2 naming: {Nombre}Rule, {Feature}Screen, {Feature}ViewModel, {Feature}UiState ‚úÖ
- ¬ß3.2 paquetes: domain/rules/, domain/model/, domain/usecase/session/, ui/session/, ui/components/ ‚úÖ

Especificaci√≥n Visual ¬ßE5:
- CenterAlignedTopAppBar sin navigationIcon ‚úÖ
- Filled Card (12dp corner, 16dp padding) con Primary Container (completed) / Error Container (incomplete) ‚úÖ
- HeadlineLarge 32sp para tonelaje, color Primary ‚úÖ
- ListItem M3 80dp con leading icon 24dp, TitleMedium name, BodyMedium clasificaci√≥n, BodySmall se√±al ‚úÖ
- AssistChip M3 "üèÜ Dominado" Tertiary Container ‚úÖ
- Filled Button full width para "Ir al Inicio" ‚úÖ
- Se√±ales: 5 filas (Est√°ndar DU s√≠, Est√°ndar DU no, Peso corporal, Isom√©trico, Isom√©trico dominado) ‚úÖ

Wireframes E5:
- Sin Bottom Navigation confirmado ‚úÖ
- "Considerar descarga" aparece en wireframe ASCII y tabla de se√±ales ‚úÖ
- "Ir al Inicio" ‚Üí B1, √∫nica salida principal ‚úÖ
- 3 tipos de ejercicio diferenciados en ASCII art ‚úÖ

Mapa de Navegaci√≥n:
- E5 accesible desde E4 (transici√≥n autom√°tica post-cierre) ‚úÖ
- E5 ‚Üí B1 ("Ir al Inicio") ‚úÖ
- E5 ‚Üí F3 (tap en ejercicio) ‚úÖ

=== BLOQUE 2: DOCUMENTOS DE NEGOCIO (5 archivos) ===

Requerimientos:
- RF59: resumen post-sesi√≥n con tonelaje, ejercicios completados, clasificaci√≥n, se√±ales de acci√≥n ‚úÖ
- RNF05: se√±ales visualmente distinguibles con colores e iconograf√≠a ‚úÖ
- RF27: prescribir misma carga si no cumpli√≥ DU, progresar en reps 8-12 ‚úÖ
- RF33: isom√©trico dominado cuando 4 series ‚â• 45s ‚úÖ

MDS:
- R1 (Doble Umbral): prescibe incremento m√≠nimo. "Subir carga" es E5 UI text ‚úÖ
- R6 (Peso Corporal): sobrecarga por repeticiones, no aplica R1 ‚úÖ
- R7 (Isom√©tricos): rango 30-45s, dominado si 4√ó45s ‚úÖ
- ¬ß5: no hay flujo expl√≠cito de "resumen post-sesi√≥n" ‚Äî RF59 lo define ‚úÖ

Visi√≥n del Producto: "feedback inmediato" y "se√±ales claras" mencionados como core ‚úÖ
Plan de Entrenamiento: A=11, B=11, C=9 ‚Äî m√°ximo de filas en lista E5 ‚úÖ
Diccionario: sin referencia a E5 ‚úÖ

=== BLOQUE 3: HUs VERIFICADAS ===

Predecesoras directas (4):
- HU-09: closeSession() + navigateToSessionSummary event. TODO en TensionNavHost L264-269. ActiveSessionViewModel L95-104 ‚úÖ
- HU-10: session_exercise.progression_classification escrito. exercise_progression.status/sessionsWithoutProgression ‚úÖ
- HU-11: exercise_progression.prescribed_load_kg escrito ‚úÖ
- HU-12: AlertEntity/AlertDao + existsActiveByModule(moduleCode, "MODULE_REQUIRES_DELOAD"). alertDao ya inyectado en SessionRepositoryImpl ‚úÖ

Predecesoras indirectas (5):
- HU-01: infraestructura Color.kt con progresi√≥n/mantenimiento/regresi√≥n ‚úÖ
- HU-05: colores sem√°nticos en Color.kt/Theme.kt, alert badge placeholder ‚úÖ
- HU-06: escribe exercise_set (weight_kg, reps) ‚Äî E5 computa tonelaje SUM(weight_kg * reps) desde estos datos ‚úÖ
- HU-07: sustituye exercise_id en session_exercise ‚Äî E5 muestra el ejercicio efectivamente ejecutado ‚úÖ
- HU-08: CA-08.07 define isom√©trico dominado (4√ó45s) ‚Üí Especificaci√≥n Visual ¬ßE5 AssistChip "üèÜ Dominado" ‚úÖ

Sucesoras (2):
- HU-16: F3 (exercise-history) ‚Äî ruta existe pero sin composable. Click E5 ‚Üí F3 forward-compatible ‚úÖ
- HU-17: reutiliza ProgressionIndicator en H1/H2 ‚úÖ

Sin referencia funcional (7): HU-02, HU-03, HU-04, HU-14, HU-15, HU-18 ‚úÖ

=== BLOQUE 4: C√ìDIGO VERIFICADO (14 archivos) ===

Nuevos (9):
- ActionSignal.kt, ExerciseSummaryItem.kt, SessionSummary.kt (domain/model/) ‚Äî NO existen ‚úÖ
- ActionSignalRule.kt (domain/rules/) ‚Äî NO existe ‚úÖ
- GetSessionSummaryUseCase.kt (domain/usecase/session/) ‚Äî NO existe ‚úÖ
- SessionSummaryUiState.kt, SessionSummaryViewModel.kt, SessionSummaryScreen.kt (ui/session/) ‚Äî NO existen ‚úÖ
- ProgressionIndicator.kt (ui/components/) ‚Äî NO existe ‚úÖ
- SessionSummaryData.kt (data/repository/model/) ‚Äî directorio NO existe, crearlo ‚úÖ

Modificados (5):
- SessionDao.kt (60 l√≠neas): ActiveSessionInfo DTO existe, getSessionSummaryInfo NO existe ‚úÖ
- SessionExerciseDao.kt (167 l√≠neas): SessionExerciseWithDetails existe, getExercisesForSummary NO existe ‚úÖ
- SessionRepository.kt (24 l√≠neas): 12 m√©todos, getSessionSummaryData NO existe ‚úÖ
- SessionRepositoryImpl.kt (482 l√≠neas): constructor L41-50 tiene 9 DAOs + database (sessionDao, sessionExerciseDao, planAssignmentDao, rotationStateDao, moduleVersionDao, exerciseSetDao, exerciseProgressionDao, alertDao, database). NO necesita nuevos DAOs ‚úÖ
- TensionNavHost.kt (318 l√≠neas): TODO L262-268, showBottomBar L79-86 no excluye session-summary ‚úÖ

Verificados sin cambio (11):
- AlertDao.kt: existsActiveByModule(moduleCode, type): Boolean ‚Äî existe ‚úÖ
- ExerciseProgressionEntity.kt: status, prescribedLoadKg, sessionsWithoutProgression ‚Äî columnas correctas ‚úÖ
- ProgressionClassificationRule.kt: WEIGHT_TOLERANCE = 0.01 (private) ‚Äî ActionSignalRule duplica ‚úÖ
- Color.kt: ProgressionPositiveLight/Dark, MaintenanceLight/Dark, RegressionLight/Dark ‚Äî existen ‚úÖ
- Theme.kt: TensionSemanticColors + LocalTensionSemanticColors ‚Äî expuestos ‚úÖ
- NavigationRoutes.kt: SESSION_SUMMARY + sessionSummaryRoute() ‚Äî existen ‚úÖ
- ActiveSessionViewModel.kt: navigateToSessionSummary SharedFlow<Long> ‚Äî existe ‚úÖ
- TensionDatabase.kt: version=5, 15 entities, 14 DAOs ‚Äî sin cambio ‚úÖ
- DatabaseModule.kt: 14 providers ‚Äî sin cambio ‚úÖ
- RepositoryModule.kt: bindSessionRepository ‚Äî sin cambio ‚úÖ
- ExerciseSessionData.kt: avgWeightKg = sum(weight)/count ‚Äî referencia para comparaci√≥n ‚úÖ

=== BLOQUE 5: VERIFICACI√ìN L√ìGICA (ActionSignalRule) ===

L√≥gica de branching (9 ramas, prioridad top-down):
1. classification == null ‚Üí FirstSession ‚úÖ
2. isIsometric && isMastered ‚Üí IsometricMastered ‚úÖ
3. isIsometric ‚Üí IsometricSignal(setCount, totalReps/setCount) ‚úÖ
4. isBodyweight ‚Üí BodyweightSignal(totalReps, diff si previousTotalReps != null) ‚úÖ
5. prescribedLoadKg != null && prescribedLoadKg - avgWeightKg > WEIGHT_TOLERANCE ‚Üí IncreaseLoad ‚úÖ
6. classification == REGRESSION && moduleRequiresDeload ‚Üí ConsiderDeload ‚úÖ
7. classification == POSITIVE_PROGRESSION ‚Üí ProgressInReps ‚úÖ
8. classification == MAINTENANCE ‚Üí MaintainLoad("Mantener carga ‚Äî progresar en reps") ‚úÖ
9. classification == REGRESSION (aislada) ‚Üí MaintainLoad("Mantener carga") ‚úÖ

Decisi√≥n 4 verificada: bodyweight/isom√©trico con regresi√≥n + moduleRequiresDeload ‚Üí se√±al tipo-espec√≠fica, NO ConsiderDeload ‚úÖ
WEIGHT_TOLERANCE = 0.01: prescribedLoadKg - avgWeightKg > 0.01 para IncreaseLoad (estricto, no >=) ‚úÖ
IsometricSignal avgSeconds: totalReps / setCount (int division) ‚Äî correcto para segundos enteros ‚úÖ

=== BLOQUE 6: ERRORES ENCONTRADOS Y CORREGIDOS ===

E1-CORREGIDO: showBottomBar no excluye session-summary ‚Üí agregada tarea Fase 6 ‚úÖ
E2-CORREGIDO: previousTotalReps subquery requer√≠a patr√≥n nested subquery ‚Üí SQL corregido directamente en Fase 2 (eliminada nota dual, query principal ahora usa patr√≥n correcto) ‚úÖ
E3-CORREGIDO: SessionSummaryData necesita directorio data/repository/model/ ‚Üí tarea de creaci√≥n de directorio agregada expl√≠citamente en Fase 3 ‚úÖ
E4-CORREGIDO: getExercisesForSummary usaba HAVING sin GROUP BY ‚Üí agregado GROUP BY se.id antes del HAVING (patr√≥n getBySessionIdWithDetails) ‚úÖ
E5-CORREGIDO: HU-11 listada tanto en "Predecesoras directas" como en "Sin referencia funcional" ‚Üí eliminada de "Sin referencia", solo queda como predecesora directa ‚úÖ
E6-CORREGIDO: HU-06, HU-07, HU-08 no listadas como predecesoras indirectas ‚Üí agregadas con justificaci√≥n (exercise_set data, substitution, CA-08.07 mastery badge) ‚úÖ
E7-CORREGIDO: L√≠neas de c√≥digo inexactas en SessionRepositoryImpl (L39‚ÜíL41, 332‚Üí482 l√≠neas) y TensionNavHost (L264‚ÜíL262) ‚Üí corregidas ‚úÖ

=== BLOQUE 7: CONTRADICCIONES DOCUMENTALES VERIFICADAS ===

C1-RESUELTA: Wireframes E5 tabla se√±ales (4 filas) vs Especificaci√≥n Visual ¬ßE5 (5 filas). La EV desglosa "Est√°ndar" en "DU cumplido" y "DU no cumplido" ‚Äî refinamiento usa la tabla m√°s granular de la EV como fuente de verdad. Sin contradicci√≥n funcional.
C2-RESUELTA: supportingContent l√≠nea 1 ‚Äî EV usa formato "‚Üë Progresi√≥n ¬∑ 60 Kg" (con flecha inline). Refinamiento omite la flecha del texto porque ya aparece en leadingContent (ProgressionIndicator). Duplicar ser√≠a redundante. Decisi√≥n de UX documentada.
C3-RESUELTA: Wireframes standard+mantenimiento dice "Mantener carga"; EV dice "Mantener carga ‚Äî progresar en reps". Refinamiento usa la EV (m√°s detallada) ‚Äî Wireframes son low-fidelity.
C4-NOTA: "Primera sesi√≥n ‚Äî sin referencia" aparece solo en HU-13 Nota 5, no en Wireframes ni EV ¬ßE5. Edge case documentado por el arquitecto para classification == null (Modelo de Datos ¬ß3.11 confirma NULL v√°lido). No contradice la especificaci√≥n.
C5-NOTA: EV ¬ßE5 regresi√≥n est√°ndar dice "Considerar descarga" gen√©ricamente; refinamiento lo condiciona a moduleRequiresDeload == true (HU-12 Decisi√≥n 13). Si regresi√≥n aislada sin alerta m√≥dulo ‚Üí "Mantener carga". Esto es m√°s preciso que la EV, no contradice sino refina.

=== BLOQUE 8: VERIFICACI√ìN CRUZADA 18 HUs ===

Verificadas todas las 18 HUs contra el refinamiento:
- HU-01 a HU-18 auditadas individualmente
- Relaciones confirmadas: 4 predecesoras directas (HU-09/10/11/12), 5 indirectas (HU-01/05/06/07/08), 2 sucesoras (HU-16/17), 7 sin relaci√≥n (HU-02/03/04/14/15/18)
- RF59, RF27, RF33, RF26, RNF05 trazados correctamente
- Visi√≥n del Producto ¬ß6 "resumen inmediato" alineado con CA-13.01
- MDS R1/R6/R7 verificados contra se√±ales de ActionSignalRule
- Mapa de Historias confirma RF59 ‚Üí HU-13 exclusivamente, RNF05 ‚Üí HU-12/13/17

=== RESULTADO FINAL ===
0 HIGH, 0 MEDIUM encontrados. 7 issues LOW/INFO encontrados y CORREGIDOS inline.
Totales verificados: 6 docs arquitectura + 5 docs business + 18 HUs + Mapa de Historias + 14 archivos c√≥digo fuente + 7 CAs + ~19 escenarios test.
Refinamiento t√©cnico APROBADO con correcciones aplicadas. -->