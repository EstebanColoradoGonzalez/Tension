# HU-05 ‚Äî Determinar e iniciar sesi√≥n seg√∫n rotaci√≥n c√≠clica

## Requisitos relacionados

RF09, RF10, RF11, RF12, RNF13

## Descripci√≥n

Como ejecutante, quiero que el sistema determine autom√°ticamente qu√© m√≥dulo y versi√≥n me corresponde entrenar seg√∫n la rotaci√≥n c√≠clica, y que al iniciar sesi√≥n me muestre los ejercicios prescritos con la carga objetivo derivada de mi historial, para saber exactamente qu√© toca entrenar y con cu√°nto peso sin tener que recordar ni calcular nada manualmente.

## Criterios de Aceptaci√≥n

### CA-05.01 ‚Äî Determinaci√≥n autom√°tica del m√≥dulo por rotaci√≥n c√≠clica

**Dado que** el ejecutante desea iniciar una nueva sesi√≥n de entrenamiento,
**cuando** accede a la funcionalidad de iniciar sesi√≥n,
**entonces** el sistema determina autom√°ticamente el m√≥dulo que corresponde seg√∫n la posici√≥n actual en la rotaci√≥n c√≠clica (A‚ÜíB‚ÜíC‚ÜíA‚ÜíB‚ÜíC), bas√°ndose exclusivamente en la secuencia de sesiones completadas (Completadas o Incompletas), sin considerar el d√≠a de la semana ni la fecha del calendario.

### CA-05.02 ‚Äî Determinaci√≥n autom√°tica de la versi√≥n

**Dado que** el sistema ha determinado el m√≥dulo que corresponde,
**cuando** calcula la versi√≥n a ejecutar,
**entonces** asigna la versi√≥n seg√∫n la secuencia de versiones del m√≥dulo: V1‚ÜíV2‚ÜíV3‚ÜíV1 para todos los m√≥dulos (A, B y C), bas√°ndose en la √∫ltima versi√≥n ejecutada del mismo m√≥dulo.

### CA-05.03 ‚Äî Primera sesi√≥n del sistema

**Dado que** el ejecutante no tiene sesiones previas en el sistema,
**cuando** inicia su primera sesi√≥n,
**entonces** el sistema asigna el M√≥dulo A, Versi√≥n 1, como punto de partida de la rotaci√≥n c√≠clica.

### CA-05.04 ‚Äî Persistencia indefinida de la posici√≥n en la rotaci√≥n

**Dado que** el ejecutante ha completado sesiones previas y se ausenta durante un per√≠odo de tiempo (d√≠as, semanas o meses),
**cuando** regresa y desea iniciar una nueva sesi√≥n,
**entonces** el sistema retoma exactamente la posici√≥n en la rotaci√≥n de m√≥dulos y la secuencia de versiones donde se qued√≥, sin reiniciar ni alterar la posici√≥n por la ausencia.

### CA-05.05 ‚Äî Durabilidad del estado de rotaci√≥n

**Dado que** el ejecutante tiene una posici√≥n activa en la rotaci√≥n c√≠clica y la secuencia de versiones,
**cuando** la aplicaci√≥n se cierra, el dispositivo se reinicia o la app se actualiza a una nueva versi√≥n,
**entonces** el estado de rotaci√≥n (m√≥dulo actual y versi√≥n por m√≥dulo) persiste de forma durable y se recupera correctamente al reabrir la aplicaci√≥n.

### CA-05.06 ‚Äî Presentaci√≥n de la prescripci√≥n al iniciar sesi√≥n

**Dado que** el sistema ha determinado el m√≥dulo y la versi√≥n que corresponde,
**cuando** presenta la sesi√≥n al ejecutante,
**entonces** muestra: el identificador del m√≥dulo y versi√≥n asignados, la lista completa de ejercicios prescritos para esa combinaci√≥n m√≥dulo-versi√≥n, y la carga objetivo para cada ejercicio derivada de su √∫ltimo registro hist√≥rico.

### CA-05.07 ‚Äî Carga objetivo para ejercicios sin historial

**Dado que** el ejecutante inicia una sesi√≥n que contiene un ejercicio que nunca ha sido ejecutado previamente,
**cuando** el sistema presenta la prescripci√≥n,
**entonces** el ejercicio se muestra sin carga objetivo precargada, indicando al ejecutante que debe establecer su carga inicial.

### CA-05.08 ‚Äî Carga objetivo derivada del historial

**Dado que** el ejecutante ha registrado previamente datos para un ejercicio prescrito en la sesi√≥n,
**cuando** el sistema presenta la prescripci√≥n,
**entonces** la carga objetivo para ese ejercicio se deriva del √∫ltimo registro hist√≥rico del mismo ejercicio, reflejando incrementos ya calculados por la Regla de Doble Umbral si corresponde, o mantenimiento de carga si no se cumplieron las condiciones de progresi√≥n.

### CA-05.09 ‚Äî Independencia total del calendario

**Dado que** el sistema determina el m√≥dulo y la versi√≥n de una sesi√≥n,
**cuando** realiza el c√°lculo,
**entonces** en ning√∫n momento consulta ni utiliza el d√≠a de la semana, la fecha del calendario ni ninguna referencia temporal para la determinaci√≥n del m√≥dulo o versi√≥n; la decisi√≥n se basa exclusivamente en la secuencia de sesiones completadas.

---

## An√°lisis y Dise√±o Arquitect√≥nico

### Alcance funcional

HU-05 es la historia m√°s compleja hasta ahora. Involucra tres capacidades distintas que se orquestan en un flujo √∫nico:

1. **Determinaci√≥n del m√≥dulo-versi√≥n** ‚Äî Lectura del `rotation_state` para derivar qu√© `module_version_id` corresponde, sin consultar calendario (CA-05.01, CA-05.02, CA-05.03, CA-05.04, CA-05.09).
2. **Creaci√≥n de la sesi√≥n** ‚Äî INSERT en `session` + N INSERTs en `session_exercise` (uno por ejercicio del plan), en transacci√≥n at√≥mica (CA-05.06).
3. **Presentaci√≥n de la prescripci√≥n con carga objetivo** ‚Äî Vista E1 parcial con ejercicios prescritos + carga derivada de `exercise_progression.prescribed_load_kg` o indicaci√≥n "Sin historial" (CA-05.06, CA-05.07, CA-05.08).
4. **Detecci√≥n de sesi√≥n activa pendiente (crash recovery)** ‚Äî B1 detecta si hay una sesi√≥n `IN_PROGRESS` y ofrece reanudarla en lugar de crear una nueva (RNF10).
5. **Transformaci√≥n de B1 de stub a Home funcional** ‚Äî Card "Pr√≥xima Sesi√≥n", Card "Reanudar Sesi√≥n" condicional, contador de microciclos.

**Lo que HU-05 NO incluye** (pertenece a HU-06+):
- Registrar series (HU-06).
- Sustituir ejercicios (HU-07).
- Condiciones especiales de peso corporal/isom√©tricos (HU-08, parcial ‚Äî solo la presentaci√≥n visual).
- Cerrar sesi√≥n y avanzar rotaci√≥n (HU-09).
- Clasificaci√≥n de progresi√≥n (HU-10).
- C√°lculo de Doble Umbral (HU-11).

### Inventario de artefactos

#### 1. Data Layer ‚Äî Entities (Nuevas)

Paquete: `data.local.entity`.

- **`SessionEntity`**: Tabla `session`. PK autoincrement. Columnas:
  - `id` (Long, PK autoincrement).
  - `module_version_id` (Long, NOT NULL, FK ‚Üí `module_version(id)`, ON DELETE RESTRICT).
  - `deload_id` (Long?, nullable, FK ‚Üí `deload(id)`, ON DELETE RESTRICT). **En HU-05 siempre ser√° `null`** ‚Äî la descarga se implementa en HU-17.
  - `date` (String, NOT NULL, ISO 8601 `"YYYY-MM-DD"`).
  - `status` (String, NOT NULL, DEFAULT `"IN_PROGRESS"`). Valores: `"IN_PROGRESS"`, `"COMPLETED"`, `"INCOMPLETE"`.
  - √çndices: `date`, `module_version_id`, `status`, `deload_id`.
  - CHECK constraints: `CHECK(status IN ('IN_PROGRESS', 'COMPLETED', 'INCOMPLETE'))`.

  **Nota sobre FK a `deload`:** La `deload` entity no existe a√∫n (HU-17). Para evitar que la FK falle, se define la columna como nullable sin `@ForeignKey` anotado en HU-05. La FK declarativa se agrega en HU-17 cuando se cree `DeloadEntity`. Esto es aceptable porque `deload_id` siempre ser√° `null` hasta HU-17 y Room no valida FKs contra tablas inexistentes si la columna es nullable sin anotaci√≥n.

  **Alternativa pragm√°tica:** Crear la entity `DeloadEntity` como stub vac√≠o (solo PK) en HU-05 para mantener la FK declarativa desde el inicio. Se descarta esta alternativa porque introduce una tabla sin uso real y con estructura incompleta que requerir√° migraci√≥n.

- **`SessionExerciseEntity`**: Tabla `session_exercise`. PK autoincrement. Columnas:
  - `id` (Long, PK autoincrement).
  - `session_id` (Long, NOT NULL, FK ‚Üí `session(id)`, ON DELETE CASCADE).
  - `exercise_id` (Long, NOT NULL, FK ‚Üí `exercise(id)`, ON DELETE RESTRICT).
  - `original_exercise_id` (Long?, nullable, FK ‚Üí `exercise(id)`, ON DELETE RESTRICT). **En HU-05 siempre ser√° `null`** ‚Äî la sustituci√≥n se implementa en HU-07.
  - `progression_classification` (String?, nullable). **En HU-05 siempre ser√° `null`** ‚Äî la clasificaci√≥n se implementa en HU-10.
  - UNIQUE(`session_id`, `exercise_id`).
  - √çndices: `session_id`, `exercise_id`.
  - CHECK constraint: `CHECK(progression_classification IN ('POSITIVE_PROGRESSION', 'MAINTENANCE', 'REGRESSION') OR progression_classification IS NULL)`.

- **`ExerciseProgressionEntity`**: Tabla `exercise_progression`. PK es `exercise_id` (FK ‚Üí `exercise(id)`). Columnas:
  - `exercise_id` (Long, PK, FK ‚Üí `exercise(id)`, ON DELETE RESTRICT).
  - `status` (String, NOT NULL, DEFAULT `"NO_HISTORY"`). Valores: `"NO_HISTORY"`, `"IN_PROGRESSION"`, `"IN_PLATEAU"`, `"IN_DELOAD"`, `"MASTERED"`.
  - `prescribed_load_kg` (Double?, nullable). **En HU-05 se usa para lectura** ‚Äî es la carga objetivo que se muestra en E1 (CA-05.08). Se actualiza al cierre de sesi√≥n (HU-10/HU-11).
  - `sessions_without_progression` (Int, NOT NULL, DEFAULT 0).
  - CHECK constraints: `CHECK(status IN ('NO_HISTORY', 'IN_PROGRESSION', 'IN_PLATEAU', 'IN_DELOAD', 'MASTERED'))`, `CHECK(prescribed_load_kg >= 0 OR prescribed_load_kg IS NULL)`, `CHECK(sessions_without_progression >= 0)`.

  **Justificaci√≥n de creaci√≥n en HU-05:** Aunque `exercise_progression` se actualiza en HU-10/HU-11, HU-05 necesita **leer** `prescribed_load_kg` para mostrar la carga objetivo en E1 (CA-05.08). Crear la entity ahora permite la consulta. Las filas se crean en HU-06 al registrar la primera serie de un ejercicio (Modelo de Datos ¬ß3.13: "Se crea una fila por ejercicio al registrar la primera serie"). En HU-05, la tabla existir√° vac√≠a para ejercicios sin historial, lo cual se interpreta correctamente como "Sin historial ‚Äî establecer carga" (CA-05.07).

- **`ExerciseSetEntity`**: Tabla `exercise_set`. PK autoincrement. Columnas seg√∫n Modelo de Datos ¬ß3.12:
  - `id` (Long, PK autoincrement).
  - `session_exercise_id` (Long, NOT NULL, FK ‚Üí `session_exercise(id)`, ON DELETE CASCADE).
  - `set_number` (Int, NOT NULL). CHECK: `set_number >= 1 AND set_number <= 4`.
  - `weight_kg` (Double, NOT NULL). CHECK: `weight_kg >= 0`.
  - `reps` (Int, NOT NULL). CHECK: `reps >= 1`.
  - `rir` (Int, NOT NULL). CHECK: `rir >= 0 AND rir <= 5`.
  - UNIQUE(`session_exercise_id`, `set_number`).
  - √çndice: `session_exercise_id`.

  **Justificaci√≥n de creaci√≥n en HU-05:** Aunque HU-06 es quien insertar√° datos en `exercise_set`, crear la tabla ahora permite que: (a) el LEFT JOIN de `SessionExerciseWithDetails` funcione sin error SQL, (b) la versi√≥n de BD (4) incluya el schema completo de sesi√≥n, evitando incremento adicional de versi√≥n en HU-06.

#### 2. Data Layer ‚Äî DAOs (Nuevos y Modificaciones)

Paquete: `data.local.dao`.

- **`SessionDao`** (Nuevo): Interface `@Dao`.
  - `insert(session: SessionEntity): Long` ‚Äî Retorna el ID generado (autoincrement). Usado para crear la sesi√≥n al iniciar.
  - `getActiveSession(): Flow<SessionEntity?>` ‚Äî `@Query("SELECT * FROM session WHERE status = 'IN_PROGRESS' LIMIT 1")`. Para crash recovery: detectar si hay sesi√≥n activa pendiente.
  - `getById(sessionId: Long): Flow<SessionEntity?>` ‚Äî Para obtener datos de una sesi√≥n espec√≠fica.
  - `getActiveSessionWithModuleVersion(): Flow<ActiveSessionInfo?>` ‚Äî Query JOIN que obtiene la sesi√≥n activa (si existe) junto con su `module_code`, `version_number`, total de ejercicios y ejercicios completados. Usado para la Card "Reanudar Sesi√≥n" en B1.

  **`ActiveSessionInfo`**: Data class intermedia (no `@Entity`), definida en `SessionDao.kt`. Campos: `sessionId: Long`, `moduleCode: String`, `versionNumber: Int`, `totalExercises: Int`, `completedExercises: Int`.

  Query para `getActiveSessionWithModuleVersion()`:
  ```sql
  SELECT
      s.id AS sessionId,
      mv.module_code AS moduleCode,
      mv.version_number AS versionNumber,
      (SELECT COUNT(*) FROM session_exercise WHERE session_id = s.id) AS totalExercises,
      (SELECT COUNT(*) FROM session_exercise se2
       INNER JOIN (
           SELECT session_exercise_id, COUNT(*) AS cnt
           FROM exercise_set GROUP BY session_exercise_id HAVING cnt >= 4
       ) completed ON se2.id = completed.session_exercise_id
       WHERE se2.session_id = s.id
      ) AS completedExercises
  FROM session s
  INNER JOIN module_version mv ON s.module_version_id = mv.id
  WHERE s.status = 'IN_PROGRESS'
  LIMIT 1
  ```

- **`SessionExerciseDao`** (Nuevo): Interface `@Dao`.
  - `insertAll(exercises: List<SessionExerciseEntity>)` ‚Äî Insert batch al crear la sesi√≥n. Una fila por cada ejercicio del plan.
  - `getBySessionId(sessionId: Long): Flow<List<SessionExerciseEntity>>` ‚Äî Listar ejercicios de la sesi√≥n activa.
  - `getBySessionIdWithDetails(sessionId: Long): Flow<List<SessionExerciseWithDetails>>` ‚Äî Query JOIN multi-tabla para obtener la informaci√≥n visual de E1: nombre del ejercicio, tipo de equipo, zonas musculares, sets/reps del plan, flags de condici√≥n especial, y conteo de series registradas. **Incluye** LEFT JOIN con `exercise_progression` para obtener `prescribed_load_kg`.

  **`SessionExerciseWithDetails`**: Data class intermedia (no `@Entity`), definida en `SessionExerciseDao.kt`. Campos: `sessionExerciseId: Long`, `exerciseId: Long`, `exerciseName: String`, `equipmentTypeName: String`, `muscleZones: String` (GROUP_CONCAT), `sets: Int`, `reps: String`, `isBodyweight: Int`, `isIsometric: Int`, `isToTechnicalFailure: Int`, `prescribedLoadKg: Double?`, `completedSets: Int`.

  Query JOIN completa:
  ```sql
  SELECT
      se.id AS sessionExerciseId,
      se.exercise_id AS exerciseId,
      e.name AS exerciseName,
      et.name AS equipmentTypeName,
      GROUP_CONCAT(DISTINCT mz.name) AS muscleZones,
      pa.sets,
      pa.reps,
      e.is_bodyweight AS isBodyweight,
      e.is_isometric AS isIsometric,
      e.is_to_technical_failure AS isToTechnicalFailure,
      ep.prescribed_load_kg AS prescribedLoadKg,
      COUNT(DISTINCT es.id) AS completedSets
  FROM session_exercise se
  INNER JOIN exercise e ON se.exercise_id = e.id
  INNER JOIN equipment_type et ON e.equipment_type_id = et.id
  INNER JOIN session s ON se.session_id = s.id
  INNER JOIN plan_assignment pa ON pa.module_version_id = s.module_version_id
      AND pa.exercise_id = se.exercise_id
  LEFT JOIN exercise_muscle_zone emz ON e.id = emz.exercise_id
  LEFT JOIN muscle_zone mz ON emz.muscle_zone_id = mz.id
  LEFT JOIN exercise_progression ep ON e.id = ep.exercise_id
  LEFT JOIN exercise_set es ON se.id = es.session_exercise_id
  WHERE se.session_id = :sessionId
  GROUP BY se.id
  ORDER BY e.name ASC
  ```

  **Nota sobre el JOIN con `plan_assignment`:** Para obtener `sets` y `reps` se une con `plan_assignment` usando la combinaci√≥n (`module_version_id` de la sesi√≥n, `exercise_id` del session_exercise). Si un ejercicio fue sustituido (HU-07), el `exercise_id` en `session_exercise` ya no coincidir√° con el `plan_assignment`. Para el sustituto, `sets` y `reps` deben derivarse del ejercicio sustituto. En HU-05 no hay sustituci√≥n, por lo que este JOIN es correcto. En HU-07, el query deber√° adaptarse para manejar la prescripci√≥n del sustituto (default: 4 series, 8-12 reps).

- **`ExerciseProgressionDao`** (Nuevo): Interface `@Dao`.
  - `getByExerciseId(exerciseId: Long): Flow<ExerciseProgressionEntity?>` ‚Äî Lectura individual. No se usa directamente en HU-05 (se obtiene via JOIN en `SessionExerciseWithDetails`), pero se expone para HU-10/HU-11.
  - `insert(progression: ExerciseProgressionEntity)` ‚Äî Para HU-06. Expuesto ahora para completar el DAO.
  - `update(progression: ExerciseProgressionEntity)` ‚Äî Para HU-10/HU-11. Expuesto ahora.

- **`ExerciseSetDao`** (Nuevo, stub): Interface `@Dao` vac√≠a. Se expone en `TensionDatabase`. Los m√©todos se implementan en HU-06.

- **`ModuleVersionDao`** (Modificaci√≥n): Agregar:
  - `getByModuleCodeAndVersion(moduleCode: String, versionNumber: Int): Flow<ModuleVersionEntity?>` ‚Äî `@Query("SELECT * FROM module_version WHERE module_code = :moduleCode AND version_number = :versionNumber LIMIT 1")`. Para resolver `(moduleCode, versionNumber)` ‚Üí `module_version_id` en la l√≥gica de determinaci√≥n de pr√≥xima sesi√≥n. Alternativa: usar `getAll()` existente y filtrar en memoria (solo 9 filas). Se prefiere la query dedicada por claridad sem√°ntica.

- **`RotationStateDao`** (Modificaci√≥n): Agregar:
  - `update(state: RotationStateEntity)` ‚Äî `@Update`. Para avanzar la rotaci√≥n al cerrar sesi√≥n (HU-09). Expuesto ahora para preparar HU-09.

#### 3. Data Layer ‚Äî Repository (Nuevo)

Paquete: `data.repository`.

- **`SessionRepositoryImpl`**: Implementa `SessionRepository`. Inyecta `SessionDao`, `SessionExerciseDao`, `PlanAssignmentDao`, `RotationStateDao`, `ModuleVersionDao`, `TensionDatabase` (para transacciones). M√©todos:

  - `getNextModuleVersionId(): Flow<Long>` ‚Äî **L√≥gica central de determinaci√≥n** (CA-05.01, CA-05.02, CA-05.03). Lee `rotation_state` y calcula el `module_version_id` correspondiente:
    1. Obtiene `micyclePosition` (1-6) del `rotation_state`.
    2. Mapea posici√≥n a m√≥dulo: 1,4 ‚Üí A; 2,5 ‚Üí B; 3,6 ‚Üí C.
    3. Obtiene la versi√≥n actual del m√≥dulo correspondiente: `current_version_module_a`, `_b`, o `_c`.
    4. Busca el `module_version_id` en la tabla `module_version` que coincida con (module_code, version_number).
    5. Retorna el ID como Flow (reactivo ‚Äî si la rotaci√≥n cambia, el Flow emite).

  - `startSession(moduleVersionId: Long): Long` ‚Äî Crea la sesi√≥n en transacci√≥n at√≥mica:
    1. Valida que NO exista sesi√≥n `IN_PROGRESS` (solo una sesi√≥n activa a la vez).
    2. INSERT `SessionEntity(module_version_id = moduleVersionId, date = LocalDate.now().toString(), status = "IN_PROGRESS", deload_id = null)`.
    3. Consulta `plan_assignment` para obtener los `exercise_id` del `moduleVersionId` (via `planAssignmentDao.getByModuleVersionId(moduleVersionId).first()` ‚Äî lectura one-shot del Flow).
    4. **Valida que la lista de ejercicios no est√© vac√≠a** (defensa contra versi√≥n del plan sin ejercicios asignados, edge case de HU-04 CA-04.08 si el usuario desasigna todos los ejercicios). Si vac√≠a, lanza `IllegalStateException("No exercises assigned to this module version")`.
    5. INSERT batch en `session_exercise`: una fila por cada ejercicio del plan, con `exercise_id` del plan, `session_id` de la sesi√≥n reci√©n creada, `original_exercise_id = null`, `progression_classification = null`.
    6. Retorna el `sessionId` generado.

  - `getActiveSession(): Flow<ActiveSession?>` ‚Äî Delega a `SessionDao.getActiveSessionWithModuleVersion()`. Mapea `ActiveSessionInfo` ‚Üí domain `ActiveSession`.

  - `getSessionExercises(sessionId: Long): Flow<List<SessionExerciseDetail>>` ‚Äî Delega a `SessionExerciseDao.getBySessionIdWithDetails()` y mapea `SessionExerciseWithDetails` ‚Üí domain model `SessionExerciseDetail`, incluyendo derivaci√≥n de `ExerciseSessionStatus` a partir de `completedSets`.

  - `getRotationState(): Flow<RotationState?>` ‚Äî Delega a `RotationStateDao.getRotationState()` y mapea `RotationStateEntity` ‚Üí domain model `RotationState`.

  - `getSessionModuleVersion(sessionId: Long): Flow<Pair<String, Int>?>` ‚Äî Consulta la sesi√≥n por ID, obtiene `module_version_id`, luego hace lookup en `ModuleVersionDao.getById()` para resolver `(moduleCode, versionNumber)`. Usado por `ActiveSessionViewModel` para el Top Bar de E1.

#### 4. Domain Layer ‚Äî Models (Nuevos)

Paquete: `domain.model`.

- **`RotationState`**: Data class ‚Äî `microcyclePosition: Int`, `currentVersionModuleA: Int`, `currentVersionModuleB: Int`, `currentVersionModuleC: Int`, `microcycleCount: Int`.

- **`SessionExerciseDetail`**: Data class para E1, contiene toda la informaci√≥n visual de un ejercicio en sesi√≥n:
  - `sessionExerciseId: Long`.
  - `exerciseId: Long`.
  - `name: String`.
  - `equipmentTypeName: String`.
  - `muscleZones: List<String>`.
  - `sets: Int`.
  - `reps: String`.
  - `isBodyweight: Boolean`.
  - `isIsometric: Boolean`.
  - `isToTechnicalFailure: Boolean`.
  - `prescribedLoadKg: Double?` ‚Äî `null` = sin historial (CA-05.07), valor = carga objetivo (CA-05.08).
  - `completedSets: Int` ‚Äî series registradas (0-4). Determina el estado derivado.
  - `status: ExerciseSessionStatus` ‚Äî derivado: `NOT_STARTED` (0 series), `IN_PROGRESS` (1-3), `COMPLETED` (4).

- **`ExerciseSessionStatus`**: Enum class ‚Äî `NOT_STARTED`, `IN_PROGRESS`, `COMPLETED`. Derivado en la capa de mapeo, no almacenado en BD (Modelo de Datos ¬ß3.11: "El estado del ejercicio dentro de la sesi√≥n no se almacena ‚Äî se deriva").

- **`NextSession`**: Data class para B1 Card "Pr√≥xima Sesi√≥n" ‚Äî `moduleCode: String`, `versionNumber: Int`, `moduleVersionId: Long`.

- **`ActiveSession`**: Data class para B1 Card "Reanudar Sesi√≥n" ‚Äî `sessionId: Long`, `moduleCode: String`, `versionNumber: Int`, `totalExercises: Int`, `completedExercises: Int`.

#### 5. Domain Layer ‚Äî Repository Interface (Nuevo)

Paquete: `domain.repository`.

- **`SessionRepository`**: Interface.
  - `getNextModuleVersionId(): Flow<Long>`.
  - `startSession(moduleVersionId: Long): Long`.
  - `getActiveSession(): Flow<ActiveSession?>`.
  - `getSessionExercises(sessionId: Long): Flow<List<SessionExerciseDetail>>`.
  - `getRotationState(): Flow<RotationState?>`.
  - `getSessionModuleVersion(sessionId: Long): Flow<Pair<String, Int>?>` ‚Äî Retorna `(moduleCode, versionNumber)` para una sesi√≥n dada. Usado por `ActiveSessionViewModel` para poblar el Top Bar de E1.

#### 6. Domain Layer ‚Äî Use Cases (Nuevos)

Paquete: `domain.usecase`.

- **`GetNextSessionInfoUseCase`**: Inyecta `SessionRepository`. Expone `operator fun invoke(): Flow<NextSession>`. Combina `getRotationState()` con la resoluci√≥n del m√≥dulo/versi√≥n para producir un `NextSession` con `moduleCode`, `versionNumber`, `moduleVersionId`.

  L√≥gica de resoluci√≥n `micyclePosition` ‚Üí `moduleCode`:
  ```kotlin
  fun resolveModuleCode(position: Int): String = when (position) {
      1, 4 -> "A"
      2, 5 -> "B"
      3, 6 -> "C"
      else -> error("Invalid microcycle position: $position")
  }
  ```

  L√≥gica de resoluci√≥n `moduleCode` + `currentVersion` ‚Üí `moduleVersionId`: Se requiere un lookup en `module_version` table. Para evitar una query adicional, se puede calcular el ID directamente si los IDs son secuenciales y conocidos: A-V1=1, A-V2=2, A-V3=3, B-V1=4, B-V2=5, B-V3=6, C-V1=7, C-V2=8, C-V3=9. La f√≥rmula es `(moduleIndex * 3) + versionNumber`, donde moduleIndex = 0 (A), 1 (B), 2 (C). **Sin embargo**, esta optimizaci√≥n acopla el c√≥digo a los IDs del seed. Es preferible hacer la query para mantener correctitud si el ejecutante custom asigna ejercicios que alteran el plan. Se usa `ModuleVersionDao.getAll()` que ya est√° disponible y tiene solo 9 filas en cache via Flow.

- **`GetActiveSessionUseCase`**: Inyecta `SessionRepository`. Expone `operator fun invoke(): Flow<ActiveSession?>`. Delega a `getActiveSession()`. Para B1 crash recovery card.

- **`StartSessionUseCase`**: Inyecta `SessionRepository`. Expone `suspend operator fun invoke(moduleVersionId: Long): Long`. Delega a `startSession()`. Retorna el `sessionId`. Si ya existe sesi√≥n activa, lanza `IllegalStateException`.

- **`GetSessionExercisesUseCase`**: Inyecta `SessionRepository`. Expone `operator fun invoke(sessionId: Long): Flow<List<SessionExerciseDetail>>`. Delega a `getSessionExercises()`. Usado por `ActiveSessionViewModel`.

- **`GetMicrocycleCountUseCase`**: Inyecta `SessionRepository`. Expone `operator fun invoke(): Flow<Int>`. Delega a `getRotationState()` y mapea a `microcycleCount`. Para B1 indicador de progreso.

#### 7. Data Layer ‚Äî Database (Modificaci√≥n)

- **`TensionDatabase`**: Agregar las 4 nuevas entities al array:
  - `SessionEntity::class`
  - `SessionExerciseEntity::class`
  - `ExerciseProgressionEntity::class`
  - `ExerciseSetEntity::class`
  Versi√≥n incrementa a **4** (se mantiene `fallbackToDestructiveMigration()` durante desarrollo).
  Exponer los 4 nuevos DAOs: `sessionDao()`, `sessionExerciseDao()`, `exerciseProgressionDao()`, `exerciseSetDao()`.

#### 8. UI Layer ‚Äî B1 Home (Reemplazo del stub)

Paquete: `ui.home`.

- **`HomeScreen`** (Reemplazo): Se reemplaza el contenido del stub existente ([HomeScreen.kt](Tension/app/src/main/java/com/estebancoloradogonzalez/tension/ui/home/HomeScreen.kt)) con la implementaci√≥n funcional. Estructura seg√∫n Wireframes B1 y Especificaci√≥n Visual ¬ß8 B1:

  - **Top Bar**: Custom inline (no `TensionTopAppBar` gen√©rico). Implementado como composable Row dentro de un `Surface`:
    - Izquierda: `Text "Tension"`, Title Large, color Primary (`#8B1A1A`). Padding horizontal 16 dp.
    - Derecha: `IconButton` con √≠cono `Notifications` (Material Symbol), tint On Surface Variant. Badge M3 superpuesto: `containerColor = Error`, `content = On Error`, texto con n√∫mero de alertas activas. Sin alertas activas: badge punto (6 dp), `containerColor = Outline`. **En HU-05, el badge siempre muestra 0** (punto sin n√∫mero). El conteo real de alertas se implementa en HU-26+. El tap navega a H1 (placeholder).

  - **Body** (`LazyColumn` scrollable): Cards condicionales seg√∫n estado.

  - **Card "Reanudar Sesi√≥n"** (condicional, Wireframes B1 #4): `ElevatedCard` con fondo `Error Container (#FFDAD6)`, elevation Level 2 (3 dp), corner 12 dp. Solo visible si hay sesi√≥n `IN_PROGRESS` (crash recovery, RNF10).
    - √çcono ‚ö†Ô∏è (24 dp, tint Error) + texto "Tienes una sesi√≥n activa sin cerrar" (Title Medium, On Error Container `#410002`).
    - Subt√≠tulo l√≠nea 1: "M√≥dulo X ‚Äî Versi√≥n N" (Body Medium, On Error Container). Formato: `home_next_session_format`.
    - Subt√≠tulo l√≠nea 2: "N de M ejercicios completados" (Body Medium, On Error Container). Formato: `home_resume_progress`.
    - Bot√≥n "Reanudar Sesi√≥n" (Filled Button, containerColor Primary, contentColor On Primary) ‚Üí navega a E1 con `sessionId` existente.
    - **Cuando visible, la Card "Pr√≥xima Sesi√≥n" se OCULTA** (Wireframes B1 estados, Especificaci√≥n Visual ¬ß8 B1 Card Reanudar "Cuando visible, se muestra ANTES de Card Pr√≥xima Sesi√≥n y la oculta").

  - **Card "Pr√≥xima Sesi√≥n"** (Wireframes B1 #3, visible si no hay sesi√≥n activa): `FilledCard` con fondo `Primary Container (#F5DDDD)`, corner 12 dp, elevation tonal (Level 1). **Oculta si hay sesi√≥n pendiente de reanudar.**
    - "M√≥dulo X ‚Äî Versi√≥n N" (Title Medium, On Primary Container `#5C0E0E`). Formato: `home_next_session_format`.
    - "Tu pr√≥xima sesi√≥n" (Body Medium, On Primary Container).
    - Bot√≥n "Iniciar Sesi√≥n" (Filled Button, full width dentro de card, containerColor Primary, contentColor On Primary) ‚Üí llama a `StartSessionUseCase`, luego navega a E1 con el `sessionId` nuevo.
    - Padding card interno: 16 dp.

  - **Secci√≥n "Progreso"** (Wireframes B1 #5): Indicador num√©rico de microciclos completados.
    - Separaci√≥n top: 24 dp (Divider M3, Outline Variant).
    - N√∫mero (Headline Medium, Primary).
    - Label "microciclos" (Body Small, On Surface Variant).
    - Centrado horizontalmente. Sin card, texto directo.
    - HU-18 agrega el label "Microciclos completados" como t√≠tulo de secci√≥n. El Wireframe lo muestra pero la Especificaci√≥n Visual solo incluye n√∫mero + label, por lo que se difiere a HU-18.

  - **Card "Estado de Descarga"** (Wireframes B1 #6): **En HU-05 siempre oculta** ‚Äî la descarga se implementa en HU-16/HU-17. No se renderiza nada.

  - **No tiene Top App Bar gen√©rica (`TensionTopAppBar`)** ‚Äî su Top Bar es custom inline (Especificaci√≥n Visual B1: Text Title Large "Tension" + Badge alertas).

  Firma actualizada:
  ```kotlin
  @Composable
  fun HomeScreen(
      onNavigateToAlerts: () -> Unit,
      onNavigateToActiveSession: (Long) -> Unit,
      viewModel: HomeViewModel = hiltViewModel(),
  )
  ```

- **`HomeViewModel`**: `@HiltViewModel`. Inyecta `GetNextSessionInfoUseCase`, `GetActiveSessionUseCase`, `StartSessionUseCase`, `GetMicrocycleCountUseCase`. Estado: `StateFlow<HomeUiState>`.

  - En `init`, combina los 3 Flows (next session info, active session, microcycle count) via `combine()` y mapea a `HomeUiState`.
  - M√©todo `startSession()`: llama a `StartSessionUseCase` en `viewModelScope.launch`. Expone resultado via `SharedFlow<Long>` (oneshot event con `sessionId` para navegaci√≥n a E1). Se usa `MutableSharedFlow` con `replay = 0` para que el evento se consuma una sola vez.
  - M√©todo `resumeSession(sessionId: Long)`: emite el `sessionId` en el mismo `SharedFlow`. La UI observa este Flow y navega.

- **`HomeUiState`**: Data class:
  - `isLoading: Boolean = true`.
  - `nextSession: NextSession? = null` ‚Äî m√≥dulo/versi√≥n/moduleVersionId. Null si hay sesi√≥n activa.
  - `activeSession: ActiveSession? = null` ‚Äî info de crash recovery. Null si no hay sesi√≥n pendiente.
  - `microcycleCount: Int = 0`.
  - `alertCount: Int = 0` ‚Äî siempre 0 en HU-05.

  Propiedades derivadas:
  - `showNextSessionCard: Boolean get() = activeSession == null`.
  - `showResumeCard: Boolean get() = activeSession != null`.

#### 9. UI Layer ‚Äî E1 Sesi√≥n Activa (Nuevo, parcial)

Paquete: `ui.session`.

- **`ActiveSessionScreen`**: Composable de nivel pantalla. Recibe `sessionId` como argumento de navegaci√≥n. Estructura seg√∫n Wireframes E1 y Especificaci√≥n Visual ¬ß8 E1:

  - **Top Bar** (custom, no CenterAligned): Sin Bottom Navigation.
    - L√≠nea 1: `Text "M√≥dulo X ‚Äî Versi√≥n N"`, Title Large, On Surface, alineado izquierda. Formato: `session_module_version_format`.
    - L√≠nea 2: `Text "Sesi√≥n activa"`, Title Small, On Surface Variant.
    - **Badge descarga**: Condicional (HU-17). En HU-05 siempre oculto.

  - **Barra de progreso** (Wireframes E1, Especificaci√≥n Visual ¬ß8 E1):
    - Texto: "N de M ejercicios completados" (Body Medium, On Surface). Formato: `session_progress_format`.
    - `LinearProgressIndicator` determinate: track Surface Variant, indicator Primary, height 8 dp, corner 4 dp.
    - Porcentaje: Label Small, On Surface Variant, alineado derecha.

  - **Lista de ejercicios** (`LazyColumn`): Cada ejercicio renderizado seg√∫n su estado derivado (`ExerciseSessionStatus`):

    - **No Iniciado** (`completedSets == 0`): `OutlinedCard` 88 dp. Borde Outline Variant, fondo transparente (Background). Leading ‚ö™ gris Outline (`#857370`), 24 dp. L√≠nea 1: Title Medium, On Surface (nombre). L√≠nea 2: `session_status_not_started` (Body Medium, On Surface Variant). L√≠nea 3: carga objetivo (variantes seg√∫n tipo ‚Äî ver tabla abajo).
      - Trailing: `Row` con spacing 8 dp: "Registrar" (Filled Tonal Button, compact 36 dp visual height, **48 dp touch target**, containerColor Primary Container, contentColor On Primary Container) + "Sustituir" (Outlined Button, compact, borderColor Outline, **48 dp touch target**) + IconButton üì∑ (tint On Surface Variant, 48√ó48 dp touch, 24 dp icon).
      - **En HU-05**: "Registrar" ‚Üí `onClick = { /* TODO: HU-06 */ }`, "Sustituir" ‚Üí `onClick = { /* TODO: HU-07 */ }`, üì∑ ‚Üí `onClick = { onNavigateToExerciseDetail(exerciseId) }` (navega a D2).

    - **En Ejecuci√≥n** (`completedSets` 1-3): `FilledCard` 88 dp. Fondo azul `#E3F2FD` (light) / `#1A2733` (dark). Leading üîµ azul (`#1565C0`), 24 dp. L√≠nea 2: `session_status_in_progress`. Sin bot√≥n "Sustituir" (CA-07.06: solo si 0 series). **En HU-05 este estado nunca se alcanza.** Se implementa el renderizado para preparar HU-06.

    - **Completado** (`completedSets == 4`): `FilledCard` 72 dp. Fondo verde `#E8F5E9` (light) / `#1A2E1A` (dark). Leading ‚úÖ verde (`#2E7D32`), 24 dp. L√≠nea 2: `session_status_completed`. Texto: On Surface con opacity 0.7. Sin botones de acci√≥n, solo üì∑. **En HU-05 nunca se alcanza.**

    **Variantes de carga mostrada (L√≠nea 3):**

    | Tipo | Condici√≥n | Texto | Estilo |
    |---|---|---|---|
    | Est√°ndar con historial | `!isBodyweight && !isIsometric && prescribedLoadKg != null` | "60 Kg" | Body Medium, On Surface |
    | Est√°ndar sin historial | `!isBodyweight && !isIsometric && prescribedLoadKg == null` | "Sin historial ‚Äî establecer carga" | Body Medium, On Surface Variant, fontStyle italic |
    | Peso corporal | `isBodyweight && !isIsometric` | "Peso corporal" | Body Medium, On Surface Variant |
    | Isom√©trico | `isIsometric` | "Isom√©trico (30-45s)" | Body Medium, On Surface Variant |

  - **Bot√≥n "Cerrar Sesi√≥n"** (Wireframes E1): `OutlinedButton` full width. `borderColor = Secondary (#6B4F4F)`. `contentColor = Secondary`. Margin top 24 dp. **En HU-05**: `onClick = { /* TODO: HU-09 */ }` (stub).

  - **Sin Bottom Navigation** (Arquitectura T√©cnica ¬ß4.5.1: E1 siempre oculta).

  - **`BackHandler`**: Intercepta el back press para prevenir abandono accidental. En HU-05: `BackHandler { /* no-op: el usuario debe cerrar sesi√≥n formalmente */ }`. En HU-09 se reemplaza con di√°logo de confirmaci√≥n.

  Firma:
  ```kotlin
  @Composable
  fun ActiveSessionScreen(
      onNavigateToRegisterSet: (Long) -> Unit,
      onNavigateToSubstitute: (Long) -> Unit,
      onNavigateToExerciseDetail: (Long) -> Unit,
      onNavigateToSessionSummary: (Long) -> Unit,
      onNavigateToHome: () -> Unit,
      viewModel: ActiveSessionViewModel = hiltViewModel(),
  )
  ```

- **`ActiveSessionViewModel`**: `@HiltViewModel`. Inyecta `GetSessionExercisesUseCase`. Recibe `sessionId` v√≠a `SavedStateHandle`. Estado: `StateFlow<ActiveSessionUiState>`.

  - En `init`, obtiene `sessionId` del SavedStateHandle, recolecta `GetSessionExercisesUseCase(sessionId)` y mapea a `ActiveSessionUiState`.
  - La informaci√≥n del m√≥dulo/versi√≥n (para el Top Bar) se obtiene combinando con un Flow adicional que resuelve la sesi√≥n ‚Üí module_version ‚Üí moduleCode + versionNumber, v√≠a `SessionRepository.getSessionModuleVersion(sessionId)` (nuevo m√©todo auxiliar de solo lectura).

- **`ActiveSessionUiState`**: Data class:
  - `isLoading: Boolean = true`.
  - `moduleCode: String = ""`.
  - `versionNumber: Int = 0`.
  - `exercises: List<ExerciseUiItem> = emptyList()`.
  - `completedCount: Int` ‚Äî derived: `exercises.count { it.status == ExerciseSessionStatus.COMPLETED }`.
  - `totalCount: Int` ‚Äî derived: `exercises.size`.
  - `progress: Float` ‚Äî derived: `if (totalCount > 0) completedCount.toFloat() / totalCount else 0f`.

- **`ExerciseUiItem`**: Data class para renderizado:
  - `sessionExerciseId: Long`.
  - `exerciseId: Long`.
  - `name: String`.
  - `equipmentTypeName: String`.
  - `muscleZones: String` ‚Äî concatenadas con ", ".
  - `sets: Int`.
  - `reps: String`.
  - `prescribedLoadKg: Double?`.
  - `isBodyweight: Boolean`.
  - `isIsometric: Boolean`.
  - `isToTechnicalFailure: Boolean`.
  - `completedSets: Int`.
  - `status: ExerciseSessionStatus`.
  - `loadDisplayText: String` ‚Äî precalculado en el mapper.
  - `statusDisplayText: String` ‚Äî precalculado (ej: "No Iniciado ¬∑ 0/4 series").

#### 10. UI Layer ‚Äî Navegaci√≥n (Modificaciones)

- **`NavigationRoutes`**: Agregar:
  - `const val ACTIVE_SESSION = "active-session/{sessionId}"`.
  - `fun activeSessionRoute(sessionId: Long) = "active-session/$sessionId"`.

- **`TensionNavHost`**: Modificaciones:
  - Actualizar el composable `HOME` para pasar `onNavigateToActiveSession` al `HomeScreen`. Implementaci√≥n del callback:
    ```kotlin
    onNavigateToActiveSession = { sessionId ->
        navController.navigate(NavigationRoutes.activeSessionRoute(sessionId))
    }
    ```
  - Agregar composable para `ACTIVE_SESSION`:
    ```kotlin
    composable(
        route = NavigationRoutes.ACTIVE_SESSION,
        arguments = listOf(navArgument("sessionId") { type = NavType.LongType }),
    ) {
        ActiveSessionScreen(
            onNavigateToRegisterSet = { /* TODO: HU-06 */ },
            onNavigateToSubstitute = { /* TODO: HU-07 */ },
            onNavigateToExerciseDetail = { exerciseId ->
                navController.navigate(NavigationRoutes.exerciseDetailRoute(exerciseId))
            },
            onNavigateToSessionSummary = { /* TODO: HU-09 */ },
            onNavigateToHome = {
                navController.navigate(NavigationRoutes.HOME) {
                    popUpTo(NavigationRoutes.HOME) { inclusive = true }
                }
            },
        )
    }
    ```

- **`BottomNavigationBar` / visibilidad**: La l√≥gica `showBottomBar` en `TensionNavHost` debe excluir las rutas de sesi√≥n. La implementaci√≥n actual solo excluye `REGISTER`. Se ampl√≠a:
  ```kotlin
  val showBottomBar = currentRoute != null &&
      currentRoute != NavigationRoutes.REGISTER &&
      !currentRoute.startsWith("active-session")
  ```
  Esto cubre E1. Cuando se implementen E2, E3 y E5 (HU-06, HU-07, HU-09), se agregar√°n sus prefijos tambi√©n.

#### 11. UI Layer ‚Äî Recursos

- **`strings.xml`**: Agregar strings para B1 y E1. Los strings del stub anterior (`home_welcome`, `home_description`) se eliminan o se dejan obsoletos (sin impacto funcional):
  ```xml
  <!-- Home B1 (funcional) -->
  <string name="home_next_session_label">Tu pr√≥xima sesi√≥n</string>
  <string name="home_next_session_format">M√≥dulo %1$s \u2014 Versi√≥n %2$d</string>
  <string name="home_start_session">Iniciar Sesi√≥n</string>
  <string name="home_resume_title">Tienes una sesi√≥n activa sin cerrar</string>
  <string name="home_resume_progress">%1$d de %2$d ejercicios completados</string>
  <string name="home_resume_session">Reanudar Sesi√≥n</string>
  <string name="home_microcycles_label">microciclos</string>
  <string name="home_alert_badge_description">Alertas activas</string>

  <!-- Active Session E1 -->
  <string name="session_active_label">Sesi√≥n activa</string>
  <string name="session_module_version_format">M√≥dulo %1$s \u2014 Versi√≥n %2$d</string>
  <string name="session_progress_format">%1$d de %2$d ejercicios completados</string>
  <string name="session_status_not_started">No Iniciado \u00b7 %1$d/%2$d series</string>
  <string name="session_status_in_progress">En Ejecuci√≥n \u00b7 %1$d/%2$d series</string>
  <string name="session_status_completed">Completado \u00b7 %1$d/%2$d series</string>
  <string name="session_load_kg_format">%.1f Kg</string>
  <string name="session_load_no_history">Sin historial \u2014 establecer carga</string>
  <string name="session_load_bodyweight">Peso corporal</string>
  <string name="session_load_isometric">Isom√©trico (30\u201345s)</string>
  <string name="session_register_set">Registrar</string>
  <string name="session_substitute">Sustituir</string>
  <string name="session_close">Cerrar Sesi√≥n</string>
  ```

#### 12. DI Layer ‚Äî Hilt Modules (Modificaciones)

- **`DatabaseModule`**: Agregar 4 providers:
  - `provideSessionDao(database): SessionDao`
  - `provideSessionExerciseDao(database): SessionExerciseDao`
  - `provideExerciseProgressionDao(database): ExerciseProgressionDao`
  - `provideExerciseSetDao(database): ExerciseSetDao`

- **`RepositoryModule`**: Agregar binding:
  ```kotlin
  @Binds @Singleton
  abstract fun bindSessionRepository(impl: SessionRepositoryImpl): SessionRepository
  ```

### Dependencias y precondiciones

| Precondici√≥n | Fuente | Estado |
|---|---|---|
| `RotationStateEntity` existe y se inicializa al crear perfil | HU-01 | ‚úÖ Implementada |
| `RotationStateDao.getRotationState()` disponible | HU-01 | ‚úÖ Implementada |
| `ModuleVersionEntity` con 9 filas seed (IDs 1-9) | HU-03 | ‚úÖ Implementada |
| `PlanAssignmentEntity` con 93 filas seed | HU-03 | ‚úÖ Implementada |
| `PlanAssignmentDao.getByModuleVersionId()` disponible | HU-03 | ‚úÖ Implementada |
| `ModuleVersionDao.getById()` disponible | HU-04 | ‚úÖ Implementada |
| `ModuleVersionDao.getAll()` disponible | HU-03 | ‚úÖ Implementada |
| Navegaci√≥n B1‚ÜíE1 definida en Mapa de Navegaci√≥n | Arquitectura | ‚úÖ Documentada |
| Ruta `active-session/{sessionId}` definida | Arquitectura T√©cnica ¬ß4.3 #9 | ‚úÖ Documentada |
| Bottom Nav oculta en E1 | Arquitectura T√©cnica ¬ß4.5.1 | ‚úÖ Documentada |

### Hitos de implementaci√≥n

| # | Entregable | Dependencia |
|---|---|---|
| 1 | Data Layer ‚Äî Entities: `SessionEntity`, `SessionExerciseEntity`, `ExerciseProgressionEntity`, `ExerciseSetEntity` | ‚Äî |
| 2 | Data Layer ‚Äî DAOs: `SessionDao` (+ `ActiveSessionInfo`), `SessionExerciseDao` (+ `SessionExerciseWithDetails`), `ExerciseProgressionDao`, `ExerciseSetDao` (stub), `RotationStateDao` (+update) | Hito 1 |
| 3 | Data Layer ‚Äî `TensionDatabase` (version 4, +4 entities, +4 DAOs) | Hito 1, Hito 2 |
| 4 | Domain ‚Äî Models: `RotationState`, `SessionExerciseDetail`, `ExerciseSessionStatus`, `NextSession`, `ActiveSession` | ‚Äî |
| 5 | Domain ‚Äî Repository interface `SessionRepository` + Use Cases (5) | Hito 4 |
| 6 | Data Layer ‚Äî `SessionRepositoryImpl` (l√≥gica de rotaci√≥n + startSession + queries) | Hito 2, Hito 3, Hito 5 |
| 7 | DI ‚Äî `DatabaseModule` (+4 DAOs), `RepositoryModule` (+SessionRepository) | Hito 3, Hito 6 |
| 8 | UI ‚Äî `HomeScreen` reemplazo + `HomeViewModel` + `HomeUiState` | Hito 5, Hito 7 |
| 9 | UI ‚Äî `ActiveSessionScreen` + `ActiveSessionViewModel` + `ActiveSessionUiState` + `ExerciseUiItem` | Hito 5, Hito 7 |
| 10 | Navegaci√≥n ‚Äî `NavigationRoutes` (+ACTIVE_SESSION), `TensionNavHost` (B1 actualizado, E1 nuevo), Bottom Nav (exclusi√≥n sesi√≥n) | Hito 8, Hito 9 |
| 11 | Recursos ‚Äî `strings.xml` (+strings B1/E1) | ‚Äî (independiente) |

### Notas de auditor√≠a

1. **CA-05.01 (rotaci√≥n c√≠clica) se resuelve leyendo `rotation_state.microcycle_position`.** El mapeo posici√≥n‚Üím√≥dulo es determin√≠stico: 1,4‚ÜíA; 2,5‚ÜíB; 3,6‚ÜíC. No se consulta fecha ni calendario en ning√∫n punto del flujo ‚Äî la fecha solo se usa como metadato de `session.date` al persistir (CA-05.09). La rotaci√≥n es agn√≥stica al calendario por dise√±o (MDS ¬ß5.A.1: "Al sistema no le importa qu√© d√≠a de la semana es; solo responde a '¬øQu√© toca entrenar ahora?'").
2. **CA-05.02 (versi√≥n) se resuelve leyendo `current_version_module_X` del `rotation_state`.** Cada m√≥dulo tiene su versi√≥n independiente (3 columnas separadas). Las versiones rotan V1‚ÜíV2‚ÜíV3‚ÜíV1 al inicio de cada microciclo nuevo (HU-09 avance). En HU-05 solo se lee; la escritura la hace HU-09 al cerrar sesi√≥n.
3. **CA-05.03 (primera sesi√≥n) se cumple por valores por defecto del `RotationStateEntity`.** `microcyclePosition = 1`, `currentVersionModuleA = 1` (c√≥digo verificado en [RotationStateEntity.kt](Tension/app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/RotationStateEntity.kt)). Posici√≥n 1 ‚Üí M√≥dulo A, Versi√≥n 1. El `module_version` con (A, 1) tiene `id = 1` (seed data Modelo de Datos ¬ß3.6, verificado en [PlanSeeder.kt](Tension/app/src/main/java/com/estebancoloradogonzalez/tension/data/local/seed/PlanSeeder.kt) l√≠nea `mv(db, 1, "A", 1)`).
4. **CA-05.04 y CA-05.05 (persistencia/durabilidad) se cumplen por dise√±o de Room.** `rotation_state` est√° en SQLite ‚Äî persiste tras cierre de app, reinicio de dispositivo y actualizaci√≥n de versi√≥n de app (RNF13). La fila se inicializa en `ProfileRepositoryImpl.createProfile()` (HU-01) dentro de transacci√≥n at√≥mica.
5. **CA-05.06 (prescripci√≥n) se resuelve con la query JOIN en `SessionExerciseDao.getBySessionIdWithDetails()`.** La lista completa de ejercicios + carga objetivo se obtiene en una sola consulta. El `module_version_id` de la sesi√≥n se usa para unir con `plan_assignment` y obtener `sets` y `reps`. La carga viene de `exercise_progression.prescribed_load_kg` via LEFT JOIN.
6. **CA-05.07 (sin historial) se resuelve con NULL.** Si no existe fila en `exercise_progression` para un ejercicio, el LEFT JOIN retorna `NULL` en `prescribedLoadKg`. La UI mapea `null` ‚Üí "Sin historial ‚Äî establecer carga" con fontStyle italic (Especificaci√≥n Visual ¬ß8 E1).
7. **CA-05.08 (carga del historial) se resuelve con `exercise_progression.prescribed_load_kg`.** Este campo se calcula y persiste al cierre de cada sesi√≥n por HU-10/HU-11 (Modelo de Datos ¬ß3.13: "Calculada por el motor de Doble Umbral al cierre de sesi√≥n y persistida"). En HU-05, para la primera sesi√≥n (sin historial), todas las cargas ser√°n `null`.
8. **RNF10 (crash recovery) se implementa en B1.** El `SessionDao.getActiveSessionWithModuleVersion()` detecta si hay sesi√≥n `IN_PROGRESS`. Si existe, B1 muestra la Card "Reanudar Sesi√≥n" con progreso parcial y oculta la Card "Pr√≥xima Sesi√≥n". Al tocar "Reanudar" ‚Üí navega a E1 con el `sessionId` existente, donde el Flow reactivo de Room emite el estado actual de los ejercicios.
9. **La restricci√≥n "solo una sesi√≥n activa a la vez" se garantiza en `startSession()`.** Antes de insertar, se verifica que no exista sesi√≥n con `status = 'IN_PROGRESS'`. Si existe, se lanza `IllegalStateException` (defensa en profundidad ‚Äî la UI no deber√≠a permitirlo porque B1 oculta el bot√≥n "Iniciar" cuando hay sesi√≥n activa y muestra "Reanudar" en su lugar).
10. **El estado del ejercicio (No Iniciado / En Ejecuci√≥n / Completado) NO se almacena en BD.** Se deriva del conteo de series: `COUNT(exercise_set WHERE session_exercise_id = X)`. 0 = No Iniciado, 1-3 = En Ejecuci√≥n, 4 = Completado (Modelo de Datos ¬ß3.11: "El estado del ejercicio dentro de la sesi√≥n no se almacena ‚Äî se deriva en la capa de aplicaci√≥n contando las series asociadas").
11. **`ExerciseSetEntity` se crea como entity completa en HU-05.** Aunque HU-06 es quien insertar√° datos, crear la tabla ahora permite que: (a) el LEFT JOIN de `SessionExerciseWithDetails` funcione sin error SQL producido por tabla inexistente, (b) la versi√≥n de BD (4) incluya el schema completo del flujo de sesi√≥n, evitando incremento adicional de versi√≥n en HU-06, (c) los `CHECK` constraints queden definidos desde el inicio.
12. **`ExerciseProgressionEntity` se crea vac√≠a en HU-05.** Las filas se crean en HU-06 al registrar la primera serie de un ejercicio (Modelo de Datos ¬ß3.13: "Se crea una fila por ejercicio al registrar la primera serie del ejercicio"). En HU-05, la tabla existe pero sin datos. El LEFT JOIN retorna `null` para todos los ejercicios ‚Üí CA-05.07 correcto.
13. **E1 no tiene Bottom Navigation** (Wireframes E1, Arquitectura T√©cnica ¬ß4.5.1: "Siempre oculta: E1, E2, E3, E4, E5"). La condici√≥n actual en `showBottomBar` solo excluye `REGISTER`. Se debe ampliar para excluir rutas que empiezan con `"active-session"`.
14. **B1 deja de ser un stub con logo y bienvenida.** Se reemplaza el placeholder de HomeScreen completamente. Los strings `home_welcome` y `home_description` de la versi√≥n stub se pueden eliminar de `strings.xml`.
15. **La Card "Estado de Descarga" en B1 se difiere a HU-17.** En HU-05, el body de B1 solo muestra: Card Reanudar (condicional) XOR Card Pr√≥xima Sesi√≥n + Secci√≥n Progreso (microciclos).
16. **La navegaci√≥n B1‚ÜíE1 se hace sin `popUpTo`.** E1 se apila sobre B1 en el back stack. Dado que E1 no tiene Bottom Nav y el ejecutante solo puede salir cerrando sesi√≥n (HU-09), el `BackHandler` en `ActiveSessionScreen` intercepta el back press y lo ignora (stub en HU-05). En HU-09, se reemplaza con di√°logo de confirmaci√≥n de cierre (E4).
17. **`deload_id` en `SessionEntity` se define como nullable sin FK anotada.** `@ColumnInfo(name = "deload_id")` con tipo `Long? = null`. No se declara `@ForeignKey` hacia `deload` porque la tabla no existe. Cuando HU-17 cree `DeloadEntity`, se agregar√° la FK y se incrementar√° la versi√≥n de BD.
18. **El `HomeViewModel.startSession()` no debe bloquear la UI.** La creaci√≥n de sesi√≥n se ejecuta en coroutine (`viewModelScope.launch`). Room opera en `Dispatchers.IO` por defecto para `suspend` functions. El resultado se emite como evento oneshot via `MutableSharedFlow<Long>(replay = 0)`. La UI collect este Flow en `LaunchedEffect` y navega a E1.
19. **Mapeo `microcycle_position` ‚Üí `module_version_id` es un c√°lculo de 3 pasos.** (1) `position` ‚Üí `moduleCode` (1,4‚ÜíA; 2,5‚ÜíB; 3,6‚ÜíC). (2) `rotation_state` ‚Üí `currentVersion` del m√≥dulo correspondiente. (3) Lookup en `module_version` WHERE `module_code = moduleCode AND version_number = currentVersion` ‚Üí `id`. Este c√°lculo se encapsula en `SessionRepositoryImpl` y es determin√≠stico/testeable unitariamente. Se puede optimizar con un Map en memoria dado que `module_version` tiene solo 9 filas inmutables.

### Riesgos y mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|---|---|---|---|
| Transacci√≥n `startSession` falla parcialmente (session creada pero exercises no) | Baja | Alto | Usar `database.withTransaction { }` de Room para atomicidad. Si falla cualquier INSERT, se revierte todo |
| `rotation_state` no existe al intentar iniciar sesi√≥n | Nula | Alto | Imposible: B1 solo es accesible con perfil existente (start destination din√°mica). Defensa en profundidad: `getRotationState()` retorna `Flow<RotationState?>`, el ViewModel verifica non-null |
| Sesi√≥n hu√©rfana (creada pero app se cierra antes de navegar a E1) | Baja | Medio | La sesi√≥n queda `IN_PROGRESS` en BD. El crash recovery de B1 la detecta y ofrece reanudarla. No hay p√©rdida de datos |
| `exercise_set` tabla vac√≠a causa error en LEFT JOIN | Nula | Alto | La tabla se crea vac√≠a en HU-05. LEFT JOIN con tabla vac√≠a retorna 0 en COUNT, que es el comportamiento esperado (0 series = No Iniciado) |
| El ejecutante toca "Iniciar Sesi√≥n" m√∫ltiples veces r√°pido (double-tap) | Media | Bajo | `startSession()` valida que no exista sesi√≥n activa. La segunda llamada encontrar√° la sesi√≥n de la primera y lanzar√° excepci√≥n. La UI deshabilita el bot√≥n tras el primer toque (loading state) |
| La query `getBySessionIdWithDetails` no encuentra `plan_assignment` para ejercicio sustituido | Nula en HU-05 | Alto en HU-07 | En HU-05 no hay sustituci√≥n. Para HU-07, la query deber√° adaptarse con LEFT JOIN a `plan_assignment` y defaults (4 series, "8-12" reps) |

### Verificaci√≥n cruzada de CAs

| CA | Mecanismo de cumplimiento | Verificado contra |
|---|---|---|
| CA-05.01 | `RotationStateEntity.microcyclePosition` mapea a m√≥dulo A/B/C. Sin referencia temporal | Modelo de Datos ¬ß3.14, MDS ¬ß5.A.1 |
| CA-05.02 | `current_version_module_X` del `rotation_state` indica versi√≥n. V1‚ÜíV2‚ÜíV3 wrap-around | Modelo de Datos ¬ß3.14 l√≥gica de avance |
| CA-05.03 | Defaults: `microcyclePosition=1`, `currentVersionModuleA=1` ‚Üí module_version(A,1) = id 1 | HU-01 `RotationStateEntity()` defaults, Modelo de Datos ¬ß3.6 seed, PlanSeeder.kt |
| CA-05.04 | SQLite persiste indefinidamente. Sin timeout ni reinicio | RNF13, Modelo de Datos ¬ß3.14 "inmune a ausencias" |
| CA-05.05 | Room/SQLite es archivo local. Sobrevive reinicios y actualizaciones | RNF13 |
| CA-05.06 | `SessionExerciseWithDetails` JOIN retorna lista completa + carga | Wireframes E1, Especificaci√≥n Visual ¬ß8 E1, RF12 |
| CA-05.07 | LEFT JOIN `exercise_progression` ‚Üí NULL ‚Üí "Sin historial" italic | Especificaci√≥n Visual ¬ß8 E1 tabla variantes |
| CA-05.08 | `exercise_progression.prescribed_load_kg` valor calculado por HU-10/11 | Modelo de Datos ¬ß3.13 |
| CA-05.09 | `LocalDate.now()` solo se usa para `session.date`. La determinaci√≥n A/B/C no usa fecha | MDS ¬ß5.A.1 "agn√≥stica al calendario" |

### Auditor√≠a profunda ‚Äî 2026-02-13

Auditor√≠a exhaustiva contra toda la documentaci√≥n (32 HUs, 5 docs de arquitectura, 5 docs de negocio) y el c√≥digo existente.

#### Hallazgos corregidos

| # | Hallazgo | Severidad | Fuente autoritativa | Correcci√≥n aplicada |
|---|---|---|---|---|
| A1 | Card "Pr√≥xima Sesi√≥n" descrita como `Card con borde Outline Variant` (Outlined Card) | Error | Especificaci√≥n Visual ¬ß8 B1: **Filled Card** con fondo `Primary Container (#F5DDDD)`, corner 12 dp, elevation tonal Level 1 | Corregido a `FilledCard` con fondo Primary Container |
| A2 | Card "Pr√≥xima Sesi√≥n" ‚Äî tipograf√≠a "M√≥dulo X" descrita como `Title Large, On Surface` | Error | Especificaci√≥n Visual ¬ß8 B1: **Title Medium, On Primary Container (#5C0E0E)** | Corregido a Title Medium + On Primary Container |
| A3 | Card "Pr√≥xima Sesi√≥n" ‚Äî orden de textos: label primero, m√≥dulo despu√©s | Error | Wireframes B1 + Especificaci√≥n Visual: m√≥dulo/versi√≥n es el headline (Title Medium), label "Tu pr√≥xima sesi√≥n" es sublabel (Body Medium) | Corregido: m√≥dulo primero, label despu√©s |
| A4 | Secci√≥n "Progreso" ‚Äî n√∫mero descrito como `Display Medium` | Error | Especificaci√≥n Visual ¬ß8 B1: **Headline Medium, Primary** | Corregido a Headline Medium |
| A5 | Secci√≥n "Progreso" ‚Äî label descrita como `Body Medium` | Error | Especificaci√≥n Visual ¬ß8 B1: **Body Small, On Surface Variant** | Corregido a Body Small |
| A6 | Card "Reanudar Sesi√≥n" ‚Äî subt√≠tulo combina m√≥dulo y progreso en una l√≠nea | Menor | Wireframes B1 muestra l√≠neas separadas | Corregido a dos l√≠neas separadas |
| A7 | `SessionRepository` interface ‚Äî faltaba `getSessionModuleVersion(sessionId)` | Gap | Referenciado en ActiveSessionViewModel (secci√≥n 9) pero no listado en la interface (secci√≥n 5) | Agregado a la interface y a SessionRepositoryImpl |
| A8 | `startSession()` ‚Äî descripto como query directa a DAO, pero `getByModuleVersionId()` retorna `Flow` | Imprecisi√≥n | Room API: Flow no se puede consumir como read s√≠ncrono en suspend function | Corregido: especificado `.first()` para lectura one-shot del Flow |
| A9 | `startSession()` ‚Äî sin validaci√≥n de plan vac√≠o | Gap | HU-04 CA-04.08 permite desasignar ejercicios ‚Üí una versi√≥n podr√≠a quedar sin ejercicios | Agregado validaci√≥n: si lista vac√≠a, lanza `IllegalStateException` |

#### Hallazgos verificados como correctos

| # | Aspecto verificado | Documentaci√≥n cruzada | Resultado |
|---|---|---|---|
| V1 | `RotationStateEntity` defaults (position=1, versionA=1) | HU-01 c√≥digo + Modelo de Datos ¬ß3.14 + seed data ¬ß3.6 | ‚úÖ Correcto. Position 1 ‚Üí Module A, Version 1 ‚Üí module_version.id = 1 |
| V2 | Mapeo posici√≥n‚Üím√≥dulo (1,4‚ÜíA; 2,5‚ÜíB; 3,6‚ÜíC) | Modelo de Datos ¬ß3.14, MDS ¬ß5.A.1, RF09 | ‚úÖ Correcto y consistente |
| V3 | V1‚ÜíV2‚ÜíV3‚ÜíV1 para los 3 m√≥dulos | Modelo de Datos ¬ß3.6 (9 filas), RF10, CA-05.02 | ‚úÖ Correcto. Los 3 m√≥dulos tienen 3 versiones en seed data |
| V4 | Session lifecycle: IN_PROGRESS ‚Üí COMPLETED/INCOMPLETE | Modelo de Datos ¬ß3.10, MDS ¬ß5.C, HU-09 CAs | ‚úÖ Correcto. "Pendiente" del MDS es estado conceptual (pre-entity), no almacenado |
| V5 | Crash recovery via sesi√≥n IN_PROGRESS | RNF10, Wireframes B1 #4, Especificaci√≥n Visual B1 Card Reanudar | ‚úÖ Completo |
| V6 | Estado ejercicio derivado (0/1-3/4 series) | Modelo de Datos ¬ß3.11, CA-06.12, MDS ¬ß5.C | ‚úÖ Consistente con 3 fuentes |
| V7 | `exercise_set` tabla creada vac√≠a en HU-05 | Modelo de Datos ¬ß3.12 (HU-06 la popula), LEFT JOIN funciona | ‚úÖ Justificado |
| V8 | `exercise_progression` tabla creada vac√≠a | Modelo de Datos ¬ß3.13 ("Se crea fila al registrar primera serie") | ‚úÖ LEFT JOIN retorna NULL ‚Üí CA-05.07 |
| V9 | `deload_id` nullable sin FK anotada | Tabla `deload` no existe a√∫n (HU-17) | ‚úÖ Decisi√≥n justificada |
| V10 | E1 sin Bottom Navigation | Arquitectura T√©cnica ¬ß4.5.1 | ‚úÖ Confirmado |
| V11 | `showBottomBar` ampliar exclusi√≥n | C√≥digo actual solo excluye REGISTER | ‚úÖ Correcci√≥n planificada |
| V12 | Rotaci√≥n agn√≥stica al calendario | MDS ¬ß5.A.1 + Modelo de Datos ¬ß3.14 + RF09 | ‚úÖ `session.date` solo es metadato, no input de decisi√≥n |
| V13 | DB version 3 ‚Üí 4 con destructive migration | C√≥digo actual: version=3, `fallbackToDestructiveMigration()` | ‚úÖ Aceptable durante desarrollo |
| V14 | `PlanAssignmentDao.getByModuleVersionId()` ya existe | C√≥digo verificado | ‚úÖ Retorna `Flow<List<PlanAssignmentEntity>>` con `exerciseId` |
| V15 | `ModuleVersionDao.getById()` ya existe | C√≥digo verificado | ‚úÖ Retorna `Flow<ModuleVersionEntity?>` |
| V16 | `ProfileRepositoryImpl.createProfile()` inicializa rotation_state | C√≥digo verificado ‚Äî transacci√≥n at√≥mica | ‚úÖ Confirmado |
| V17 | Converters para LocalDate ya existen | `Converters.kt` con `@TypeConverter` | ‚úÖ Reutilizable para `session.date` |

#### Dependencias confirmadas c√≥digo vs. documentaci√≥n

| Dependencia | Estado c√≥digo | Estado documentaci√≥n |
|---|---|---|
| `RotationStateEntity` con defaults | ‚úÖ Implementada (HU-01) | ‚úÖ Documentada |
| `RotationStateDao.getRotationState()` | ‚úÖ Implementada | ‚úÖ Documentada |
| `RotationStateDao.update()` | ‚ùå No existe ‚Äî **debe agregarse** en HU-05 | ‚úÖ Documentada en an√°lisis |
| `ModuleVersionDao.getAll()` | ‚úÖ Implementada | ‚úÖ Documentada |
| `ModuleVersionDao.getById()` | ‚úÖ Implementada | ‚úÖ Documentada |
| `ModuleVersionDao.getByModuleCodeAndVersion()` | ‚ùå No existe ‚Äî **debe agregarse** en HU-05 | ‚úÖ Documentada en an√°lisis |
| `PlanAssignmentDao.getByModuleVersionId()` | ‚úÖ Implementada | ‚úÖ Documentada |
| HomeScreen stub con `onNavigateToAlerts` | ‚úÖ Implementada | ‚úÖ Documentada (ser√° reemplazada) |
| 10 entities en DB version 3 | ‚úÖ Implementada | ‚úÖ Consistente |
| 9 DAOs en DatabaseModule | ‚úÖ Implementada | ‚úÖ Consistente |
| 3 Repository bindings | ‚úÖ Implementada | ‚úÖ Consistente |

#### Inconsistencia externa detectada (HU-01, fuera del alcance de HU-05)

**HU-01 dice `current_version_module_b` rango 1-2**, pero:
- Modelo de Datos ¬ß3.14: `CHECK(current_version_module_b >= 1 AND current_version_module_b <= 3)` ‚Üí **rango 1-3**
- HU-04 CA-04.01: M√≥dulo B tiene **3 versiones** (V1, V2, V3)
- RF05: "entre 2 y 3 por m√≥dulo"
- Seed data: 9 filas en `module_version` (3 por m√≥dulo, incluyendo B: ids 4, 5, 6)
- C√≥digo implementado: `currentVersionModuleB: Int = 1` sin CHECK constraint ‚Äî acepta cualquier valor

**Impacto en HU-05:** Ninguno. HU-05 lee `currentVersionModuleB` y el valor siempre ser√° 1, 2 o 3 (controlado por HU-09 al avanzar). La inconsistencia es documental en HU-01, no funcional.

**Recomendaci√≥n:** Corregir HU-01 para documentar rango 1-3 para m√≥dulo B, consistente con el Modelo de Datos y el seed data.

#### Cadena de dependencias verificada

```
HU-01 (rotation_state init) ‚úÖ Implementada
  ‚Üí HU-03 (module_version + plan_assignment seed) ‚úÖ Implementada
    ‚Üí HU-04 (ModuleVersionDao.getById, plan customization) ‚úÖ Implementada
      ‚Üí HU-05 (session creation, rotation read, E1/B1) ‚è≥ ESTA HU
        ‚Üí HU-06 (exercise_set writes, exercise_progression creates)
        ‚Üí HU-07 (session_exercise substitution)
        ‚Üí HU-09 (session close, rotation advance)
          ‚Üí HU-10 (progression classification)
          ‚Üí HU-11 (prescribed_load_kg ‚Üí consumed by next HU-05 cycle)
          ‚Üí HU-18 (microcycle_count display in B1)
```

---

## Refinamiento T√©cnico (Developer)

<!-- SECCI√ìN AGREGADA POR: Workflow refinamiento-tecnico -->
<!-- ETAPA: Refinamiento T√©cnico -->
<!-- RESPONSABLE: Developer -->
<!-- BASE: An√°lisis Arquitect√≥nico (Arquitecto) - Ver secci√≥n arriba -->
<!-- FECHA: 2026-02-13 -->
<!-- ESTADO: Listo para Desarrollo -->
<!-- AUDITOR√çA: Completada 2026-02-13 ‚Äî Auditor√≠a profunda: cruce exhaustivo contra Modelo de Datos ¬ß3.10-¬ß3.14, Especificaci√≥n Visual ¬ß8 B1/E1, Wireframes B1/E1, Arquitectura T√©cnica ¬ß4.3/¬ß4.5/¬ß4.5.1/¬ß4.7/¬ß5.1-¬ß5.4, ADR-05/ADR-11/ADR-18, Mapa de Navegaci√≥n ¬ßB1/E1, Requerimientos RF09/RF10/RF11/RF12/RNF06/RNF10/RNF13, Manifiesto de Dominio Sist√©mico ¬ß5.A.1/¬ß5.C/¬ß6.B.9, 32 HUs completas (HU-01/HU-03/HU-04/HU-06/HU-07/HU-09/HU-10/HU-11/HU-14/HU-17/HU-18 verificadas individualmente), y c√≥digo HU-01/HU-02/HU-03/HU-04 implementado (9/9 claims de c√≥digo verificados). 9 hallazgos corregidos por el arquitecto (A1-A9), 17 verificaciones positivas (V1-V17), 1 inconsistencia externa documentada (HU-01 rango m√≥dulo B). Auditor√≠a post-refinamiento: 5 hallazgos (2 MEDIUM, 3 LOW). Correcciones aplicadas: (B-3) bot√≥n "Registrar" en estado "En Ejecuci√≥n" corregido de FilledTonalButton/Primary Container a Filled Button/Primary per Especificaci√≥n Visual ¬ß8 E1; (D-1) showBottomBar extendido con evaluaci√≥n de back stack para ocultar Bottom Nav en D2 cuando origen es E1 per Arquitectura T√©cnica ¬ß4.5.1/¬ß4.7; (B-4) colores de estado de ejercicio ampliados con variantes light/dark per Especificaci√≥n Visual ¬ß4.3. Hallazgos LOW sin correcci√≥n: (B-1) subt√≠tulo Card Reanudar en dos l√≠neas ‚Äî decisi√≥n deliberada del arquitecto (A6) priorizando Wireframes sobre Especificaci√≥n Visual; (B-2) inconsistencia interna en Especificaci√≥n Visual ¬ß3.3 vs ¬ß8 re: logo en B1 ‚Äî refinamiento sigue ¬ß8 correctamente. -->

### Consideraciones Generales

**Basado en an√°lisis arquitect√≥nico:**
An√°lisis Arquitect√≥nico de HU-05 con 11 hitos, 12+ componentes nuevos, 6 riesgos identificados y 9 hallazgos corregidos. Patr√≥n MVVM con capa Domain expl√≠cita (ADR-05). Quinta historia ‚Äî es la m√°s compleja hasta ahora. Orquesta tres capacidades: determinaci√≥n de m√≥dulo-versi√≥n por rotaci√≥n c√≠clica, creaci√≥n de sesi√≥n con ejercicios prescritos, y presentaci√≥n visual con carga objetivo. Infraestructura base completa gracias a HU-01 a HU-04 (10 entities, 9 DAOs, 3 repositories).

**Nivel de complejidad:**
ALTA ‚Äî Introduce 4 entidades Room nuevas (`SessionEntity`, `SessionExerciseEntity`, `ExerciseProgressionEntity`, `ExerciseSetEntity`), 4 DAOs nuevos + 2 modificaciones a DAOs existentes, 5 modelos de dominio nuevos + 1 enum, 1 repositorio nuevo con l√≥gica de negocio compleja (rotaci√≥n + transacci√≥n at√≥mica), 5 Use Cases, 2 pantallas funcionales (B1 Home reemplazo y E1 Sesi√≥n Activa parcial), 2 ViewModels, navegaci√≥n con argumentos tipados, ocultamiento de Bottom Nav para rutas de sesi√≥n, Custom Top Bar en B1 y E1 (no usa `TensionTopAppBar` gen√©rico), crash recovery con card condicional, y queries JOIN multi-tabla con LEFT JOIN para carga objetivo.

**Riesgos t√©cnicos conocidos:**

1. Transacci√≥n `startSession` puede fallar parcialmente ‚Äî usar `database.withTransaction {}` de Room para atomicidad. Si falla cualquier INSERT, se revierte todo.
2. Double-tap en "Iniciar Sesi√≥n" ‚Äî `startSession()` valida que no exista sesi√≥n `IN_PROGRESS`. La UI deshabilita el bot√≥n tras el primer toque (loading state). El ViewModel emite evento oneshot via `MutableSharedFlow`.
3. Sesi√≥n hu√©rfana (creada pero app se cierra antes de navegar a E1) ‚Äî la sesi√≥n queda `IN_PROGRESS` y el crash recovery de B1 la detecta para reanudarla.
4. La query JOIN de `SessionExerciseWithDetails` es compleja (7 tablas) ‚Äî verificar con datos reales que GROUP_CONCAT y COUNT retornan valores correctos. LEFT JOIN con tablas vac√≠as (`exercise_set`, `exercise_progression`) retorna NULL/0 que es el comportamiento esperado.
5. `deload_id` en SessionEntity sin FK anotada a tabla inexistente ‚Äî aceptable, la FK declarativa se agrega en HU-17.

**Patrones y convenciones del equipo (establecidos en HU-01‚ÄîHU-04):**

- C√≥digo fuente en ingl√©s, UI y datos de dominio en espa√±ol (Arquitectura T√©cnica ¬ß5.1)
- Naming: `{Feature}Screen`, `{Feature}ViewModel`, `{Acci√≥n}{Entidad}UseCase`, `{Entidad}Entity`, `{Entidad}Dao` (¬ß5.2)
- Estructura Composable: `hiltViewModel()` + `collectAsStateWithLifecycle()` + `LaunchedEffect` para eventos oneshot (¬ß5.3)
- Estructura ViewModel: `_uiState MutableStateFlow` / `uiState StateFlow` + `MutableSharedFlow` para eventos de navegaci√≥n (¬ß5.4)
- `operator fun invoke()` en Use Cases
- Callbacks en Composables con prefijo `on` (`onNavigateToActiveSession`)
- `childRoutes` y `childRoutePrefixes` en `BottomNavItem` para rutas hijas (patr√≥n HU-02/HU-03)

**Dependencias nuevas a instalar:**
Ninguna. Todas las APIs necesarias (Room, Hilt, Compose Navigation, Material3, Coroutines) ya est√°n en el proyecto.

**Estrategia de testing:**
JUnit 4 (ADR-18) + MockK + kotlinx-coroutines-test | Tests unitarios para los 5 Use Cases (domain): `GetNextSessionInfoUseCase`, `GetActiveSessionUseCase`, `StartSessionUseCase`, `GetSessionExercisesUseCase`, `GetMicrocycleCountUseCase` | Cobertura: 100% Use Cases

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**
- HU-01 ‚Äî `ProfileRepositoryImpl.createProfile()` con transacci√≥n at√≥mica (patr√≥n reutilizado para `startSession()`). Inicializaci√≥n de `RotationStateEntity()` con defaults verificados.
- HU-02 ‚Äî `WeightHistoryViewModel` como referencia para patr√≥n Flow ‚Üí StateFlow con `combine()`. `BottomNavItem.childRoutePrefixes` para ocultar Bottom Nav en rutas con argumentos.
- HU-03 ‚Äî `ExerciseDao` con query JOIN multi-tabla y GROUP_CONCAT (patr√≥n reutilizado para `SessionExerciseDao.getBySessionIdWithDetails()`).
- HU-04 ‚Äî `PlanVersionDetailViewModel` con `SavedStateHandle` para recibir argumentos de navegaci√≥n (patr√≥n reutilizado para `ActiveSessionViewModel`).

**Patrones de c√≥digo reutilizados:**

- `database.withTransaction { }` de `ProfileRepositoryImpl` ‚Üí reutilizado en `SessionRepositoryImpl.startSession()`
- Query JOIN con GROUP_CONCAT de `ExerciseDao` ‚Üí reutilizado/extendido en `SessionExerciseDao.getBySessionIdWithDetails()`
- `SavedStateHandle` de `ExerciseDetailViewModel` y `PlanVersionDetailViewModel` ‚Üí reutilizado en `ActiveSessionViewModel`
- `MutableSharedFlow<T>(replay = 0)` para eventos oneshot de navegaci√≥n ‚Üí patr√≥n nuevo en HU-05, reutilizable en HU-06+
- Patr√≥n `showBottomBar` por exclusi√≥n de ruta ‚Üí se extiende para prefijo `"active-session"`

**HUs futuras que dependen de artefactos de HU-05:**

- HU-06: Registrar series ‚Üí INSERT en `exercise_set` (tabla creada en HU-05), CREATE/UPDATE en `exercise_progression` (tabla creada en HU-05)
- HU-07: Sustituci√≥n de ejercicios ‚Üí UPDATE en `session_exercise.exercise_id` + SET `original_exercise_id`
- HU-08: Condiciones especiales peso corporal/isom√©tricos ‚Üí lectura de flags ya expuestos en E1 por HU-05
- HU-09: Cerrar sesi√≥n ‚Üí UPDATE `session.status`, avance de rotaci√≥n con `RotationStateDao.update()` (expuesto en HU-05)
- HU-10: Clasificaci√≥n de progresi√≥n ‚Üí UPDATE `session_exercise.progression_classification`
- HU-11: Doble Umbral ‚Üí UPDATE `exercise_progression.prescribed_load_kg` (le√≠do por HU-05)
- HU-17: Descarga ‚Üí utiliza `session.deload_id` (columna creada nullable en HU-05)
- HU-18: Microciclos en B1 ‚Üí lectura de `rotation_state.microcycle_count` ya expuesta en B1

### C√≥digo existente verificado (HU-01 + HU-02 + HU-03 + HU-04 implementados)

| Componente | Archivo | Estado |
| --- | --- | --- |
| `TensionDatabase` | `data/local/database/TensionDatabase.kt` | ‚úÖ Existe ‚Äî versi√≥n 3, 10 entities, 9 DAOs. Se modifica: +4 entities, +4 DAOs, versi√≥n ‚Üí 4 |
| `DatabaseModule` | `di/DatabaseModule.kt` | ‚úÖ Existe ‚Äî provee DB + 9 DAOs. Se modifica: +4 DAOs |
| `RepositoryModule` | `di/RepositoryModule.kt` | ‚úÖ Existe ‚Äî binds ProfileRepository, ExerciseRepository, PlanRepository. Se modifica: +SessionRepository |
| `RotationStateEntity` | `data/local/entity/RotationStateEntity.kt` | ‚úÖ Existe ‚Äî PK id=1, defaults: position=1, versionA=1, versionB=1, versionC=1, count=0. No se modifica |
| `RotationStateDao` | `data/local/dao/RotationStateDao.kt` | ‚úÖ Existe ‚Äî `insert()`, `getRotationState()`. Se modifica: +`update()` |
| `ModuleVersionEntity` | `data/local/entity/ModuleVersionEntity.kt` | ‚úÖ Existe ‚Äî id, moduleCode, versionNumber. No se modifica |
| `ModuleVersionDao` | `data/local/dao/ModuleVersionDao.kt` | ‚úÖ Existe ‚Äî `getAll()`, `getAllWithExerciseCount()`, `getById()`, `insertAll()`. Se modifica: +`getByModuleCodeAndVersion()` |
| `PlanAssignmentEntity` | `data/local/entity/PlanAssignmentEntity.kt` | ‚úÖ Existe ‚Äî composite PK (moduleVersionId, exerciseId), sets, reps. No se modifica |
| `PlanAssignmentDao` | `data/local/dao/PlanAssignmentDao.kt` | ‚úÖ Existe ‚Äî `getByModuleVersionId()`, `getDetailsByModuleVersionId()`, `insertAll()`, `insert()`, `delete()`. No se modifica |
| `ExerciseEntity` | `data/local/entity/ExerciseEntity.kt` | ‚úÖ Existe ‚Äî includes isBodyweight, isIsometric, isToTechnicalFailure, isCustom, mediaResource?. No se modifica |
| `Converters` | `data/local/database/Converters.kt` | ‚úÖ Existe ‚Äî `LocalDate ‚Üî String`. Reutilizable para `session.date` (almacenado como String ISO 8601) |
| `NavigationRoutes` | `ui/navigation/NavigationRoutes.kt` | ‚úÖ Existe ‚Äî 12 constantes + 3 helper functions. Se modifica: +ACTIVE_SESSION + helper |
| `TensionNavHost` | `ui/navigation/TensionNavHost.kt` | ‚úÖ Existe ‚Äî 12 composables. Se modifica: actualizar HOME, agregar ACTIVE_SESSION, extender showBottomBar |
| `BottomNavigationBar` | `ui/components/BottomNavigationBar.kt` | ‚úÖ Existe ‚Äî 5 tabs, childRoutes/childRoutePrefixes. No se modifica directamente (showBottomBar se maneja en TensionNavHost) |
| `HomeScreen` | `ui/home/HomeScreen.kt` | ‚úÖ Existe ‚Äî stub con logo + bienvenida. Se REEMPLAZA completamente |
| `TensionTopAppBar` | `ui/components/TensionTopAppBar.kt` | ‚úÖ Existe ‚Äî variantes retorno y cierre. **No se usa en B1 ni E1** (ambos tienen Top Bar custom inline) |
| `strings.xml` | `res/values/strings.xml` | ‚úÖ Existe ‚Äî strings hasta HU-04. Se modifica: +strings B1/E1, strings stub (`home_welcome`, `home_description`) se eliminan |
| `logo.png` | `res/drawable/logo.png` | ‚úÖ Existe ‚Äî **No se usa en B1 funcional** (B1 stub usaba el logo, el B1 funcional no) |

---

## Tareas de Implementaci√≥n (Developer)

### Fase 1: Data Layer ‚Äî Entities (4 nuevas)

> Basado en Hito #1 del An√°lisis Arquitect√≥nico

#### üì¶ Entities de sesi√≥n

- [ ] **Crear SessionEntity** (AC: 05.06)
  - [ ] `@Entity(tableName = "session")`. PK autoincrement `id: Long`. FK: `moduleVersionId` ‚Üí `module_version(id)` ON DELETE RESTRICT. Columnas: `moduleVersionId` (column = "module_version_id", Long, NOT NULL), `deloadId` (column = "deload_id", Long?, nullable ‚Äî **sin `@ForeignKey` anotado** porque la tabla `deload` no existe a√∫n, se agrega en HU-17), `date` (column = "date", String, NOT NULL ‚Äî formato ISO 8601 `"YYYY-MM-DD"`), `status` (column = "status", String, NOT NULL, defaultValue = `"IN_PROGRESS"`). √çndices: `date`, `module_version_id`, `status`, `deload_id`. **No declarar CHECK constraint en Room** (Room no soporta CHECK en `@Entity` ‚Äî se valida en la capa de aplicaci√≥n) ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/SessionEntity.kt`

- [ ] **Crear SessionExerciseEntity** (AC: 05.06)
  - [ ] `@Entity(tableName = "session_exercise")`. PK autoincrement `id: Long`. FKs: `sessionId` ‚Üí `session(id)` ON DELETE CASCADE, `exerciseId` ‚Üí `exercise(id)` ON DELETE RESTRICT. Columnas: `sessionId` (column = "session_id", Long, NOT NULL), `exerciseId` (column = "exercise_id", Long, NOT NULL), `originalExerciseId` (column = "original_exercise_id", Long?, nullable ‚Äî **En HU-05 siempre null**, sustituci√≥n se implementa en HU-07. Sin `@ForeignKey` anotado hacia `exercise(id)` por la segunda FK porque Room requiere declarar FKs en el array `foreignKeys` del `@Entity`, y tener dos FKs al mismo parentColumn es permitido pero la FK de `original_exercise_id` se declara completa), `progressionClassification` (column = "progression_classification", String?, nullable ‚Äî **En HU-05 siempre null**, clasificaci√≥n se implementa en HU-10). √çndices: `session_id`, `exercise_id`. UNIQUE(`session_id`, `exercise_id`) ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/SessionExerciseEntity.kt`

- [ ] **Crear ExerciseProgressionEntity** (AC: 05.07, 05.08)
  - [ ] `@Entity(tableName = "exercise_progression")`. PK natural `exerciseId: Long` (FK ‚Üí `exercise(id)` ON DELETE RESTRICT). Columnas: `exerciseId` (column = "exercise_id", Long, PK), `status` (column = "status", String, NOT NULL, defaultValue = `"NO_HISTORY"`), `prescribedLoadKg` (column = "prescribed_load_kg", Double?, nullable ‚Äî **En HU-05 la tabla est√° vac√≠a**, las filas se crean en HU-06 al registrar la primera serie. Se lee via LEFT JOIN para determinar carga objetivo: null ‚Üí "Sin historial"), `sessionsWithoutProgression` (column = "sessions_without_progression", Int, NOT NULL, defaultValue = "0"). **Justificaci√≥n de creaci√≥n en HU-05:** El LEFT JOIN de `SessionExerciseWithDetails` requiere que la tabla exista en el schema. Adem√°s, evita incremento de versi√≥n de BD en HU-06 ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ExerciseProgressionEntity.kt`

- [ ] **Crear ExerciseSetEntity** (AC: 05.06 indirect ‚Äî schema completud)
  - [ ] `@Entity(tableName = "exercise_set")`. PK autoincrement `id: Long`. FK: `sessionExerciseId` ‚Üí `session_exercise(id)` ON DELETE CASCADE. Columnas: `sessionExerciseId` (column = "session_exercise_id", Long, NOT NULL), `setNumber` (column = "set_number", Int, NOT NULL), `weightKg` (column = "weight_kg", Double, NOT NULL), `reps` (column = "reps", Int, NOT NULL), `rir` (column = "rir", Int, NOT NULL). √çndice: `session_exercise_id`. UNIQUE(`session_exercise_id`, `set_number`). **Justificaci√≥n de creaci√≥n en HU-05:** (a) LEFT JOIN de `SessionExerciseWithDetails` necesita COUNT de series ‚Äî la tabla debe existir, (b) evita incremento de versi√≥n de BD en HU-06 (BD pasa de 3 ‚Üí 4 una sola vez), (c) los constraints quedan definidos desde el inicio ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/entity/ExerciseSetEntity.kt`

### Fase 2: Data Layer ‚Äî DAOs (4 nuevos + 2 modificaciones)

> Basado en Hito #2 del An√°lisis Arquitect√≥nico

- [ ] **Crear SessionDao** (AC: 05.06, 05.01, RNF10)
  - [ ] `@Dao`. M√©todos:
    - `insert(session: SessionEntity): Long` ‚Äî `@Insert`. Retorna el ID generado (autoincrement). Usado para crear la sesi√≥n al iniciar.
    - `getActiveSession(): Flow<SessionEntity?>` ‚Äî `@Query("SELECT * FROM session WHERE status = 'IN_PROGRESS' LIMIT 1")`. Para crash recovery: detectar si hay sesi√≥n activa pendiente.
    - `getById(sessionId: Long): Flow<SessionEntity?>` ‚Äî Para obtener datos de una sesi√≥n espec√≠fica.
    - `getActiveSessionWithModuleVersion(): Flow<ActiveSessionInfo?>` ‚Äî Query JOIN que obtiene la sesi√≥n activa (si existe) junto con su `module_code`, `version_number`, total de ejercicios y ejercicios completados (derivado de COUNT de `exercise_set` con `cnt >= 4`). Usado para la Card "Reanudar Sesi√≥n" en B1.
  - [ ] **Definir `ActiveSessionInfo`** como data class en `SessionDao.kt`: `sessionId: Long`, `moduleCode: String`, `versionNumber: Int`, `totalExercises: Int`, `completedExercises: Int`. **No es `@Entity`** ‚Äî es resultado intermedio de query JOIN.
  - Query SQL para `getActiveSessionWithModuleVersion()`:
    ```sql
    SELECT s.id AS sessionId, mv.module_code AS moduleCode, mv.version_number AS versionNumber,
        (SELECT COUNT(*) FROM session_exercise WHERE session_id = s.id) AS totalExercises,
        (SELECT COUNT(*) FROM session_exercise se2
         INNER JOIN (SELECT session_exercise_id, COUNT(*) AS cnt FROM exercise_set
                     GROUP BY session_exercise_id HAVING cnt >= 4) completed
         ON se2.id = completed.session_exercise_id WHERE se2.session_id = s.id) AS completedExercises
    FROM session s INNER JOIN module_version mv ON s.module_version_id = mv.id
    WHERE s.status = 'IN_PROGRESS' LIMIT 1
    ```
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/SessionDao.kt`

- [ ] **Crear SessionExerciseDao** (AC: 05.06, 05.07, 05.08)
  - [ ] `@Dao`. M√©todos:
    - `insertAll(exercises: List<SessionExerciseEntity>)` ‚Äî `@Insert`. Insert batch al crear la sesi√≥n. Una fila por cada ejercicio del plan.
    - `getBySessionId(sessionId: Long): Flow<List<SessionExerciseEntity>>` ‚Äî Listar ejercicios de la sesi√≥n.
    - `getBySessionIdWithDetails(sessionId: Long): Flow<List<SessionExerciseWithDetails>>` ‚Äî Query JOIN multi-tabla (7 tablas) para obtener informaci√≥n visual completa de E1.
  - [ ] **Definir `SessionExerciseWithDetails`** como data class en `SessionExerciseDao.kt`: `sessionExerciseId: Long`, `exerciseId: Long`, `exerciseName: String`, `equipmentTypeName: String`, `muscleZones: String` (GROUP_CONCAT), `sets: Int`, `reps: String`, `isBodyweight: Int`, `isIsometric: Int`, `isToTechnicalFailure: Int`, `prescribedLoadKg: Double?`, `completedSets: Int`.
  - Query SQL para `getBySessionIdWithDetails()`:
    ```sql
    SELECT se.id AS sessionExerciseId, se.exercise_id AS exerciseId, e.name AS exerciseName,
        et.name AS equipmentTypeName, GROUP_CONCAT(DISTINCT mz.name) AS muscleZones,
        pa.sets, pa.reps, e.is_bodyweight AS isBodyweight, e.is_isometric AS isIsometric,
        e.is_to_technical_failure AS isToTechnicalFailure,
        ep.prescribed_load_kg AS prescribedLoadKg,
        (SELECT COUNT(*) FROM exercise_set es WHERE es.session_exercise_id = se.id) AS completedSets
    FROM session_exercise se
    INNER JOIN exercise e ON se.exercise_id = e.id
    INNER JOIN equipment_type et ON e.equipment_type_id = et.id
    INNER JOIN session s ON se.session_id = s.id
    INNER JOIN plan_assignment pa ON pa.module_version_id = s.module_version_id AND pa.exercise_id = se.exercise_id
    LEFT JOIN exercise_muscle_zone emz ON e.id = emz.exercise_id
    LEFT JOIN muscle_zone mz ON emz.muscle_zone_id = mz.id
    LEFT JOIN exercise_progression ep ON e.id = ep.exercise_id
    WHERE se.session_id = :sessionId
    GROUP BY se.id ORDER BY e.name ASC
    ```
    **Nota sobre COUNT de `completedSets`:** Se usa subquery `(SELECT COUNT(*) FROM exercise_set es WHERE es.session_exercise_id = se.id)` en vez de `COUNT(DISTINCT es.id)` en el GROUP BY para evitar interacci√≥n con el GROUP_CONCAT de muscle_zones. La subquery es independiente y m√°s confiable.
    **Nota sobre JOIN con `plan_assignment`:** En HU-05 no hay sustituci√≥n, por lo que `se.exercise_id` siempre coincide con `pa.exercise_id`. En HU-07, este JOIN deber√° adaptarse con COALESCE/LEFT JOIN para manejar ejercicios sustituidos que no est√°n en `plan_assignment`.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/SessionExerciseDao.kt`

- [ ] **Crear ExerciseProgressionDao** (AC: 05.07, 05.08 ‚Äî lectura via JOIN)
  - [ ] `@Dao`. M√©todos:
    - `getByExerciseId(exerciseId: Long): Flow<ExerciseProgressionEntity?>` ‚Äî Lectura individual. No se usa directamente en HU-05 (se obtiene via LEFT JOIN en `SessionExerciseWithDetails`), pero se expone para HU-10/HU-11.
    - `insert(progression: ExerciseProgressionEntity)` ‚Äî `@Insert`. Para HU-06 (crear fila al registrar primera serie). Expuesto ahora para completar el DAO.
    - `update(progression: ExerciseProgressionEntity)` ‚Äî `@Update`. Para HU-10/HU-11. Expuesto ahora.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ExerciseProgressionDao.kt`

- [ ] **Crear ExerciseSetDao** (stub para HU-06)
  - [ ] `@Dao` interface vac√≠a. Los m√©todos de inserci√≥n y consulta se implementan en HU-06. La interface se expone en `TensionDatabase` para que Room la valide ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ExerciseSetDao.kt`

- [ ] **Modificar RotationStateDao** (+1 m√©todo)
  - [ ] Agregar: `@Update suspend fun update(state: RotationStateEntity)`. Usado en HU-09 para avanzar la rotaci√≥n al cerrar sesi√≥n. Se expone ahora para preparar HU-09 ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/RotationStateDao.kt`

- [ ] **Modificar ModuleVersionDao** (+1 m√©todo)
  - [ ] Agregar: `@Query("SELECT * FROM module_version WHERE module_code = :moduleCode AND version_number = :versionNumber LIMIT 1") fun getByModuleCodeAndVersion(moduleCode: String, versionNumber: Int): Flow<ModuleVersionEntity?>`. Para resolver `(moduleCode, versionNumber)` ‚Üí `module_version_id` en la l√≥gica de determinaci√≥n de pr√≥xima sesi√≥n ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/dao/ModuleVersionDao.kt`

### Fase 3: Data Layer ‚Äî Database y DI

> Basado en Hitos #3 y #7 del An√°lisis Arquitect√≥nico

- [ ] **Actualizar TensionDatabase** (AC: 05.06)
  - [ ] Agregar 4 entities al array: `SessionEntity`, `SessionExerciseEntity`, `ExerciseProgressionEntity`, `ExerciseSetEntity`. Incrementar `version = 4`. Exponer 4 DAOs abstractos: `sessionDao()`, `sessionExerciseDao()`, `exerciseProgressionDao()`, `exerciseSetDao()`. Se mantiene `fallbackToDestructiveMigration()` ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/local/database/TensionDatabase.kt`

- [ ] **Actualizar DatabaseModule** (AC: 05.06)
  - [ ] Agregar 4 `@Provides` para los nuevos DAOs:
    - `provideSessionDao(database): SessionDao`
    - `provideSessionExerciseDao(database): SessionExerciseDao`
    - `provideExerciseProgressionDao(database): ExerciseProgressionDao`
    - `provideExerciseSetDao(database): ExerciseSetDao`
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/di/DatabaseModule.kt`

- [ ] **Actualizar RepositoryModule** (AC: 05.06)
  - [ ] Agregar: `@Binds @Singleton abstract fun bindSessionRepository(impl: SessionRepositoryImpl): SessionRepository` ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/di/RepositoryModule.kt`

### Fase 4: Domain Layer ‚Äî Models + Enum

> Basado en Hito #4 del An√°lisis Arquitect√≥nico

- [ ] **Crear ExerciseSessionStatus** (AC: 05.06)
  - [ ] Enum class: `NOT_STARTED`, `IN_PROGRESS`, `COMPLETED`. Derivado del conteo de series (0 = NOT_STARTED, 1-3 = IN_PROGRESS, 4 = COMPLETED). Modelo de Datos ¬ß3.11: "El estado del ejercicio dentro de la sesi√≥n no se almacena ‚Äî se deriva". Kotlin puro ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/ExerciseSessionStatus.kt`

- [ ] **Crear RotationState** (AC: 05.01, 05.02, 05.04, 05.05)
  - [ ] Data class: `microcyclePosition: Int`, `currentVersionModuleA: Int`, `currentVersionModuleB: Int`, `currentVersionModuleC: Int`, `microcycleCount: Int`. Kotlin puro ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/RotationState.kt`

- [ ] **Crear NextSession** (AC: 05.01, 05.02, 05.03)
  - [ ] Data class para B1 Card "Pr√≥xima Sesi√≥n": `moduleCode: String`, `versionNumber: Int`, `moduleVersionId: Long`. Kotlin puro ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/NextSession.kt`

- [ ] **Crear ActiveSession** (RNF10)
  - [ ] Data class para B1 Card "Reanudar Sesi√≥n": `sessionId: Long`, `moduleCode: String`, `versionNumber: Int`, `totalExercises: Int`, `completedExercises: Int`. Kotlin puro ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/ActiveSession.kt`

- [ ] **Crear SessionExerciseDetail** (AC: 05.06, 05.07, 05.08)
  - [ ] Data class para E1, informaci√≥n visual completa de un ejercicio en sesi√≥n: `sessionExerciseId: Long`, `exerciseId: Long`, `name: String`, `equipmentTypeName: String`, `muscleZones: List<String>`, `sets: Int`, `reps: String`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isToTechnicalFailure: Boolean`, `prescribedLoadKg: Double?` (null = sin historial CA-05.07, valor = carga objetivo CA-05.08), `completedSets: Int` (0-4, determina estado derivado), `status: ExerciseSessionStatus` (derivado en mapper). Kotlin puro ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/model/SessionExerciseDetail.kt`

### Fase 5: Domain Layer ‚Äî Repository Interface + Use Cases

> Basado en Hito #5 del An√°lisis Arquitect√≥nico

#### üì¶ Repository Interface

- [ ] **Crear SessionRepository** (AC: 05.01-05.09)
  - [ ] Interface Kotlin puro. 6 contratos:
    - `getNextModuleVersionId(): Flow<Long>` ‚Äî L√≥gica central de determinaci√≥n de m√≥dulo-versi√≥n.
    - `startSession(moduleVersionId: Long): Long` ‚Äî Crea sesi√≥n + session_exercises en transacci√≥n at√≥mica. Retorna sessionId.
    - `getActiveSession(): Flow<ActiveSession?>` ‚Äî Para B1 crash recovery card.
    - `getSessionExercises(sessionId: Long): Flow<List<SessionExerciseDetail>>` ‚Äî Para E1 lista de ejercicios.
    - `getRotationState(): Flow<RotationState?>` ‚Äî Para resoluci√≥n de m√≥dulo-versi√≥n y microciclos.
    - `getSessionModuleVersion(sessionId: Long): Flow<Pair<String, Int>?>` ‚Äî Retorna `(moduleCode, versionNumber)` para el Top Bar de E1.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/repository/SessionRepository.kt`

#### üì¶ Use Cases

- [ ] **Crear GetNextSessionInfoUseCase** (AC: 05.01, 05.02, 05.03, 05.09)
  - [ ] Inyecta `SessionRepository`. `operator fun invoke(): Flow<NextSession>`. Combina `getRotationState()` con la resoluci√≥n del m√≥dulo/versi√≥n, produciendo un `NextSession` con `moduleCode`, `versionNumber`, `moduleVersionId`. La l√≥gica de resoluci√≥n:
    1. Lee `microcyclePosition` (1-6) del `rotation_state`.
    2. Mapea posici√≥n ‚Üí m√≥dulo: `when(position) { 1,4 ‚Üí "A"; 2,5 ‚Üí "B"; 3,6 ‚Üí "C" }`.
    3. Lee la versi√≥n actual del m√≥dulo correspondiente: `currentVersionModuleA`, `_b`, o `_c`.
    4. Resuelve `moduleVersionId` consultando `module_version` WHERE `(moduleCode, versionNumber)`.
    **Nota sobre CA-05.09:** La fecha NO se usa en ning√∫n paso de esta l√≥gica. Solo se usa `rotation_state` ‚Äî la rotaci√≥n es agn√≥stica al calendario.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetNextSessionInfoUseCase.kt`
  - [ ] Test unitario: verifica mapeo posici√≥n‚Üím√≥dulo para las 6 posiciones, primera sesi√≥n (position=1 ‚Üí A-V1), caso con versiones avanzadas. Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetNextSessionInfoUseCaseTest.kt`

- [ ] **Crear GetActiveSessionUseCase** (RNF10)
  - [ ] Inyecta `SessionRepository`. `operator fun invoke(): Flow<ActiveSession?>`. Delega a `getActiveSession()`. Lectura pura.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetActiveSessionUseCase.kt`
  - [ ] Test unitario: verifica delegaci√≥n, caso sesi√≥n activa encontrada, caso null. Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetActiveSessionUseCaseTest.kt`

- [ ] **Crear StartSessionUseCase** (AC: 05.06)
  - [ ] Inyecta `SessionRepository`. `suspend operator fun invoke(moduleVersionId: Long): Long`. Delega a `startSession()`. Retorna el `sessionId`. Si ya existe sesi√≥n activa, propaga `IllegalStateException`.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/session/StartSessionUseCase.kt`
  - [ ] Test unitario: verifica delegaci√≥n, caso exitoso retorna ID, caso sesi√≥n activa existente lanza excepci√≥n. Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/session/StartSessionUseCaseTest.kt`

- [ ] **Crear GetSessionExercisesUseCase** (AC: 05.06, 05.07, 05.08)
  - [ ] Inyecta `SessionRepository`. `operator fun invoke(sessionId: Long): Flow<List<SessionExerciseDetail>>`. Delega a `getSessionExercises()`. Lectura pura.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetSessionExercisesUseCase.kt`
  - [ ] Test unitario: verifica delegaci√≥n, caso lista con ejercicios, caso vac√≠o. Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetSessionExercisesUseCaseTest.kt`

- [ ] **Crear GetMicrocycleCountUseCase** (B1 progreso)
  - [ ] Inyecta `SessionRepository`. `operator fun invoke(): Flow<Int>`. Delega a `getRotationState()` y mapea a `microcycleCount`. Para el indicador de progreso en B1.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetMicrocycleCountUseCase.kt`
  - [ ] Test unitario: verifica mapeo de rotationState a count, caso null ‚Üí 0. Archivo: `app/src/test/java/com/estebancoloradogonzalez/tension/domain/usecase/session/GetMicrocycleCountUseCaseTest.kt`

### Fase 6: Data Layer ‚Äî Repository Implementation

> Basado en Hito #6 del An√°lisis Arquitect√≥nico

- [ ] **Crear SessionRepositoryImpl** (AC: 05.01-05.09)
  - [ ] `@Inject constructor`. Inyecta: `SessionDao`, `SessionExerciseDao`, `PlanAssignmentDao`, `RotationStateDao`, `ModuleVersionDao`, `TensionDatabase` (para `withTransaction`). Implementa `SessionRepository`. M√©todos:

    - **`getNextModuleVersionId(): Flow<Long>`** ‚Äî L√≥gica central:
      1. Obtiene `rotation_state` via `RotationStateDao.getRotationState()`.
      2. Lee `microcyclePosition` (1-6) del rotation state.
      3. Mapea posici√≥n a m√≥dulo: `when(pos) { 1,4 ‚Üí "A"; 2,5 ‚Üí "B"; 3,6 ‚Üí "C" }`.
      4. Lee la versi√≥n actual del m√≥dulo: `currentVersionModuleA`, `_b`, o `_c`.
      5. Busca `module_version_id` via `ModuleVersionDao.getByModuleCodeAndVersion(moduleCode, versionNumber)`.
      6. Retorna `moduleVersion.id` como Flow.
      **Implementaci√≥n con `flatMapLatest`:** El Flow de `rotationState` mapea a un Flow de `moduleVersion`, encadenado con `flatMapLatest` para que si la rotaci√≥n cambia, el resultado se actualice reactivamente.

    - **`startSession(moduleVersionId: Long): Long`** ‚Äî Transacci√≥n at√≥mica:
      1. `database.withTransaction { ... }`
      2. Verifica que NO exista sesi√≥n `IN_PROGRESS` via `sessionDao.getActiveSession().first()`. Si existe, lanza `IllegalStateException("A session is already in progress")`.
      3. INSERT `SessionEntity(moduleVersionId = moduleVersionId, date = LocalDate.now().toString(), status = "IN_PROGRESS", deloadId = null)`. Obtiene `sessionId` del retorno de `insert()`.
      4. Consulta `planAssignmentDao.getByModuleVersionId(moduleVersionId).first()` ‚Äî lectura one-shot del Flow para obtener la lista de `PlanAssignmentEntity`.
      5. **Valida que la lista no est√© vac√≠a.** Si vac√≠a, lanza `IllegalStateException("No exercises assigned to this module version")`.
      6. Construye `List<SessionExerciseEntity>` con una fila por cada `PlanAssignmentEntity`: `SessionExerciseEntity(sessionId = sessionId, exerciseId = pa.exerciseId, originalExerciseId = null, progressionClassification = null)`.
      7. INSERT batch via `sessionExerciseDao.insertAll(exercises)`.
      8. Retorna `sessionId`.

    - **`getActiveSession(): Flow<ActiveSession?>`** ‚Äî Delega a `sessionDao.getActiveSessionWithModuleVersion()` y mapea `ActiveSessionInfo` ‚Üí `ActiveSession` (domain model).

    - **`getSessionExercises(sessionId: Long): Flow<List<SessionExerciseDetail>>`** ‚Äî Delega a `sessionExerciseDao.getBySessionIdWithDetails(sessionId)` y mapea `SessionExerciseWithDetails` ‚Üí `SessionExerciseDetail` (domain model). El mapeo:
      - `muscleZones`: split por `", "` del GROUP_CONCAT ‚Üí `List<String>`.
      - `isBodyweight/isIsometric/isToTechnicalFailure`: `Int ‚Üí Boolean` (1 = true, 0 = false).
      - `status`: derivado de `completedSets` ‚Üí `when { 0 ‚Üí NOT_STARTED; in 1..3 ‚Üí IN_PROGRESS; >= 4 ‚Üí COMPLETED }`.

    - **`getRotationState(): Flow<RotationState?>`** ‚Äî Delega a `rotationStateDao.getRotationState()` y mapea `RotationStateEntity` ‚Üí `RotationState` (domain model).

    - **`getSessionModuleVersion(sessionId: Long): Flow<Pair<String, Int>?>`** ‚Äî Obtiene la sesi√≥n por ID via `sessionDao.getById(sessionId)`, extrae `moduleVersionId`, luego consulta `moduleVersionDao.getById(moduleVersionId)` para resolver `(moduleCode, versionNumber)`. Usa `flatMapLatest` para encadenar los dos Flows reactivamente.

  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/data/repository/SessionRepositoryImpl.kt`

### Fase 7: UI Layer ‚Äî B1 Home (Reemplazo del stub)

> Basado en Hito #8 del An√°lisis Arquitect√≥nico

#### üì¶ UiState

- [ ] **Crear HomeUiState** (AC: 05.01, 05.02, 05.03, RNF10)
  - [ ] Data class: `isLoading: Boolean = true`, `nextSession: NextSession? = null` (m√≥dulo/versi√≥n/moduleVersionId ‚Äî null si hay sesi√≥n activa), `activeSession: ActiveSession? = null` (info de crash recovery ‚Äî null si no hay sesi√≥n pendiente), `microcycleCount: Int = 0`, `alertCount: Int = 0` (siempre 0 en HU-05). Propiedades derivadas: `showNextSessionCard: Boolean get() = activeSession == null`, `showResumeCard: Boolean get() = activeSession != null` ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/home/HomeUiState.kt`

#### üì¶ ViewModel

- [ ] **Crear HomeViewModel** (AC: 05.01, 05.02, 05.03, 05.06, RNF10)
  - [ ] `@HiltViewModel`. Inyecta `GetNextSessionInfoUseCase`, `GetActiveSessionUseCase`, `StartSessionUseCase`, `GetMicrocycleCountUseCase`. Estado: `StateFlow<HomeUiState>`.
  - En `init`, combina los 3 Flows (nextSessionInfo, activeSession, microcycleCount) via `combine()` y mapea a `HomeUiState`. **L√≥gica:** Si `activeSession != null`, `nextSession` se fuerza a `null` (mutuamente excluyentes: Card Reanudar oculta Card Pr√≥xima Sesi√≥n). Si `activeSession == null`, `nextSession` se calcula normalmente.
  - **Evento de navegaci√≥n:** `private val _navigationEvent = MutableSharedFlow<Long>(replay = 0)` / `val navigationEvent = _navigationEvent.asSharedFlow()`. Emite `sessionId` cuando se crea o reanuda una sesi√≥n.
  - **M√©todo `startSession()`:** `viewModelScope.launch { try { val sessionId = startSessionUseCase(moduleVersionId); _navigationEvent.emit(sessionId) } catch (e: Exception) { /* handle error */ } }`. Recibe `moduleVersionId` del `nextSession` en el UiState.
  - **M√©todo `resumeSession(sessionId: Long)`:** `viewModelScope.launch { _navigationEvent.emit(sessionId) }`.
  - **Loading flag:** Se gestiona con `isLoading = true` como default, cambia a `false` cuando el primer emit de `combine()` llega.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/home/HomeViewModel.kt`

#### üì¶ Screen B1

- [ ] **Reemplazar HomeScreen** (AC: 05.01, 05.02, 05.03, 05.06, RNF10)
  - [ ] Composable de nivel pantalla. Firma actualizada:
    ```kotlin
    @Composable
    fun HomeScreen(
        onNavigateToAlerts: () -> Unit,
        onNavigateToActiveSession: (Long) -> Unit,
        viewModel: HomeViewModel = hiltViewModel(),
    )
    ```
  - Recolecta `uiState` con `collectAsStateWithLifecycle()`. Recolecta `navigationEvent` en `LaunchedEffect`:
    ```kotlin
    LaunchedEffect(Unit) {
        viewModel.navigationEvent.collect { sessionId ->
            onNavigateToActiveSession(sessionId)
        }
    }
    ```
  - Estructura seg√∫n Wireframes B1 y Especificaci√≥n Visual ¬ß8 B1:
    - **Top Bar custom (NO usa `TensionTopAppBar`)**: Implementado como `Row` dentro de `Surface(color = surfaceContainerLowest)`, height ~64 dp. Izquierda: `Text("Tension")`, Title Large, color Primary (`#8B1A1A`), padding horizontal 16 dp. Derecha: `IconButton` con √≠cono `Icons.Outlined.Notifications` (Material), tint On Surface Variant. Badge M3 superpuesto: `BadgedBox { Badge { ... } }`. **En HU-05 el badge es punto vac√≠o** (`Badge` sin content, `containerColor = Outline (#857370)`, size 6 dp). Al tocar ‚Üí `onNavigateToAlerts()`. Padding horizontal 4 dp.
    - **Body** (`LazyColumn`, padding horizontal 16 dp, contentPadding top 16 dp):
      - **Card "Reanudar Sesi√≥n"** (condicional: `showResumeCard`, Wireframes B1 #4): `ElevatedCard`, containerColor Error Container (`#FFDAD6`), tonalElevation Level 2 (3 dp), shape RoundedCornerShape(12 dp). Content (column, padding 16 dp):
        - Row: √çcono `Icons.Default.Warning` (24 dp, tint Error `#BA1A1A`) + Spacer(8 dp) + `Text("Tienes una sesi√≥n activa sin cerrar")` (Title Medium, On Error Container `#410002`).
        - Spacer(8 dp).
        - `Text` l√≠nea 1: "M√≥dulo X ‚Äî Versi√≥n N" (Body Medium, On Error Container). Formato: `home_next_session_format`.
        - `Text` l√≠nea 2: "N de M ejercicios completados" (Body Medium, On Error Container). Formato: `home_resume_progress`.
        - Spacer(12 dp).
        - `Button("Reanudar Sesi√≥n")` (containerColor Primary, contentColor On Primary) ‚Üí `viewModel.resumeSession(activeSession.sessionId)`.
      - **Card "Pr√≥xima Sesi√≥n"** (condicional: `showNextSessionCard`, Wireframes B1 #3): `Card` (Filled), containerColor Primary Container (`#F5DDDD`), shape RoundedCornerShape(12 dp). Content (column, padding 16 dp):
        - `Text` "M√≥dulo X ‚Äî Versi√≥n N" (Title Medium, On Primary Container `#5C0E0E`). Formato: `home_next_session_format`.
        - Spacer(4 dp).
        - `Text` "Tu pr√≥xima sesi√≥n" (Body Medium, On Primary Container).
        - Spacer(12 dp).
        - `Button("Iniciar Sesi√≥n", modifier = Modifier.fillMaxWidth())` (containerColor Primary, contentColor On Primary) ‚Üí `viewModel.startSession()`.
      - **Secci√≥n "Progreso"** (Wireframes B1 #5):
        - Spacer(24 dp).
        - `HorizontalDivider` (color Outline Variant).
        - Spacer(16 dp).
        - `Text(microcycleCount.toString())` (Headline Medium, Primary). Centrado horizontalmente.
        - `Text("microciclos")` (Body Small, On Surface Variant). Centrado horizontalmente.
      - **Card "Estado de Descarga"** (HU-16/17): **No se renderiza en HU-05** ‚Äî completamente omitida.
    - **Sin Scaffold propio para Top Bar** ‚Äî el Top Bar custom se incluye como primer elemento de un `Column` que contiene el `LazyColumn` debajo. O alternativamente `Scaffold(topBar = { ... })` con el Top Bar custom. **Nota:** B1 S√ç tiene Bottom Navigation (la visibilidad se controla en `TensionNavHost`).
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/home/HomeScreen.kt`

### Fase 8: UI Layer ‚Äî E1 Sesi√≥n Activa (Nuevo, parcial)

> Basado en Hito #9 del An√°lisis Arquitect√≥nico

#### üì¶ UiState

- [ ] **Crear ActiveSessionUiState y ExerciseUiItem** (AC: 05.06, 05.07, 05.08)
  - [ ] `ActiveSessionUiState`: data class con `isLoading: Boolean = true`, `moduleCode: String = ""`, `versionNumber: Int = 0`, `exercises: List<ExerciseUiItem> = emptyList()`. Propiedades derivadas: `completedCount: Int get() = exercises.count { it.status == ExerciseSessionStatus.COMPLETED }`, `totalCount: Int get() = exercises.size`, `progress: Float get() = if (totalCount > 0) completedCount.toFloat() / totalCount else 0f`.
  - [ ] `ExerciseUiItem`: data class con `sessionExerciseId: Long`, `exerciseId: Long`, `name: String`, `equipmentTypeName: String`, `muscleZones: String` (concatenadas con ", "), `sets: Int`, `reps: String`, `prescribedLoadKg: Double?`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `isToTechnicalFailure: Boolean`, `completedSets: Int`, `status: ExerciseSessionStatus`, `loadDisplayText: String` (precalculado en mapper), `statusDisplayText: String` (precalculado: ej. "No Iniciado ¬∑ 0/4 series").
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/session/ActiveSessionUiState.kt`

#### üì¶ ViewModel

- [ ] **Crear ActiveSessionViewModel** (AC: 05.06, 05.07, 05.08)
  - [ ] `@HiltViewModel`. Inyecta `GetSessionExercisesUseCase`, `SessionRepository` (para `getSessionModuleVersion`). Recibe `sessionId: Long` via `SavedStateHandle` (argumento de navegaci√≥n `"sessionId"`). Estado: `StateFlow<ActiveSessionUiState>`.
  - En `init`, obtiene `sessionId` del `SavedStateHandle`. Combina dos Flows via `combine()`:
    1. `getSessionExercisesUseCase(sessionId)` ‚Äî lista de ejercicios con detalles.
    2. `sessionRepository.getSessionModuleVersion(sessionId)` ‚Äî `(moduleCode, versionNumber)` para el Top Bar.
  - Mapea `SessionExerciseDetail` ‚Üí `ExerciseUiItem`:
    - `muscleZones`: `detail.muscleZones.joinToString(", ")`.
    - `loadDisplayText`: calculado con l√≥gica de variantes:
      ```kotlin
      when {
          detail.isIsometric -> "Isom√©trico (30-45s)"
          detail.isBodyweight -> "Peso corporal"
          detail.prescribedLoadKg != null -> "%.1f Kg".format(detail.prescribedLoadKg)
          else -> "Sin historial ‚Äî establecer carga"
      }
      ```
    - `statusDisplayText`: `"${statusLabel} ¬∑ ${completedSets}/${sets} series"` donde `statusLabel` = "No Iniciado" / "En Ejecuci√≥n" / "Completado" seg√∫n `status`.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/session/ActiveSessionViewModel.kt`

#### üì¶ Screen E1

- [ ] **Crear ActiveSessionScreen** (AC: 05.06, 05.07, 05.08)
  - [ ] Composable. Firma:
    ```kotlin
    @Composable
    fun ActiveSessionScreen(
        onNavigateToRegisterSet: (Long) -> Unit,
        onNavigateToSubstitute: (Long) -> Unit,
        onNavigateToExerciseDetail: (Long) -> Unit,
        onNavigateToSessionSummary: (Long) -> Unit,
        onNavigateToHome: () -> Unit,
        viewModel: ActiveSessionViewModel = hiltViewModel(),
    )
    ```
  - Recolecta `uiState` con `collectAsStateWithLifecycle()`. Estructura seg√∫n Wireframes E1 y Especificaci√≥n Visual ¬ß8 E1:
    - **Top Bar custom (NO usa `TensionTopAppBar` ni `CenterAlignedTopAppBar`)**: `Column` con padding horizontal 16 dp, padding top ~48 dp (status bar), padding bottom 8 dp, fondo Background:
      - `Text("M√≥dulo X ‚Äî Versi√≥n N")` (Title Large, On Surface, textAlign Start). Formato: `session_module_version_format`.
      - `Text("Sesi√≥n activa")` (Title Small, On Surface Variant).
      - Badge descarga: **oculto en HU-05** (se implementa en HU-17).
    - **Barra de progreso** (padding horizontal 16 dp, padding top 16 dp):
      - `Text("N de M ejercicios completados")` (Body Medium, On Surface). Formato: `session_progress_format`.
      - Spacer(8 dp).
      - `LinearProgressIndicator(progress = uiState.progress)` ‚Äî determinate, trackColor Surface Variant, color Primary, height 8 dp, shape RoundedCornerShape(4 dp).
      - `Text("${(uiState.progress * 100).toInt()}%")` (Label Small, On Surface Variant, textAlign End).
    - **Lista de ejercicios** (`LazyColumn`, padding horizontal 16 dp, contentPadding vertical 8 dp):
      - Cada ejercicio renderizado con `ExerciseRow` composable seg√∫n `status`:

        **No Iniciado** (`status == NOT_STARTED`): `OutlinedCard`, height ‚â• 88 dp (wrap content), borderColor Outline Variant, containerColor Background. Padding 12 dp.
        - Leading: `Box` circular 24 dp, fondo Outline (`#857370`) ‚Äî ‚ö™.
        - Content column:
          - L√≠nea 1: `Text(name)` (Title Medium, On Surface).
          - L√≠nea 2: `Text(statusDisplayText)` (Body Medium, On Surface Variant). Ej: "No Iniciado ¬∑ 0/4 series".
          - L√≠nea 3: `Text(loadDisplayText)` (Body Medium). Color y estilo seg√∫n variante:
            - Est√°ndar con historial: On Surface, normal.
            - Sin historial: On Surface Variant, fontStyle Italic.
            - Peso corporal: On Surface Variant.
            - Isom√©trico: On Surface Variant.
        - Trailing `Row` spacing 8 dp:
          - `Button("Registrar")` ‚Äî `FilledTonalButton`, height 36 dp visual / **48 dp touch target** (RNF06: `Modifier.defaultMinSize(minHeight = 48.dp)`), containerColor Primary Container, contentColor On Primary Container. **En HU-05: `onClick = { /* TODO: HU-06 */ }`**.
          - `OutlinedButton("Sustituir")` ‚Äî compact, borderColor Outline, **48 dp touch target**. **En HU-05: `onClick = { /* TODO: HU-07 */ }`**.
          - `IconButton(üì∑)` ‚Äî √≠cono `PhotoCamera` o `RemoveRedEye`, tint On Surface Variant, 48√ó48 dp. `onClick = { onNavigateToExerciseDetail(exerciseId) }` ‚Äî navega a D2.

        **En Ejecuci√≥n** (`status == IN_PROGRESS`): `Card` (Filled), containerColor azul fila `#E3F2FD` (light) / `#1A2733` (dark). Leading üîµ azul (`#1565C0` light / `#64B5F6` dark), 24 dp. Contenido:
        - L√≠nea 1: `Text(name)` (Title Medium, On Surface).
        - L√≠nea 2: `Text(statusDisplayText)` (Body Medium, On Surface Variant). Usando `session_status_in_progress`.
        - L√≠nea 3: `Text(loadDisplayText)` (Body Medium, On Surface).
        - Trailing `Row` spacing 8 dp:
          - `Button("Registrar")` ‚Äî **`Button` (Filled)**, height 36 dp visual / **48 dp touch target**, containerColor **Primary**, contentColor **On Primary**. **Nota:** Distinto de No Iniciado (que usa FilledTonalButton con Primary Container) ‚Äî la Especificaci√≥n Visual ¬ß8 E1 escala intencionalmente la prominencia del bot√≥n a Filled Primary para ejercicios ya en ejecuci√≥n. **En HU-05: `onClick = { /* TODO: HU-06 */ }`**.
          - `IconButton(üì∑)` ‚Äî tint On Surface Variant, 48√ó48 dp. `onClick = { onNavigateToExerciseDetail(exerciseId) }`.
          - **Sin bot√≥n "Sustituir"** (CA-07.06: solo si 0 series ‚Äî aqu√≠ ya tiene series).
        - **En HU-05 este estado nunca se alcanza** (no se registran series). Se implementa el renderizado para preparar HU-06.

        **Completado** (`status == COMPLETED`): `Card` (Filled), containerColor verde fila `#E8F5E9` (light) / `#1A2E1A` (dark), height ‚â§ 72 dp. Leading ‚úÖ verde (`#2E7D32` light / `#81C784` dark), 24 dp. Texto con `alpha = 0.7f`. Sin botones de acci√≥n, solo üì∑. **En HU-05 nunca se alcanza.**

    - **Bot√≥n "Cerrar Sesi√≥n"**: `OutlinedButton(modifier = Modifier.fillMaxWidth())`, borderColor Secondary (`#6B4F4F`), contentColor Secondary. Margin top 24 dp, margin bottom 16 dp. **En HU-05: `onClick = { /* TODO: HU-09 */ }`** (stub).

    - **`BackHandler`**: Intercepta back press. En HU-05: `BackHandler { /* no-op */ }` ‚Äî el usuario debe cerrar sesi√≥n formalmente v√≠a el bot√≥n. En HU-09 se reemplaza con di√°logo de confirmaci√≥n (E4).

    - **Sin Bottom Navigation** (Arquitectura T√©cnica ¬ß4.5.1: E1 siempre oculta).
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/session/ActiveSessionScreen.kt`

### Fase 9: Navigation + Strings

> Basado en Hitos #10 y #11 del An√°lisis Arquitect√≥nico

#### üì¶ NavigationRoutes

- [ ] **Agregar ruta ACTIVE_SESSION** (AC: 05.06)
  - [ ] Agregar constante: `const val ACTIVE_SESSION = "active-session/{sessionId}"`. Agregar helper: `fun activeSessionRoute(sessionId: Long) = "active-session/$sessionId"` ‚Äî Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/navigation/NavigationRoutes.kt`

#### üì¶ TensionNavHost

- [ ] **Actualizar NavHost** (AC: 05.06)
  - [ ] **Actualizar composable HOME:** Cambiar firma de `HomeScreen` para incluir `onNavigateToActiveSession`:
    ```kotlin
    HomeScreen(
        onNavigateToAlerts = { /* TODO: HU-14+ */ },
        onNavigateToActiveSession = { sessionId ->
            navController.navigate(NavigationRoutes.activeSessionRoute(sessionId))
        },
    )
    ```
  - [ ] **Agregar composable ACTIVE_SESSION:**
    ```kotlin
    composable(
        route = NavigationRoutes.ACTIVE_SESSION,
        arguments = listOf(navArgument("sessionId") { type = NavType.LongType }),
    ) {
        ActiveSessionScreen(
            onNavigateToRegisterSet = { /* TODO: HU-06 */ },
            onNavigateToSubstitute = { /* TODO: HU-07 */ },
            onNavigateToExerciseDetail = { exerciseId ->
                navController.navigate(NavigationRoutes.exerciseDetailRoute(exerciseId))
            },
            onNavigateToSessionSummary = { /* TODO: HU-09 */ },
            onNavigateToHome = {
                navController.navigate(NavigationRoutes.HOME) {
                    popUpTo(NavigationRoutes.HOME) { inclusive = true }
                }
            },
        )
    }
    ```
  - [ ] **Extender l√≥gica `showBottomBar`:** Actualmente: `currentRoute != null && currentRoute != NavigationRoutes.REGISTER`. Cambiar a:
    ```kotlin
    val showBottomBar = currentRoute != null &&
        currentRoute != NavigationRoutes.REGISTER &&
        !currentRoute.startsWith("active-session")
    ```
    Esto oculta la Bottom Nav en E1. Cuando se implementen E2, E3, E4, E5 (HU-06, HU-07, HU-09), se agregar√°n sus prefijos.
    **Caso especial D2 desde E1 (Arquitectura T√©cnica ¬ß4.5.1 + ¬ß4.7):** Cuando el ejecutante toca üì∑ en E1, navega a `exercise-detail/{id}` (D2). La regla ¬ß4.5.1 indica que D2 es **condicional**: Bottom Nav visible si el origen es D1/D4/F3, **oculta si el origen es E1** (sesi√≥n activa). La l√≥gica `showBottomBar` por prefijo NO cubre este caso porque `exercise-detail` no empieza con `active-session`. Para resolverlo, se debe evaluar si la entry anterior en el back stack pertenece al session-graph (¬ß4.7). Implementaci√≥n: verificar si `navController.previousBackStackEntry?.destination?.route?.startsWith("active-session") == true` y, si es as√≠, ocultar Bottom Nav. Alternativa pragm√°tica para HU-05: pasar un query parameter `?fromSession=true` en la ruta al navegar desde E1 a D2 y evaluarlo en `showBottomBar`. Se prefiere la evaluaci√≥n del back stack por ser m√°s limpia y no contaminar la ruta.
  - Archivo: `app/src/main/java/com/estebancoloradogonzalez/tension/ui/navigation/TensionNavHost.kt`

#### üì¶ Strings

- [ ] **Actualizar strings.xml** (AC: 05.01, 05.06)
  - [ ] **Eliminar** strings obsoletos del stub B1: `home_welcome` ("Bienvenido a Tension"), `home_description` ("Tu sistema de decisiones..."). **Nota:** `home_title` ("Tension") se puede reutilizar para el Top Bar custom de B1.
  - [ ] **Agregar secci√≥n Home B1:**
    ```xml
    <string name="home_next_session_label">Tu pr√≥xima sesi√≥n</string>
    <string name="home_next_session_format">M√≥dulo %1$s \u2014 Versi√≥n %2$d</string>
    <string name="home_start_session">Iniciar Sesi√≥n</string>
    <string name="home_resume_title">Tienes una sesi√≥n activa sin cerrar</string>
    <string name="home_resume_progress">%1$d de %2$d ejercicios completados</string>
    <string name="home_resume_session">Reanudar Sesi√≥n</string>
    <string name="home_microcycles_label">microciclos</string>
    <string name="home_alert_badge_description">Alertas activas</string>
    ```
  - [ ] **Agregar secci√≥n Active Session E1:**
    ```xml
    <string name="session_active_label">Sesi√≥n activa</string>
    <string name="session_module_version_format">M√≥dulo %1$s \u2014 Versi√≥n %2$d</string>
    <string name="session_progress_format">%1$d de %2$d ejercicios completados</string>
    <string name="session_status_not_started">No Iniciado \u00b7 %1$d/%2$d series</string>
    <string name="session_status_in_progress">En Ejecuci√≥n \u00b7 %1$d/%2$d series</string>
    <string name="session_status_completed">Completado \u00b7 %1$d/%2$d series</string>
    <string name="session_load_kg_format">%.1f Kg</string>
    <string name="session_load_no_history">Sin historial \u2014 establecer carga</string>
    <string name="session_load_bodyweight">Peso corporal</string>
    <string name="session_load_isometric">Isom√©trico (30\u201345s)</string>
    <string name="session_register_set">Registrar</string>
    <string name="session_substitute">Sustituir</string>
    <string name="session_close">Cerrar Sesi√≥n</string>
    ```
  - Archivo: `app/src/main/res/values/strings.xml`

### Fase 10: QA y Deployment

#### üì¶ Code Quality

- [ ] **Ejecutar Agente Peer Review** ‚Äî MANUAL
- [ ] **Resolver incidentes del Peer Review** (condicional) ‚Äî MANUAL

#### üì¶ Deployment DEV

- [ ] **Crear Pull Request** ‚Äî MANUAL
- [ ] **Ejecutar pipeline deployment DEV** ‚Äî MANUAL

#### üì¶ Testing Manual

- [ ] **Dise√±ar set de pruebas manuales** ‚Äî MANUAL
- [ ] **Ejecutar pruebas manuales** ‚Äî MANUAL

---

**Notas sobre vinculaci√≥n con Criterios de Aceptaci√≥n:**

- CA-05.01 ‚Üí Fases 4, 5, 6 (RotationState model + GetNextSessionInfoUseCase + SessionRepositoryImpl l√≥gica posici√≥n‚Üím√≥dulo). Mapeo determin√≠stico: 1,4‚ÜíA; 2,5‚ÜíB; 3,6‚ÜíC
- CA-05.02 ‚Üí Fases 4, 5, 6 (RotationState model + GetNextSessionInfoUseCase + SessionRepositoryImpl lectura de `current_version_module_X`). V1‚ÜíV2‚ÜíV3 wrap-around
- CA-05.03 ‚Üí Fase 6 (defaults de RotationStateEntity: position=1, versionA=1 ‚Üí module_version A-V1 = id 1)
- CA-05.04 ‚Üí Impl√≠cito (SQLite persiste indefinidamente, sin timeout ni reinicio por ausencia. RNF13)
- CA-05.05 ‚Üí Impl√≠cito (Room/SQLite es archivo local, sobrevive reinicios y actualizaciones. RNF13)
- CA-05.06 ‚Üí Fases 1, 2, 3, 6, 7, 8 (Entities + DAOs + Database + Repository startSession + B1 Card Pr√≥xima + E1 lista ejercicios)
- CA-05.07 ‚Üí Fases 1, 2, 6, 8 (ExerciseProgressionEntity vac√≠a + LEFT JOIN retorna NULL + E1 muestra "Sin historial ‚Äî establecer carga" italic)
- CA-05.08 ‚Üí Fases 1, 2, 6, 8 (ExerciseProgressionEntity.prescribedLoadKg + LEFT JOIN retorna valor + E1 muestra "60 Kg")
- CA-05.09 ‚Üí Fase 5 (GetNextSessionInfoUseCase NO usa fecha. La fecha solo es metadato en session.date, no input de decisi√≥n)