# HU-08 — Registrar ejercicios de peso corporal e isométricos

## Requisitos relacionados

RF31, RF32, RF33, RNF12

## Descripción

Como ejecutante, quiero que el sistema maneje correctamente el registro y la progresión de ejercicios de peso corporal y ejercicios isométricos con sus reglas específicas, para que la medición de mi avance en estos movimientos refleje sus características biomecánicas particulares y no se apliquen reglas de carga que no les corresponden.

## Criterios de Aceptación

### CA-08.01 — Registro de ejercicios de peso corporal con Peso = 0

**Dado que** el ejecutante registra una serie de un ejercicio de peso corporal (Flexiones, Sentadilla a cuerpo libre, Abdominales, Escalador, Giro Ruso),
**cuando** completa el formulario de registro,
**entonces** el campo de peso se establece en 0 Kg, y el sistema registra las repeticiones logradas y el RIR normalmente.

### CA-08.02 — Progresión de peso corporal por repeticiones totales

**Dado que** el ejecutante ha completado las 4 series de un ejercicio de peso corporal,
**cuando** el sistema evalúa la progresión de ese ejercicio,
**entonces** mide la progresión exclusivamente por el total de repeticiones logradas en las 4 series comparado con la sesión anterior del mismo ejercicio, sin aplicar la Regla de Doble Umbral de carga.

### CA-08.03 — Regla de Doble Umbral no aplica a peso corporal

**Dado que** un ejercicio de peso corporal alcanza ≥ 12 repeticiones en 3 de 4 series con RIR ≥ 2,
**cuando** el sistema evalúa si debe incrementar carga,
**entonces** no prescribe incremento de carga (ya que Δmin = 0 Kg para peso corporal); la progresión sigue midiéndose por repeticiones totales.

### CA-08.04 — Registro de ejercicios isométricos en segundos

**Dado que** el ejecutante registra una serie de un ejercicio isométrico (Plancha, Plancha Lateral),
**cuando** completa el formulario de registro,
**entonces** el sistema solicita la duración en segundos sostenidos en lugar de repeticiones, y el campo de entrada refleja claramente que se trata de segundos, junto con el RIR correspondiente.

### CA-08.05 — Validación de rango isométrico

**Dado que** el ejecutante registra la duración de una serie de un ejercicio isométrico,
**cuando** ingresa un valor,
**entonces** el sistema acepta valores ≥ 1 segundo y muestra una referencia visual del rango prescrito de 30 a 45 segundos para orientar al ejecutante.

### CA-08.06 — Progresión de isométricos por tiempo sostenido

**Dado que** el ejecutante ha completado las 4 series de un ejercicio isométrico,
**cuando** el sistema evalúa la progresión,
**entonces** mide la progresión por los segundos sostenidos dentro del rango prescrito (30-45 segundos), comparando con la sesión anterior del mismo ejercicio.

### CA-08.07 — Marcado de isométrico como "dominado"

**Dado que** el ejecutante completa las 4 series de un ejercicio isométrico y las 4 series alcanzaron ≥ 45 segundos,
**cuando** el sistema evalúa la progresión del ejercicio,
**entonces** marca el ejercicio como "dominado" e indica al ejecutante que el ejercicio ya no ofrece estímulo progresivo suficiente en su forma actual.

### CA-08.08 — Validación de datos de entrada

**Dado que** el ejecutante registra una serie de cualquier tipo de ejercicio (peso corporal o isométrico),
**cuando** ingresa valores fuera de los rangos permitidos (repeticiones < 1, duración en segundos < 1, RIR fuera de 0-5),
**entonces** el sistema rechaza el registro con un mensaje de error claro antes de persistir.

---

## Análisis Arquitectónico (Arquitecto)

### Decisiones de Diseño

**Hallazgo Principal — HU-08 es una historia de naturaleza transversal (cross-cutting), no una funcionalidad independiente.**

HU-08 define 8 Criterios de Aceptación que se dividen en dos categorías claramente diferenciadas:

1. **CAs de registro (comportamiento de E2):** CA-08.01, CA-08.04, CA-08.05, CA-08.08 — Cómo el formulario de registro de serie adapta su interfaz y validación según el tipo de ejercicio (peso corporal vs. isométrico vs. estándar).

2. **CAs de progresión (evaluación post-sesión):** CA-08.02, CA-08.03, CA-08.06, CA-08.07 — Cómo el motor de progresión evalúa y clasifica el rendimiento de ejercicios de peso corporal e isométricos con reglas diferentes al estándar.

**Los CAs de registro (4 de 8) ya están completamente implementados en el código actual** como parte de HU-06 (Registrar series). La decisión de pre-implementarlos en HU-06 fue explícita y documentada en el análisis de HU-06 §6: *"Los CAs de HU-08 referenciados en E2 (CA-08.01, CA-08.04, CA-08.05, CA-08.08) se cubren en este diseño"*.

**Los CAs de progresión (4 de 8) corresponden al motor de reglas de HU-10/HU-11**, que evalúa progresión al cierre de sesión. No existe actualmente ninguna lógica de evaluación de progresión en el codebase — solo la infraestructura de datos (`ExerciseProgressionEntity` con campos `status`, `prescribedLoadKg`, `sessionsWithoutProgression`).

**Conclusión: HU-08 no requiere trabajo de implementación autónomo.** Todos sus CAs están cubiertos por otras historias — 4 ya implementados (HU-06) y 4 se implementarán en HU-10/HU-11 cuando el motor de progresión sea desarrollado.

### Verificación Exhaustiva CA por CA

#### CAs de Registro — Ya implementados en HU-06

**CA-08.01 — Peso = 0 para ejercicios de peso corporal:**

| Capa | Implementación | Archivo | Evidencia |
|------|----------------|---------|-----------|
| ViewModel | `weightKg = "0"` cuando `info.isBodyweight == true` | `RegisterSetViewModel.kt` línea 44 | `info.isBodyweight \|\| info.isIsometric -> "0"` |
| ViewModel | `isWeightEditable = false` | `RegisterSetViewModel.kt` línea 54 | `!info.isBodyweight && !info.isIsometric` |
| Screen | Label cambia a "Peso (Kg) (Peso corporal)" | `RegisterSetScreen.kt` línea 155 | `stringResource(R.string.register_set_weight_bodyweight_label)` |
| Screen | Campo deshabilitado con fondo `surfaceContainerHighest.copy(alpha = 0.5f)` | `RegisterSetScreen.kt` líneas 178-186 | `enabled = uiState.isWeightEditable` con colors custom |
| Repository | `lastWeightKg = 0.0` para bodyweight | `SessionRepositoryImpl.kt` línea 176 | `if (info.isBodyweight == 1 \|\| info.isIsometric == 1) 0.0` |
| Strings | `register_set_weight_bodyweight_label` | `strings.xml` línea 51 | `"Peso (Kg) (Peso corporal)"` |

**CA-08.04 — Registro de isométricos en segundos:**

| Capa | Implementación | Archivo | Evidencia |
|------|----------------|---------|-----------|
| Screen | Label cambia a "Segundos sostenidos" | `RegisterSetScreen.kt` línea 194 | `if (uiState.isIsometric) stringResource(R.string.register_set_seconds_label)` |
| Screen | Suffix cambia a "seg" | `RegisterSetScreen.kt` línea 200 | `if (uiState.isIsometric) stringResource(R.string.register_set_seconds_suffix)` |
| Screen | Label cambia a "Peso (Kg) (Isométrico)" | `RegisterSetScreen.kt` línea 163 | `stringResource(R.string.register_set_weight_isometric_label)` — **Corrección aplicada durante auditoría:** el `when` original verificaba `isBodyweight` antes de `isIsometric`, causando que ejercicios isométricos (que son subconjunto de bodyweight según Modelo de Datos: `is_isometric = 1 → is_bodyweight = 1`) mostraran label "(Peso corporal)" en vez de "(Isométrico)". Se invirtió el orden para que `isIsometric` se evalúe primero (consistente con `ActiveSessionViewModel` en E1). |
| UiState | Campo `isIsometric: Boolean` disponible | `RegisterSetUiState.kt` línea 11 | `val isIsometric: Boolean = false` |
| Strings | `register_set_seconds_label`, `register_set_seconds_suffix` | `strings.xml` líneas 56-57 | `"Segundos sostenidos"`, `"seg"` |

**CA-08.05 — Validación ≥ 1 segundo + referencia visual 30-45s:**

| Capa | Implementación | Archivo | Evidencia |
|------|----------------|---------|-----------|
| ViewModel | Validación `parsed < 1` → `error_seconds_min` | `RegisterSetViewModel.kt` línea 70 | `context.getString(R.string.error_seconds_min)` |
| Screen | `supportingText` muestra referencia cuando isometric y sin error | `RegisterSetScreen.kt` líneas 206-216 | `stringResource(R.string.register_set_seconds_reference)` |
| UseCase | `require(reps >= 1)` (campo `reps` almacena segundos para isométricos) | `RegisterSetUseCase.kt` línea 16 | Validación de dominio |
| Strings | `register_set_seconds_reference`, `error_seconds_min` | `strings.xml` líneas 58, 64 | `"(Referencia: 30–45 seg)"`, `"La duración debe ser ≥ 1 segundo"` |

**CA-08.08 — Validación de datos de entrada:**

| Capa | Implementación | Archivo | Evidencia |
|------|----------------|---------|-----------|
| UseCase | `require(weightKg >= 0)`, `require(reps >= 1)`, `require(rir in 0..5)` | `RegisterSetUseCase.kt` líneas 15-17 | 3 validaciones de dominio |
| ViewModel | Validación inline en `onWeightChanged` (peso < 0) | `RegisterSetViewModel.kt` línea 63 | `error_weight_negative` |
| ViewModel | Validación inline en `onRepsChanged` (reps/seconds < 1) | `RegisterSetViewModel.kt` líneas 68-78 | Error diferenciado por tipo |
| ViewModel | `onConfirm` valida null-safety + captura `IllegalArgumentException` | `RegisterSetViewModel.kt` líneas 86-126 | Double-validation (UI + UseCase) |
| Screen | RIR es selector fijo 0-5, imposible ingresar fuera de rango | `RegisterSetScreen.kt` línea 271 | `for (rir in 0..5)` chips circulares |

#### CAs de Progresión — Diferidos a HU-10/HU-11

**CA-08.02 — Progresión de peso corporal por repeticiones totales:**

Responsabilidad de **HU-10** (Evaluar y clasificar progresión post-sesión). La progresión se evalúa al cerrar la sesión (HU-09 trigger → HU-10 lógica). El motor de reglas de HU-10 comparará el total de repeticiones de las 4 series del ejercicio de peso corporal contra el total de la sesión anterior del mismo ejercicio. Regla 6 del MDS §6-A.

**Estado de la infraestructura:** Los datos necesarios (`exercise_set.reps` × 4 series por `session_exercise`) ya se persisten correctamente. Solo falta la lógica de comparación y clasificación.

**CA-08.03 — Regla de Doble Umbral no aplica a peso corporal:**

Responsabilidad de **HU-11** (Motor de Doble Umbral). El motor de Doble Umbral evalúa si debe incrementar carga. Para ejercicios de peso corporal, `Δmin = 0`, por lo que la regla no prescribe incremento. La exclusión se implementará como condición `if (!exercise.isBodyweight) applyDoubleThreshold()` en el motor de reglas.

**Estado de la infraestructura:** `ExerciseEntity.isBodyweight` ya existe. `ExerciseProgressionEntity.prescribedLoadKg` es nullable (null = no aplica para peso corporal). Solo falta la lógica del motor.

**CA-08.06 — Progresión de isométricos por tiempo sostenido:**

Responsabilidad de **HU-10**. El motor comparará los segundos sostenidos (almacenados en `exercise_set.reps`) contra el rango prescrito (30-45 seg). Regla 7 del MDS §6-A.

**Estado de la infraestructura:** Los segundos se almacenan en `reps` (diseño documentado en Modelo de Datos §3.12: "Para ejercicios isométricos, este campo almacena los segundos sostenidos"). Solo falta la lógica de evaluación.

**CA-08.07 — Marcado de isométrico como "dominado":**

Responsabilidad de **HU-10**. Cuando 4 de 4 series alcanzan ≥ 45 segundos, `ExerciseProgressionEntity.status` pasa a `"MASTERED"`. La entidad ya tiene el campo `status` con validación `CHECK(status IN (..., 'MASTERED'))`.

**Estado de la infraestructura:** `ExerciseProgressionEntity.status` existe con default `"NO_HISTORY"` y valores posibles incluyendo `"MASTERED"` (Modelo de Datos §3.13, línea 500). Solo falta el código que ejecute la transición de estado.

### Validación de Impacto

**Código verificado (post HU-07):**

| Archivo | Estado | Resultado |
|---|---|---|
| `RegisterSetViewModel.kt` | 142 líneas | ✅ CA-08.01, CA-08.04, CA-08.05, CA-08.08 completamente cubiertos |
| `RegisterSetScreen.kt` | 307 líneas | ✅ 3 variantes de E2 (estándar, peso corporal, isométrico) implementadas |
| `RegisterSetUiState.kt` | 27 líneas | ✅ Campos `isBodyweight`, `isIsometric`, `isWeightEditable` presentes |
| `RegisterSetUseCase.kt` | ~20 líneas | ✅ 3 validaciones: peso ≥ 0, reps ≥ 1, RIR 0-5 |
| `SessionRepositoryImpl.kt` | 268 líneas | ✅ `getRegisterSetInfo` retorna `lastWeightKg = 0.0` para bodyweight/isometric |
| `ExerciseProgressionEntity.kt` | 33 líneas | ✅ Schema preparado: `status`, `prescribedLoadKg`, `sessionsWithoutProgression` |
| `strings.xml` | ~100 líneas | ✅ 7 strings de E2 para bodyweight/isometric presentes |

**Impacto en HU-10/HU-11:** Cuando se implemente el motor de progresión, deberá:
1. Detectar si el ejercicio es `isBodyweight` o `isIsometric` (flags ya persisten en `exercise`).
2. Para bodyweight: comparar `SUM(reps)` de las 4 series contra la sesión anterior (Regla 6).
3. Para isometric: comparar segundos sostenidos en rango 30-45s contra sesión anterior (Regla 7).
4. Para isometric: si las 4 series ≥ 45s → `status = "MASTERED"` (CA-08.07).
5. Para bodyweight: NO aplicar Doble Umbral (`prescribedLoadKg` permanece null).

### Notas Técnicas

1. **El campo `exercise_set.reps` almacena tanto repeticiones como segundos.** El Modelo de Datos §3.12 documenta que "Para ejercicios isométricos, este campo almacena los segundos sostenidos en lugar de repeticiones." No se requiere una columna separada. La interpretación del valor depende de `exercise.is_isometric`.

2. **HU-08 como historia transversal.** A diferencia de HU-01 a HU-07, que mapean 1:1 a funcionalidades concretas, HU-08 es una historia que refina el comportamiento de E2 (HU-06) y del motor de progresión (HU-10/HU-11) para tipos de ejercicio especiales. Su valor reside en documentar las reglas de negocio que afectan a múltiples componentes, no en introducir nueva funcionalidad autónoma.

3. **La decisión de pre-implementar los CAs de registro en HU-06 fue correcta y deliberada.** Implementar las variantes de E2 junto con el formulario base evitó: (a) duplicar la creación de test scenarios de E2, (b) reabrir un composable ya validado, (c) introducir complejidad de merge entre branches. HU-06 implementó E2 completo con sus 3 variantes en un solo pass.

4. **Consistencia con el patrón de HU-05 → HU-06.** Así como HU-05 pre-implementó el estado de ejercicio en E1 (que HU-06 usó directamente), HU-06 pre-implementó las variantes de E2 (que HU-08 documenta como requisitos). Este patrón de "implementar infraestructura de forma anticipada cuando el costo marginal es bajo" es consistente en toda la línea de implementación.

5. **Relación con la Especificación Visual.** La Especificación Visual §8 E2 documenta explícitamente las 3 variantes de E2 con su trazabilidad: *"HU-06 (CA-06.01 a CA-06.09) · HU-08 (CA-08.01, CA-08.04, CA-08.05, CA-08.08)"*. Ambas HUs contribuyen a la misma pantalla, pero la implementación completa está en HU-06.

### Historias Relacionadas

**Historias que ya implementaron comportamiento de HU-08:**

- HU-03: Crear ejercicio — CA-03.10: define los checkboxes "Peso corporal", "Isométrico", "Al fallo técnico" en el formulario de creación. Origina las flags `is_bodyweight`, `is_isometric`, `is_to_technical_failure` en `ExerciseEntity`. El seeder marca los 43 ejercicios base con sus flags correctos.
- HU-04: Asignación a versión del plan — CA-04.04: diferencia claramente los ejercicios con rango estándar (8-12 reps) de "Al fallo técnico" y "30-45 seg" en la lista de D1. Muestra labels en itálica para condiciones especiales.
- HU-05: Determinar e iniciar sesión — Muestra texto de carga diferenciado en E1: "Peso corporal" para bodyweight, "Isométrico (30-45s)" para isométrico, valor en Kg para estándar. Ya usa el orden correcto `isIsometric` → `isBodyweight` en el `when`.
- HU-06: Registrar series — Implementó todos los CAs de registro de HU-08 (CA-08.01, CA-08.04, CA-08.05, CA-08.08). Pre-implementación explícita, documentada en análisis HU-06 §6.
- HU-07: Sustituir ejercicio — Reconoce que un ejercicio sustituto puede ser bodyweight o isométrico. E2 (HU-06) ya maneja las 3 variantes sin cambios.

**Historias que implementarán comportamiento futuro de HU-08:**

- HU-09: Cerrar sesión — Trigger que invoca la evaluación de progresión. El cierre de sesión dispara el motor de HU-10.
- HU-10: Evaluar y clasificar progresión post-sesión — Implementará CA-08.02 (progresión bodyweight por reps totales), CA-08.06 (progresión isométrica por segundos), CA-08.07 (marcado "dominado" / MASTERED). Reglas 6 y 7 del MDS §6-A. **Nota:** Los CAs actuales de HU-10 (CA-10.01 a CA-10.09) no mencionan explícitamente las reglas de bodyweight/isométrico ni el estado MASTERED — esta cobertura deberá verificarse durante el análisis de HU-10.
- HU-11: Doble Umbral — CA-11.08 excluye explícitamente bodyweight del Doble Umbral: `Δmin = 0`. Implementará CA-08.03.

**Historias con interacción futura relevante:**

- HU-17: Protocolo de descarga — CA-17.09: prescripciones específicas para bodyweight (8 reps, RIR 4-5, sin ajuste de carga) e isométricos (30 seg, RIR 4-5) durante descarga.
- HU-19: KPIs por ejercicio — CA-19.05: excluye bodyweight de "Velocidad de Progresión de Carga" (Peso = 0).
- HU-23: Historial de ejercicio — CA-23.06: muestra tendencia por repeticiones totales (en vez de carga) para ejercicios de peso corporal.

### Referencias y Validación

**Documentación consultada:**

- Modelo de Datos §3.12 (`exercise_set`): campo `reps` almacena segundos para isométricos.
- Modelo de Datos §3.13 (`exercise_progression`): campo `status` incluye `MASTERED` para isométricos dominados.
- Wireframes E2: Variante isométrica con "Segundos sostenidos" y referencia 30-45 seg. Variante peso corporal con peso fijo 0.
- Especificación Visual §8 E2: Trazabilidad `HU-06 + HU-08`. 3 variantes documentadas (estándar, peso corporal, isométrico).
- MDS §6-A Regla 6: Progresión peso corporal por repeticiones totales.
- MDS §6-A Regla 7: Progresión isométrica por segundos + condición "dominado" (4 series ≥ 45s).
- ADR §4.2: Las Reglas 1-7 del MDS se implementan como funciones puras en el paquete `domain.rules`, invocadas por Use Cases — testeables unitariamente sin emulador.
- Requerimientos: RF31 (progresión bodyweight por reps), RF32 (registro y progresión isométrica), RF33 (marcado "dominado"), RNF12 (validación de entrada).
- HU-06 análisis §6: documentación explícita de pre-implementación de CAs de HU-08 en E2.

### Verificación Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-08.01 | ✅ Completo | Peso = 0, campo no editable, label adaptado | HU-06 (E2 bodyweight variant) |
| CA-08.02 | ⏳ Diferido | Comparación de reps totales × 4 series | Futuro HU-10 (Regla 6 MDS) |
| CA-08.03 | ⏳ Diferido | Exclusión de bodyweight del motor de Doble Umbral | Futuro HU-11 (Regla 1 MDS, Δmin = 0) |
| CA-08.04 | ✅ Completo | Label "Segundos sostenidos", suffix "seg", peso fijo 0 | HU-06 (E2 isometric variant). **Fix aplicado:** orden de `when` en `WeightField` corregido (B2) |
| CA-08.05 | ✅ Completo | Validación ≥ 1s + supportingText "(Referencia: 30-45 seg)" | HU-06 (E2 isometric variant) |
| CA-08.06 | ⏳ Diferido | Evaluación de progresión por segundos sostenidos | Futuro HU-10 (Regla 7 MDS) |
| CA-08.07 | ⏳ Diferido | Transición status → MASTERED cuando 4 series ≥ 45s | Futuro HU-10 (Regla 7 MDS) |
| CA-08.08 | ✅ Completo | weight ≥ 0, reps/seconds ≥ 1, RIR 0-5 en UI + UseCase | HU-06 (E2 validation) |

### Hitos de implementación

| # | Entregable | Estado |
|---|---|---|
| 1 | Fix: `WeightField` orden `when` (`isIsometric` antes de `isBodyweight`) en `RegisterSetScreen.kt` | ✅ Aplicado durante auditoría |
| — | No hay hitos de implementación adicionales | **HU-08 no requiere trabajo de implementación nuevo** |

**Justificación:** 4 CAs de registro ya completados en HU-06 (con 1 fix menor aplicado). 4 CAs de progresión serán completados en HU-10/HU-11. No existe gap de implementación pendiente.

**Validado por:** esteban.colorado | **Fecha:** 2026-02-15 | **Enfoque:** Verificación contra código existente
