# HU-16 ‚Äî Historial de Ejercicios y Sesiones

## Requisitos relacionados

RF50, RF51, RF60

## Descripci√≥n

Como ejecutante, quiero consultar el historial completo de cualquier ejercicio con su tendencia de carga y el historial de todas mis sesiones pasadas con sus datos completos, para evaluar mi progreso real en cada movimiento, revisar mi entrenamiento reciente, comparar sesiones y tener un registro completo, accesible y trazable de todo mi trabajo realizado.

## Historias originales consolidadas

Esta historia consolida las siguientes historias del dise√±o original, que son dos perspectivas complementarias del mismo concepto (historial) y comparten la misma secci√≥n de navegaci√≥n y los mismos datos fuente:

- **HU-23 original** ‚Äî Consultar historial y tendencia de carga de un ejercicio (RF50, RF51)
- **HU-24 original** ‚Äî Consultar historial de sesiones pasadas (RF60)

---

## Criterios de Aceptaci√≥n

### Bloque A ‚Äî Historial y Tendencia de Carga por Ejercicio (RF50, RF51)

#### CA-16.01 ‚Äî Historial completo de registros

**Dado que** el ejecutante selecciona un ejercicio para consultar su historial,
**cuando** el sistema presenta los datos,
**entonces** muestra el historial completo de todas las sesiones en las que se registr√≥ ese ejercicio, incluyendo para cada sesi√≥n: fecha, peso utilizado (Kg), repeticiones logradas (por serie o totales), RIR (por serie o promedio) y clasificaci√≥n de progresi√≥n (Progresi√≥n positiva, Mantenimiento o Regresi√≥n).

#### CA-16.02 ‚Äî Orden cronol√≥gico

**Dado que** el sistema presenta el historial de un ejercicio,
**cuando** ordena las entradas,
**entonces** las muestra en orden cronol√≥gico, de la sesi√≥n m√°s reciente a la m√°s antigua, permitiendo al ejecutante ver primero su estado actual.

#### CA-16.03 ‚Äî Historial independiente del m√≥dulo-versi√≥n

**Dado que** un ejercicio puede aparecer en varias versiones del mismo m√≥dulo o puede haber sido ejecutado como sustituci√≥n,
**cuando** el sistema construye el historial,
**entonces** incluye todos los registros del ejercicio independientemente de la versi√≥n del m√≥dulo en que se haya ejecutado, consolidando toda la data del ejercicio en una sola vista.

#### CA-16.04 ‚Äî Visualizaci√≥n de la tendencia de carga

**Dado que** el ejecutante consulta un ejercicio con m√∫ltiples sesiones de historial,
**cuando** visualiza la tendencia de carga,
**entonces** el sistema muestra la evoluci√≥n del peso utilizado a lo largo del tiempo, permitiendo identificar visualmente si la carga es ascendente, estable o descendente.

#### CA-16.05 ‚Äî Ejercicios sin historial

**Dado que** el ejecutante consulta un ejercicio que nunca ha sido registrado,
**cuando** intenta ver el historial,
**entonces** el sistema indica que no hay registros disponibles para ese ejercicio.

#### CA-16.06 ‚Äî Ejercicios de peso corporal: tendencia por repeticiones

**Dado que** el ejecutante consulta el historial de un ejercicio de peso corporal (Peso = 0),
**cuando** visualiza la tendencia,
**entonces** la tendencia se muestra por repeticiones totales en lugar de carga, ya que el peso no var√≠a.

### Bloque B ‚Äî Historial de Sesiones Pasadas (RF60)

#### CA-16.07 ‚Äî Listado de sesiones pasadas

**Dado que** el ejecutante accede al historial de sesiones,
**cuando** el sistema presenta el listado,
**entonces** muestra todas las sesiones cerradas, cada una con: fecha, m√≥dulo (A, B o C), versi√≥n (V1, V2 o V3), estado (Completada o Incompleta) y tonelaje total, ordenadas de la m√°s reciente a la m√°s antigua.

#### CA-16.08 ‚Äî Detalle de una sesi√≥n pasada

**Dado que** el ejecutante selecciona una sesi√≥n del historial,
**cuando** accede al detalle,
**entonces** el sistema muestra los ejercicios ejecutados en esa sesi√≥n con sus datos completos: para cada ejercicio, las series registradas con peso, repeticiones, RIR y la clasificaci√≥n de progresi√≥n del ejercicio en esa sesi√≥n.

#### CA-16.09 ‚Äî Sesiones incompletas en el historial

**Dado que** el ejecutante tiene sesiones cerradas como Incompletas,
**cuando** consulta el historial,
**entonces** las sesiones incompletas aparecen claramente marcadas como "Incompleta", mostrando solo los ejercicios y series que efectivamente fueron registrados, sin datos inventados para los ejercicios faltantes.

#### CA-16.10 ‚Äî Sustituciones reflejadas en el historial

**Dado que** una sesi√≥n pasada incluy√≥ sustituciones puntuales de ejercicios,
**cuando** el ejecutante consulta el detalle de esa sesi√≥n,
**entonces** el sistema muestra los ejercicios que realmente se ejecutaron (incluyendo los sustitutos), reflejando fielmente lo que ocurri√≥ en la sesi√≥n.

#### CA-16.11 ‚Äî Inmutabilidad de sesiones consultadas

**Dado que** el ejecutante consulta el detalle de una sesi√≥n pasada,
**cuando** visualiza los datos,
**entonces** toda la informaci√≥n es de solo lectura; no se ofrecen opciones para editar, eliminar o agregar datos a sesiones cerradas.

#### CA-16.12 ‚Äî Historial vac√≠o

**Dado que** el ejecutante no tiene sesiones cerradas registradas,
**cuando** accede al historial,
**entonces** el sistema indica que no hay sesiones pasadas disponibles.

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** MVVM Read-Only con Room DAO Queries (3 pantallas, 3 ViewModels, 3 Use Cases)

**Justificaci√≥n:** HU-16 es una feature 100% de lectura ‚Äî no modifica datos, no dispara reglas de negocio, no crea entidades. Las 3 pantallas (F1, F2, F3) son vistas de solo lectura sobre datos ya persistidos por HU-06/09/10. No se necesitan nuevas Rules ni nuevos Repositories: los datos provienen de las tablas `session`, `session_exercise` y `exercise_set` ‚Äî ya manejadas por `SessionRepository`. Los DAOs necesitan queries nuevos porque no existen queries que devuelvan los datos con la forma requerida por las pantallas. La capa UI necesita 3 pantallas: F1 (placeholder existente), F3 (placeholder existente) y F2 (nueva). F3 incluye un gr√°fico Canvas de tendencia de carga, pintado con Canvas Compose sin librer√≠a externa (coherente con `TonnageChartComposable.kt` de HU-15/G2). Los Use Cases son orquestadores delegados al Repository sin l√≥gica adicional, siguiendo la convenci√≥n del proyecto (ADR-05: MVVM con capa Domain expl√≠cita).

### Decisiones Fundamentadas

**1. Los nuevos Use Cases son wrappers delegados al Repository, sin l√≥gica adicional.**

Para HU-16 no hay transformaci√≥n de negocio: el UseCase invoca un solo m√©todo del Repository y retorna el resultado. Esto mantiene la convenci√≥n del proyecto (todas las pantallas usan UseCase ‚Üí Repository) y permite agregar l√≥gica de dominio futura sin cambiar el ViewModel. Sigue el patr√≥n ya establecido en `GetWeightHistoryUseCase`, `GetProfileUseCase`, etc.

**2. F2 reutiliza `getSessionSummaryInfo()` existente y agrega queries para detalle de ejercicios.**

El detalle de sesi√≥n pasada necesita: resumen (tonelaje, conteo de ejercicios, estado) + lista de ejercicios (nombre, clasificaci√≥n, nota de sustituci√≥n) + series de cada ejercicio (peso, reps, RIR). El resumen de la sesi√≥n se obtiene reutilizando el query `SessionDao.getSessionSummaryInfo(sessionId)` ya creado por HU-13 ‚Äî devuelve `SessionSummaryInfo(status, moduleCode, versionNumber, totalTonnageKg, totalExercises, completedExercises)`. La fecha de la sesi√≥n se obtiene con `SessionDao.getById(sessionId)` ya existente. La lista de ejercicios se obtiene con un nuevo query en `SessionExerciseDao` y las series con el query `ExerciseSetDao.getSetsForSessionExercise(sessionExerciseId)` ya existente (iterado por ejercicio en el Repository). Esto evita queries N+1 innecesarios y es el patr√≥n ya usado por `getExercisesForSummary()` en `SessionExerciseDao`.

**3. El historial de ejercicio (F3) se construye con un query que cruza `session_exercise` con `session`, no con `exercise_progression`.**

`exercise_progression` solo tiene el estado actual (`status`, `prescribed_load_kg`, `sessions_without_progression`). Para obtener el historial longitudinal (fecha, peso, reps, RIR, clasificaci√≥n por cada sesi√≥n), se necesita la cadena `session_exercise` ‚Üí `session` ‚Üí `exercise_set`. El estado de progresi√≥n actual del ejercicio (Sin Historial / En Progresi√≥n / En Meseta / En Descarga) s√≠ se lee de `exercise_progression.status` como campo separado.

**4. La tendencia de carga se calcula en el ViewModel, no en el DAO.**

El gr√°fico de tendencia muestra puntos (session_index, weightKg) o (session_index, totalReps) para bodyweight. Estos datos ya se obtienen con el query de historial. El ViewModel transforma la lista de `ExerciseHistoryEntry` en puntos para el gr√°fico Canvas. No se necesita un c√°lculo en SQL ni una regla de dominio ‚Äî es una transformaci√≥n de presentaci√≥n.

**5. Bottom Navigation condicional en F3 requiere modificaci√≥n de `showBottomBar` en `TensionNavHost`.**

Wireframes dicen: Bottom Nav visible si se accede desde F2, G1, H2, D2; oculto si se accede desde E5 (post-sesi√≥n). La implementaci√≥n actual del `showBottomBar` en `TensionNavHost` excluye rutas de sesi√≥n activa (`active-session`, `register-set`, `substitute-exercise`, `session-summary`) y `exercise-detail` con origen `active-session`. **Sin embargo, NO maneja el caso de `exercise-history` con origen `session-summary`.** Cuando el ejecutante navega E5 ‚Üí F3, la ruta actual es `exercise-history/{id}` y la entry anterior en el back stack es `session-summary/{id}` ‚Äî la l√≥gica actual NO oculta el bottom bar porque `exercise-history` no est√° en la lista de exclusi√≥n. Se necesita agregar una condici√≥n an√°loga a la de `exercise-detail`: `!(currentRoute.startsWith("exercise-history") && navController.previousBackStackEntry?.destination?.route?.startsWith("session-summary") == true)`. El bot√≥n ‚Üê retorna al lugar correcto con `navController.popBackStack()`.

**6. La ruta `session-detail/{sessionId}` no existe a√∫n en el c√≥digo ‚Äî se agrega.**

`NavigationRoutes` define `SESSION_HISTORY` pero NO define `SESSION_DETAIL`. La Arquitectura T√©cnica (¬ß4.3) define la ruta como `session-detail/{sessionId}`. Se agrega la constante `SESSION_DETAIL`, la funci√≥n factory `sessionDetailRoute(sessionId)`, y el composable en `TensionNavHost`.

**7. Se crea `TrendChartComposable` porque `TonnageChartComposable` no es reutilizable para F3.**

`TonnageChartComposable` pinta evoluci√≥n de tonelaje por grupo muscular con m√∫ltiples l√≠neas y eje X = microciclos. F3 necesita una sola l√≠nea con eje X = sesiones y eje Y = Kg (o reps). Se crea `TrendChartComposable` como componente separado en `ui.components`, siguiendo las specs visuales: Canvas con l√≠nea Primary (2dp), puntos rellenos (6dp radio), grid dashed, labels en Label Small, 200dp de altura.

**8. Las sesiones incompletas muestran solo los ejercicios con series registradas (CA-16.09).**

El query de F2 filtra con `HAVING setCount > 0` (mismo patr√≥n que `getExercisesForSummary` existente). Los ejercicios sin series registradas no aparecen en el detalle. Esto cumple CA-16.09: "mostrando solo los ejercicios y series que efectivamente fueron registrados, sin datos inventados".

**9. No se crea un `HistoryRepository` separado.**

Los datos provienen de `session`, `session_exercise` y `exercise_set` ‚Äî tablas ya bajo la responsabilidad de `SessionRepository`. Agregar 3 m√©todos a una interface existente es menos intrusivo que crear un nuevo Repository con su binding Hilt. No se introduce nueva fuente de datos ni nuevo dominio funcional.

### Componentes Afectados

**Componentes nuevos:**

| # | Componente | Tipo | Paquete | Responsabilidad |
|---|-----------|------|---------|-----------------|
| 1 | `SessionHistoryScreen` | Nuevo (Composable) | `ui.history` | Pantalla F1 ‚Äî Listado de sesiones cerradas con fecha, m√≥dulo-versi√≥n, estado y tonelaje. Acceso desde Bottom Navigation |
| 2 | `SessionHistoryViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F1 ‚Äî carga lista de sesiones cerradas |
| 3 | `SessionHistoryUiState` | Nuevo (data class) | `ui.history` | Estado UI para F1 ‚Äî Loading/Empty/Loaded con lista de `SessionHistoryItem` |
| 4 | `SessionDetailScreen` | Nuevo (Composable) | `ui.history` | Pantalla F2 ‚Äî Detalle de sesi√≥n pasada con ejercicios, series y clasificaciones. Solo lectura |
| 5 | `SessionDetailViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F2 ‚Äî carga detalle completo de una sesi√≥n |
| 6 | `SessionDetailUiState` | Nuevo (data class) | `ui.history` | Estado UI para F2 ‚Äî Loading/Loaded con resumen + lista de ejercicios con series |
| 7 | `ExerciseHistoryViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F3 ‚Äî carga historial longitudinal de un ejercicio |
| 8 | `ExerciseHistoryUiState` | Nuevo (data class) | `ui.history` | Estado UI para F3 ‚Äî Loading/Empty/Loaded con estado progresi√≥n + tendencia + lista de sesiones |
| 9 | `GetSessionHistoryUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene lista de sesiones cerradas ordenadas cronol√≥gicamente descendente |
| 10 | `GetSessionDetailUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene detalle completo de una sesi√≥n: resumen + ejercicios con series |
| 11 | `GetExerciseHistoryUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene historial de un ejercicio a lo largo de todas las sesiones |
| 12 | `SessionHistoryItem` | Nuevo (domain model) | `domain.model` | Modelo para cada fila de F1: sessionId, date, moduleCode, versionNumber, status, totalTonnageKg |
| 13 | `SessionDetail` | Nuevo (domain model) | `domain.model` | Modelo para F2: resumen de sesi√≥n + lista de ejercicios con series detalladas |
| 14 | `SessionDetailExercise` | Nuevo (domain model) | `domain.model` | Modelo para cada ejercicio en F2: nombre, clasificaci√≥n, series, nota de sustituci√≥n |
| 15 | `ExerciseHistoryEntry` | Nuevo (domain model) | `domain.model` | Modelo para cada fila de F3: date, moduleCode, versionNumber, weightKg, totalReps, avgRir, classification |
| 16 | `ExerciseHistoryData` | Nuevo (domain model) | `domain.model` | Modelo compuesto para F3: exerciseName, progressionStatus, isBodyweight, isIsometric, entries (list) |
| 17 | `TrendChartComposable` | Nuevo (Composable) | `ui.components` | Gr√°fico lineal Canvas reutilizable para tendencia de carga/repeticiones (F3) |

**Componentes reutilizados (existentes, sin modificaci√≥n):**

| # | Componente | Paquete | Uso en HU-16 |
|---|-----------|---------|---------------|
| R1 | `ProgressionIndicator` | `ui.components` | Reutilizado en F2 y F3 para mostrar clasificaci√≥n de progresi√≥n (‚Üë/=/‚Üì) con color sem√°ntico. Ya creado por HU-13 |
| R2 | `TensionTopAppBar` | `ui.components` | Reutilizado en F1, F2, F3 para la barra superior con t√≠tulo y bot√≥n de retorno |
| R3 | `ExerciseProgressionDao.getByExerciseId()` | `data.local.dao` | Reutilizado en F3 para obtener el estado de progresi√≥n actual del ejercicio (`status`) |
| R4 | `SessionDao.getSessionSummaryInfo()` | `data.local.dao` | Reutilizado en F2 para obtener el resumen de la sesi√≥n (status, m√≥dulo, versi√≥n, tonelaje, conteos). Query existente de HU-13 |

**Componentes modificados:**

| # | Componente | Modificaci√≥n | Nivel |
|---|-----------|-------------|-------|
| 1 | `SessionDao` | Agregar query `getClosedSessionsWithSummary()` para F1 ‚Äî sesiones cerradas con m√≥dulo-versi√≥n, estado y tonelaje. Reutilizar `getSessionSummaryInfo()` existente para F2 (resumen) y `getById()` existente para F2 (fecha) | Menor |
| 2 | `SessionExerciseDao` | Agregar query `getExercisesForSessionDetail()` para F2 y `getExerciseHistoryEntries()` para F3 | Medio |
| 3 | `ExerciseSetDao` | Reutilizar `getSetsForSessionExercise(sessionExerciseId)` existente para F2 ‚Äî se itera por cada ejercicio en el Repository. No se necesita query nuevo | Sin cambio |
| 4 | `SessionRepository` (interface) | Agregar 3 m√©todos: `getSessionHistory()`, `getSessionDetail()`, `getExerciseHistory()` | Menor |
| 5 | `SessionRepositoryImpl` | Implementar los 3 nuevos m√©todos mapeando DTOs de DAO a domain models | Medio |
| 6 | `ExerciseHistoryScreen` | Refactorizar de placeholder a implementaci√≥n completa de F3: estado progresi√≥n, gr√°fico tendencia, lista de sesiones | Mayor |
| 7 | `NavigationRoutes` | Agregar `SESSION_DETAIL` route con argumento `sessionId` y funci√≥n factory `sessionDetailRoute()` | Menor |
| 8 | `TensionNavHost` | Reemplazar placeholder de `SESSION_HISTORY` con `SessionHistoryScreen`, agregar `SESSION_DETAIL` composable, actualizar `EXERCISE_HISTORY` con ViewModel y callbacks (`onNavigateBack`, `onNavigateToExerciseDetail`), agregar condici√≥n de `showBottomBar` para `exercise-history` con origen `session-summary` | Mayor |
| 9 | `BottomNavigationBar` | Mover `exercise-history` de `childRoutePrefixes` del tab Diccionario al tab Historial. Agregar `session-detail` como `childRoutePrefix` del tab Historial. F3 pertenece a `history-graph` (Arquitectura T√©cnica ¬ß4.4), no a `catalog-graph` | Medio |
| 10 | `strings.xml` | Agregar ~20 strings para las 3 pantallas (t√≠tulos, etiquetas, estados vac√≠os, formatos) | Menor |

**Componentes NO tocados (verificado en c√≥digo):**

- Toda la capa `domain/rules/` ‚Äî no hay nuevas reglas de negocio, la clasificaci√≥n ya existe en `session_exercise.progression_classification`
- `ExerciseProgressionDao` ‚Äî se lee `status` a trav√©s de un JOIN en query de F3, no se agrega query directo
- `ProfileRepository`, `PlanRepository`, `MetricsRepository`, `ExerciseRepository` ‚Äî no participan
- `data/local/entity/` ‚Äî ninguna entidad se modifica (0 cambios de esquema, 0 migraciones)
- `data/local/database/TensionDatabase.kt` ‚Äî no se modifica (versi√≥n se mantiene en 7)
- `data/local/seed/` ‚Äî no se toca ning√∫n seeder
- `di/DatabaseModule.kt` ‚Äî no se modifica (no hay nuevos DAOs)
- `di/RepositoryModule.kt` ‚Äî no se modifica (no hay nuevo Repository)
- Flujos E (sesi√≥n activa), B (home), C (perfil), D (cat√°logo), G (m√©tricas) ‚Äî no se modifican sus pantallas

### Hitos de Implementaci√≥n

| # | Componente(s) | Descripci√≥n | Dependencias |
|---|--------------|-------------|--------------|
| 1 | Domain Models | Crear `SessionHistoryItem`, `SessionDetail`, `SessionDetailExercise`, `ExerciseHistoryEntry`, `ExerciseHistoryData` en `domain.model` | Ninguna |
| 2 | DAO Queries | Agregar queries nuevos en `SessionDao` (F1) y `SessionExerciseDao` (F2, F3). Reutilizar `ExerciseSetDao.getSetsForSessionExercise()` existente (sin modificaci√≥n) | Ninguna |
| 3 | Repository | Agregar 3 m√©todos a `SessionRepository` (interface) e implementarlos en `SessionRepositoryImpl` | Hitos 1, 2 |
| 4 | Use Cases | Crear `GetSessionHistoryUseCase`, `GetSessionDetailUseCase`, `GetExerciseHistoryUseCase` en `domain.usecase.history` | Hito 3 |
| 5 | F1 ‚Äî Historial de Sesiones | Crear `SessionHistoryScreen`, `SessionHistoryViewModel`, `SessionHistoryUiState`. Reemplazar PlaceholderScreen en NavHost | Hito 4 |
| 6 | F2 ‚Äî Detalle de Sesi√≥n Pasada | Crear `SessionDetailScreen`, `SessionDetailViewModel`, `SessionDetailUiState`. Agregar ruta `SESSION_DETAIL` y navegaci√≥n F1 ‚Üí F2 | Hito 4 |
| 7 | Gr√°fico Tendencia | Crear `TrendChartComposable` en `ui.components` (Canvas lineal reutilizable) | Ninguna |
| 8 | F3 ‚Äî Historial de Ejercicio | Refactorizar `ExerciseHistoryScreen` de placeholder a implementaci√≥n completa con ViewModel, estado progresi√≥n, gr√°fico tendencia y lista de sesiones | Hitos 4, 7 |
| 9 | Navegaci√≥n y Strings | Actualizar `NavigationRoutes` (SESSION_DETAIL), `TensionNavHost` (3 composables), `BottomNavigationBar` (childRoutePrefixes), `strings.xml` (~20 strings) | Hitos 5, 6, 8 |
| 10 | Tests unitarios | Tests para los 3 Use Cases y para la transformaci√≥n de datos en ViewModels | Hitos 4, 5, 6, 8 |

### Validaci√≥n de Impacto

**C√≥digo real verificado (paso 1.5):**

- `ExerciseHistoryScreen.kt`: Actualmente es un placeholder que muestra "Pr√≥ximamente" dentro de un `Scaffold` con `TensionTopAppBar`. Se refactoriza completamente para implementar F3.
- `TensionNavHost.kt`: `SESSION_HISTORY` actualmente apunta a `PlaceholderScreen`. `EXERCISE_HISTORY` apunta al placeholder `ExerciseHistoryScreen`. Ambos se reemplazan con implementaciones reales. Se agrega la ruta `SESSION_DETAIL` que no existe.
- `BottomNavigationBar.kt`: El tab "Historial" (`SESSION_HISTORY`) no tiene `childRoutePrefixes`. Se necesita agregar `"session-detail"` y mover `"exercise-history"` desde el tab Diccionario al tab Historial para que F1 ‚Üí F2 ‚Üí F3 mantengan el tab activo. Actualmente `exercise-history` es childRoutePrefix del tab Diccionario (correcto para D2 ‚Üí F3, incorrecto para F2 ‚Üí F3). La Arquitectura T√©cnica ¬ß4.4 coloca F3 en `history-graph`, lo que confirma que Historial es el tab leg√≠timo.
- `NavigationRoutes.kt`: Define `SESSION_HISTORY = "session-history"` y `EXERCISE_HISTORY = "exercise-history/{exerciseId}"`. Falta `SESSION_DETAIL = "session-detail/{sessionId}"`.
- `SessionDao.kt`: Tiene `getClosedSessionsOrdered()` que devuelve `List<SessionEntity>` ‚Äî √∫til pero no incluye m√≥dulo-versi√≥n ni tonelaje. Se necesita un query nuevo que haga JOIN con `module_version` y calcule tonelaje.
- `SessionExerciseDao.kt`: Tiene `getExercisesForSummary()` que devuelve datos similares a F2 pero con l√≥gica de se√±ales de acci√≥n (c√°lculo de `previousTotalReps`, `isMastered`). Para F2 se necesita un query m√°s simple: nombre, clasificaci√≥n, nota sustituci√≥n. Para F3 se necesita un query cross-session por `exercise_id`.
- `ExerciseSetDao.kt`: Tiene `getSetsForSessionExercise(sessionExerciseId)` que devuelve series de un √∫nico `sessionExerciseId` ‚Äî se reutiliza iterativamente en el Repository para F2 (un call por ejercicio). No se necesita query nuevo. El patr√≥n de iteraci√≥n es aceptable porque una sesi√≥n tiene m√°ximo ~10 ejercicios.
- `SessionRepositoryImpl.kt`: 664 l√≠neas. Implementa `SessionRepository`. Los 3 nuevos m√©todos se agregan al final.
- `ExerciseProgressionDao.kt`: Tiene `getByExerciseId()` que retorna `Flow<ExerciseProgressionEntity?>` ‚Äî se usa para obtener el estado de progresi√≥n actual del ejercicio (campo `status`) para F3.
- `strings.xml`: Tiene strings para `exercise_history_title` y `nav_history`. Faltan strings para F1 (estado vac√≠o, formato tonelaje), F2 (t√≠tulo, estado, etiquetas de series), F3 (subt√≠tulo, estados de progresi√≥n, estado vac√≠o, enlace a t√©cnica).
- `TonnageChartComposable.kt`: 240 l√≠neas con Canvas multil√≠nea para G2. No reutilizable para F3 (diferente estructura de datos y prop√≥sito). Se crea `TrendChartComposable` separado.

**An√°lisis de dependencias:**

- HU-16 depende de: HU-06 (registr√≥ series), HU-07 (sustituciones registradas en `session_exercise.original_exercise_id`), HU-08 (ejercicios bodyweight/isom√©tricos ‚Äî F3 muestra tendencia por reps totales para bodyweight y segundos para isom√©tricos), HU-09 (cerr√≥ sesiones con estado COMPLETED/INCOMPLETE y tonelaje), HU-10 (clasific√≥ progresi√≥n y almacen√≥ en `session_exercise.progression_classification`), HU-13 (cre√≥ `ProgressionIndicator` reutilizable y `getSessionSummaryInfo()` reutilizable para F2).
- HU-16 NO modifica datos ‚Äî es puramente de lectura. No hay riesgo de conflicto con otras HUs.
- HU-16 habilita: HU-17 (alertas navegan a F3 desde H2), HU-18 (backup incluir√° historial visible).

**Impacto en performance:**

- F1: Query con JOIN a `module_version` y subconsulta de tonelaje sobre `exercise_set`. √çndices existentes: `session.status`, `session.date`, `session_exercise.session_id`. Suficiente para < 500 sesiones.
- F2: Query de ejercicios con JOIN a `exercise` + iteraci√≥n para series. Los √≠ndices `session_exercise.session_id` y `exercise_set.session_exercise_id` cubren el caso.
- F3: Query cross-session filtrado por `exercise_id`. √çndice existente `session_exercise.exercise_id`. Para un ejercicio con 100 sesiones, el query es O(n) con n = registros del ejercicio ‚Äî rendimiento aceptable.

### Notas T√©cnicas

**Nota 1 ‚Äî Sustituciones en F2 (CA-16.10).**

`session_exercise` tiene `exercise_id` (el ejercicio realmente ejecutado) y `original_exercise_id` (el ejercicio originalmente prescrito, si hubo sustituci√≥n). En F2, se muestra el nombre del ejercicio ejecutado (`exercise_id`) y si `original_exercise_id IS NOT NULL`, se agrega la nota "Sustituy√≥ a: [nombre del ejercicio original]". Esto requiere un LEFT JOIN adicional en el query de F2 para obtener el nombre del ejercicio original.

**Nota 2 ‚Äî Formato de fecha para display.**

Las sesiones almacenan `date` como `String` en formato ISO (`yyyy-MM-dd`). Para F1 y F3, el ViewModel formatea a `"dd MMM yyyy"` (ej: "10 feb 2026") usando `LocalDate.parse()` + `DateTimeFormatter`. La locale es espa√±ol (ADR-17). Este patr√≥n ya se usa en `WeightHistoryScreen`.

**Nota 3 ‚Äî El estado de progresi√≥n en F3 se mapea desde `exercise_progression.status`.**

Los valores posibles son: `NO_HISTORY` (‚ö™ Sin Historial), `IN_PROGRESSION` (üü¢ En Progresi√≥n), `IN_PLATEAU` (üü° En Meseta), `IN_DELOAD` (üîµ En Descarga), `MASTERED` (no tiene √≠cono en wireframe ‚Äî se trata como `IN_PROGRESSION` visualmente). El ViewModel convierte el string de BD al enum/sealed class correspondiente para el UI.

**Nota 4 ‚Äî Paginaci√≥n no es necesaria para esta versi√≥n.**

El ejecutante es un √∫nico usuario que entrena 3-6 sesiones por semana. En 2 a√±os acumular√≠a ~300-600 sesiones como m√°ximo. Room + `LazyColumn` manejan esta escala sin paginaci√≥n. Si el historial creciera significativamente, se podr√≠a agregar `Paging 3` en una HU futura sin modificar la arquitectura de capas (solo cambiar el tipo de retorno del DAO de `List<>` a `PagingSource<>`).

**Nota 5 ‚Äî F3 necesita callback `onNavigateToExerciseDetail` para el link "Ver t√©cnica de ejecuci√≥n ‚Üí".**

El wireframe F3 incluye un Text Button `"Ver t√©cnica de ejecuci√≥n ‚Üí"` que navega a D2 (Detalle de Ejercicio). El composable `ExerciseHistoryScreen` actualmente solo recibe `onNavigateBack`. Se debe agregar `onNavigateToExerciseDetail: (Long) -> Unit` al composable y registrar la navegaci√≥n correspondiente en `TensionNavHost`. Esto genera un paso D2 ‚Üê F3 ya definido en el Mapa de Navegaci√≥n ¬ßF3.

**Nota 6 ‚Äî Ejercicios isom√©tricos en F3: `reps` representa segundos.**

Para ejercicios isom√©tricos (`is_isometric = 1`), la columna `exercise_set.reps` almacena segundos sostenidos, no repeticiones (Modelo de Datos ¬ß3.12). El ViewModel de F3 debe interpretar este campo seg√∫n el tipo de ejercicio: si `isIsometric` ‚Üí label "s" (segundos) y tendencia por segundos totales. Si `isBodyweight && !isIsometric` ‚Üí label "reps" y tendencia por repeticiones totales. Si est√°ndar ‚Üí label "Kg" y tendencia por peso promedio.

### Verificaci√≥n Cruzada de CAs

| CA | Mecanismo | Componente |
|----|-----------|------------|
| CA-16.01 | Query DAO que incluye fecha, peso, reps, RIR, clasificaci√≥n por sesi√≥n del ejercicio | `SessionExerciseDao.getExerciseHistoryEntries()` + `ExerciseHistoryScreen` |
| CA-16.02 | `ORDER BY s.date DESC, s.id DESC` en query de F3 | DAO query |
| CA-16.03 | Query JOIN sin filtro por `module_version_id` ‚Äî solo por `exercise_id` | DAO query |
| CA-16.04 | `TrendChartComposable` con puntos extra√≠dos del historial | `ExerciseHistoryScreen` + `TrendChartComposable` |
| CA-16.05 | `ExerciseHistoryUiState.Empty` con texto "No hay registros disponibles para este ejercicio." | `ExerciseHistoryScreen` empty state |
| CA-16.06 | Condicional en ViewModel: si `isBodyweight` ‚Üí eje Y = reps totales; si `isIsometric` ‚Üí eje Y = segundos totales; si est√°ndar ‚Üí eje Y = peso promedio (Kg) | `ExerciseHistoryViewModel` + `TrendChartComposable` |
| CA-16.07 | Query DAO con `status IN ('COMPLETED', 'INCOMPLETE')` + JOIN a `module_version` para m√≥dulo y versi√≥n | `SessionDao.getClosedSessionsWithSummary()` + `SessionHistoryScreen` |
| CA-16.08 | Query para ejercicios de sesi√≥n con series detalladas (peso, reps, RIR por serie) y clasificaci√≥n | `SessionDetailScreen` + DAO queries |
| CA-16.09 | `HAVING setCount > 0` en query de F2 filtra ejercicios sin series registradas | DAO query |
| CA-16.10 | `session_exercise.exercise_id` refleja el ejercicio real. LEFT JOIN a `exercise` con `original_exercise_id` para obtener nombre original ‚Üí nota "Sustituy√≥ a:" | `SessionDetailScreen` |
| CA-16.11 | Pantalla de solo lectura sin botones de edici√≥n/eliminaci√≥n | `SessionDetailScreen` ‚Äî no tiene acciones de escritura |
| CA-16.12 | `SessionHistoryUiState.Empty` con texto "No hay sesiones pasadas disponibles." | `SessionHistoryScreen` empty state |

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Wireframes ‚Äî [Wireframes.md](docs/architecture/Wireframes.md) (¬ßF1 Historial de Sesiones, ¬ßF2 Detalle de Sesi√≥n Pasada, ¬ßF3 Historial de Ejercicio)
- Mapa de Navegaci√≥n ‚Äî [Mapa de Navegaci√≥n.md](docs/architecture/Mapa%20de%20Navegaci√≥n.md) (¬ßFlujo F ‚Äî Historial, transiciones F1‚ÜîF2‚ÜîF3)
- Especificaci√≥n Visual ‚Äî [Especificaci√≥n Visual.md](docs/architecture/Especificaci√≥n%20Visual.md) (¬ßFlujo F ‚Äî F1, F2, F3 component specs)
- Modelo de Datos ‚Äî [Modelo de Datos.md](docs/architecture/Modelo%20de%20Datos.md) (¬ß3.10 session, ¬ß3.11 session_exercise, ¬ß3.12 exercise_set, ¬ß3.13 exercise_progression)
- Arquitectura T√©cnica ‚Äî [Arquitectura T√©cnica.md](docs/architecture/Arquitectura%20T√©cnica.md) (¬ß3.2 √°rbol de paquetes ui.history, ¬ß4.3 inventario de rutas F1/F2/F3)
- ADR ‚Äî [ADR.md](docs/architecture/ADR.md) (ADR-05 MVVM con capa Domain expl√≠cita, ADR-07 Single Activity + Navigation Compose, ADR-09 StateFlow para gesti√≥n de estado)

**Historias relacionadas:**

- Historia #6 (HU-06): Registr√≥ series de ejercicios ‚Äî los datos de `exercise_set` son la fuente primaria para F2 y F3
- Historia #7 (HU-07): Sustituciones puntuales ‚Äî `session_exercise.original_exercise_id` se usa para mostrar nota de sustituci√≥n en F2 (CA-16.10)
- Historia #9 (HU-09): Cerr√≥ sesiones con estado COMPLETED/INCOMPLETE y tonelaje ‚Äî la consulta de F1 se basa en sesiones cerradas con estos estados
- Historia #10 (HU-10): Clasific√≥ progresi√≥n post-sesi√≥n ‚Äî `session_exercise.progression_classification` se muestra en F2 y F3 como dato ya almacenado
- Historia #8 (HU-08): Ejercicios bodyweight e isom√©tricos ‚Äî F3 muestra tendencia por repeticiones totales para bodyweight (CA-16.06) y por segundos sostenidos para isom√©tricos
- Historia #13 (HU-13): Resumen post-sesi√≥n (E5) ‚Äî navega a F3 desde el resumen, cre√≥ `ProgressionIndicator` reutilizable para F2/F3, cre√≥ `getSessionSummaryInfo()` reutilizable para F2
- Historia #15 (HU-15): Panel de m√©tricas (G1) ‚Äî navega a F3 desde KPIs, usa mismos datos de tendencia
- Historia #15.5 (HU-15.5): Migraci√≥n Pull/Push/Legs ‚Äî los datos hist√≥ricos son v√°lidos post-migraci√≥n porque F3 consulta por `exercise_id` (no por `module_code`)

**Validado por:** esteban.colorado | **Fecha:** 2026-02-19 | **Enfoque:** Exploratorio
---

## Refinamiento T√©cnico (Developer)

<!-- ============================================================================ -->
<!-- SECCI√ìN AGREGADA POR: Workflow refinamiento-tecnico                         -->
<!-- ETAPA: Refinamiento T√©cnico                                                  -->
<!-- RESPONSABLE: Developer                                                       -->
<!-- BASE: An√°lisis Arquitect√≥nico (Arquitecto) - Ver secci√≥n arriba             -->
<!-- FECHA: 2026-02-19                                                            -->
<!-- ESTADO: Refinado (Developer) - Basado en An√°lisis Arquitect√≥nico            -->
<!-- ============================================================================ -->

### Consideraciones Generales

**Basado en an√°lisis arquitect√≥nico:**
S√≠ ‚Äî An√°lisis Arquitect√≥nico del Arquitecto con 9 decisiones fundamentadas, 17 componentes nuevos, 10 componentes modificados, 4 componentes reutilizados y 10 hitos de implementaci√≥n. Patr√≥n: MVVM Read-Only con Room DAO Queries (3 pantallas, 3 ViewModels, 3 Use Cases delegados al `SessionRepository`).

**Nivel de complejidad:**
MEDIA ‚Äî HU-16 crea 17 componentes nuevos distribuidos en 4 capas (domain models, use cases, ViewModels, UI) y modifica 10 componentes existentes, pero no introduce l√≥gica de negocio nueva: es 100% lectura de datos ya persistidos por HU-06/09/10. La complejidad real reside en: (1) los queries SQL con JOINs m√∫ltiples y subconsultas para F1 y F3, (2) el gr√°fico Canvas `TrendChartComposable` con l√≥gica de escalado y renderizado, (3) la orquestaci√≥n de navegaci√≥n F1‚ÜíF2‚ÜíF3 con Bottom Navigation condicional, y (4) la correcta interpretaci√≥n del tipo de ejercicio (est√°ndar/bodyweight/isom√©trico) para la tendencia de F3.

**Riesgos t√©cnicos conocidos:**

1. **Performance de queries F3 con historial extenso:** El query de `getExerciseHistoryEntries()` hace un cross-session JOIN por `exercise_id` incluyendo subconsultas de peso promedio, reps totals y RIR promedio por sesi√≥n. Para un ejercicio con 100+ sesiones, el query puede ser lento sin √≠ndices adecuados. Mitigaci√≥n: los √≠ndices `session_exercise.exercise_id` y `session.status` ya existen. El query limita a sesiones cerradas (`COMPLETED`/`INCOMPLETE`). Para la escala del usuario (1 ejecutante, ~300-600 sesiones en 2 a√±os, ~8 ejercicios por sesi√≥n), el rendimiento es aceptable sin paginaci√≥n.
2. **`BottomNavigationBar` ‚Äî `exercise-history` en dos tabs:** Actualmente `exercise-history` es `childRoutePrefix` del tab Diccionario (correcto para D2‚ÜíF3), pero tambi√©n se necesita que el tab Historial quede activo cuando se navega F2‚ÜíF3. Resolver con un source parameter no es viable sin cambiar la definici√≥n de ruta. Mitigaci√≥n: mover `exercise-history` al tab Historial (su tab leg√≠timo seg√∫n Arquitectura T√©cnica ¬ß4.4 `history-graph`). Cuando se navega D2‚ÜíF3, el tab activo ser√° Historial ‚Äî esto es aceptable porque F3 ES una pantalla de historial funcionalmente.
3. **`showBottomBar` ‚Äî omisi√≥n del caso E5‚ÜíF3:** El `TensionNavHost` actual oculta el Bottom Bar para rutas de sesi√≥n (`active-session`, `register-set`, `substitute-exercise`, `session-summary`) y para `exercise-detail` con origen `active-session`. Falta el caso `exercise-history` con origen `session-summary`. Mitigaci√≥n: agregar condici√≥n an√°loga en Fase 9.

**Patrones y convenciones del equipo (establecidos en HU-01‚ÄîHU-15.5):**

- ViewModels: `@HiltViewModel` con `SavedStateHandle` para argumentos de navegaci√≥n, `MutableStateFlow<UiState>` + `asStateFlow()`, carga en `init {}` via `viewModelScope.launch`
- UiState: `sealed interface` con variantes `Loading`, `Empty`, `Loaded` (o `Success`/`Error` para operaciones con fallback)
- Use Cases: `class XxxUseCase @Inject constructor(private val repo: XxxRepository)` con `operator fun invoke()` delegando directamente al Repository
- Use Cases en paquete: `domain.usecase.{feature}/` (ej: `session/`, `catalog/`, `metrics/`, `profile/`, `deload/`)
- Domain Models: `data class` en `domain.model/` ‚Äî mapeo Entity‚ÜíModel en el Repository
- DAO DTOs: `data class` definida en el mismo archivo del DAO (ej: `SessionSummaryInfo`, `ExerciseSummaryDto`) ‚Äî usados como retorno de `@Query`
- Screens: `@Composable fun XxxScreen(...)` con patr√≥n `val uiState by viewModel.uiState.collectAsStateWithLifecycle()`
- Componentes Compose reutilizables: en `ui.components/` (ej: `ProgressionIndicator`, `TensionTopAppBar`, `BottomNavigationBar`)
- Navegaci√≥n: `NavigationRoutes` con `const val` + funciones factory `xxxRoute(id)`, composables en `TensionNavHost` con `navArgument`
- Strings: en `strings.xml`, agrupados por pantalla con comentarios `<!-- Secci√≥n -->`, formato `snake_case`
- Formato fecha: `LocalDate.parse()` + `DateTimeFormatter.ofPattern("dd MMM yyyy", Locale("es"))` ‚Äî patr√≥n ya usado en `WeightHistoryScreen`

**Dependencias nuevas a instalar:**
Ninguna.

**Estrategia de testing:**
JUnit 4 + MockK + Kotlin Coroutines Test | Tests unitarios para 3 Use Cases (delegaci√≥n) + 3 ViewModels (transformaci√≥n de datos y manejo de estados) | Cobertura: 12 CAs cubiertos por los 6 tests | Builders: no se requieren ‚Äî los tests usan domain models directos (data classes inmutables) con constructores expl√≠citos, como en `GetSessionExercisesUseCaseTest`

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**

- HU-13 ([HU-13.md](HU-13.md)): Cre√≥ `SessionSummaryScreen`, `SessionSummaryViewModel`, `SessionSummaryUiState`, `ProgressionIndicator`, `getSessionSummaryInfo()` y `getExercisesForSummary()`. Este es el patr√≥n m√°s cercano a F2 (misma estructura: resumen + lista de ejercicios con clasificaci√≥n). Se reutiliza `ProgressionIndicator` y `getSessionSummaryInfo()` directamente.
- HU-15 ([HU-15.md](HU-15.md)): Cre√≥ `TonnageChartComposable` con Canvas multil√≠nea. Se analiza para replicar la t√©cnica de Canvas Compose en `TrendChartComposable` (l√≠nea √∫nica con puntos).
- HU-06 ([HU-06.md](HU-06.md)): Registr√≥ series de ejercicios ‚Äî `exercise_set` es la fuente primaria para F2 y F3. Se reutiliza `ExerciseSetDao.getSetsForSessionExercise()`.
- HU-07 ([HU-07.md](HU-07.md)): Registr√≥ sustituciones ‚Äî `session_exercise.original_exercise_id` se usa para mostrar nota "Sustituy√≥ a:" en F2 (CA-16.10).
- HU-09 ([HU-09.md](HU-09.md)): Cerr√≥ sesiones con estado COMPLETED/INCOMPLETE y tonelaje. F1 filtra por estos estados.
- HU-10 ([HU-10.md](HU-10.md)): Clasific√≥ progresi√≥n post-sesi√≥n ‚Äî `session_exercise.progression_classification` se muestra en F2 y F3 como dato ya almacenado.
- HU-08 ([HU-08.md](HU-08.md)): Ejercicios bodyweight e isom√©tricos ‚Äî F3 discrimina tendencia por tipo de ejercicio.
- HU-15.5 ([HU-15.5.md](HU-15.5.md)): Migraci√≥n Pull/Push/Legs ‚Äî datos hist√≥ricos v√°lidos post-migraci√≥n porque F3 consulta por `exercise_id` (no por `module_code`).

**Patrones de c√≥digo reutilizados:**

- ViewModel con `SavedStateHandle` + `sealed interface UiState` (de `SessionSummaryViewModel.kt`)
- `ProgressionIndicator` composable para clasificaci√≥n ‚Üë/=/‚Üì con color sem√°ntico (de `ui.components`)
- `TensionTopAppBar` con bot√≥n ‚Üê (de `ui.components`)
- `CenterAlignedTopAppBar` con subt√≠tulo en Column (de `SessionSummaryScreen.kt`)
- Canvas con `drawLine`, `drawCircle`, `drawText` (de `TonnageChartComposable.kt`)
- ListItem M3 con overline/headline/supporting content (de `ExerciseDictionaryScreen.kt`, `TrendScreen.kt`)
- Formato fecha con `DateTimeFormatter.ofPattern("dd MMM yyyy", Locale("es"))` (de `WeightHistoryScreen.kt`)

**Mejores pr√°cticas aplicadas:**

- Queries DAO con `HAVING setCount > 0` para filtrar ejercicios sin series (patr√≥n de `getExercisesForSummary`)
- Reutilizaci√≥n de queries existentes (`getSessionSummaryInfo`, `getSetsForSessionExercise`, `getByExerciseId`) en lugar de duplicar l√≥gica SQL
- Domain models separados de DAO DTOs ‚Äî el Repository mapea entre capas
- Composable de gr√°fico creado como componente aislado y reutilizable en `ui.components` (podr√≠a usarse por HU-17 alertas)
- Solo lectura: ninguna pantalla ofrece acciones de escritura ‚Üí no se necesitan reglas de dominio ni confirmaciones

---

## Tareas de Implementaci√≥n (Developer)

### Fase 1: Domain Models

<!-- Basado en Hito #1 del An√°lisis Arquitect√≥nico -->
<!-- AC: Infraestructura ‚Äî Modelos compartidos por F1, F2, F3 -->

#### üì¶ Domain Layer ‚Äî Modelos

- [ ] **Crear `SessionHistoryItem`** (usado por F1)
  - [ ] Crear archivo: `domain/model/SessionHistoryItem.kt`
  - [ ] Campos: `sessionId: Long`, `date: String`, `moduleCode: String`, `versionNumber: Int`, `status: String`, `totalTonnageKg: Double`

- [ ] **Crear `SessionDetailExercise`** (usado por F2)
  - [ ] Crear archivo: `domain/model/SessionDetailExercise.kt`
  - [ ] Campos: `exerciseId: Long`, `exerciseName: String`, `classification: ProgressionClassification?`, `originalExerciseName: String?` (null si no hubo sustituci√≥n), `sets: List<SetData>`
  - [ ] Reutiliza `SetData` existente de `domain.model.ExerciseSessionData.kt` (ya creado por HU-10). No se crea clase anidada ‚Äî se importa directamente

- [ ] **Crear `SessionDetail`** (usado por F2)
  - [ ] Crear archivo: `domain/model/SessionDetail.kt`
  - [ ] Campos: `sessionId: Long`, `date: String`, `moduleCode: String`, `versionNumber: Int`, `status: String`, `totalTonnageKg: Double`, `totalExercises: Int`, `completedExercises: Int`, `exercises: List<SessionDetailExercise>`

- [ ] **Crear `ExerciseHistoryEntry`** (usado por F3)
  - [ ] Crear archivo: `domain/model/ExerciseHistoryEntry.kt`
  - [ ] Campos: `date: String`, `moduleCode: String`, `versionNumber: Int`, `avgWeightKg: Double`, `totalReps: Int`, `avgRir: Double`, `classification: ProgressionClassification?`

- [ ] **Crear `ExerciseHistoryData`** (usado por F3)
  - [ ] Crear archivo: `domain/model/ExerciseHistoryData.kt`
  - [ ] Campos: `exerciseName: String`, `progressionStatus: String`, `isBodyweight: Boolean`, `isIsometric: Boolean`, `entries: List<ExerciseHistoryEntry>`

### Fase 2: DAO Queries

<!-- Basado en Hito #2 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.01, CA-16.02, CA-16.03, CA-16.07, CA-16.08, CA-16.09, CA-16.10 -->

#### üì¶ Data Layer ‚Äî DAO

- [ ] **Agregar DAO DTO `ClosedSessionDto`** en `SessionDao.kt` (AC: 7)
  - [ ] Modificar archivo: `data/local/dao/SessionDao.kt`
  - [ ] Data class: `sessionId: Long`, `date: String`, `moduleCode: String`, `versionNumber: Int`, `status: String`, `totalTonnageKg: Double`

- [ ] **Agregar query `getClosedSessionsWithSummary()`** en `SessionDao` (AC: 7, 12)
  - [ ] Modificar archivo: `data/local/dao/SessionDao.kt`
  - [ ] SQL: `SELECT s.id AS sessionId, s.date, mv.module_code AS moduleCode, mv.version_number AS versionNumber, s.status, COALESCE((SELECT SUM(es.weight_kg * es.reps) FROM exercise_set es INNER JOIN session_exercise se ON es.session_exercise_id = se.id WHERE se.session_id = s.id), 0.0) AS totalTonnageKg FROM session s INNER JOIN module_version mv ON s.module_version_id = mv.id WHERE s.status IN ('COMPLETED', 'INCOMPLETE') ORDER BY s.date DESC, s.id DESC`
  - [ ] Retorno: `suspend fun getClosedSessionsWithSummary(): List<ClosedSessionDto>`

- [ ] **Agregar DAO DTO `SessionDetailExerciseDto`** en `SessionExerciseDao.kt` (AC: 8, 9, 10)
  - [ ] Modificar archivo: `data/local/dao/SessionExerciseDao.kt`
  - [ ] Data class: `sessionExerciseId: Long`, `exerciseId: Long`, `exerciseName: String`, `classification: String?`, `originalExerciseName: String?`, `setCount: Int`

- [ ] **Agregar query `getExercisesForSessionDetail()`** en `SessionExerciseDao` (AC: 8, 9, 10)
  - [ ] Modificar archivo: `data/local/dao/SessionExerciseDao.kt`
  - [ ] SQL: `SELECT se.id AS sessionExerciseId, se.exercise_id AS exerciseId, e.name AS exerciseName, se.progression_classification AS classification, oe.name AS originalExerciseName, (SELECT COUNT(*) FROM exercise_set es WHERE es.session_exercise_id = se.id) AS setCount FROM session_exercise se INNER JOIN exercise e ON se.exercise_id = e.id LEFT JOIN exercise oe ON se.original_exercise_id = oe.id WHERE se.session_id = :sessionId GROUP BY se.id HAVING setCount > 0 ORDER BY e.name ASC`
  - [ ] Retorno: `suspend fun getExercisesForSessionDetail(sessionId: Long): List<SessionDetailExerciseDto>`
  - [ ] Nota: `HAVING setCount > 0` filtra ejercicios sin series (CA-16.09, patr√≥n de `getExercisesForSummary`)

- [ ] **Agregar DAO DTO `ExerciseHistoryEntryDto`** en `SessionExerciseDao.kt` (AC: 1, 2, 3, 6)
  - [ ] Modificar archivo: `data/local/dao/SessionExerciseDao.kt`
  - [ ] Data class: `date: String`, `moduleCode: String`, `versionNumber: Int`, `avgWeightKg: Double`, `totalReps: Int`, `avgRir: Double`, `classification: String?`

- [ ] **Agregar query `getExerciseHistoryEntries()`** en `SessionExerciseDao` (AC: 1, 2, 3, 6)
  - [ ] Modificar archivo: `data/local/dao/SessionExerciseDao.kt`
  - [ ] SQL: `SELECT s.date, mv.module_code AS moduleCode, mv.version_number AS versionNumber, COALESCE(AVG(es.weight_kg), 0.0) AS avgWeightKg, COALESCE(SUM(es.reps), 0) AS totalReps, COALESCE(AVG(es.rir), 0.0) AS avgRir, se.progression_classification AS classification FROM session_exercise se INNER JOIN session s ON se.session_id = s.id INNER JOIN module_version mv ON s.module_version_id = mv.id INNER JOIN exercise_set es ON es.session_exercise_id = se.id WHERE se.exercise_id = :exerciseId AND s.status IN ('COMPLETED', 'INCOMPLETE') GROUP BY se.id ORDER BY s.date DESC, s.id DESC`
  - [ ] Retorno: `suspend fun getExerciseHistoryEntries(exerciseId: Long): List<ExerciseHistoryEntryDto>`
  - [ ] Nota: no filtra por `module_version_id` ‚Äî include todos los registros independientemente del m√≥dulo-versi√≥n (CA-16.03)

### Fase 3: Repository

<!-- Basado en Hito #3 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.01 a CA-16.12 (repository orquesta datos para las 3 pantallas) -->

#### üì¶ Domain Layer ‚Äî Interface

- [ ] **Agregar 3 m√©todos a `SessionRepository`** (AC: todos)
  - [ ] Modificar archivo: `domain/repository/SessionRepository.kt`
  - [ ] Agregar: `suspend fun getSessionHistory(): List<SessionHistoryItem>`
  - [ ] Agregar: `suspend fun getSessionDetail(sessionId: Long): SessionDetail`
  - [ ] Agregar: `suspend fun getExerciseHistory(exerciseId: Long): ExerciseHistoryData`

#### üì¶ Data Layer ‚Äî Implementation

- [ ] **Implementar `getSessionHistory()` en `SessionRepositoryImpl`** (AC: 7, 12)
  - [ ] Modificar archivo: `data/repository/SessionRepositoryImpl.kt`
  - [ ] Invoca `sessionDao.getClosedSessionsWithSummary()` y mapea `ClosedSessionDto` ‚Üí `SessionHistoryItem`

- [ ] **Implementar `getSessionDetail()` en `SessionRepositoryImpl`** (AC: 8, 9, 10, 11)
  - [ ] Modificar archivo: `data/repository/SessionRepositoryImpl.kt`
  - [ ] Invoca `sessionDao.getSessionSummaryInfo(sessionId)` para resumen (reutiliza query existente de HU-13)
  - [ ] Invoca `sessionDao.getById(sessionId).first()` para obtener fecha ‚Äî nota: `getById()` retorna `Flow<SessionEntity?>`, se usa `.first()` para obtener valor √∫nico en contexto `suspend`
  - [ ] Invoca `sessionExerciseDao.getExercisesForSessionDetail(sessionId)` para lista de ejercicios
  - [ ] Para cada ejercicio, invoca `exerciseSetDao.getSetsForSessionExercise(sessionExerciseId)` para obtener series (reutiliza query existente)
  - [ ] Mapea DTOs a `SessionDetail` con lista de `SessionDetailExercise`
  - [ ] Nota: la iteraci√≥n por ejercicio es aceptable (~10 ejercicios por sesi√≥n m√°ximo)

- [ ] **Implementar `getExerciseHistory()` en `SessionRepositoryImpl`** (AC: 1, 2, 3, 5, 6)
  - [ ] Modificar archivo: `data/repository/SessionRepositoryImpl.kt`
  - [ ] Invoca `sessionExerciseDao.getExerciseHistoryEntries(exerciseId)` para lista de sesiones
  - [ ] Invoca `exerciseProgressionDao.getByExerciseId(exerciseId).first()` para estado de progresi√≥n actual (suspend + `.first()`)
  - [ ] Obtener nombre del ejercicio e indicadores `isBodyweight`/`isIsometric` v√≠a `exerciseDao.getByIdOnce(exerciseId)` (verificado: existe, retorna `ExerciseEntity?` con `name`, `isBodyweight`, `isIsometric`)

- [ ] **Obtener datos del ejercicio via `ExerciseDao.getByIdOnce()`** (verificado: existe)
  - [ ] Usar `exerciseDao.getByIdOnce(exerciseId)` que retorna `suspend fun`: `ExerciseEntity?` con campos `name`, `isBodyweight`, `isIsometric`
  - [ ] No se necesita agregar query nuevo ‚Äî `getByIdOnce()` ya existe en `ExerciseDao.kt` (verificado en auditor√≠a)

### Fase 4: Use Cases

<!-- Basado en Hito #4 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.01 a CA-16.12 (use cases delegan al repository) -->

#### üì¶ Domain Layer ‚Äî Use Cases

- [ ] **Crear `GetSessionHistoryUseCase`** (AC: 7, 12)
  - [ ] Crear archivo: `domain/usecase/history/GetSessionHistoryUseCase.kt`
  - [ ] `class GetSessionHistoryUseCase @Inject constructor(private val sessionRepository: SessionRepository)`
  - [ ] `suspend operator fun invoke(): List<SessionHistoryItem> = sessionRepository.getSessionHistory()`

- [ ] **Crear `GetSessionDetailUseCase`** (AC: 8, 9, 10, 11)
  - [ ] Crear archivo: `domain/usecase/history/GetSessionDetailUseCase.kt`
  - [ ] `class GetSessionDetailUseCase @Inject constructor(private val sessionRepository: SessionRepository)`
  - [ ] `suspend operator fun invoke(sessionId: Long): SessionDetail = sessionRepository.getSessionDetail(sessionId)`

- [ ] **Crear `GetExerciseHistoryUseCase`** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Crear archivo: `domain/usecase/history/GetExerciseHistoryUseCase.kt`
  - [ ] `class GetExerciseHistoryUseCase @Inject constructor(private val sessionRepository: SessionRepository)`
  - [ ] `suspend operator fun invoke(exerciseId: Long): ExerciseHistoryData = sessionRepository.getExerciseHistory(exerciseId)`

### Fase 5: F1 ‚Äî Historial de Sesiones (Screen + ViewModel)

<!-- Basado en Hito #5 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.07, CA-16.09, CA-16.12 -->

#### üì¶ UI Layer ‚Äî ViewModel

- [ ] **Crear `SessionHistoryUiState`** (AC: 7, 12)
  - [ ] Crear archivo: `ui/history/SessionHistoryUiState.kt`
  - [ ] `sealed interface SessionHistoryUiState` con variantes: `data object Loading`, `data object Empty`, `data class Loaded(val sessions: List<SessionHistoryItem>)`

- [ ] **Crear `SessionHistoryViewModel`** (AC: 7, 12)
  - [ ] Crear archivo: `ui/history/SessionHistoryViewModel.kt`
  - [ ] `@HiltViewModel class SessionHistoryViewModel @Inject constructor(private val getSessionHistoryUseCase: GetSessionHistoryUseCase)`
  - [ ] `init {}`: launch ‚Üí invoke use case ‚Üí si lista vac√≠a ‚Üí `Empty`, si no ‚Üí `Loaded(sessions)`
  - [ ] StateFlow: `MutableStateFlow<SessionHistoryUiState>(Loading)` + `asStateFlow()`

#### üì¶ UI Layer ‚Äî Pantalla

- [ ] **Crear `SessionHistoryScreen`** (AC: 7, 9, 12)
  - [ ] Crear archivo: `ui/history/SessionHistoryScreen.kt`
  - [ ] Par√°metros: `onNavigateToSessionDetail: (Long) -> Unit`, `viewModel: SessionHistoryViewModel = hiltViewModel()`
  - [ ] Scaffold con `CenterAlignedTopAppBar` t√≠tulo "Historial" (sin `navigationIcon`)
  - [ ] Body: `when (uiState)` ‚Üí Loading: `CircularProgressIndicator` centrado, Empty: texto "No hay sesiones pasadas disponibles." centrado, Loaded: `LazyColumn`
  - [ ] Cada fila: `ListItem` M3 (80dp) con overline (fecha `dd MMM yyyy`), headline (Row: "M√≥dulo X ‚Äî VN" + Spacer + Badge estado), supporting (tonelaje formateado), clickable ‚Üí `onNavigateToSessionDetail(sessionId)`
  - [ ] Badge estado: √≠cono ‚úÖ verde `#2E7D32` + "Completada" o ‚ö†Ô∏è naranja `#E65100` + "Incompleta" (Body Small)
  - [ ] `HorizontalDivider` entre filas
  - [ ] Formato fecha: `LocalDate.parse(date).format(DateTimeFormatter.ofPattern("dd MMM yyyy", Locale("es")))`

### Fase 6: F2 ‚Äî Detalle de Sesi√≥n Pasada (Screen + ViewModel)

<!-- Basado en Hito #6 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.08, CA-16.09, CA-16.10, CA-16.11 -->

#### üì¶ UI Layer ‚Äî ViewModel

- [ ] **Crear `SessionDetailUiState`** (AC: 8)
  - [ ] Crear archivo: `ui/history/SessionDetailUiState.kt`
  - [ ] `sealed interface SessionDetailUiState` con variantes: `data object Loading`, `data class Loaded(val detail: SessionDetail)`

- [ ] **Crear `SessionDetailViewModel`** (AC: 8)
  - [ ] Crear archivo: `ui/history/SessionDetailViewModel.kt`
  - [ ] `@HiltViewModel class SessionDetailViewModel @Inject constructor(private val getSessionDetailUseCase: GetSessionDetailUseCase, savedStateHandle: SavedStateHandle)`
  - [ ] `val sessionId: Long = savedStateHandle.get<Long>("sessionId") ?: throw IllegalArgumentException("sessionId is required")`
  - [ ] `init {}`: launch ‚Üí invoke use case ‚Üí `Loaded(detail)`

#### üì¶ UI Layer ‚Äî Pantalla

- [ ] **Crear `SessionDetailScreen`** (AC: 8, 9, 10, 11)
  - [ ] Crear archivo: `ui/history/SessionDetailScreen.kt`
  - [ ] Par√°metros: `onNavigateBack: () -> Unit`, `onNavigateToExerciseHistory: (Long) -> Unit`, `viewModel: SessionDetailViewModel = hiltViewModel()`
  - [ ] Scaffold con `CenterAlignedTopAppBar`: t√≠tulo "M√≥dulo X ‚Äî VN" (din√°mico), subt√≠tulo "dd MMM yyyy ¬∑ Completada/Incompleta", navigationIcon ArrowBack ‚Üí `onNavigateBack`
  - [ ] Body (LazyColumn): Card resumen (tonelaje, ejercicios completados/total, estado con badge ‚úÖ/‚ö†Ô∏è), Divider, lista de ejercicios
  - [ ] Cada ejercicio: nombre (Title Medium), `ProgressionIndicator` + texto clasificaci√≥n, nota sustituci√≥n italic "Sustituy√≥ a: [original]" si `originalExerciseName != null` (CA-16.10), 4 filas de series ("Serie N: X Kg √ó Y ¬∑ RIR Z"), clickable ‚Üí `onNavigateToExerciseHistory(exerciseId)` (‚Üí F3)
  - [ ] Solo lectura ‚Äî sin botones de edici√≥n/eliminaci√≥n (CA-16.11)
  - [ ] Sesiones incompletas: solo ejercicios con series registradas aparecen ‚Äî filtrado por `HAVING setCount > 0` en query (CA-16.09)

### Fase 7: TrendChartComposable

<!-- Basado en Hito #7 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.04, CA-16.06 -->

#### üì¶ UI Layer ‚Äî Componente reutilizable

- [ ] **Crear `TrendChartComposable`** (AC: 4, 6)
  - [ ] Crear archivo: `ui/components/TrendChartComposable.kt`
  - [ ] Par√°metros: `data: List<TrendPoint>` (data class: `label: String`, `value: Float`), `yAxisLabel: String` ("Kg", "reps" o "s"), `modifier: Modifier`
  - [ ] Dimensiones: height 200dp, Canvas con padding para labels
  - [ ] Rendering:
    - Grid horizontal: l√≠neas dashed (Outline Variant, 1dp, `PathEffect.dashPathEffect`)
    - L√≠nea conectora: color Primary (`#8B1A1A`), strokeWidth 2dp
    - Puntos: c√≠rculo relleno Primary, radio 6dp
    - Labels eje Y: Label Small, On Surface Variant (valores min/max con interpolaci√≥n)
    - Labels eje X: Label Small, On Surface Variant ("S1", "S2", ... sesiones)
    - `TextMeasurer` para renderizado de texto en Canvas (patr√≥n de `TonnageChartComposable`)
  - [ ] Edge cases: si `data.size < 2` ‚Üí no dibujar l√≠nea, solo puntos; si `data.isEmpty()` ‚Üí no renderizar
  - [ ] Card contenedora: `Filled Card`, fondo Surface Container, corner 12dp, padding 16dp

### Fase 8: F3 ‚Äî Historial de Ejercicio (Screen + ViewModel)

<!-- Basado en Hito #8 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.01, CA-16.02, CA-16.03, CA-16.04, CA-16.05, CA-16.06 -->

#### üì¶ UI Layer ‚Äî ViewModel

- [ ] **Crear `ExerciseHistoryUiState`** (AC: 1, 5)
  - [ ] Crear archivo: `ui/history/ExerciseHistoryUiState.kt`
  - [ ] `sealed interface ExerciseHistoryUiState` con variantes: `data object Loading`, `data object Empty`, `data class Loaded(val data: ExerciseHistoryData, val trendPoints: List<TrendPoint>, val yAxisLabel: String)`

- [ ] **Crear `ExerciseHistoryViewModel`** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Crear archivo: `ui/history/ExerciseHistoryViewModel.kt`
  - [ ] `@HiltViewModel class ExerciseHistoryViewModel @Inject constructor(private val getExerciseHistoryUseCase: GetExerciseHistoryUseCase, savedStateHandle: SavedStateHandle)`
  - [ ] `val exerciseId: Long = savedStateHandle.get<Long>("exerciseId") ?: throw IllegalArgumentException("exerciseId is required")`
  - [ ] `init {}`: launch ‚Üí invoke use case ‚Üí si entries vac√≠o ‚Üí `Empty`, si no ‚Üí transformar a `Loaded`
  - [ ] **Transformaci√≥n de tendencia** (CA-16.04, CA-16.06):
    - Si `isIsometric` ‚Üí `trendPoints` = entries reversed (m√°s antiguo primero) mapeados a `TrendPoint(label = "S${i+1}", value = entry.totalReps.toFloat())`, `yAxisLabel = "s"` (segundos)
    - Si `isBodyweight && !isIsometric` ‚Üí `trendPoints` = entries reversed mapeados a `TrendPoint(label = "S${i+1}", value = entry.totalReps.toFloat())`, `yAxisLabel = "reps"`
    - Si est√°ndar ‚Üí `trendPoints` = entries reversed mapeados a `TrendPoint(label = "S${i+1}", value = entry.avgWeightKg.toFloat())`, `yAxisLabel = "Kg"`
    - Nota: entries est√°n en orden DESC (reciente‚Üíantiguo), para el gr√°fico se revierten (antiguo‚Üíreciente)
  - [ ] **Mapeo de `progressionStatus`** a badge (Nota 3 del arquitecto):
    - `NO_HISTORY` ‚Üí "Sin Historial" ‚ö™
    - `IN_PROGRESSION` ‚Üí "En Progresi√≥n" üü¢
    - `IN_PLATEAU` ‚Üí "En Meseta" üü°
    - `IN_DELOAD` ‚Üí "En Descarga" üîµ
    - `MASTERED` ‚Üí "En Progresi√≥n" üü¢ (visualmente igual, Nota 3)

#### üì¶ UI Layer ‚Äî Pantalla

- [ ] **Refactorizar `ExerciseHistoryScreen`** de placeholder a implementaci√≥n completa (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Modificar archivo: `ui/history/ExerciseHistoryScreen.kt`
  - [ ] Nuevos par√°metros: `onNavigateToExerciseDetail: (Long) -> Unit`, `viewModel: ExerciseHistoryViewModel = hiltViewModel()` (adem√°s de `onNavigateBack`)
  - [ ] Scaffold con `CenterAlignedTopAppBar`: t√≠tulo = nombre del ejercicio (din√°mico), subt√≠tulo "Historial completo", navigationIcon ArrowBack ‚Üí `onNavigateBack`
  - [ ] Body `when (uiState)`:
    - `Loading`: `CircularProgressIndicator` centrado
    - `Empty`: texto "No hay registros disponibles para este ejercicio." centrado (CA-16.05)
    - `Loaded`: `LazyColumn` con:
      1. **Badge estado progresi√≥n** ‚Äî `AssistChip` M3 read-only con colores por estado (En Progresi√≥n verde `#E8F5E9`/`#1A2E1A`, En Meseta √°mbar `#FFF8E1`/`#4A3800`, En Descarga azul `#E3F2FD`/`#1A2733`, Sin Historial gris Surface Variant)
      2. **Gr√°fico tendencia** ‚Äî `TrendChartComposable(data = trendPoints, yAxisLabel = yAxisLabel)` (CA-16.04)
      3. **Divider**
      4. **Lista de sesiones** ‚Äî cada fila: `ListItem` M3 (72dp), overline "dd MMM yyyy ¬∑ X-VN", headline "60 Kg ¬∑ 45 reps ¬∑ RIR 2.3", supporting con `ProgressionIndicator` + texto clasificaci√≥n
      5. **Divider**
      6. **Text Button** "Ver t√©cnica de ejecuci√≥n ‚Üí" ‚Üí `onNavigateToExerciseDetail(exerciseId)` (Nota 5 del arquitecto)

### Fase 9: Navegaci√≥n y Strings

<!-- Basado en Hito #9 del An√°lisis Arquitect√≥nico -->
<!-- AC: CA-16.07, CA-16.11 (navegaci√≥n correcta entre F1, F2, F3) -->

#### üì¶ Navigation Layer

- [ ] **Agregar `SESSION_DETAIL` en `NavigationRoutes`** (Decisi√≥n 6 del arquitecto)
  - [ ] Modificar archivo: `ui/navigation/NavigationRoutes.kt`
  - [ ] Agregar: `const val SESSION_DETAIL = "session-detail/{sessionId}"`
  - [ ] Agregar: `fun sessionDetailRoute(sessionId: Long) = "session-detail/$sessionId"`

- [ ] **Actualizar `TensionNavHost`** (Decisiones 5, 6 del arquitecto)
  - [ ] Modificar archivo: `ui/navigation/TensionNavHost.kt`
  - [ ] Agregar import de `SessionHistoryScreen`, `SessionDetailScreen`, `SessionDetailViewModel`
  - [ ] Reemplazar placeholder de `SESSION_HISTORY`:
    - Antes: `PlaceholderScreen(stringResource(R.string.nav_history))`
    - Despu√©s: `SessionHistoryScreen(onNavigateToSessionDetail = { sessionId -> navController.navigate(NavigationRoutes.sessionDetailRoute(sessionId)) })`
  - [ ] Agregar composable `SESSION_DETAIL`:
    - `composable(route = NavigationRoutes.SESSION_DETAIL, arguments = listOf(navArgument("sessionId") { type = NavType.LongType })) { SessionDetailScreen(onNavigateBack = { navController.popBackStack() }, onNavigateToExerciseHistory = { exerciseId -> navController.navigate(NavigationRoutes.exerciseHistoryRoute(exerciseId)) }) }`
  - [ ] Actualizar composable `EXERCISE_HISTORY`:
    - Antes: `ExerciseHistoryScreen(onNavigateBack = { navController.popBackStack() })`
    - Despu√©s: `ExerciseHistoryScreen(onNavigateBack = { navController.popBackStack() }, onNavigateToExerciseDetail = { exerciseId -> navController.navigate(NavigationRoutes.exerciseDetailRoute(exerciseId)) })`
  - [ ] Agregar condici√≥n `showBottomBar` para E5‚ÜíF3 (Decisi√≥n 5):
    - Agregar: `&& !(currentRoute?.startsWith("exercise-history") == true && navController.previousBackStackEntry?.destination?.route?.startsWith("session-summary") == true)`

- [ ] **Actualizar `BottomNavigationBar`** (Decisi√≥n 9 del arquitecto)
  - [ ] Modificar archivo: `ui/components/BottomNavigationBar.kt`
  - [ ] Mover `"exercise-history"` del `childRoutePrefixes` del tab Diccionario al tab Historial
  - [ ] Agregar `"session-detail"` como `childRoutePrefix` del tab Historial
  - [ ] Result: tab Historial ‚Üí `childRoutePrefixes = setOf("exercise-history", "session-detail")`
  - [ ] Tab Diccionario ‚Üí `childRoutePrefixes = setOf("exercise-detail", "plan-version-detail")`

#### üì¶ Resources

- [ ] **Agregar strings en `strings.xml`**
  - [ ] Modificar archivo: `res/values/strings.xml`
  - [ ] Agregar secci√≥n `<!-- Session History F1 -->`:
    - `session_history_title` = "Historial"
    - `session_history_empty` = "No hay sesiones pasadas disponibles."
    - `session_history_tonnage_format` = "Tonelaje: %1$s Kg"
    - `session_history_completed` = "Completada"
    - `session_history_incomplete` = "Incompleta"
  - [ ] Agregar secci√≥n `<!-- Session Detail F2 -->`:
    - `session_detail_tonnage` = "Tonelaje: %1$s Kg"
    - `session_detail_exercises` = "Ejercicios: %1$d/%2$d"
    - `session_detail_set_format` = "Serie %1$d: %2$s Kg √ó %3$d ¬∑ RIR %4$d"
    - `session_detail_substituted` = "Sustituy√≥ a: %1$s"
  - [ ] Agregar secci√≥n `<!-- Exercise History F3 -->`:
    - `exercise_history_subtitle` = "Historial completo"
    - `exercise_history_empty` = "No hay registros disponibles para este ejercicio."
    - `exercise_history_weight_format` = "%1$s Kg ¬∑ %2$d reps ¬∑ RIR %3$s"
    - `exercise_history_bodyweight_format` = "%1$d reps ¬∑ RIR %2$s"
    - `exercise_history_isometric_format` = "%1$d s ¬∑ RIR %2$s"
    - `exercise_history_session_format` = "%1$s ¬∑ %2$s-V%3$d"
    - `exercise_history_view_technique` = "Ver t√©cnica de ejecuci√≥n \u2192"
    - `exercise_history_status_in_progression` = "En Progresi√≥n"
    - `exercise_history_status_in_plateau` = "En Meseta"
    - `exercise_history_status_in_deload` = "En Descarga"
    - `exercise_history_status_no_history` = "Sin Historial"

### Fase 10: Tests Unitarios

<!-- Basado en Hito #10 del An√°lisis Arquitect√≥nico -->
<!-- AC: Todos los CAs cubiertos indirectamente por tests de Use Cases y ViewModels -->

#### üß™ Tests ‚Äî Use Cases

- [ ] **Test `GetSessionHistoryUseCaseTest`** (AC: 7, 12)
  - [ ] Crear archivo: `test/.../domain/usecase/history/GetSessionHistoryUseCaseTest.kt`
  - [ ] Caso 1: `invoke returns list of closed sessions` ‚Äî mock repository retorna lista con 2 `SessionHistoryItem`, assert tama√±o y datos
  - [ ] Caso 2: `invoke returns empty list when no sessions` ‚Äî mock repository retorna lista vac√≠a, assert isEmpty

- [ ] **Test `GetSessionDetailUseCaseTest`** (AC: 8, 10)
  - [ ] Crear archivo: `test/.../domain/usecase/history/GetSessionDetailUseCaseTest.kt`
  - [ ] Caso 1: `invoke returns session detail with exercises and sets` ‚Äî mock repository retorna `SessionDetail` con 2 ejercicios, assert datos completos
  - [ ] Caso 2: `invoke returns detail with substitution note` ‚Äî mock repository retorna ejercicio con `originalExerciseName != null`, assert nombre original presente

- [ ] **Test `GetExerciseHistoryUseCaseTest`** (AC: 1, 5)
  - [ ] Crear archivo: `test/.../domain/usecase/history/GetExerciseHistoryUseCaseTest.kt`
  - [ ] Caso 1: `invoke returns exercise history with entries` ‚Äî mock repository retorna `ExerciseHistoryData` con 3 entries, assert datos
  - [ ] Caso 2: `invoke returns exercise history with empty entries` ‚Äî mock repository retorna `ExerciseHistoryData` con entries vac√≠a, assert isEmpty

#### üß™ Tests ‚Äî ViewModels

- [ ] **Test `SessionHistoryViewModelTest`** (AC: 7, 12)
  - [ ] Crear archivo: `test/.../ui/history/SessionHistoryViewModelTest.kt`
  - [ ] Caso 1: `initial state is Loading` ‚Äî verificar estado inicial antes de coroutine completion
  - [ ] Caso 2: `state transitions to Loaded with sessions` ‚Äî mock UseCase retorna lista, assert `uiState.value is Loaded`
  - [ ] Caso 3: `state transitions to Empty when no sessions` ‚Äî mock UseCase retorna lista vac√≠a, assert `uiState.value is Empty`

- [ ] **Test `SessionDetailViewModelTest`** (AC: 8)
  - [ ] Crear archivo: `test/.../ui/history/SessionDetailViewModelTest.kt`
  - [ ] Caso 1: `loads session detail on init` ‚Äî mock UseCase + SavedStateHandle con sessionId, assert `uiState.value is Loaded`
  - [ ] Caso 2: `throws when sessionId missing` ‚Äî SavedStateHandle vac√≠o, assert `IllegalArgumentException`

- [ ] **Test `ExerciseHistoryViewModelTest`** (AC: 1, 4, 5, 6)
  - [ ] Crear archivo: `test/.../ui/history/ExerciseHistoryViewModelTest.kt`
  - [ ] Caso 1: `state is Loaded with standard exercise trend points in Kg` ‚Äî datos con `isBodyweight=false`, assert `yAxisLabel == "Kg"` y `trendPoints` mapeados desde `avgWeightKg`
  - [ ] Caso 2: `state is Loaded with bodyweight exercise trend points in reps` ‚Äî datos con `isBodyweight=true, isIsometric=false`, assert `yAxisLabel == "reps"` y `trendPoints` mapeados desde `totalReps`
  - [ ] Caso 3: `state is Loaded with isometric exercise trend points in seconds` ‚Äî datos con `isIsometric=true`, assert `yAxisLabel == "s"` y `trendPoints` mapeados desde `totalReps`
  - [ ] Caso 4: `state is Empty when no entries` ‚Äî entries vac√≠a, assert `uiState.value is Empty`
  - [ ] Caso 5: `trend points are reversed for chronological chart` ‚Äî entries en orden DESC, assert trendPoints[0] corresponde a la sesi√≥n m√°s antigua

### Fase 11: QA y Deployment

<!-- Fase N ‚Äî Tareas manuales -->

#### üìã Code Quality

- [ ] **Ejecutar Agente Peer Review** (MANUAL)
- [ ] **Resolver incidentes del Peer Review** (MANUAL, condicional)

#### üöÄ Deployment DEV

- [ ] **Crear Pull Request** (MANUAL)
- [ ] **Ejecutar pipeline deployment DEV** (MANUAL)

#### üß™ Testing Manual

- [ ] **Dise√±ar set de pruebas manuales** (MANUAL)
  - F1: verificar listado con sesiones reales, estado vac√≠o, orden cronol√≥gico, navegaci√≥n a F2
  - F2: verificar resumen correcto, series detalladas, nota sustituci√≥n, ejercicios incompletos filtrados, solo lectura, navegaci√≥n a F3
  - F3: verificar estado progresi√≥n, gr√°fico tendencia con/sin datos, bodyweight vs est√°ndar vs isom√©trico, lista de sesiones, "Ver t√©cnica de ejecuci√≥n" navega a D2, estado vac√≠o
  - Navegaci√≥n: bottom bar activa en tab Historial para F1‚ÜíF2‚ÜíF3, bottom bar oculta para E5‚ÜíF3, "Ver t√©cnica" navega a D2 correctamente
- [ ] **Ejecutar pruebas manuales** (MANUAL)

---

**Notas sobre vinculaci√≥n con Criterios de Aceptaci√≥n:**

| CA | Fases | Componentes principales |
|----|-------|------------------------|
| CA-16.01 | 2, 3, 8 | `getExerciseHistoryEntries()`, `getExerciseHistory()`, `ExerciseHistoryScreen` |
| CA-16.02 | 2 | `ORDER BY s.date DESC, s.id DESC` en query DAO |
| CA-16.03 | 2 | Query sin filtro por `module_version_id` ‚Äî solo por `exercise_id` |
| CA-16.04 | 7, 8 | `TrendChartComposable`, `ExerciseHistoryViewModel` (transformaci√≥n) |
| CA-16.05 | 8 | `ExerciseHistoryUiState.Empty` |
| CA-16.06 | 8 | Condicional en ViewModel: `isBodyweight` ‚Üí reps, `isIsometric` ‚Üí segundos |
| CA-16.07 | 2, 5 | `getClosedSessionsWithSummary()`, `SessionHistoryScreen` |
| CA-16.08 | 2, 3, 6 | `getExercisesForSessionDetail()`, `getSessionDetail()`, `SessionDetailScreen` |
| CA-16.09 | 2 | `HAVING setCount > 0` en query de F2 |
| CA-16.10 | 2, 6 | `LEFT JOIN exercise oe ON se.original_exercise_id = oe.id`, nota "Sustituy√≥ a:" |
| CA-16.11 | 6 | Pantalla sin acciones de escritura |
| CA-16.12 | 5 | `SessionHistoryUiState.Empty` |