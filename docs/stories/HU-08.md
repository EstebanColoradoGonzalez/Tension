# HU-08 ‚Äî Registrar ejercicios de peso corporal e isom√©tricos

## Requisitos relacionados

RNF12

> **Nota:** Los requisitos RF31, RF32 y RF33 que originalmente pertenec√≠an a esta historia fueron redistribuidos a HU-10 y HU-11, donde se implementar√°n junto con el motor de progresi√≥n. Los CAs de registro (CA-08.01, CA-08.04, CA-08.05, CA-08.08) fueron pre-implementados en HU-06 como parte del formulario E2 completo.

## Descripci√≥n

Como ejecutante, quiero que el sistema maneje correctamente el registro de ejercicios de peso corporal y ejercicios isom√©tricos con sus reglas de interfaz y validaci√≥n espec√≠ficas, para que la captura de datos refleje las caracter√≠sticas biomec√°nicas particulares de cada tipo de ejercicio.

> **Nota hist√≥rica:** Esta historia originalmente inclu√≠a 8 CAs (4 de registro + 4 de progresi√≥n). Los 4 CAs de registro fueron pre-implementados en HU-06 como parte del formulario E2. Los 4 CAs de progresi√≥n (CA-08.02, CA-08.03, CA-08.06, CA-08.07) fueron redistribuidos a HU-10 (como CA-10.10, CA-10.11, CA-10.12) y HU-11 (ya cubierto por CA-11.08), donde ser√°n implementados junto con el motor de progresi√≥n que les da contexto de ejecuci√≥n.

## Criterios de Aceptaci√≥n

### CA-08.01 ‚Äî Registro de ejercicios de peso corporal con Peso = 0

**Dado que** el ejecutante registra una serie de un ejercicio de peso corporal (Flexiones, Sentadilla a cuerpo libre, Abdominales, Escalador, Giro Ruso),
**cuando** completa el formulario de registro,
**entonces** el campo de peso se establece en 0 Kg, y el sistema registra las repeticiones logradas y el RIR normalmente.

> **Estado:** ‚úÖ Implementado en HU-06 (RegisterSetViewModel, RegisterSetScreen).

### CA-08.04 ‚Äî Registro de ejercicios isom√©tricos en segundos

**Dado que** el ejecutante registra una serie de un ejercicio isom√©trico (Plancha, Plancha Lateral),
**cuando** completa el formulario de registro,
**entonces** el sistema solicita la duraci√≥n en segundos sostenidos en lugar de repeticiones, y el campo de entrada refleja claramente que se trata de segundos, junto con el RIR correspondiente.

> **Estado:** ‚úÖ Implementado en HU-06 (RegisterSetScreen, variante isom√©trica).

### CA-08.05 ‚Äî Validaci√≥n de rango isom√©trico

**Dado que** el ejecutante registra la duraci√≥n de una serie de un ejercicio isom√©trico,
**cuando** ingresa un valor,
**entonces** el sistema acepta valores ‚â• 1 segundo y muestra una referencia visual del rango prescrito de 30 a 45 segundos para orientar al ejecutante.

> **Estado:** ‚úÖ Implementado en HU-06 (RegisterSetViewModel validaci√≥n, RegisterSetScreen referencia visual).

### CA-08.08 ‚Äî Validaci√≥n de datos de entrada

**Dado que** el ejecutante registra una serie de cualquier tipo de ejercicio (peso corporal o isom√©trico),
**cuando** ingresa valores fuera de los rangos permitidos (repeticiones < 1, duraci√≥n en segundos < 1, RIR fuera de 0-5),
**entonces** el sistema rechaza el registro con un mensaje de error claro antes de persistir.

> **Estado:** ‚úÖ Implementado en HU-06 (RegisterSetUseCase require, RegisterSetViewModel validaci√≥n inline).

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Hallazgo Principal ‚Äî HU-08 es una historia de naturaleza transversal (cross-cutting), no una funcionalidad independiente.**

HU-08 define 8 Criterios de Aceptaci√≥n que se dividen en dos categor√≠as claramente diferenciadas:

1. **CAs de registro (comportamiento de E2):** CA-08.01, CA-08.04, CA-08.05, CA-08.08 ‚Äî C√≥mo el formulario de registro de serie adapta su interfaz y validaci√≥n seg√∫n el tipo de ejercicio (peso corporal vs. isom√©trico vs. est√°ndar).

2. **CAs de progresi√≥n (evaluaci√≥n post-sesi√≥n):** CA-08.02, CA-08.03, CA-08.06, CA-08.07 ‚Äî C√≥mo el motor de progresi√≥n eval√∫a y clasifica el rendimiento de ejercicios de peso corporal e isom√©tricos con reglas diferentes al est√°ndar.

**Los CAs de registro (4 de 8) ya est√°n completamente implementados en el c√≥digo actual** como parte de HU-06 (Registrar series). La decisi√≥n de pre-implementarlos en HU-06 fue expl√≠cita y documentada en el an√°lisis de HU-06 ¬ß6: *"Los CAs de HU-08 referenciados en E2 (CA-08.01, CA-08.04, CA-08.05, CA-08.08) se cubren en este dise√±o"*.

**Los CAs de progresi√≥n (4 de 8) corresponden al motor de reglas de HU-10/HU-11**, que eval√∫a progresi√≥n al cierre de sesi√≥n. No existe actualmente ninguna l√≥gica de evaluaci√≥n de progresi√≥n en el codebase ‚Äî solo la infraestructura de datos (`ExerciseProgressionEntity` con campos `status`, `prescribedLoadKg`, `sessionsWithoutProgression`).

**Conclusi√≥n: HU-08 no requiere trabajo de implementaci√≥n aut√≥nomo.** Todos sus CAs est√°n cubiertos por otras historias ‚Äî 4 ya implementados (HU-06) y 4 se implementar√°n en HU-10/HU-11 cuando el motor de progresi√≥n sea desarrollado.

### Verificaci√≥n Exhaustiva CA por CA

#### CAs de Registro ‚Äî Ya implementados en HU-06

**CA-08.01 ‚Äî Peso = 0 para ejercicios de peso corporal:**

| Capa | Implementaci√≥n | Archivo | Evidencia |
|------|----------------|---------|-----------|
| ViewModel | `weightKg = "0"` cuando `info.isBodyweight == true` | `RegisterSetViewModel.kt` l√≠nea 44 | `info.isBodyweight \|\| info.isIsometric -> "0"` |
| ViewModel | `isWeightEditable = false` | `RegisterSetViewModel.kt` l√≠nea 54 | `!info.isBodyweight && !info.isIsometric` |
| Screen | Label cambia a "Peso (Kg) (Peso corporal)" | `RegisterSetScreen.kt` l√≠nea 155 | `stringResource(R.string.register_set_weight_bodyweight_label)` |
| Screen | Campo deshabilitado con fondo `surfaceContainerHighest.copy(alpha = 0.5f)` | `RegisterSetScreen.kt` l√≠neas 178-186 | `enabled = uiState.isWeightEditable` con colors custom |
| Repository | `lastWeightKg = 0.0` para bodyweight | `SessionRepositoryImpl.kt` l√≠nea 176 | `if (info.isBodyweight == 1 \|\| info.isIsometric == 1) 0.0` |
| Strings | `register_set_weight_bodyweight_label` | `strings.xml` l√≠nea 51 | `"Peso (Kg) (Peso corporal)"` |

**CA-08.04 ‚Äî Registro de isom√©tricos en segundos:**

| Capa | Implementaci√≥n | Archivo | Evidencia |
|------|----------------|---------|-----------|
| Screen | Label cambia a "Segundos sostenidos" | `RegisterSetScreen.kt` l√≠nea 194 | `if (uiState.isIsometric) stringResource(R.string.register_set_seconds_label)` |
| Screen | Suffix cambia a "seg" | `RegisterSetScreen.kt` l√≠nea 200 | `if (uiState.isIsometric) stringResource(R.string.register_set_seconds_suffix)` |
| Screen | Label cambia a "Peso (Kg) (Isom√©trico)" | `RegisterSetScreen.kt` l√≠nea 163 | `stringResource(R.string.register_set_weight_isometric_label)` ‚Äî **Correcci√≥n aplicada durante auditor√≠a:** el `when` original verificaba `isBodyweight` antes de `isIsometric`, causando que ejercicios isom√©tricos (que son subconjunto de bodyweight seg√∫n Modelo de Datos: `is_isometric = 1 ‚Üí is_bodyweight = 1`) mostraran label "(Peso corporal)" en vez de "(Isom√©trico)". Se invirti√≥ el orden para que `isIsometric` se eval√∫e primero (consistente con `ActiveSessionViewModel` en E1). |
| UiState | Campo `isIsometric: Boolean` disponible | `RegisterSetUiState.kt` l√≠nea 11 | `val isIsometric: Boolean = false` |
| Strings | `register_set_seconds_label`, `register_set_seconds_suffix` | `strings.xml` l√≠neas 56-57 | `"Segundos sostenidos"`, `"seg"` |

**CA-08.05 ‚Äî Validaci√≥n ‚â• 1 segundo + referencia visual 30-45s:**

| Capa | Implementaci√≥n | Archivo | Evidencia |
|------|----------------|---------|-----------|
| ViewModel | Validaci√≥n `parsed < 1` ‚Üí `error_seconds_min` | `RegisterSetViewModel.kt` l√≠nea 70 | `context.getString(R.string.error_seconds_min)` |
| Screen | `supportingText` muestra referencia cuando isometric y sin error | `RegisterSetScreen.kt` l√≠neas 206-216 | `stringResource(R.string.register_set_seconds_reference)` |
| UseCase | `require(reps >= 1)` (campo `reps` almacena segundos para isom√©tricos) | `RegisterSetUseCase.kt` l√≠nea 16 | Validaci√≥n de dominio |
| Strings | `register_set_seconds_reference`, `error_seconds_min` | `strings.xml` l√≠neas 58, 64 | `"(Referencia: 30‚Äì45 seg)"`, `"La duraci√≥n debe ser ‚â• 1 segundo"` |

**CA-08.08 ‚Äî Validaci√≥n de datos de entrada:**

| Capa | Implementaci√≥n | Archivo | Evidencia |
|------|----------------|---------|-----------|
| UseCase | `require(weightKg >= 0)`, `require(reps >= 1)`, `require(rir in 0..5)` | `RegisterSetUseCase.kt` l√≠neas 15-17 | 3 validaciones de dominio |
| ViewModel | Validaci√≥n inline en `onWeightChanged` (peso < 0) | `RegisterSetViewModel.kt` l√≠nea 63 | `error_weight_negative` |
| ViewModel | Validaci√≥n inline en `onRepsChanged` (reps/seconds < 1) | `RegisterSetViewModel.kt` l√≠neas 68-78 | Error diferenciado por tipo |
| ViewModel | `onConfirm` valida null-safety + captura `IllegalArgumentException` | `RegisterSetViewModel.kt` l√≠neas 86-126 | Double-validation (UI + UseCase) |
| Screen | RIR es selector fijo 0-5, imposible ingresar fuera de rango | `RegisterSetScreen.kt` l√≠nea 271 | `for (rir in 0..5)` chips circulares |

#### CAs de Progresi√≥n ‚Äî Diferidos a HU-10/HU-11

**CA-08.02 ‚Äî Progresi√≥n de peso corporal por repeticiones totales:**

Responsabilidad de **HU-10** (Evaluar y clasificar progresi√≥n post-sesi√≥n). La progresi√≥n se eval√∫a al cerrar la sesi√≥n (HU-09 trigger ‚Üí HU-10 l√≥gica). El motor de reglas de HU-10 comparar√° el total de repeticiones de las 4 series del ejercicio de peso corporal contra el total de la sesi√≥n anterior del mismo ejercicio. Regla 6 del MDS ¬ß6-A.

**Estado de la infraestructura:** Los datos necesarios (`exercise_set.reps` √ó 4 series por `session_exercise`) ya se persisten correctamente. Solo falta la l√≥gica de comparaci√≥n y clasificaci√≥n.

**CA-08.03 ‚Äî Regla de Doble Umbral no aplica a peso corporal:**

Responsabilidad de **HU-11** (Motor de Doble Umbral). El motor de Doble Umbral eval√∫a si debe incrementar carga. Para ejercicios de peso corporal, `Œîmin = 0`, por lo que la regla no prescribe incremento. La exclusi√≥n se implementar√° como condici√≥n `if (!exercise.isBodyweight) applyDoubleThreshold()` en el motor de reglas.

**Estado de la infraestructura:** `ExerciseEntity.isBodyweight` ya existe. `ExerciseProgressionEntity.prescribedLoadKg` es nullable (null = no aplica para peso corporal). Solo falta la l√≥gica del motor.

**CA-08.06 ‚Äî Progresi√≥n de isom√©tricos por tiempo sostenido:**

Responsabilidad de **HU-10**. El motor comparar√° los segundos sostenidos (almacenados en `exercise_set.reps`) contra el rango prescrito (30-45 seg). Regla 7 del MDS ¬ß6-A.

**Estado de la infraestructura:** Los segundos se almacenan en `reps` (dise√±o documentado en Modelo de Datos ¬ß3.12: "Para ejercicios isom√©tricos, este campo almacena los segundos sostenidos"). Solo falta la l√≥gica de evaluaci√≥n.

**CA-08.07 ‚Äî Marcado de isom√©trico como "dominado":**

Responsabilidad de **HU-10**. Cuando 4 de 4 series alcanzan ‚â• 45 segundos, `ExerciseProgressionEntity.status` pasa a `"MASTERED"`. La entidad ya tiene el campo `status` con validaci√≥n `CHECK(status IN (..., 'MASTERED'))`.

**Estado de la infraestructura:** `ExerciseProgressionEntity.status` existe con default `"NO_HISTORY"` y valores posibles incluyendo `"MASTERED"` (Modelo de Datos ¬ß3.13, l√≠nea 500). Solo falta el c√≥digo que ejecute la transici√≥n de estado.

### Validaci√≥n de Impacto

**C√≥digo verificado (post HU-07):**

| Archivo | Estado | Resultado |
|---|---|---|
| `RegisterSetViewModel.kt` | 142 l√≠neas | ‚úÖ CA-08.01, CA-08.04, CA-08.05, CA-08.08 completamente cubiertos |
| `RegisterSetScreen.kt` | 307 l√≠neas | ‚úÖ 3 variantes de E2 (est√°ndar, peso corporal, isom√©trico) implementadas |
| `RegisterSetUiState.kt` | 27 l√≠neas | ‚úÖ Campos `isBodyweight`, `isIsometric`, `isWeightEditable` presentes |
| `RegisterSetUseCase.kt` | ~20 l√≠neas | ‚úÖ 3 validaciones: peso ‚â• 0, reps ‚â• 1, RIR 0-5 |
| `SessionRepositoryImpl.kt` | 268 l√≠neas | ‚úÖ `getRegisterSetInfo` retorna `lastWeightKg = 0.0` para bodyweight/isometric |
| `ExerciseProgressionEntity.kt` | 33 l√≠neas | ‚úÖ Schema preparado: `status`, `prescribedLoadKg`, `sessionsWithoutProgression` |
| `strings.xml` | ~100 l√≠neas | ‚úÖ 7 strings de E2 para bodyweight/isometric presentes |

**Impacto en HU-10/HU-11:** Cuando se implemente el motor de progresi√≥n, deber√°:
1. Detectar si el ejercicio es `isBodyweight` o `isIsometric` (flags ya persisten en `exercise`).
2. Para bodyweight: comparar `SUM(reps)` de las 4 series contra la sesi√≥n anterior (Regla 6).
3. Para isometric: comparar segundos sostenidos en rango 30-45s contra sesi√≥n anterior (Regla 7).
4. Para isometric: si las 4 series ‚â• 45s ‚Üí `status = "MASTERED"` (CA-08.07).
5. Para bodyweight: NO aplicar Doble Umbral (`prescribedLoadKg` permanece null).

### Notas T√©cnicas

1. **El campo `exercise_set.reps` almacena tanto repeticiones como segundos.** El Modelo de Datos ¬ß3.12 documenta que "Para ejercicios isom√©tricos, este campo almacena los segundos sostenidos en lugar de repeticiones." No se requiere una columna separada. La interpretaci√≥n del valor depende de `exercise.is_isometric`.

2. **HU-08 como historia transversal.** A diferencia de HU-01 a HU-07, que mapean 1:1 a funcionalidades concretas, HU-08 es una historia que refina el comportamiento de E2 (HU-06) y del motor de progresi√≥n (HU-10/HU-11) para tipos de ejercicio especiales. Su valor reside en documentar las reglas de negocio que afectan a m√∫ltiples componentes, no en introducir nueva funcionalidad aut√≥noma.

3. **La decisi√≥n de pre-implementar los CAs de registro en HU-06 fue correcta y deliberada.** Implementar las variantes de E2 junto con el formulario base evit√≥: (a) duplicar la creaci√≥n de test scenarios de E2, (b) reabrir un composable ya validado, (c) introducir complejidad de merge entre branches. HU-06 implement√≥ E2 completo con sus 3 variantes en un solo pass.

4. **Consistencia con el patr√≥n de HU-05 ‚Üí HU-06.** As√≠ como HU-05 pre-implement√≥ el estado de ejercicio en E1 (que HU-06 us√≥ directamente), HU-06 pre-implement√≥ las variantes de E2 (que HU-08 documenta como requisitos). Este patr√≥n de "implementar infraestructura de forma anticipada cuando el costo marginal es bajo" es consistente en toda la l√≠nea de implementaci√≥n.

5. **Relaci√≥n con la Especificaci√≥n Visual.** La Especificaci√≥n Visual ¬ß8 E2 documenta expl√≠citamente las 3 variantes de E2 con su trazabilidad: *"HU-06 (CA-06.01 a CA-06.09) ¬∑ HU-08 (CA-08.01, CA-08.04, CA-08.05, CA-08.08)"*. Ambas HUs contribuyen a la misma pantalla, pero la implementaci√≥n completa est√° en HU-06.

### Historias Relacionadas

**Historias que ya implementaron comportamiento de HU-08:**

- HU-03: Crear ejercicio ‚Äî CA-03.10: define los checkboxes "Peso corporal", "Isom√©trico", "Al fallo t√©cnico" en el formulario de creaci√≥n. Origina las flags `is_bodyweight`, `is_isometric`, `is_to_technical_failure` en `ExerciseEntity`. El seeder marca los 43 ejercicios base con sus flags correctos.
- HU-04: Asignaci√≥n a versi√≥n del plan ‚Äî CA-04.04: diferencia claramente los ejercicios con rango est√°ndar (8-12 reps) de "Al fallo t√©cnico" y "30-45 seg" en la lista de D1. Muestra labels en it√°lica para condiciones especiales.
- HU-05: Determinar e iniciar sesi√≥n ‚Äî Muestra texto de carga diferenciado en E1: "Peso corporal" para bodyweight, "Isom√©trico (30-45s)" para isom√©trico, valor en Kg para est√°ndar. Ya usa el orden correcto `isIsometric` ‚Üí `isBodyweight` en el `when`.
- HU-06: Registrar series ‚Äî Implement√≥ todos los CAs de registro de HU-08 (CA-08.01, CA-08.04, CA-08.05, CA-08.08). Pre-implementaci√≥n expl√≠cita, documentada en an√°lisis HU-06 ¬ß6.
- HU-07: Sustituir ejercicio ‚Äî Reconoce que un ejercicio sustituto puede ser bodyweight o isom√©trico. E2 (HU-06) ya maneja las 3 variantes sin cambios.

**Historias que implementar√°n comportamiento futuro de HU-08:**

- HU-09: Cerrar sesi√≥n ‚Äî Trigger que invoca la evaluaci√≥n de progresi√≥n. El cierre de sesi√≥n dispara el motor de HU-10.
- HU-10: Evaluar y clasificar progresi√≥n post-sesi√≥n ‚Äî Implementar√° CA-08.02 (progresi√≥n bodyweight por reps totales), CA-08.06 (progresi√≥n isom√©trica por segundos), CA-08.07 (marcado "dominado" / MASTERED). Reglas 6 y 7 del MDS ¬ß6-A. **Nota:** Los CAs actuales de HU-10 (CA-10.01 a CA-10.09) no mencionan expl√≠citamente las reglas de bodyweight/isom√©trico ni el estado MASTERED ‚Äî esta cobertura deber√° verificarse durante el an√°lisis de HU-10.
- HU-11: Doble Umbral ‚Äî CA-11.08 excluye expl√≠citamente bodyweight del Doble Umbral: `Œîmin = 0`. Implementar√° CA-08.03.

**Historias con interacci√≥n futura relevante:**

- HU-17: Protocolo de descarga ‚Äî CA-17.09: prescripciones espec√≠ficas para bodyweight (8 reps, RIR 4-5, sin ajuste de carga) e isom√©tricos (30 seg, RIR 4-5) durante descarga.
- HU-19: KPIs por ejercicio ‚Äî CA-19.05: excluye bodyweight de "Velocidad de Progresi√≥n de Carga" (Peso = 0).
- HU-23: Historial de ejercicio ‚Äî CA-23.06: muestra tendencia por repeticiones totales (en vez de carga) para ejercicios de peso corporal.

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Modelo de Datos ¬ß3.12 (`exercise_set`): campo `reps` almacena segundos para isom√©tricos.
- Modelo de Datos ¬ß3.13 (`exercise_progression`): campo `status` incluye `MASTERED` para isom√©tricos dominados.
- Wireframes E2: Variante isom√©trica con "Segundos sostenidos" y referencia 30-45 seg. Variante peso corporal con peso fijo 0.
- Especificaci√≥n Visual ¬ß8 E2: Trazabilidad `HU-06 + HU-08`. 3 variantes documentadas (est√°ndar, peso corporal, isom√©trico).
- MDS ¬ß6-A Regla 6: Progresi√≥n peso corporal por repeticiones totales.
- MDS ¬ß6-A Regla 7: Progresi√≥n isom√©trica por segundos + condici√≥n "dominado" (4 series ‚â• 45s).
- ADR ¬ß4.2: Las Reglas 1-7 del MDS se implementan como funciones puras en el paquete `domain.rules`, invocadas por Use Cases ‚Äî testeables unitariamente sin emulador.
- Requerimientos: RF31 (progresi√≥n bodyweight por reps), RF32 (registro y progresi√≥n isom√©trica), RF33 (marcado "dominado"), RNF12 (validaci√≥n de entrada).
- HU-06 an√°lisis ¬ß6: documentaci√≥n expl√≠cita de pre-implementaci√≥n de CAs de HU-08 en E2.

### Verificaci√≥n Cruzada de CAs

| CA | Estado | Mecanismo | Implementado en |
|---|---|---|---|
| CA-08.01 | ‚úÖ Completo | Peso = 0, campo no editable, label adaptado | HU-06 (E2 bodyweight variant) |
| CA-08.02 | ‚è≥ Diferido | Comparaci√≥n de reps totales √ó 4 series | Futuro HU-10 (Regla 6 MDS) |
| CA-08.03 | ‚è≥ Diferido | Exclusi√≥n de bodyweight del motor de Doble Umbral | Futuro HU-11 (Regla 1 MDS, Œîmin = 0) |
| CA-08.04 | ‚úÖ Completo | Label "Segundos sostenidos", suffix "seg", peso fijo 0 | HU-06 (E2 isometric variant). **Fix aplicado:** orden de `when` en `WeightField` corregido (B2) |
| CA-08.05 | ‚úÖ Completo | Validaci√≥n ‚â• 1s + supportingText "(Referencia: 30-45 seg)" | HU-06 (E2 isometric variant) |
| CA-08.06 | ‚è≥ Diferido | Evaluaci√≥n de progresi√≥n por segundos sostenidos | Futuro HU-10 (Regla 7 MDS) |
| CA-08.07 | ‚è≥ Diferido | Transici√≥n status ‚Üí MASTERED cuando 4 series ‚â• 45s | Futuro HU-10 (Regla 7 MDS) |
| CA-08.08 | ‚úÖ Completo | weight ‚â• 0, reps/seconds ‚â• 1, RIR 0-5 en UI + UseCase | HU-06 (E2 validation) |

### Hitos de implementaci√≥n

| # | Entregable | Estado |
|---|---|---|
| 1 | Fix: `WeightField` orden `when` (`isIsometric` antes de `isBodyweight`) en `RegisterSetScreen.kt` | ‚úÖ Aplicado durante auditor√≠a |
| ‚Äî | No hay hitos de implementaci√≥n adicionales | **HU-08 no requiere trabajo de implementaci√≥n nuevo** |

**Justificaci√≥n:** 4 CAs de registro ya completados en HU-06 (con 1 fix menor aplicado). 4 CAs de progresi√≥n ser√°n completados en HU-10/HU-11. No existe gap de implementaci√≥n pendiente.

**Validado por:** esteban.colorado | **Fecha:** 2026-02-15 | **Enfoque:** Verificaci√≥n contra c√≥digo existente
---

## Refinamiento T√©cnico (Developer)

<!-- SECCI√ìN AGREGADA POR: Workflow refinamiento-tecnico -->
<!-- ETAPA: Refinamiento T√©cnico -->
<!-- RESPONSABLE: Developer -->
<!-- BASE: An√°lisis Arquitect√≥nico (Arquitecto) - Ver secci√≥n arriba -->
<!-- FECHA: 2026-02-15 -->
<!-- ESTADO: Listo para Desarrollo -->
<!-- AUDITOR√çA: Completada 2026-02-15 ‚Äî Verificaci√≥n exhaustiva archivo-por-archivo contra c√≥digo implementado (HU-01 a HU-07).

DIMENSIONES AUDITADAS (5):
- A. C√≥digo implementado: 7 archivos verificados contra claims del arquitecto. RegisterSetViewModel.kt (146 l√≠neas, CA-08.01/08.04/08.05/08.08 presentes), RegisterSetScreen.kt (307 l√≠neas, 3 variantes E2 confirmadas), RegisterSetUiState.kt (27 l√≠neas, isBodyweight/isIsometric/isWeightEditable), RegisterSetUseCase.kt (3 validaciones: weight‚â•0, reps‚â•1, RIR 0-5), SessionRepositoryImpl.kt (268 l√≠neas, lastWeightKg=0.0 para bodyweight/isometric), ExerciseProgressionEntity.kt (status con MASTERED, prescribedLoadKg nullable), strings.xml (7 strings E2 bodyweight/isometric confirmadas).
- B. HU-06 pre-implementaci√≥n: an√°lisis ¬ß6 de HU-06 documenta expl√≠citamente la cobertura de CA-08.01, CA-08.04, CA-08.05, CA-08.08 en E2.
- C. Orden when en WeightField: isIsometric se eval√∫a antes de isBodyweight (l√≠nea 162-163 RegisterSetScreen.kt) ‚Äî correcto por dise√±o (isom√©tricos tambi√©n son bodyweight en el modelo).
- D. ExerciseProgressionEntity: status CHECK incluye 'MASTERED', prescribedLoadKg nullable, sessionsWithoutProgression con default 0 ‚Äî infraestructura lista para HU-10/HU-11.
- E. Cross-check HUs: HU-03 (flags is_bodyweight/is_isometric en ExerciseEntity), HU-05 (texto de carga diferenciado en E1), HU-06 (pre-implementaci√≥n E2), HU-07 (sustituto puede ser bodyweight/isom√©trico sin cambios en E2).

CORRECCIONES APLICADAS (1 LOW):
(L1) RegisterSetViewModel.kt: Arquitecto cita "l√≠nea 44" para bodyweight check pero actual es l√≠nea 43. Discrepancia off-by-one; sin impacto funcional.

AUDITOR√çA PROFUNDA (2026-02-15):
Scope: 7 docs arquitectura + 5 docs business + 32 HUs + 7 archivos de c√≥digo.
Docs cruzados: Modelo de Datos ¬ß3.12/¬ß3.13, Especificaci√≥n Visual ¬ß8 E1/E2/E5, ADR-06, Wireframes E2, Requerimientos RF31/RF32/RF33/RNF12, MDS ¬ß6-A Reglas 6-7.
HUs cruzadas (11 con referencias): HU-01 (RNF12 ‚úÖ), HU-03 (flags is_bodyweight/is_isometric en ExerciseEntity ‚úÖ), HU-04 (CA-04.04 labels diferenciados en D4 ‚úÖ ‚Äî AGREGADO), HU-05 (texto carga diferenciado E1 ‚úÖ), HU-06 (pre-implementaci√≥n 4 CAs registro, ¬ß6 ‚úÖ), HU-07 (sustituto bodyweight/isom√©trico ‚úÖ), HU-10 (GAP confirmado: no menciona bodyweight/isometric/MASTERED ‚Äî correctamente flaggeado en L197 ‚úÖ), HU-11 (CA-11.08 excluye bodyweight ‚úÖ), HU-13 (E5 Badge Dominado, CA-08.07 trazado en Esp. Visual ‚Äî AGREGADO a HUs futuras), HU-17 (CA-17.09 prescripciones descarga ‚úÖ), HU-19 (CA-19.05 excluye bodyweight ‚úÖ), HU-23 (CA-23.06 tendencia reps ‚úÖ).
Mapa de Historias: 7 referencias verificadas (RF31/RF32/RF33/RNF12 trazabilidad ‚úÖ).
C√≥digo verificado: RegisterSetViewModel.kt (146 l√≠neas, 4 CAs ‚úÖ), RegisterSetScreen.kt (307 l√≠neas, 3 variantes ‚úÖ), RegisterSetUiState.kt (27 l√≠neas, 3 flags ‚úÖ), RegisterSetUseCase.kt (20 l√≠neas, 3 require ‚úÖ), SessionRepositoryImpl.kt (268 l√≠neas, lastWeightKg=0.0 ‚úÖ), ExerciseProgressionEntity.kt (33 l√≠neas, status/prescribedLoadKg/sessionsWithoutProgression ‚úÖ), strings.xml (159 l√≠neas, 7 strings E2 bodyweight/isometric ‚úÖ).
Observaci√≥n INFO: CHECK constraints de exercise_progression est√°n en Modelo de Datos doc, no enforced en Room runtime (Room no soporta CHECK annotations). Aplicaci√≥n valida por c√≥digo.

CORRECCIONES APLICADAS EN AUDITOR√çA PROFUNDA (2 INFO ‚Üí correcciones):
(I1) HU-04 agregada a "Implementaciones similares analizadas" ‚Äî CA-04.04 diferencia labels bodyweight/isometric en D4.
(I2) HU-13 agregada a "HUs futuras que dependen de artefactos" ‚Äî Especificaci√≥n Visual ¬ß8 E5 traza CA-08.07 al Badge üèÜ Dominado (AssistChip M3).

RESULTADO FINAL: 0 HIGH, 0 MEDIUM, 1 LOW (off-by-one, no requiere fix), 2 INFO corregidas. -->

### Consideraciones Generales

**Basado en an√°lisis arquitect√≥nico:**
An√°lisis Arquitect√≥nico de HU-08 con hallazgo principal: HU-08 es una historia de naturaleza transversal (cross-cutting) ‚Äî no requiere trabajo de implementaci√≥n aut√≥nomo. Los 8 CAs se dividen en: 4 CAs de registro (ya implementados en HU-06) y 4 CAs de progresi√≥n (diferidos a HU-10/HU-11). El arquitecto verific√≥ exhaustivamente la cobertura CA por CA contra 7 archivos de c√≥digo. No define hitos de implementaci√≥n nuevos.

**Nivel de complejidad:**
NULA ‚Äî HU-08 no introduce componentes nuevos, no modifica archivos existentes, y no requiere tareas de implementaci√≥n. Es una historia de verificaci√≥n y documentaci√≥n de reglas de negocio transversales. Los 4 CAs de registro (CA-08.01, CA-08.04, CA-08.05, CA-08.08) est√°n completamente implementados en el c√≥digo actual como parte de HU-06. Los 4 CAs de progresi√≥n (CA-08.02, CA-08.03, CA-08.06, CA-08.07) ser√°n implementados en HU-10 (motor de clasificaci√≥n de progresi√≥n) y HU-11 (motor de Doble Umbral).

**Riesgos t√©cnicos conocidos:**

Ninguno ‚Äî no hay trabajo de implementaci√≥n.

**Patrones y convenciones del equipo (establecidos en HU-01‚ÄîHU-07):**

- C√≥digo fuente en ingl√©s, UI y datos de dominio en espa√±ol (Arquitectura T√©cnica ¬ß5.1)
- Mensajes de validaci√≥n de dominio (`require()`, `IllegalStateException`) en ingl√©s (¬ß5.7)
- Naming: `{Feature}Screen`, `{Feature}ViewModel`, `{Acci√≥n}{Entidad}UseCase`, `{Entidad}Entity` (¬ß5.2)
- Validaci√≥n en 2 capas: UI (ViewModel inline) + Domain (UseCase require)
- El campo `exercise_set.reps` almacena tanto repeticiones (est√°ndar/bodyweight) como segundos (isom√©tricos); la interpretaci√≥n depende de `exercise.is_isometric`

**Dependencias nuevas a instalar:**
Ninguna.

**Estrategia de testing:**
JUnit 4 + MockK + kotlinx-coroutines-test | No se requieren tests nuevos ‚Äî HU-08 no genera c√≥digo nuevo | Cobertura: los tests existentes de HU-06 (RegisterSetUseCaseTest) ya cubren los 4 CAs de registro

### C√≥digo existente verificado (HU-01 a HU-07 implementados)

| Componente | Archivo | CA cubierto | Estado |
| --- | --- | --- | --- |
| `RegisterSetViewModel` | `ui/session/RegisterSetViewModel.kt` (146 l√≠neas) | CA-08.01, CA-08.04, CA-08.05, CA-08.08 | ‚úÖ Peso=0, isWeightEditable=false, error diferenciado isom√©trico/est√°ndar, validaci√≥n inline |
| `RegisterSetScreen` | `ui/session/RegisterSetScreen.kt` (307 l√≠neas) | CA-08.01, CA-08.04, CA-08.05, CA-08.08 | ‚úÖ 3 variantes: est√°ndar, peso corporal, isom√©trico. WeightField: isIsometric‚ÜíisBodyweight‚Üíelse. RepsField: "Segundos sostenidos"/"seg" + referencia 30-45s |
| `RegisterSetUiState` | `ui/session/RegisterSetUiState.kt` (27 l√≠neas) | CA-08.01, CA-08.04 | ‚úÖ isBodyweight, isIsometric, isWeightEditable presentes |
| `RegisterSetUseCase` | `domain/usecase/session/RegisterSetUseCase.kt` | CA-08.08 | ‚úÖ `require(weightKg >= 0)`, `require(reps >= 1)`, `require(rir in 0..5)` |
| `SessionRepositoryImpl` | `data/repository/SessionRepositoryImpl.kt` (268 l√≠neas) | CA-08.01 | ‚úÖ `lastWeightKg = 0.0` cuando isBodyweight o isIsometric |
| `ExerciseProgressionEntity` | `data/local/entity/ExerciseProgressionEntity.kt` | CA-08.07 (infra) | ‚úÖ `status` con default `"NO_HISTORY"`, CHECK incluye `'MASTERED'`. `prescribedLoadKg` nullable. Infraestructura lista |
| `strings.xml` | `res/values/strings.xml` | CA-08.01, CA-08.04, CA-08.05, CA-08.08 | ‚úÖ 7 strings: `register_set_weight_bodyweight_label`, `register_set_weight_isometric_label`, `register_set_seconds_label`, `register_set_seconds_suffix`, `register_set_seconds_reference`, `error_seconds_min`, `error_reps_min` |

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**

- HU-06 (RegisterSet) ‚Äî Pre-implement√≥ todos los CAs de registro de HU-08 como parte de E2. La decisi√≥n fue expl√≠cita y documentada en HU-06 an√°lisis ¬ß6: "Los CAs de HU-08 referenciados en E2 (CA-08.01, CA-08.04, CA-08.05, CA-08.08) se cubren en este dise√±o". Esto evit√≥ duplicar test scenarios y reabrir un composable ya validado.
- HU-05 (ActiveSession) ‚Äî Muestra texto de carga diferenciado en E1: `session_load_bodyweight` ("Peso corporal"), `session_load_isometric` ("Isom√©trico (30-45s)"), valor en Kg para est√°ndar. Orden del `when` ya correcto: isIsometric ‚Üí isBodyweight ‚Üí else.
- HU-04 (AssignExercise) ‚Äî CA-04.04: diferencia ejercicios con condiciones especiales en D4. Labels "Al fallo t√©cnico" (bodyweight con `isToTechnicalFailure`) y "30-45 seg" (isom√©tricos) en fontStyle italic. Usa flags `isBodyweight`, `isIsometric`, `isToTechnicalFailure` en `PlanExercise` data class.
- HU-03 (CreateExercise) ‚Äî Origin√≥ las flags `is_bodyweight`, `is_isometric`, `is_to_technical_failure` en `ExerciseEntity`. Los 43 ejercicios del seeder tienen flags correctos asignados.
- HU-07 (SubstituteExercise) ‚Äî Reconoce que un sustituto puede ser bodyweight o isom√©trico. E2 ya maneja las 3 variantes sin cambios adicionales.

**Patrones de c√≥digo reutilizados:**

- Validaci√≥n en 2 capas: (`RegisterSetViewModel` inline + `RegisterSetUseCase` require) ‚Üí patr√≥n que HU-10/HU-11 deber√°n seguir para las reglas de progresi√≥n
- `exercise_set.reps` como campo dual (repeticiones o segundos) ‚Üí la interpretaci√≥n depende de `exercise.is_isometric`, sin columna separada (Modelo de Datos ¬ß3.12)
- Orden `when`: isIsometric se eval√∫a antes de isBodyweight en toda la capa UI (WeightField, ActiveSessionViewModel) porque en el modelo de datos los isom√©tricos son subconjunto de bodyweight (`is_isometric = 1 ‚Üí is_bodyweight = 1`)

**Mejores pr√°cticas aplicadas:**

- Pre-implementaci√≥n de variantes cuando el costo marginal es bajo (HU-06 implement√≥ las 3 variantes de E2 en un solo pass)
- Infraestructura de progresi√≥n preparada (ExerciseProgressionEntity con status MASTERED, prescribedLoadKg nullable) sin implementar l√≥gica ‚Äî datos listos para HU-10/HU-11
- Campo `reps` reutilizado para segundos en isom√©tricos, evitando columna adicional con misma sem√°ntica (INTEGER ‚â• 1, operaciones de suma y comparaci√≥n id√©nticas)

### CAs diferidos a HU-10/HU-11 ‚Äî Infraestructura verificada

| CA | Responsabilidad | Infraestructura presente | Pendiente por implementar |
| --- | --- | --- | --- |
| CA-08.02 | HU-10 (Regla 6 MDS) | `exercise_set.reps` √ó 4 series por `session_exercise` ‚Äî datos se persisten correctamente | L√≥gica de comparaci√≥n: `SUM(reps)` de 4 series vs sesi√≥n anterior. Condici√≥n: `exercise.isBodyweight == true` |
| CA-08.03 | HU-11 (Regla 1 MDS) | `exercise.is_bodyweight` flag disponible. `exercise_progression.prescribed_load_kg` nullable | Exclusi√≥n: `if (!exercise.isBodyweight) applyDoubleThreshold()`. `Œîmin = 0` ‚Üí no prescribir incremento |
| CA-08.06 | HU-10 (Regla 7 MDS) | `exercise_set.reps` almacena segundos para isom√©tricos. `exercise.is_isometric` disponible | Evaluaci√≥n: comparar segundos sostenidos (en rango 30-45s) vs sesi√≥n anterior del mismo ejercicio |
| CA-08.07 | HU-10 (Regla 7 MDS) | `exercise_progression.status` incluye `'MASTERED'`. CHECK constraint ya definido en schema | Transici√≥n: cuando 4 de 4 series ‚â• 45s ‚Üí `status = "MASTERED"`. Estado terminal para isom√©tricos |

**HUs futuras que dependen de artefactos verificados en HU-08:**

- HU-09: Cerrar sesi√≥n ‚Üí trigger que invoca evaluaci√≥n de progresi√≥n (HU-10). Los datos registrados (reps/segundos con peso=0) son la entrada.
- HU-10: Clasificaci√≥n de progresi√≥n ‚Üí implementar√° CA-08.02, CA-08.06, CA-08.07. Deber√° detectar `isBodyweight`/`isIsometric` y aplicar reglas espec√≠ficas (Reglas 6 y 7 del MDS ¬ß6-A).
- HU-11: Doble Umbral ‚Üí implementar√° CA-08.03. CA-11.08 excluye bodyweight (`Œîmin = 0`).
- HU-13: Resumen Post-Sesi√≥n (E5) ‚Üí Especificaci√≥n Visual ¬ß8 E5 traza CA-08.07 al "Badge üèÜ Dominado" (AssistChip M3, Tertiary Container, solo isom√©tricos con 4 series ‚â• 45s). HU-13 implementar√° la visualizaci√≥n del estado MASTERED.
- HU-17: Protocolo de descarga ‚Üí CA-17.09: prescripciones espec√≠ficas bodyweight (8 reps, RIR 4-5) e isom√©tricos (30 seg, RIR 4-5).
- HU-19: KPIs por ejercicio ‚Üí CA-19.05: excluye bodyweight de "Velocidad de Progresi√≥n de Carga".
- HU-23: Historial de ejercicio ‚Üí CA-23.06: tendencia por repeticiones totales para bodyweight.

---

## Tareas de Implementaci√≥n (Developer)

<!-- HU-08 es una historia transversal sin trabajo de implementaci√≥n aut√≥nomo.
     
     Los 4 CAs de registro (CA-08.01, CA-08.04, CA-08.05, CA-08.08) ya est√°n completamente
     implementados en el c√≥digo actual como parte de HU-06.
     
     Los 4 CAs de progresi√≥n (CA-08.02, CA-08.03, CA-08.06, CA-08.07) ser√°n implementados
     en HU-10 y HU-11 cuando el motor de progresi√≥n sea desarrollado.
     
     No existen fases de implementaci√≥n activas. Solo se incluye la Fase N obligatoria. -->

### Fase N: QA y Deployment

- [ ] **Ejecutar Agente Peer Review** (MANUAL)
- [ ] **Resolver incidentes del Peer Review** (MANUAL, condicional)
- [ ] **Crear Pull Request** (MANUAL)
- [ ] **Ejecutar pipeline deployment DEV** (MANUAL)
- [ ] **Dise√±ar set de pruebas manuales** (MANUAL)
- [ ] **Ejecutar pruebas manuales** (MANUAL)

---

**Notas sobre vinculaci√≥n con Criterios de Aceptaci√≥n:**

- CA-08.01 ‚Üí Ya implementado en HU-06 (RegisterSetViewModel peso=0, RegisterSetScreen campo deshabilitado, SessionRepositoryImpl lastWeightKg=0.0)
- CA-08.02 ‚Üí Diferido a HU-10 (Regla 6 MDS: progresi√≥n bodyweight por reps totales)
- CA-08.03 ‚Üí Diferido a HU-11 (Regla 1 MDS: exclusi√≥n de bodyweight del motor de Doble Umbral, Œîmin=0)
- CA-08.04 ‚Üí Ya implementado en HU-06 (RegisterSetScreen label "Segundos sostenidos", suffix "seg", peso=0 isom√©trico)
- CA-08.05 ‚Üí Ya implementado en HU-06 (RegisterSetScreen supportingText "(Referencia: 30-45 seg)", RegisterSetViewModel validaci√≥n ‚â•1s)
- CA-08.06 ‚Üí Diferido a HU-10 (Regla 7 MDS: progresi√≥n isom√©trica por tiempo sostenido)
- CA-08.07 ‚Üí Diferido a HU-10 (Regla 7 MDS: transici√≥n status ‚Üí MASTERED cuando 4 series ‚â• 45s)
- CA-08.08 ‚Üí Ya implementado en HU-06 (RegisterSetUseCase require weight‚â•0/reps‚â•1/RIR 0-5, RegisterSetViewModel validaci√≥n inline, RegisterSetScreen RIR selector fijo 0-5)
