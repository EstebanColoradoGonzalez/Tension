# HU-17 ‚Äî Sistema de Alertas

## Requisitos relacionados

RF53, RF54, RF55, RF56, RF57, RF58, RNF05

## Descripci√≥n

Como ejecutante, quiero que el sistema emita alertas proactivas con dos niveles de severidad (alerta y crisis) cuando detecte condiciones que requieran mi atenci√≥n ‚Äî tasa de progresi√≥n baja, RIR fuera de rango por m√≥dulo, adherencia semanal insuficiente, ca√≠da de tonelaje por grupo muscular o inactividad prolongada por m√≥dulo ‚Äî para recibir se√±ales tempranas y objetivas de problemas antes de que comprometan mis adaptaciones, sin que estas se√±ales bloqueen mi autonom√≠a de entrenamiento.

## Historias originales consolidadas

Esta historia consolida las siguientes historias del dise√±o original, que comparten la misma tabla (`alert`), las mismas pantallas (H1/H2), el mismo patr√≥n (alerta vs. crisis, informativo, no bloqueante, retiro autom√°tico) y la misma infraestructura visual (RNF05):

- **HU-26 original** ‚Äî Alertas de tasa de progresi√≥n baja (RF53)
- **HU-27 original** ‚Äî Alertas de RIR por m√≥dulo (RF54, RF55)
- **HU-28 original** ‚Äî Alertas de adherencia baja (RF56)
- **HU-29 original** ‚Äî Alertas de ca√≠da de tonelaje por grupo muscular (RF57)
- **HU-30 original** ‚Äî Alertas de inactividad por m√≥dulo (RF58)

---

## Criterios de Aceptaci√≥n

### Bloque A ‚Äî Alertas de Tasa de Progresi√≥n Baja (RF53)

#### CA-17.01 ‚Äî Alerta por tasa de progresi√≥n < 40%

**Dado que** el sistema calcula la Tasa de Progresi√≥n de un ejercicio en un per√≠odo de 4 semanas,
**cuando** el resultado es menor al 40%,
**entonces** emite una alerta informativa indicando el nombre del ejercicio, su tasa de progresi√≥n actual y que est√° por debajo del umbral de alerta.

#### CA-17.02 ‚Äî Alerta de crisis por tasa de progresi√≥n < 20%

**Dado que** el sistema calcula la Tasa de Progresi√≥n de un ejercicio en un per√≠odo de 4 semanas,
**cuando** el resultado es menor al 20%,
**entonces** emite una alerta de crisis con mayor urgencia visual, indicando el nombre del ejercicio, su tasa de progresi√≥n actual y que est√° en estado cr√≠tico de estancamiento.

#### CA-17.03 ‚Äî Diferenciaci√≥n visual entre alerta y crisis de progresi√≥n

**Dado que** el sistema emite una alerta de tasa de progresi√≥n,
**cuando** el ejecutante visualiza la alerta,
**entonces** la alerta de nivel normal (< 40%) y la de crisis (< 20%) son visualmente distinguibles entre s√≠ mediante colores e iconograf√≠a diferenciada, sin depender √∫nicamente del texto.

#### CA-17.04 ‚Äî Alertas de progresi√≥n informativas, no bloqueantes

**Dado que** el sistema emite una alerta de tasa de progresi√≥n baja,
**cuando** el ejecutante interact√∫a con el sistema,
**entonces** la alerta es informativa y no impide iniciar sesiones, registrar series ni cerrar sesiones; el ejecutante mantiene autonom√≠a total.

#### CA-17.05 ‚Äî Evaluaci√≥n peri√≥dica de progresi√≥n

**Dado que** el sistema eval√∫a la tasa de progresi√≥n,
**cuando** se completa un per√≠odo de 4 semanas o un microciclo,
**entonces** recalcula la tasa y emite o retira alertas seg√∫n corresponda al estado actual de cada ejercicio.

### Bloque B ‚Äî Alertas de RIR por M√≥dulo (RF54, RF55)

#### CA-17.06 ‚Äî Alerta por RIR Promedio < 1.5 (intensidad excesiva)

**Dado que** el sistema calcula el RIR Promedio de un m√≥dulo,
**cuando** el resultado es < 1.5 de forma sostenida durante 2 o m√°s sesiones del mismo m√≥dulo,
**entonces** emite una alerta al ejecutante indicando: el m√≥dulo afectado, el RIR Promedio actual, que est√° entrenando demasiado cerca del fallo t√©cnico de forma sostenida, y recomienda prescribir una descarga para permitir recuperaci√≥n del SNC.

#### CA-17.07 ‚Äî Alerta por RIR Promedio > 3.5 (intensidad insuficiente)

**Dado que** el sistema calcula el RIR Promedio de un m√≥dulo,
**cuando** el resultado es > 3.5 de forma sostenida durante 2 o m√°s sesiones del mismo m√≥dulo,
**entonces** emite una alerta al ejecutante indicando: el m√≥dulo afectado, el RIR Promedio actual, que el est√≠mulo puede ser insuficiente para generar adaptaci√≥n, y recomienda incrementar la carga de los ejercicios del m√≥dulo.

#### CA-17.08 ‚Äî Condici√≥n de "sostenido" durante 2+ sesiones

**Dado que** el sistema eval√∫a si el RIR Promedio est√° fuera de rango de forma sostenida,
**cuando** determina si emitir la alerta,
**entonces** verifica que la condici√≥n (< 1.5 o > 3.5) se cumple en las √∫ltimas 2 o m√°s sesiones consecutivas del mismo m√≥dulo; una sola sesi√≥n fuera de rango no dispara la alerta.

#### CA-17.09 ‚Äî Diferenciaci√≥n visual entre alertas de RIR

**Dado que** el sistema emite alertas de RIR por m√≥dulo,
**cuando** el ejecutante visualiza las alertas,
**entonces** la alerta por RIR bajo (< 1.5, riesgo de fatiga) y la alerta por RIR alto (> 3.5, est√≠mulo insuficiente) son visualmente distinguibles entre s√≠ mediante colores e iconograf√≠a diferenciada.

#### CA-17.10 ‚Äî Alertas de RIR informativas, no bloqueantes

**Dado que** el sistema emite una alerta de RIR por m√≥dulo,
**cuando** el ejecutante interact√∫a con el sistema,
**entonces** la alerta es informativa; no impide entrenar ni fuerza una descarga autom√°tica. El ejecutante decide si seguir la recomendaci√≥n.

#### CA-17.11 ‚Äî Retiro autom√°tico de alerta de RIR

**Dado que** el sistema ha emitido una alerta de RIR por m√≥dulo,
**cuando** las sesiones posteriores del m√≥dulo retornan el RIR Promedio a la zona √≥ptima (1.5-3.5),
**entonces** el sistema retira la alerta activa para ese m√≥dulo.

### Bloque C ‚Äî Alertas de Adherencia Baja (RF56)

#### CA-17.12 ‚Äî Alerta informativa por adherencia < 60% en una semana

**Dado que** el sistema calcula el √çndice de Adherencia al finalizar una semana natural,
**cuando** el resultado es < 60%,
**entonces** emite una alerta informativa indicando la adherencia de la semana, cu√°ntas sesiones se completaron respecto al objetivo, y que la baja frecuencia puede afectar la resoluci√≥n temporal de las se√±ales del sistema.

#### CA-17.13 ‚Äî Alerta de crisis por adherencia < 60% durante 2+ semanas consecutivas

**Dado que** el sistema calcula el √çndice de Adherencia semanal,
**cuando** el resultado es < 60% durante 2 o m√°s semanas consecutivas,
**entonces** emite una alerta de crisis con mayor urgencia visual, indicando la racha de semanas con baja adherencia y advirtiendo que las comparaciones entre sesiones pierden validez por el excesivo tiempo entre ellas.

#### CA-17.14 ‚Äî Diferenciaci√≥n visual entre alerta y crisis de adherencia

**Dado que** el sistema emite alertas de adherencia,
**cuando** el ejecutante visualiza las alertas,
**entonces** la alerta informativa (1 semana < 60%) y la de crisis (2+ semanas < 60%) son visualmente distinguibles mediante colores e iconograf√≠a diferenciada.

#### CA-17.15 ‚Äî Alertas de adherencia informativas, no bloqueantes

**Dado que** el sistema emite una alerta de adherencia baja,
**cuando** el ejecutante interact√∫a con el sistema,
**entonces** la alerta es informativa; no impide entrenar, registrar sesiones ni acceder a ninguna funcionalidad. El ejecutante es aut√≥nomo.

#### CA-17.16 ‚Äî Retiro de alerta de crisis de adherencia

**Dado que** el sistema ha emitido una alerta de crisis por adherencia,
**cuando** el ejecutante completa una semana con adherencia ‚â• 60%,
**entonces** el sistema retira la alerta de crisis, manteniendo el registro hist√≥rico de las semanas con baja adherencia.

### Bloque D ‚Äî Alertas de Ca√≠da de Tonelaje por Grupo Muscular (RF57)

#### CA-17.17 ‚Äî Alerta por ca√≠da de tonelaje > 10%

**Dado que** el sistema calcula el Tonelaje por Grupo Muscular al completar un microciclo,
**cuando** el tonelaje de un grupo muscular cae m√°s del 10% respecto al microciclo anterior,
**entonces** emite una alerta indicando el grupo muscular afectado, el porcentaje de ca√≠da y el tonelaje comparado de ambos microciclos.

#### CA-17.18 ‚Äî Alerta de crisis por ca√≠da de tonelaje > 20%

**Dado que** el sistema calcula el Tonelaje por Grupo Muscular al completar un microciclo,
**cuando** el tonelaje de un grupo muscular cae m√°s del 20% respecto al microciclo anterior,
**entonces** emite una alerta de crisis con mayor urgencia visual, indicando que la p√©rdida de volumen es severa y puede comprometer las adaptaciones del grupo muscular.

#### CA-17.19 ‚Äî Verificaci√≥n de descarga planificada

**Dado que** el sistema detecta una ca√≠da de tonelaje en un grupo muscular,
**cuando** analiza la causa de la ca√≠da,
**entonces** verifica si el microciclo evaluado corresponde a un per√≠odo de descarga activa (HU-14); si es descarga planificada, la alerta se contextualiza como "Ca√≠da esperada por descarga" y no se clasifica como crisis.

#### CA-17.20 ‚Äî Diferenciaci√≥n entre descarga y regresi√≥n

**Dado que** el sistema emite una alerta de ca√≠da de tonelaje,
**cuando** la ca√≠da corresponde a una descarga planificada,
**entonces** la alerta indica claramente "Descarga planificada ‚Äî ca√≠da de tonelaje esperada y controlada", diferenci√°ndola de una regresi√≥n no intencional.

#### CA-17.21 ‚Äî Diferenciaci√≥n visual entre alerta y crisis de tonelaje

**Dado que** el sistema emite alertas de tonelaje,
**cuando** el ejecutante visualiza las alertas,
**entonces** la alerta de nivel normal (> 10%) y la de crisis (> 20%) son visualmente distinguibles mediante colores e iconograf√≠a diferenciada.

#### CA-17.22 ‚Äî Alertas de tonelaje informativas, no bloqueantes

**Dado que** el sistema emite una alerta de ca√≠da de tonelaje,
**cuando** el ejecutante interact√∫a con el sistema,
**entonces** la alerta es informativa y no impide ninguna operaci√≥n del ejecutante.

### Bloque E ‚Äî Alertas de Inactividad por M√≥dulo (RF58)

#### CA-17.23 ‚Äî Alerta por inactividad > 10 d√≠as naturales

**Dado que** el sistema monitorea la √∫ltima fecha de ejecuci√≥n de cada m√≥dulo,
**cuando** transcurren m√°s de 10 d√≠as naturales sin que se ejecute un m√≥dulo espec√≠fico (A, B o C),
**entonces** emite una alerta indicando el m√≥dulo inactivo, la cantidad de d√≠as transcurridos desde su √∫ltima ejecuci√≥n y los grupos musculares asociados que pueden verse afectados.

#### CA-17.24 ‚Äî Alerta de crisis por inactividad > 14 d√≠as naturales

**Dado que** el sistema monitorea la √∫ltima fecha de ejecuci√≥n de cada m√≥dulo,
**cuando** transcurren m√°s de 14 d√≠as naturales sin que se ejecute un m√≥dulo espec√≠fico,
**entonces** emite una alerta de crisis con mayor urgencia visual, informando al ejecutante que el grupo muscular asociado puede estar perdiendo adaptaciones musculares y que se recomienda priorizar ese m√≥dulo.

#### CA-17.25 ‚Äî Referencia a los grupos musculares afectados

**Dado que** el sistema emite una alerta de inactividad por m√≥dulo,
**cuando** presenta la alerta al ejecutante,
**entonces** detalla los grupos musculares asociados al m√≥dulo inactivo: M√≥dulo A = Espalda, B√≠ceps, Abdomen; M√≥dulo B = Pecho, Hombro, Tr√≠ceps; M√≥dulo C = Cu√°driceps, Isquiotibiales, Gl√∫teos, Aductores, Abductores, Gemelos.

#### CA-17.26 ‚Äî Conteo basado en d√≠as naturales

**Dado que** el sistema eval√∫a la inactividad de un m√≥dulo,
**cuando** cuenta los d√≠as transcurridos,
**entonces** utiliza d√≠as naturales del calendario (no sesiones ni microciclos), ya que la p√©rdida de adaptaciones musculares se correlaciona con el tiempo absoluto sin est√≠mulo.

#### CA-17.27 ‚Äî Diferenciaci√≥n visual entre alerta y crisis de inactividad

**Dado que** el sistema emite alertas de inactividad,
**cuando** el ejecutante visualiza las alertas,
**entonces** la alerta de nivel normal (> 10 d√≠as) y la de crisis (> 14 d√≠as) son visualmente distinguibles mediante colores e iconograf√≠a diferenciada.

#### CA-17.28 ‚Äî Alertas de inactividad informativas, no bloqueantes

**Dado que** el sistema emite una alerta de inactividad por m√≥dulo,
**cuando** el ejecutante interact√∫a con el sistema,
**entonces** la alerta es informativa; no altera la rotaci√≥n c√≠clica ni fuerza un cambio de m√≥dulo. El ejecutante sigue la rotaci√≥n normal.

#### CA-17.29 ‚Äî Retiro autom√°tico de alerta de inactividad

**Dado que** el sistema ha emitido una alerta de inactividad para un m√≥dulo,
**cuando** el ejecutante completa una sesi√≥n de ese m√≥dulo,
**entonces** el sistema retira la alerta de inactividad y reinicia el conteo de d√≠as para ese m√≥dulo.

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** Motor de Alertas Write-Time en Pipeline Existente + MVVM Read-Only para 2 pantallas (H1, H2) con AlertRepository dedicado

**Justificaci√≥n:** HU-17 tiene dos caras. La cara **write-side** extiende el pipeline transaccional existente (`SessionRepositoryImpl.evaluateProgression()`) con 5 bloques de evaluaci√≥n nuevos que crean/resuelven alertas al cierre de cada sesi√≥n ‚Äî reutilizando las Rules ya implementadas por HU-15 (`ProgressionRateRule`, `AvgRirRule`, `AdherenceRule`, `TonnageRule`). La infraestructura de alertas (tabla `alert`, `AlertEntity`, `AlertDao`, patr√≥n insert/resolve) ya existe por HU-12 ‚Äî solo se ampl√≠a. La cara **read-side** crea 2 pantallas nuevas (H1 Centro de Alertas, H2 Detalle de Alerta) que son de solo lectura y recalculan datos din√°micamente. El rec√°lculo es seguro porque las sesiones cerradas son inmutables (Modelo de Datos ¬ß3.10). Se crea un `AlertRepository` dedicado como nuevo dominio funcional de lectura/resoluci√≥n, separado de `SessionRepository` (que solo escribe alertas). Las alertas de tipo `MODULE_INACTIVITY` se eval√∫an al cerrar sesi√≥n comparando la fecha de √∫ltima sesi√≥n de cada m√≥dulo contra today ‚Äî no requieren background job porque el usuario no consulta la app entre sesiones.

### Decisiones Fundamentadas

**1. Se crea `AlertRepository` (interfaz + impl) como nuevo dominio funcional de lectura.**

`AlertDao` actualmente se inyecta directamente en `SessionRepositoryImpl` para operaciones de escritura (insert/resolve de alertas PLATEAU y MODULE_REQUIRES_DELOAD). Para H1 y H2 se necesitan operaciones de lectura (listado de alertas activas, detalle por ID, conteo reactivo, datos de contexto para rec√°lculo). Estas responsabilidades de lectura no pertenecen a `SessionRepository` ‚Äî son un dominio funcional separado. `AlertRepository` encapsula: lectura de alertas, construcci√≥n de datos de contexto para H2, y el conteo reactivo para el badge de B1. La escritura de alertas permanece en `SessionRepositoryImpl` (ya tiene `AlertDao` en su constructor y todas las dependencias transaccionales). Sigue el patr√≥n de la Arquitectura T√©cnica ¬ß5.2: `AlertRepository` / `AlertRepositoryImpl`.

**2. La evaluaci√≥n de los 5 nuevos tipos de alerta extiende `evaluateProgression()` con bloques post-loop.**

El pipeline actual ejecuta un loop de ejercicios (clasificaci√≥n + plateau alerts) seguido de un deload guard (`if (isDeloadSession) return` en l√≠nea 536) y an√°lisis a nivel de m√≥dulo (MODULE_REQUIRES_DELOAD). Los 5 nuevos tipos se agregan DESPU√âS del bloque MODULE_REQUIRES_DELOAD, como Steps 7-11 del pipeline. El deload guard existente en l√≠nea 536 ya protege los 5 nuevos Steps ‚Äî durante sesiones de descarga, `evaluateProgression()` retorna antes de alcanzarlos, lo cual es correcto: la progresi√≥n, RIR, adherencia, tonelaje e inactividad no deben evaluarse durante descarga controlada. Los DAOs necesarios (`sessionDao`, `exerciseSetDao`, `sessionExerciseDao`, `alertDao`) ya est√°n inyectados en `SessionRepositoryImpl` ‚Äî solo se necesita agregar `ProfileDao` al constructor para obtener `weekly_frequency` (adherencia, Step 9). Cada bloque sigue el patr√≥n existente: calcular ‚Üí evaluar umbral ‚Üí if(supera && !existsActive) ‚Üí insert | if(!supera && existsActive) ‚Üí resolve. Los Steps 8 (RIR) y 11 (inactividad) iteran sobre los 3 m√≥dulos (A, B, C), no solo el m√≥dulo de la sesi√≥n actual. El Step 7 (progresi√≥n) eval√∫a todos los ejercicios activos, el Step 9 (adherencia) es global, y el Step 10 (tonelaje) eval√∫a todos los grupos musculares.

**3. No se crean nuevas Rules de c√°lculo ‚Äî se reutilizan las existentes de HU-15.**

`ProgressionRateRule.calculate(positiveCount, totalCount)` ya calcula la tasa exacta que necesitan CA-17.01/CA-17.02. `AvgRirRule.calculate(rirValues)` ya calcula el RIR promedio de CA-17.06/CA-17.07. `AdherenceRule.calculate(completed, planned)` ya calcula la adherencia de CA-17.12/CA-17.13. `TonnageRule.calculateForMuscleGroup(sets)` ya calcula el tonelaje por grupo muscular de CA-17.17/CA-17.18. Solo se crea `AlertThresholdRule` ‚Äî un objeto con funciones puras que eval√∫an si un valor calculado supera umbrales de alerta o crisis (ej: `isProgressionCrisis(rate) = rate < 20.0`, `isProgressionAlert(rate) = rate < 40.0`). Esto centraliza los umbrales m√°gicos en un solo lugar testeable.

**4. `AlertThresholdRule` centraliza todos los umbrales de los 5 bloques de alerta.**

Los umbrales est√°n definidos en los CAs: progresi√≥n < 40% (alerta) / < 20% (crisis), RIR < 1.5 o > 3.5 (sostenido 2+ sesiones), adherencia < 60% (alerta) / 2+ semanas (crisis), tonelaje > 10% ca√≠da (alerta) / > 20% (crisis), inactividad > 10 d√≠as (alerta) / > 14 d√≠as (crisis). Todos se codifican como constantes y funciones puras en `AlertThresholdRule`. Testear umbrales es trivial ‚Äî un test unitario por funci√≥n con boundary values.

**5. MODULE_INACTIVITY se eval√∫a al cerrar sesi√≥n, no como background job.**

CA-17.26 dice que el conteo es en d√≠as naturales. Sin embargo, un WorkManager/AlarmManager requerir√≠a permisos adicionales (RNF30: permisos m√≠nimos) y complejidad de infraestructura innecesaria. La evaluaci√≥n al cierre de sesi√≥n es suficiente: (a) el ejecutante entrena 3-6 sesiones/semana ‚Üí eval√∫a inactividad de los otros m√≥dulos cada 1-2 d√≠as, (b) entre sesiones el usuario no ve la app, (c) el umbral m√≠nimo es 10 d√≠as ‚Äî si entrena al menos cada 2-3 d√≠as, la evaluaci√≥n del cierre detecta la inactividad a tiempo. Si el usuario deja de entrenar 14+ d√≠as, la alerta se crear√° al reabrir la app y cerrar su primera sesi√≥n de vuelta. Se necesita un nuevo query `SessionDao.getLastSessionDateByModule()` que retorne la fecha de la √∫ltima sesi√≥n cerrada de cada m√≥dulo.

**6. H2 recalcula datos din√°micamente ‚Äî no se almacenan en la tabla `alert`.**

El Modelo de Datos ¬ß3.16 dice: "Los datos que dispararon la alerta y las recomendaciones escalonadas no se almacenan ‚Äî se recalculan din√°micamente". Para cada tipo de alerta, H2 recalcula usando las mismas Rules y DAOs: (a) mesetas: `PlateauCausalAnalysisRule` + `CorrectiveActionRule` (ya existentes, HU-12), (b) progresi√≥n baja: `GetProgressionRateUseCase` con los datos del ejercicio, (c) RIR: `GetAvgRirByModuleUseCase` con las sesiones del m√≥dulo, (d) adherencia: `GetAdherenceUseCase` con la semana actual, (e) tonelaje: `GetTonnageByMuscleGroupUseCase` con los microciclos, (f) inactividad: `SessionDao.getLastSessionDateByModule()`. Las sesiones cerradas son inmutables ‚Üí el rec√°lculo siempre produce el mismo resultado.

**7. CA-17.19/CA-17.20: La verificaci√≥n de descarga planificada para ca√≠das de tonelaje usa `deload_id`.**

Cuando se detecta una ca√≠da de tonelaje en un grupo muscular, el pipeline verifica si las sesiones del microciclo evaluado tienen `deload_id IS NOT NULL`. Si es descarga planificada, la alerta se crea con nivel `MEDIUM_ALERT` y mensaje contextualizado ("Descarga planificada ‚Äî ca√≠da de tonelaje esperada y controlada") en lugar de `CRISIS`. Esto cumple CA-17.19 y CA-17.20 sin l√≥gica adicional ‚Äî solo un condicional en el bloque de evaluaci√≥n de tonelaje.

**8. CA-17.08: La condici√≥n "sostenido 2+ sesiones" para RIR usa el query `getSessionIdsByModuleInRange()` existente.**

`SessionDao.getSessionIdsByModuleInRange(moduleCode, limit=2)` ya obtiene las √∫ltimas N sesiones de un m√≥dulo. Se calcula el RIR promedio de cada una de las 2 √∫ltimas sesiones por separado usando `ExerciseSetDao.getRirValuesBySessionIds()`. Si ambas sesiones cumplen la condici√≥n (< 1.5 o > 3.5), se emite la alerta. Una sola sesi√≥n fuera de rango no la dispara. El retiro autom√°tico (CA-17.11) ocurre cuando las 2 √∫ltimas sesiones del m√≥dulo retornan a la zona √≥ptima (1.5-3.5).

**9. CA-17.05/CA-17.13: La adherencia usa semanas naturales y se eval√∫a al cierre de sesi√≥n.**

La adherencia semanal se calcula con `AdherenceRule.calculate()` usando `SessionDao.countSessionsInWeek()` (ya existente) comparado con el `weekly_frequency` del perfil. Para la crisis de 2+ semanas consecutivas (CA-17.13), se necesita verificar la semana anterior tambi√©n. Si ambas semanas est√°n por debajo del 60%, se crea/escala a CRISIS. Para el retiro (CA-17.16), basta con una semana ‚â• 60% para resolver la alerta.

**10. El badge de alertas en B1 se conecta con un `Flow<Int>` reactivo.**

`AlertDao.countActive()` ya retorna `Flow<Int>`. El `HomeViewModel` actualmente hardcodea `alertCount = 0`. Se inyecta `GetActiveAlertCountUseCase` que expone el Flow del conteo. El `combine()` existente del ViewModel se extiende con un cuarto Flow. El Badge M3 en HomeScreen ya renderiza el conteo ‚Äî solo cambia la fuente de datos.

### Componentes Afectados

**Componentes nuevos:**

| # | Componente | Tipo | Paquete | Responsabilidad |
|---|-----------|------|---------|-----------------|
| 1 | `AlertThresholdRule` | Nuevo (Rule) | `domain.rules` | Funciones puras con umbrales de los 5 tipos de alerta. Constantes: PROGRESSION_ALERT=40, PROGRESSION_CRISIS=20, RIR_LOW=1.5, RIR_HIGH=3.5, ADHERENCE_THRESHOLD=60, TONNAGE_ALERT=10, TONNAGE_CRISIS=20, INACTIVITY_ALERT=10, INACTIVITY_CRISIS=14 |
| 2 | `AlertRepository` | Nuevo (interfaz) | `domain.repository` | Contrato para operaciones de lectura de alertas: `countActive(): Flow<Int>`, `getActiveAlerts(): Flow<List<AlertItem>>`, `getAlertDetail(alertId: Long): AlertDetail` |
| 3 | `AlertRepositoryImpl` | Nuevo (impl) | `data.repository` | Implementaci√≥n con `AlertDao` para lectura + DAOs auxiliares para rec√°lculo de datos de H2 (ejercicios, sesiones, series, progresi√≥n) |
| 4 | `GetActiveAlertCountUseCase` | Nuevo (UseCase) | `domain.usecase.alerts` | Retorna `Flow<Int>` del conteo de alertas activas para badge de B1 |
| 5 | `GetActiveAlertsUseCase` | Nuevo (UseCase) | `domain.usecase.alerts` | Retorna `Flow<List<AlertItem>>` de alertas activas agrupadas por nivel para H1 |
| 6 | `GetAlertDetailUseCase` | Nuevo (UseCase) | `domain.usecase.alerts` | Carga detalle completo de una alerta para H2: tipo, nivel, datos que la dispararon, an√°lisis causal, recomendaciones. Recalcula datos din√°micamente |
| 7 | `AlertItem` | Nuevo (domain model) | `domain.model` | Modelo para cada fila de H1: alertId, type, level, entityName (ejercicio/m√≥dulo/grupo muscular), message, createdAt |
| 8 | `AlertDetail` | Nuevo (domain model) | `domain.model` | Modelo compuesto para H2: type, level, entityName, triggerData (datos que dispararon), causalAnalysis (texto), recommendations (lista), showExerciseHistoryLink (Boolean), showDeloadLink (Boolean), exerciseId (Long?), isDeloadContextualized (Boolean) |
| 9 | `AlertTriggerData` | Nuevo (domain model) | `domain.model` | Modelo sellado para los datos que dispararon la alerta por tipo: sesiones con peso/reps (meseta), tasa de progresi√≥n (progresi√≥n baja), valor RIR promedio (RIR), porcentaje adherencia (adherencia), porcentaje ca√≠da tonelaje (tonelaje), d√≠as de inactividad (inactividad) |
| 10 | `AlertCenterScreen` | Nuevo (Composable) | `ui.alerts` | Pantalla H1 ‚Äî Listado de alertas activas agrupadas: secci√≥n Crisis (üî¥) + secci√≥n Alertas (üü†üü°). Estado vac√≠o. Acceso desde B1 |
| 11 | `AlertCenterViewModel` | Nuevo (HiltViewModel) | `ui.alerts` | Estado reactivo para H1 ‚Äî carga lista de alertas activas v√≠a Flow |
| 12 | `AlertCenterUiState` | Nuevo (data class) | `ui.alerts` | Estado UI para H1 ‚Äî Loading/Empty/Loaded con crisisAlerts + regularAlerts + totalCount (para subt√≠tulo "N alertas activas" en Top Bar) |
| 13 | `AlertDetailScreen` | Nuevo (Composable) | `ui.alerts` | Pantalla H2 ‚Äî Detalle con card de tipo/nivel, datos disparadores, an√°lisis causal, recomendaciones, enlaces condicionales a F3/I1 |
| 14 | `AlertDetailViewModel` | Nuevo (HiltViewModel) | `ui.alerts` | Estado reactivo para H2 ‚Äî carga detalle completo de una alerta con rec√°lculo din√°mico |
| 15 | `AlertDetailUiState` | Nuevo (data class) | `ui.alerts` | Estado UI para H2 ‚Äî Loading/Loaded con AlertDetail |
| 16 | `AlertLevelIndicator` | Nuevo (Composable) | `ui.components` | Indicador circular relleno de nivel de alerta (12dp para H1, 16dp para H2). Color: rojo crisis, naranja alta, amarillo media. Reutilizable en H1 y H2 |
| 17 | `AlertCard` | Nuevo (Composable) | `ui.alerts` | Card de alerta con fondo por nivel (Error Container / naranja / amarillo), leading indicator, t√≠tulo tipo, entidad, dato clave. Clickable ‚Üí H2 |
| 18 | `ModuleInactivityData` | Nuevo (domain model) | `domain.model` | Modelo para inactividad por m√≥dulo: moduleCode, lastSessionDate, daysSinceLastSession, muscleGroups (lista) |

**Componentes modificados:**

| # | Componente | Modificaci√≥n | Nivel |
|---|-----------|-------------|-------|
| 1 | `SessionRepositoryImpl` | Agregar 5 bloques de evaluaci√≥n post-loop en `evaluateProgression()` (Steps 7-11): LOW_PROGRESSION_RATE, RIR_OUT_OF_RANGE, LOW_ADHERENCE, TONNAGE_DROP, MODULE_INACTIVITY. Cada bloque: calcular KPI ‚Üí evaluar umbral ‚Üí crear/resolver alerta. Inyectar `ProfileDao` para obtener `weekly_frequency` (adherencia). Los dem√°s DAOs ya est√°n inyectados | Mayor |
| 2 | `AlertDao` | Agregar 4 queries nuevos: `getAlertById(alertId): AlertEntity?` para H2, `resolveByMuscleGroupAndType(muscleGroup, type, resolvedAt)` para resolver TONNAGE_DROP, `existsActiveByMuscleGroup(muscleGroup, type): Boolean` para deduplicar TONNAGE_DROP, `getActiveAlertsFull(): Flow<List<AlertWithEntityName>>` con JOIN a `exercise`/`module` para obtener nombre de la entidad afectada | Medio |
| 3 | `SessionDao` | Agregar `getLastSessionDateByModule(moduleCode): String?` ‚Äî retorna `MAX(date)` de sesiones cerradas filtradas por m√≥dulo. Reutiliza JOIN con `module_version` | Menor |
| 4 | `HomeViewModel` | Inyectar `GetActiveAlertCountUseCase`. Reemplazar `alertCount = 0` hardcoded con `getActiveAlertCountUseCase()` como cuarto Flow en el `combine()`. El badge M3 se actualiza reactivamente | Menor |
| 5 | `NavigationRoutes` | Agregar `ALERT_CENTER = "alert-center"` y `ALERT_DETAIL = "alert-detail/{alertId}"` con funci√≥n factory `alertDetailRoute(alertId: Long)` | Menor |
| 6 | `TensionNavHost` | Registrar `AlertCenterScreen` y `AlertDetailScreen` composables. Conectar `onNavigateToAlerts` de HomeScreen con `navController.navigate(NavigationRoutes.ALERT_CENTER)`. Registrar navegaci√≥n H1‚ÜíH2, H2‚ÜíF3, H2‚ÜíI1 | Medio |
| 7 | `RepositoryModule` | Agregar binding `AlertRepository` ‚Üí `AlertRepositoryImpl` | Menor |
| 8 | `DatabaseModule` | Sin cambio ‚Äî `AlertDao` ya est√° provisto por `provideAlertDao()` | Sin cambio |
| 9 | `strings.xml` | Agregar ~30 strings: t√≠tulos de pantallas, nombres de tipos de alerta, etiquetas de nivel, textos de an√°lisis causal por tipo, textos de recomendaciones, estado vac√≠o, formatos de datos disparadores, enlaces de acci√≥n | Menor |
| 10 | `BottomNavigationBar` | Agregar `childRoutePrefixes = setOf("alert-center", "alert-detail")` al `BottomNavItem` de HOME para que el tab Inicio aparezca seleccionado en H1 y H2 | Menor |

**Componentes reutilizados (existentes, sin modificaci√≥n):**

| # | Componente | Paquete | Uso en HU-17 |
|---|-----------|---------|---------------|
| R1 | `ProgressionRateRule` | `domain.rules` | C√°lculo de tasa de progresi√≥n para alertas LOW_PROGRESSION_RATE (write-side) y rec√°lculo en H2 (read-side) |
| R2 | `AvgRirRule` | `domain.rules` | C√°lculo de RIR promedio por m√≥dulo para alertas RIR_OUT_OF_RANGE (write-side) y rec√°lculo en H2 |
| R3 | `AdherenceRule` | `domain.rules` | C√°lculo de adherencia semanal para alertas LOW_ADHERENCE (write-side) y rec√°lculo en H2 |
| R4 | `TonnageRule` | `domain.rules` | C√°lculo de tonelaje por grupo muscular para alertas TONNAGE_DROP (write-side) y rec√°lculo en H2 |
| R5 | `PlateauCausalAnalysisRule` | `domain.rules` | An√°lisis causal de mesetas en H2 (read-side) ‚Äî CA-12.10 a CA-12.12. Ya existente por HU-12 |
| R6 | `CorrectiveActionRule` | `domain.rules` | Recomendaciones escalonadas en H2 (read-side) ‚Äî CA-12.16, CA-12.17. Ya existente por HU-12 |
| R7 | `ModuleFatigueRule` | `domain.rules` | Detecci√≥n de fatiga acumulada en m√≥dulo ‚Äî contextualiza alertas de meseta grupal. Ya existente por HU-12 |
| R8 | `AlertEntity` | `data.local.entity` | Entidad Room para la tabla `alert`. Ya existente por HU-12 |
| R9 | `AlertDao.insert()` | `data.local.dao` | Inserci√≥n de alertas nuevas. Ya existente por HU-12 |
| R10 | `AlertDao.existsActiveByExercise()` | `data.local.dao` | Verificaci√≥n de deduplicaci√≥n por ejercicio. Ya existente por HU-12 |
| R11 | `AlertDao.existsActiveByModule()` | `data.local.dao` | Verificaci√≥n de deduplicaci√≥n por m√≥dulo. Ya existente por HU-12 |
| R12 | `AlertDao.resolveByExerciseAndType()` | `data.local.dao` | Resoluci√≥n de alertas por ejercicio. Ya existente por HU-12 |
| R13 | `AlertDao.resolveByModuleAndType()` | `data.local.dao` | Resoluci√≥n de alertas por m√≥dulo. Ya existente por HU-12 |
| R14 | `AlertDao.countActive()` | `data.local.dao` | Conteo reactivo de alertas activas para badge B1. Ya existente por HU-12 |
| R15 | `AlertDao.getActiveAlerts()` | `data.local.dao` | Lista de alertas activas ordenadas. Ya existente por HU-12 |
| R16 | `SessionDao.getSessionIdsByModuleInRange()` | `data.local.dao` | √öltimas N sesiones de un m√≥dulo para evaluaci√≥n sostenida de RIR |
| R17 | `SessionDao.countSessionsInWeek()` | `data.local.dao` | Sesiones completadas en una semana para adherencia |
| R18 | `ExerciseSetDao.getRirValuesBySessionIds()` | `data.local.dao` | Valores RIR de sesiones espec√≠ficas para c√°lculo de RIR promedio |
| R19 | `TensionTopAppBar` | `ui.components` | Barra superior reutilizada en H1 y H2 |

**Componentes NO tocados (verificado en c√≥digo):**

- Toda la capa `domain/rules/` existente ‚Äî ninguna Rule se modifica, solo se agregan constantes en `AlertThresholdRule`
- `data/local/entity/` ‚Äî `AlertEntity` no se modifica (0 cambios de esquema, 0 migraciones)
- `data/local/database/TensionDatabase.kt` ‚Äî no se modifica (versi√≥n se mantiene, `AlertDao` ya est√° registrado)
- `data/local/seed/` ‚Äî no se toca ning√∫n seeder
- Flujos E (sesi√≥n activa), C (perfil), D (cat√°logo), F (historial), G (m√©tricas), I (descarga), J (configuraci√≥n) ‚Äî no se modifican sus pantallas
- `MetricsRepository`/`MetricsRepositoryImpl` ‚Äî no se modifican. Los DAOs subyacentes se invocan directamente en `SessionRepositoryImpl` y `AlertRepositoryImpl`
- `ExerciseRepository`, `PlanRepository`, `ProfileRepository` ‚Äî no participan

### Hitos de Implementaci√≥n

| # | Componente(s) | Descripci√≥n | Dependencias |
|---|--------------|-------------|--------------|
| 1 | Domain Models + Rule | Crear `AlertItem`, `AlertDetail`, `AlertTriggerData`, `ModuleInactivityData` en `domain.model`. Crear `AlertThresholdRule` en `domain.rules` con todos los umbrales y funciones de evaluaci√≥n | Ninguna |
| 2 | DAO Queries | Agregar queries nuevos en `AlertDao` (4 queries: getById, resolveByMuscleGroup, existsActiveByMuscleGroup, getActiveAlertsFull), `SessionDao` (1 query: getLastSessionDateByModule) | Ninguna |
| 3 | AlertRepository | Crear `AlertRepository` (interfaz en `domain.repository`) y `AlertRepositoryImpl` (en `data.repository`). Agregar binding en `RepositoryModule` | Hitos 1, 2 |
| 4 | Pipeline de Alertas | Agregar 5 bloques de evaluaci√≥n al final de `evaluateProgression()` en `SessionRepositoryImpl`: LOW_PROGRESSION_RATE (Step 7), RIR_OUT_OF_RANGE (Step 8), LOW_ADHERENCE (Step 9), TONNAGE_DROP (Step 10), MODULE_INACTIVITY (Step 11). Inyectar `ProfileDao` en constructor | Hitos 1, 2 |
| 5 | Use Cases | Crear `GetActiveAlertCountUseCase`, `GetActiveAlertsUseCase`, `GetAlertDetailUseCase` en `domain.usecase.alerts` | Hito 3 |
| 6 | B1 Badge | Inyectar `GetActiveAlertCountUseCase` en `HomeViewModel`. Reemplazar `alertCount = 0` con Flow reactivo en `combine()` | Hito 5 |
| 7 | H1 ‚Äî Centro de Alertas | Crear `AlertCenterScreen`, `AlertCenterViewModel`, `AlertCenterUiState`, `AlertCard`, `AlertLevelIndicator`. Agregar ruta ALERT_CENTER en NavigationRoutes y TensionNavHost. Conectar onNavigateToAlerts de HomeScreen. Agregar `childRoutePrefixes` de alertas al tab HOME en `BottomNavigationBar` | Hito 5 |
| 8 | H2 ‚Äî Detalle de Alerta | Crear `AlertDetailScreen`, `AlertDetailViewModel`, `AlertDetailUiState`. Agregar ruta ALERT_DETAIL y navegaci√≥n H1‚ÜíH2, H2‚ÜíF3, H2‚ÜíI1 | Hito 5 |
| 9 | Strings + Navegaci√≥n final | Agregar ~30 strings en `strings.xml`. Verificar navegaci√≥n completa: B1‚ÜíH1‚ÜíH2‚ÜíF3, B1‚ÜíH1‚ÜíH2‚ÜíI1. Verificar badge reactivo | Hitos 6, 7, 8 |
| 10 | Tests unitarios | Tests para `AlertThresholdRule` (boundary values de todos los umbrales), tests para los 3 Use Cases, tests para los 5 bloques del pipeline en `SessionRepositoryImpl` | Hitos 4, 5, 6, 7, 8 |

### Validaci√≥n de Impacto

**C√≥digo real verificado (paso 1.5):**

- `SessionRepositoryImpl.kt` (749 l√≠neas): `evaluateProgression()` actualmente tiene Steps 1-6 (loop de ejercicios + PLATEAU + deload guard + MODULE_REQUIRES_DELOAD). El deload guard (`if (isDeloadSession) return`) est√° en la l√≠nea 536 y protege autom√°ticamente todo el c√≥digo posterior ‚Äî incluidos los 5 nuevos Steps (7-11) que se agregan al final del m√©todo, despu√©s del bloque MODULE_REQUIRES_DELOAD. El constructor ya inyecta `sessionDao`, `exerciseSetDao`, `sessionExerciseDao`, `alertDao`, `moduleDao` ‚Äî solo falta `ProfileDao` para `weekly_frequency` (adherencia). `ProfileDao` ya est√° provisto por `DatabaseModule` (usado por `ProfileRepositoryImpl`), Hilt lo resolver√° autom√°ticamente. `ProfileDao.getProfile()` retorna `Flow<ProfileEntity?>` ‚Äî se usa `.first()` para obtener el valor s√≠ncrono dentro de la transacci√≥n.
- `AlertDao.kt` (80 l√≠neas): Tiene `insert()`, `existsActiveByExercise()`, `existsActiveByModule()`, `resolveByExerciseAndType()`, `resolveByModuleAndType()`, `countActive(): Flow<Int>`, `getActiveAlerts(): Flow<List<AlertEntity>>`, `getActiveAlertsByType()`, `resolveAllByType()`. Faltan: `getAlertById()`, `resolveByMuscleGroupAndType()`, `existsActiveByMuscleGroup()`, `getActiveAlertsFull()` (con JOIN para nombre de entidad).
- `AlertEntity.kt` (63 l√≠neas): Completo con todos los campos necesarios. Los 7 tipos ya est√°n definidos: PLATEAU, LOW_PROGRESSION_RATE, RIR_OUT_OF_RANGE, LOW_ADHERENCE, TONNAGE_DROP, MODULE_INACTIVITY, MODULE_REQUIRES_DELOAD. Los 3 niveles: CRISIS, HIGH_ALERT, MEDIUM_ALERT. No requiere modificaci√≥n.
- `HomeViewModel.kt` (97 l√≠neas): `alertCount = 0` hardcoded en l√≠nea 51. El `combine()` tiene 3 Flows ‚Äî se agrega un 4to: `getActiveAlertCountUseCase()`. El constructor necesita un nuevo par√°metro `GetActiveAlertCountUseCase`.
- `TensionNavHost.kt`: `onNavigateToAlerts = { /* TODO: HU-17 */ }` en l√≠nea 128. Se reemplaza con `navController.navigate(NavigationRoutes.ALERT_CENTER)`. No hay rutas ALERT_CENTER ni ALERT_DETAIL definidas.
- `NavigationRoutes.kt` (36 l√≠neas): No tiene rutas de alertas. Se agregan `ALERT_CENTER = "alert-center"` y `ALERT_DETAIL = "alert-detail/{alertId}"`.
- `RepositoryModule.kt` (55 l√≠neas): Tiene 5 bindings (Profile, Exercise, Plan, Session, Metrics). Se agrega el 6to: `AlertRepository` ‚Üí `AlertRepositoryImpl`.
- `DatabaseModule.kt`: Ya provee `AlertDao` v√≠a `provideAlertDao()`. No requiere modificaci√≥n.
- `ProgressionRateRule.kt`: `calculate(positiveCount, totalCount): Double` ‚Äî retorna porcentaje. Reutilizable directamente.
- `AvgRirRule.kt`: `calculate(rirValues: List<Int>): Double` ‚Äî retorna promedio con 1 decimal. Reutilizable directamente.
- `AdherenceRule.kt`: `calculate(completedSessions, plannedSessions): Double` ‚Äî retorna porcentaje. Reutilizable directamente.
- `TonnageRule.kt`: `calculateForMuscleGroup(sets): Map<String, Double>` ‚Äî retorna tonelaje por grupo muscular. Reutilizable directamente.
- `PlateauCausalAnalysisRule.kt`: `analyze(lastSessionsAvgRir, isGroupStagnant): PlateauCause` ‚Äî retorna causa. Reutilizable en H2 para mesetas.
- `CorrectiveActionRule.kt`: `recommend(sessionsWithoutProgression): List<CorrectiveAction>` ‚Äî retorna acciones sugeridas. Reutilizable en H2 para mesetas.
- `SessionDao.kt`: Tiene `getSessionIdsByModuleInRange(moduleCode, limit)`, `countSessionsInWeek(weekStartDate, weekEndDate)`, `getClosedSessionsOrdered()`. Falta `getLastSessionDateByModule()`.
- `ExerciseSetDao.kt`: Tiene `getRirValuesBySessionIds(sessionIds)`, `getTonnageDataBySessionIds(sessionIds)`. Suficiente para los c√°lculos.
- `strings.xml`: Tiene `home_alert_badge_description`. Faltan ~30 strings para H1/H2 (t√≠tulos, tipos de alerta, niveles, textos de an√°lisis, recomendaciones, estado vac√≠o, formatos).
- `BottomNavigationBar.kt` (144 l√≠neas): H1 y H2 se acceden desde B1 badge. Bottom Nav debe mostrar "Inicio" como activo (Wireframe H1: "Inicio marcado como activo"). El tab HOME actualmente no tiene `childRoutePrefixes` ‚Äî se debe agregar `setOf("alert-center", "alert-detail")` para que el tab quede seleccionado al navegar a H1/H2. Sin este cambio, ning√∫n tab se resaltar√≠a. La l√≥gica de `showBottomBar` (blocklist en `TensionNavHost.kt`) ya muestra el Bottom Nav en H1/H2 sin cambios.

**An√°lisis de dependencias:**

- HU-17 depende de: HU-12 (infraestructura de alertas: `AlertEntity`, `AlertDao`, patr√≥n insert/resolve, alertas PLATEAU y MODULE_REQUIRES_DELOAD), HU-14 (descarga: `deload_id` en session para contextualizar ca√≠das de tonelaje, resoluci√≥n de MODULE_REQUIRES_DELOAD), HU-15 (Rules de KPIs: `ProgressionRateRule`, `AvgRirRule`, `AdherenceRule`, `TonnageRule`, `GetMicrocycleMapUseCase`), HU-16 (F3: navegaci√≥n H2‚ÜíF3 para historial de ejercicio ya implementada).
- HU-17 NO introduce nuevas entidades ni migraciones ‚Äî usa la tabla `alert` existente con los 7 tipos ya definidos en el CHECK constraint.
- HU-17 habilita: HU-18 (backup ‚Äî la tabla `alert` con alertas resueltas se exporta como hist√≥rico).

**Impacto en performance:**

- Pipeline write-side: Los 5 bloques agregan ~5-8 queries adicionales al cierre de sesi√≥n (√∫ltima fecha por m√≥dulo √ó3, RIR por m√≥dulo √ó3, progresi√≥n rate √ó1, adherencia √ó1, tonelaje √ó1). Cada query usa √≠ndices existentes. El cierre de sesi√≥n pasa de ~200ms a ~350ms estimados ‚Äî aceptable dado que ocurre m√°ximo una vez al d√≠a.
- H1 read-side: `getActiveAlerts()` con Flow reactivo. Con < 20 alertas activas simult√°neas (caso t√≠pico), la lectura es instant√°nea.
- H2 read-side: Rec√°lculo din√°mico de datos disparadores. Para mesetas: 2-3 queries (√∫ltimas sesiones, RIR, ejercicios en meseta). Para tonelaje: query de microciclo + tonelaje. Total < 100ms.
- Badge B1: `countActive()` es un `SELECT COUNT(*) WHERE is_active = 1` con √≠ndice en `is_active`. Pr√°cticamente instant√°neo.

### Notas T√©cnicas

**Nota 1 ‚Äî Mapeo tipo de alerta ‚Üí nivel visual (H1).**

El wireframe define 3 niveles visuales: üî¥ Crisis (rojo/Error Container), üü† Alerta alta (naranja), üü° Alerta media (amarillo). El mapeo desde `alert.level` es: `CRISIS` ‚Üí üî¥, `HIGH_ALERT` ‚Üí üü†, `MEDIUM_ALERT` ‚Üí üü°. En H1, las alertas se agrupan en 2 secciones: "Crisis" (solo üî¥) y "Alertas" (üü† + üü°), ordenadas internamente por `created_at DESC`. La secci√≥n "Crisis" solo es visible si hay alertas de nivel CRISIS.

**Nota 2 ‚Äî H2: An√°lisis causal var√≠a por tipo de alerta.**

Para alertas de tipo PLATEAU: usa `PlateauCausalAnalysisRule.analyze()` y `CorrectiveActionRule.recommend()` ya existentes (HU-12 CA-12.10 a CA-12.12). Para LOW_PROGRESSION_RATE: texto fijo seg√∫n nivel ("Tasa de progresi√≥n por debajo del umbral de alerta/crisis"). Para RIR_OUT_OF_RANGE: texto condicional (< 1.5 ‚Üí "entrenando demasiado cerca del fallo t√©cnico", > 3.5 ‚Üí "est√≠mulo insuficiente para generar adaptaci√≥n"). Para LOW_ADHERENCE: texto con datos de semana(s) afectada(s). Para TONNAGE_DROP: texto condicional (descarga planificada ‚Üí azul "Ca√≠da esperada", regresi√≥n ‚Üí "Ca√≠da no intencional, evaluar causas"). Para MODULE_INACTIVITY: texto con d√≠as transcurridos y grupos musculares afectados (CA-17.25). Los textos se almacenan en `strings.xml` con placeholders `%s`/`%d`.

**Nota 3 ‚Äî H2: Links de acci√≥n condicionales.**

"Ver historial del ejercicio ‚Üí" (navega a F3): visible solo si `alert.type ‚àà {PLATEAU, LOW_PROGRESSION_RATE}` y `alert.exercise_id != null`. "Gestionar descarga ‚Üí" (navega a I1): visible solo si `alert.type ‚àà {MODULE_REQUIRES_DELOAD}` o si la alerta de RIR_OUT_OF_RANGE recomienda descarga (RIR < 1.5 sostenido). Estos condicionales se eval√∫an en el ViewModel y se exponen como booleanos en `AlertDetail`.

**Nota 4 ‚Äî Deduplicaci√≥n de alertas.**

El bloque de evaluaci√≥n verifica `existsActiveByExercise/Module/MuscleGroup()` antes de insertar. No se crean alertas duplicadas por la misma condici√≥n. Si una alerta CRISIS ya existe para un ejercicio/m√≥dulo/grupo, no se crea una segunda. Si la condici√≥n cambia de nivel (ej: inactividad pasa de 10 a 14 d√≠as), la alerta MEDIUM_ALERT se resuelve y se crea una nueva CRISIS. Esto se maneja con resolve + insert en el bloque correspondiente.

**Nota 5 ‚Äî Escalamiento de nivel (MEDIUM_ALERT ‚Üí CRISIS).**

Para tipos con 2 niveles (TONNAGE_DROP, LOW_ADHERENCE, MODULE_INACTIVITY, LOW_PROGRESSION_RATE), cuando la condici√≥n escala de alerta a crisis, el pipeline: (1) resuelve la alerta MEDIUM_ALERT existente, (2) crea una nueva de nivel CRISIS. Cuando la condici√≥n baja de crisis a alerta normal, la CRISIS se resuelve y se crea una MEDIUM_ALERT. Cuando la condici√≥n desaparece, se resuelven todas las alertas activas de ese tipo para la entidad.

**Nota 6 ‚Äî Grupos musculares por m√≥dulo para CA-17.25.**

Los grupos musculares asociados a cada m√≥dulo est√°n definidos en el Modelo de Datos como datos de seed: A = Espalda, B√≠ceps, Abdomen; B = Pecho, Hombro, Tr√≠ceps; C = Cu√°driceps, Isquiotibiales, Gl√∫teos, Aductores, Abductores, Gemelos. Para H2 y para el mensaje de la alerta de inactividad, se codifican como constante en `AlertThresholdRule` (o `AlertRepositoryImpl`) porque son datos fijos del dominio que no cambian en runtime.

**Nota 7 ‚Äî Bottom Navigation en H1 y H2.**

El wireframe muestra "Inicio marcado como activo" en H1/H2. La Arquitectura T√©cnica ¬ß4.5.1 confirma que H1 y H2 est√°n en el grupo "Siempre visible" para Bottom Nav. En el c√≥digo actual, `showBottomBar` usa un blocklist (oculta solo A1, E1-E5, y condicionales D2/F3) ‚Äî como `alert-center` y `alert-detail` no est√°n en el blocklist, el Bottom Nav se muestra autom√°ticamente. Sin embargo, el `BottomNavItem` del tab HOME actualmente no tiene `childRoutePrefixes` ‚Äî cuando el usuario est√° en H1 o H2, ning√∫n tab quedar√° seleccionado (sin highlight). Para que "Inicio" aparezca como activo, se debe agregar `childRoutePrefixes = setOf("alert-center", "alert-detail")` al `BottomNavItem` de HOME en `BottomNavigationBar.kt`.

**Nota 8 ‚Äî La evaluaci√≥n de tonelaje por microciclo reutiliza `GetMicrocycleMapUseCase`.**

CA-17.17/CA-17.18 comparan tonelaje entre el microciclo actual y el anterior. En `evaluateProgression()`, se obtienen los sessionIds del microciclo actual vs anterior usando la l√≥gica de `SessionDao.getClosedSessionsOrdered()` + agrupaci√≥n por posiciones (6 sesiones = 1 microciclo). Se calcula el tonelaje por grupo muscular de cada microciclo con `TonnageRule.calculateForMuscleGroup()` y se compara la variaci√≥n porcentual. Si la ca√≠da > 10% (alerta) o > 20% (crisis), se emite. La verificaci√≥n de descarga planificada (CA-17.19) se hace comprobando `deload_id IS NOT NULL` en las sesiones del microciclo evaluado.

**Nota 9 ‚Äî `getSessionIdsByModuleInRange()` ya filtra sesiones de descarga.**

El query existente `SessionDao.getSessionIdsByModuleInRange()` incluye `AND s.deload_id IS NULL`, lo cual excluye sesiones de descarga de la evaluaci√≥n de RIR. Esto garantiza que CA-17.08 (sostenido 2+ sesiones) eval√∫e solo sesiones normales ‚Äî el RIR durante descarga no contamina la evaluaci√≥n.

**Nota 10 ‚Äî Navegaci√≥n H2‚ÜíF3: Bottom Nav condicional en F3 para origen H2.**

La Arquitectura T√©cnica ¬ß4.5.1 define que F3 es "Condicional" ‚Äî **Visible** si el origen es F2, G1, H2 o D2; **Oculta** si el origen es E5. El c√≥digo actual en `TensionNavHost.kt` ya implementa la l√≥gica condicional para F3 (oculta solo cuando viene de `session-summary`). Como H2 no es `session-summary`, F3 mostrar√° Bottom Nav cuando se navega desde H2. No se necesita cambio adicional.

### Verificaci√≥n Cruzada de CAs

| CA | Mecanismo | Componente |
|----|-----------|------------|
| CA-17.01 | `ProgressionRateRule.calculate()` ‚Üí si < 40% y no existe activa ‚Üí insert MEDIUM_ALERT | `SessionRepositoryImpl` Step 7 + `AlertThresholdRule.isProgressionAlert()` |
| CA-17.02 | Si < 20% ‚Üí insert CRISIS (o escalar MEDIUM‚ÜíCRISIS) | `SessionRepositoryImpl` Step 7 + `AlertThresholdRule.isProgressionCrisis()` |
| CA-17.03 | Card crisis (üî¥ Error Container) vs card media (üü° amarillo) con indicador circular diferenciado | `AlertCard` + `AlertLevelIndicator` + Especificaci√≥n Visual ¬ßH1 |
| CA-17.04 | No hay l√≥gica de bloqueo ‚Äî alertas son informativas de solo lectura | Todo el flujo es read-only excepto la creaci√≥n/resoluci√≥n autom√°tica |
| CA-17.05 | Evaluaci√≥n al cierre de cada sesi√≥n ‚Äî recalcula tasa y crea/resuelve seg√∫n estado actual | `SessionRepositoryImpl` Step 7 ejecuta en cada `evaluateProgression()` |
| CA-17.06 | `AvgRirRule.calculate()` por cada una de las 2 √∫ltimas sesiones del m√≥dulo ‚Üí si ambas < 1.5 ‚Üí insert MEDIUM_ALERT con recomendaci√≥n de descarga | `SessionRepositoryImpl` Step 8 |
| CA-17.07 | Mismo mecanismo pero si ambas > 3.5 ‚Üí insert MEDIUM_ALERT con recomendaci√≥n de incrementar carga | `SessionRepositoryImpl` Step 8 |
| CA-17.08 | `getSessionIdsByModuleInRange(moduleCode, 2)` ‚Üí RIR por cada sesi√≥n individual ‚Üí ambas fuera de rango = sostenido | `SessionRepositoryImpl` Step 8 |
| CA-17.09 | Card media (üü°) con indicador circular diferente al de alertas de progresi√≥n (üü†/üî¥). RIR bajo vs RIR alto diferenciados por mensaje y tipo de recomendaci√≥n | `AlertCard` con contenido din√°mico |
| CA-17.10 | Sin l√≥gica de bloqueo ‚Äî solo lectura | Mismo que CA-17.04 |
| CA-17.11 | Si las 2 √∫ltimas sesiones del m√≥dulo retornan a zona √≥ptima (1.5-3.5) ‚Üí `resolveByModuleAndType(moduleCode, "RIR_OUT_OF_RANGE")` | `SessionRepositoryImpl` Step 8 bloque else |
| CA-17.12 | `AdherenceRule.calculate()` con semana actual ‚Üí si < 60% y no existe activa ‚Üí insert MEDIUM_ALERT | `SessionRepositoryImpl` Step 9 |
| CA-17.13 | Verificar semana anterior tambi√©n: si ambas semanas < 60% ‚Üí escalar a CRISIS | `SessionRepositoryImpl` Step 9 |
| CA-17.14 | Card media (üü° 1 semana) vs card crisis (üî¥ 2+ semanas) | `AlertCard` + `AlertLevelIndicator` |
| CA-17.15 | Sin l√≥gica de bloqueo | Mismo que CA-17.04 |
| CA-17.16 | Si semana actual ‚â• 60% ‚Üí `resolveByModuleAndType(null, "LOW_ADHERENCE")` ‚Äî resuelve crisis y alerta | `SessionRepositoryImpl` Step 9 bloque else. `LOW_ADHERENCE` no tiene `module_code` ‚Äî se necesita `resolveAllByType("LOW_ADHERENCE")` |
| CA-17.17 | `TonnageRule.calculateForMuscleGroup()` con microciclo actual vs anterior ‚Üí si ca√≠da > 10% ‚Üí insert MEDIUM_ALERT con grupo muscular afectado | `SessionRepositoryImpl` Step 10 |
| CA-17.18 | Si ca√≠da > 20% ‚Üí insert CRISIS (o escalar) | `SessionRepositoryImpl` Step 10 |
| CA-17.19 | Si sesiones del microciclo tienen `deload_id IS NOT NULL` ‚Üí contextualizar como descarga planificada, no crisis | `SessionRepositoryImpl` Step 10 ‚Äî condicional sobre `deload_id` |
| CA-17.20 | Mensaje: "Descarga planificada ‚Äî ca√≠da de tonelaje esperada y controlada" en nivel MEDIUM_ALERT, no CRISIS | Condicional en Step 10 que modifica mensaje y nivel |
| CA-17.21 | Card media (üü° > 10%) vs card crisis (üî¥ > 20%) | `AlertCard` + `AlertLevelIndicator` |
| CA-17.22 | Sin l√≥gica de bloqueo | Mismo que CA-17.04 |
| CA-17.23 | `getLastSessionDateByModule()` ‚Üí `ChronoUnit.DAYS.between(lastDate, today)` ‚Üí si > 10 ‚Üí insert MEDIUM_ALERT | `SessionRepositoryImpl` Step 11 |
| CA-17.24 | Si > 14 d√≠as ‚Üí insert CRISIS (o escalar) | `SessionRepositoryImpl` Step 11 |
| CA-17.25 | Mensaje incluye grupos musculares: c√≥digo harcoded M√≥dulo A = Espalda, B√≠ceps, Abdomen; B = Pecho, Hombro, Tr√≠ceps; C = Cu√°driceps, Isquiotibiales, Gl√∫teos, Aductores, Abductores, Gemelos | `AlertThresholdRule` constante + `strings.xml` |
| CA-17.26 | `ChronoUnit.DAYS.between(LocalDate.parse(lastDate), today)` ‚Äî calcula d√≠as naturales | `SessionRepositoryImpl` Step 11 |
| CA-17.27 | Card media (üü° > 10 d√≠as) vs card crisis (üî¥ > 14 d√≠as) | `AlertCard` + `AlertLevelIndicator` |
| CA-17.28 | Sin l√≥gica de bloqueo ‚Äî no altera rotaci√≥n ni fuerza cambio de m√≥dulo | La rotaci√≥n sigue la secuencia A‚ÜíB‚ÜíC independientemente |
| CA-17.29 | Al cerrar sesi√≥n del m√≥dulo, si alerta de inactividad activa para ese m√≥dulo ‚Üí `resolveByModuleAndType(moduleCode, "MODULE_INACTIVITY")` | `SessionRepositoryImpl` Step 11 (resolve al inicio si la sesi√≥n actual es del m√≥dulo) |

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Wireframes ‚Äî [Wireframes.md](docs/architecture/Wireframes.md) (¬ßH1 Centro de Alertas, ¬ßH2 Detalle de Alerta)
- Mapa de Navegaci√≥n ‚Äî [Mapa de Navegaci√≥n.md](docs/architecture/Mapa%20de%20Navegaci√≥n.md) (¬ßH1 transiciones B1‚ÜîH1‚ÜîH2‚ÜîF3/I1)
- Especificaci√≥n Visual ‚Äî [Especificaci√≥n Visual.md](docs/architecture/Especificaci√≥n%20Visual.md) (¬ßH1, ¬ßH2 component specs con colores por nivel)
- Modelo de Datos ‚Äî [Modelo de Datos.md](docs/architecture/Modelo%20de%20Datos.md) (¬ß3.16 alert, ¬ß3.1 module, ¬ß3.3 muscle_zone)
- Arquitectura T√©cnica ‚Äî [Arquitectura T√©cnica.md](docs/architecture/Arquitectura%20T√©cnica.md) (¬ß3.2 paquete ui.alerts, ¬ß4.3 rutas H1/H2, ¬ß4.4 alerts-graph, ¬ß5.2 naming AlertRepository)
- ADR ‚Äî [ADR.md](docs/architecture/ADR.md) (ADR-05 MVVM con capa Domain, ADR-03 Room, ADR-09 StateFlow)
- Requerimientos ‚Äî [Requerimientos.md](docs/business_definition/Requerimientos.md) (RF53-RF58, RNF05)

**Historias relacionadas:**

- Historia #12 (HU-12): Infraestructura de alertas (AlertEntity, AlertDao, patr√≥n insert/resolve, alertas PLATEAU y MODULE_REQUIRES_DELOAD) ‚Äî base sobre la que HU-17 construye
- Historia #13 (HU-13): Resumen post-sesi√≥n ‚Äî `existsActiveByModule("MODULE_REQUIRES_DELOAD")` para se√±al "Considerar descarga" ya implementado
- Historia #14 (HU-14): Protocolo de descarga ‚Äî `deload_id` en session, guard de alertas PLATEAU durante deload, resoluci√≥n de MODULE_REQUIRES_DELOAD al activar descarga
- Historia #15 (HU-15): KPIs y m√©tricas ‚Äî Rules (`ProgressionRateRule`, `AvgRirRule`, `AdherenceRule`, `TonnageRule`), Use Cases (`GetProgressionRateUseCase`, `GetAvgRirByModuleUseCase`, `GetAdherenceUseCase`, `GetTonnageByMuscleGroupUseCase`, `GetMicrocycleMapUseCase`), MetricsRepository con DAOs subyacentes
- Historia #16 (HU-16): Historial de ejercicios y sesiones ‚Äî F3 ya implementado con navegaci√≥n desde m√∫ltiples or√≠genes (H2‚ÜíF3 navega al historial del ejercicio afectado)

**Validado por:** esteban.colorado | **Fecha:** 2026-02-19 | **Enfoque:** Exploratorio