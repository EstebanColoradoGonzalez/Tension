# HU-16 ‚Äî Historial de Ejercicios y Sesiones

## Requisitos relacionados

RF50, RF51, RF60

## Descripci√≥n

Como ejecutante, quiero consultar el historial completo de cualquier ejercicio con su tendencia de carga y el historial de todas mis sesiones pasadas con sus datos completos, para evaluar mi progreso real en cada movimiento, revisar mi entrenamiento reciente, comparar sesiones y tener un registro completo, accesible y trazable de todo mi trabajo realizado.

## Historias originales consolidadas

Esta historia consolida las siguientes historias del dise√±o original, que son dos perspectivas complementarias del mismo concepto (historial) y comparten la misma secci√≥n de navegaci√≥n y los mismos datos fuente:

- **HU-23 original** ‚Äî Consultar historial y tendencia de carga de un ejercicio (RF50, RF51)
- **HU-24 original** ‚Äî Consultar historial de sesiones pasadas (RF60)

---

## Criterios de Aceptaci√≥n

### Bloque A ‚Äî Historial y Tendencia de Carga por Ejercicio (RF50, RF51)

#### CA-16.01 ‚Äî Historial completo de registros

**Dado que** el ejecutante selecciona un ejercicio para consultar su historial,
**cuando** el sistema presenta los datos,
**entonces** muestra el historial completo de todas las sesiones en las que se registr√≥ ese ejercicio, incluyendo para cada sesi√≥n: fecha, peso utilizado (Kg), repeticiones logradas (por serie o totales), RIR (por serie o promedio) y clasificaci√≥n de progresi√≥n (Progresi√≥n positiva, Mantenimiento o Regresi√≥n).

#### CA-16.02 ‚Äî Orden cronol√≥gico

**Dado que** el sistema presenta el historial de un ejercicio,
**cuando** ordena las entradas,
**entonces** las muestra en orden cronol√≥gico, de la sesi√≥n m√°s reciente a la m√°s antigua, permitiendo al ejecutante ver primero su estado actual.

#### CA-16.03 ‚Äî Historial independiente del m√≥dulo-versi√≥n

**Dado que** un ejercicio puede aparecer en varias versiones del mismo m√≥dulo o puede haber sido ejecutado como sustituci√≥n,
**cuando** el sistema construye el historial,
**entonces** incluye todos los registros del ejercicio independientemente de la versi√≥n del m√≥dulo en que se haya ejecutado, consolidando toda la data del ejercicio en una sola vista.

#### CA-16.04 ‚Äî Visualizaci√≥n de la tendencia de carga

**Dado que** el ejecutante consulta un ejercicio con m√∫ltiples sesiones de historial,
**cuando** visualiza la tendencia de carga,
**entonces** el sistema muestra la evoluci√≥n del peso utilizado a lo largo del tiempo, permitiendo identificar visualmente si la carga es ascendente, estable o descendente.

#### CA-16.05 ‚Äî Ejercicios sin historial

**Dado que** el ejecutante consulta un ejercicio que nunca ha sido registrado,
**cuando** intenta ver el historial,
**entonces** el sistema indica que no hay registros disponibles para ese ejercicio.

#### CA-16.06 ‚Äî Ejercicios de peso corporal: tendencia por repeticiones

**Dado que** el ejecutante consulta el historial de un ejercicio de peso corporal (Peso = 0),
**cuando** visualiza la tendencia,
**entonces** la tendencia se muestra por repeticiones totales en lugar de carga, ya que el peso no var√≠a.

### Bloque B ‚Äî Historial de Sesiones Pasadas (RF60)

#### CA-16.07 ‚Äî Listado de sesiones pasadas

**Dado que** el ejecutante accede al historial de sesiones,
**cuando** el sistema presenta el listado,
**entonces** muestra todas las sesiones cerradas, cada una con: fecha, m√≥dulo (A, B o C), versi√≥n (V1, V2 o V3), estado (Completada o Incompleta) y tonelaje total, ordenadas de la m√°s reciente a la m√°s antigua.

#### CA-16.08 ‚Äî Detalle de una sesi√≥n pasada

**Dado que** el ejecutante selecciona una sesi√≥n del historial,
**cuando** accede al detalle,
**entonces** el sistema muestra los ejercicios ejecutados en esa sesi√≥n con sus datos completos: para cada ejercicio, las series registradas con peso, repeticiones, RIR y la clasificaci√≥n de progresi√≥n del ejercicio en esa sesi√≥n.

#### CA-16.09 ‚Äî Sesiones incompletas en el historial

**Dado que** el ejecutante tiene sesiones cerradas como Incompletas,
**cuando** consulta el historial,
**entonces** las sesiones incompletas aparecen claramente marcadas como "Incompleta", mostrando solo los ejercicios y series que efectivamente fueron registrados, sin datos inventados para los ejercicios faltantes.

#### CA-16.10 ‚Äî Sustituciones reflejadas en el historial

**Dado que** una sesi√≥n pasada incluy√≥ sustituciones puntuales de ejercicios,
**cuando** el ejecutante consulta el detalle de esa sesi√≥n,
**entonces** el sistema muestra los ejercicios que realmente se ejecutaron (incluyendo los sustitutos), reflejando fielmente lo que ocurri√≥ en la sesi√≥n.

#### CA-16.11 ‚Äî Inmutabilidad de sesiones consultadas

**Dado que** el ejecutante consulta el detalle de una sesi√≥n pasada,
**cuando** visualiza los datos,
**entonces** toda la informaci√≥n es de solo lectura; no se ofrecen opciones para editar, eliminar o agregar datos a sesiones cerradas.

#### CA-16.12 ‚Äî Historial vac√≠o

**Dado que** el ejecutante no tiene sesiones cerradas registradas,
**cuando** accede al historial,
**entonces** el sistema indica que no hay sesiones pasadas disponibles.

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** MVVM Read-Only con Room DAO Queries (3 pantallas, 3 ViewModels, 3 Use Cases)

**Justificaci√≥n:** HU-16 es una feature 100% de lectura ‚Äî no modifica datos, no dispara reglas de negocio, no crea entidades. Las 3 pantallas (F1, F2, F3) son vistas de solo lectura sobre datos ya persistidos por HU-06/09/10. No se necesitan nuevas Rules ni nuevos Repositories: los datos provienen de las tablas `session`, `session_exercise` y `exercise_set` ‚Äî ya manejadas por `SessionRepository`. Los DAOs necesitan queries nuevos porque no existen queries que devuelvan los datos con la forma requerida por las pantallas. La capa UI necesita 3 pantallas: F1 (placeholder existente), F3 (placeholder existente) y F2 (nueva). F3 incluye un gr√°fico Canvas de tendencia de carga, pintado con Canvas Compose sin librer√≠a externa (coherente con `TonnageChartComposable.kt` de HU-15/G2). Los Use Cases son orquestadores delegados al Repository sin l√≥gica adicional, siguiendo la convenci√≥n del proyecto (ADR-05: MVVM con capa Domain expl√≠cita).

### Decisiones Fundamentadas

**1. Los nuevos Use Cases son wrappers delegados al Repository, sin l√≥gica adicional.**

Para HU-16 no hay transformaci√≥n de negocio: el UseCase invoca un solo m√©todo del Repository y retorna el resultado. Esto mantiene la convenci√≥n del proyecto (todas las pantallas usan UseCase ‚Üí Repository) y permite agregar l√≥gica de dominio futura sin cambiar el ViewModel. Sigue el patr√≥n ya establecido en `GetWeightHistoryUseCase`, `GetProfileUseCase`, etc.

**2. F2 reutiliza `getSessionSummaryInfo()` existente y agrega queries para detalle de ejercicios.**

El detalle de sesi√≥n pasada necesita: resumen (tonelaje, conteo de ejercicios, estado) + lista de ejercicios (nombre, clasificaci√≥n, nota de sustituci√≥n) + series de cada ejercicio (peso, reps, RIR). El resumen de la sesi√≥n se obtiene reutilizando el query `SessionDao.getSessionSummaryInfo(sessionId)` ya creado por HU-13 ‚Äî devuelve `SessionSummaryInfo(status, moduleCode, versionNumber, totalTonnageKg, totalExercises, completedExercises)`. La fecha de la sesi√≥n se obtiene con `SessionDao.getById(sessionId)` ya existente. La lista de ejercicios se obtiene con un nuevo query en `SessionExerciseDao` y las series con el query `ExerciseSetDao.getSetsForSessionExercise(sessionExerciseId)` ya existente (iterado por ejercicio en el Repository). Esto evita queries N+1 innecesarios y es el patr√≥n ya usado por `getExercisesForSummary()` en `SessionExerciseDao`.

**3. El historial de ejercicio (F3) se construye con un query que cruza `session_exercise` con `session`, no con `exercise_progression`.**

`exercise_progression` solo tiene el estado actual (`status`, `prescribed_load_kg`, `sessions_without_progression`). Para obtener el historial longitudinal (fecha, peso, reps, RIR, clasificaci√≥n por cada sesi√≥n), se necesita la cadena `session_exercise` ‚Üí `session` ‚Üí `exercise_set`. El estado de progresi√≥n actual del ejercicio (Sin Historial / En Progresi√≥n / En Meseta / En Descarga) s√≠ se lee de `exercise_progression.status` como campo separado.

**4. La tendencia de carga se calcula en el ViewModel, no en el DAO.**

El gr√°fico de tendencia muestra puntos (session_index, weightKg) o (session_index, totalReps) para bodyweight. Estos datos ya se obtienen con el query de historial. El ViewModel transforma la lista de `ExerciseHistoryEntry` en puntos para el gr√°fico Canvas. No se necesita un c√°lculo en SQL ni una regla de dominio ‚Äî es una transformaci√≥n de presentaci√≥n.

**5. Bottom Navigation condicional en F3 requiere modificaci√≥n de `showBottomBar` en `TensionNavHost`.**

Wireframes dicen: Bottom Nav visible si se accede desde F2, G1, H2, D2; oculto si se accede desde E5 (post-sesi√≥n). La implementaci√≥n actual del `showBottomBar` en `TensionNavHost` excluye rutas de sesi√≥n activa (`active-session`, `register-set`, `substitute-exercise`, `session-summary`) y `exercise-detail` con origen `active-session`. **Sin embargo, NO maneja el caso de `exercise-history` con origen `session-summary`.** Cuando el ejecutante navega E5 ‚Üí F3, la ruta actual es `exercise-history/{id}` y la entry anterior en el back stack es `session-summary/{id}` ‚Äî la l√≥gica actual NO oculta el bottom bar porque `exercise-history` no est√° en la lista de exclusi√≥n. Se necesita agregar una condici√≥n an√°loga a la de `exercise-detail`: `!(currentRoute.startsWith("exercise-history") && navController.previousBackStackEntry?.destination?.route?.startsWith("session-summary") == true)`. El bot√≥n ‚Üê retorna al lugar correcto con `navController.popBackStack()`.

**6. La ruta `session-detail/{sessionId}` no existe a√∫n en el c√≥digo ‚Äî se agrega.**

`NavigationRoutes` define `SESSION_HISTORY` pero NO define `SESSION_DETAIL`. La Arquitectura T√©cnica (¬ß4.3) define la ruta como `session-detail/{sessionId}`. Se agrega la constante `SESSION_DETAIL`, la funci√≥n factory `sessionDetailRoute(sessionId)`, y el composable en `TensionNavHost`.

**7. Se crea `TrendChartComposable` porque `TonnageChartComposable` no es reutilizable para F3.**

`TonnageChartComposable` pinta evoluci√≥n de tonelaje por grupo muscular con m√∫ltiples l√≠neas y eje X = microciclos. F3 necesita una sola l√≠nea con eje X = sesiones y eje Y = Kg (o reps). Se crea `TrendChartComposable` como componente separado en `ui.components`, siguiendo las specs visuales: Canvas con l√≠nea Primary (2dp), puntos rellenos (6dp radio), grid dashed, labels en Label Small, 200dp de altura.

**8. Las sesiones incompletas muestran solo los ejercicios con series registradas (CA-16.09).**

El query de F2 filtra con `HAVING setCount > 0` (mismo patr√≥n que `getExercisesForSummary` existente). Los ejercicios sin series registradas no aparecen en el detalle. Esto cumple CA-16.09: "mostrando solo los ejercicios y series que efectivamente fueron registrados, sin datos inventados".

**9. No se crea un `HistoryRepository` separado.**

Los datos provienen de `session`, `session_exercise` y `exercise_set` ‚Äî tablas ya bajo la responsabilidad de `SessionRepository`. Agregar 3 m√©todos a una interface existente es menos intrusivo que crear un nuevo Repository con su binding Hilt. No se introduce nueva fuente de datos ni nuevo dominio funcional.

### Componentes Afectados

**Componentes nuevos:**

| # | Componente | Tipo | Paquete | Responsabilidad |
|---|-----------|------|---------|-----------------|
| 1 | `SessionHistoryScreen` | Nuevo (Composable) | `ui.history` | Pantalla F1 ‚Äî Listado de sesiones cerradas con fecha, m√≥dulo-versi√≥n, estado y tonelaje. Acceso desde Bottom Navigation |
| 2 | `SessionHistoryViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F1 ‚Äî carga lista de sesiones cerradas |
| 3 | `SessionHistoryUiState` | Nuevo (data class) | `ui.history` | Estado UI para F1 ‚Äî Loading/Empty/Loaded con lista de `SessionHistoryItem` |
| 4 | `SessionDetailScreen` | Nuevo (Composable) | `ui.history` | Pantalla F2 ‚Äî Detalle de sesi√≥n pasada con ejercicios, series y clasificaciones. Solo lectura |
| 5 | `SessionDetailViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F2 ‚Äî carga detalle completo de una sesi√≥n |
| 6 | `SessionDetailUiState` | Nuevo (data class) | `ui.history` | Estado UI para F2 ‚Äî Loading/Loaded con resumen + lista de ejercicios con series |
| 7 | `ExerciseHistoryViewModel` | Nuevo (HiltViewModel) | `ui.history` | Estado reactivo para F3 ‚Äî carga historial longitudinal de un ejercicio |
| 8 | `ExerciseHistoryUiState` | Nuevo (data class) | `ui.history` | Estado UI para F3 ‚Äî Loading/Empty/Loaded con estado progresi√≥n + tendencia + lista de sesiones |
| 9 | `GetSessionHistoryUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene lista de sesiones cerradas ordenadas cronol√≥gicamente descendente |
| 10 | `GetSessionDetailUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene detalle completo de una sesi√≥n: resumen + ejercicios con series |
| 11 | `GetExerciseHistoryUseCase` | Nuevo (UseCase) | `domain.usecase.history` | Obtiene historial de un ejercicio a lo largo de todas las sesiones |
| 12 | `SessionHistoryItem` | Nuevo (domain model) | `domain.model` | Modelo para cada fila de F1: sessionId, date, moduleCode, versionNumber, status, totalTonnageKg |
| 13 | `SessionDetail` | Nuevo (domain model) | `domain.model` | Modelo para F2: resumen de sesi√≥n + lista de ejercicios con series detalladas |
| 14 | `SessionDetailExercise` | Nuevo (domain model) | `domain.model` | Modelo para cada ejercicio en F2: nombre, clasificaci√≥n, series, nota de sustituci√≥n |
| 15 | `ExerciseHistoryEntry` | Nuevo (domain model) | `domain.model` | Modelo para cada fila de F3: date, moduleCode, versionNumber, weightKg, totalReps, avgRir, classification |
| 16 | `ExerciseHistoryData` | Nuevo (domain model) | `domain.model` | Modelo compuesto para F3: exerciseName, progressionStatus, isBodyweight, isIsometric, entries (list) |
| 17 | `TrendChartComposable` | Nuevo (Composable) | `ui.components` | Gr√°fico lineal Canvas reutilizable para tendencia de carga/repeticiones (F3) |

**Componentes reutilizados (existentes, sin modificaci√≥n):**

| # | Componente | Paquete | Uso en HU-16 |
|---|-----------|---------|---------------|
| R1 | `ProgressionIndicator` | `ui.components` | Reutilizado en F2 y F3 para mostrar clasificaci√≥n de progresi√≥n (‚Üë/=/‚Üì) con color sem√°ntico. Ya creado por HU-13 |
| R2 | `TensionTopAppBar` | `ui.components` | Reutilizado en F1, F2, F3 para la barra superior con t√≠tulo y bot√≥n de retorno |
| R3 | `ExerciseProgressionDao.getByExerciseId()` | `data.local.dao` | Reutilizado en F3 para obtener el estado de progresi√≥n actual del ejercicio (`status`) |
| R4 | `SessionDao.getSessionSummaryInfo()` | `data.local.dao` | Reutilizado en F2 para obtener el resumen de la sesi√≥n (status, m√≥dulo, versi√≥n, tonelaje, conteos). Query existente de HU-13 |

**Componentes modificados:**

| # | Componente | Modificaci√≥n | Nivel |
|---|-----------|-------------|-------|
| 1 | `SessionDao` | Agregar query `getClosedSessionsWithSummary()` para F1 ‚Äî sesiones cerradas con m√≥dulo-versi√≥n, estado y tonelaje. Reutilizar `getSessionSummaryInfo()` existente para F2 (resumen) y `getById()` existente para F2 (fecha) | Menor |
| 2 | `SessionExerciseDao` | Agregar query `getExercisesForSessionDetail()` para F2 y `getExerciseHistoryEntries()` para F3 | Medio |
| 3 | `ExerciseSetDao` | Reutilizar `getSetsForSessionExercise(sessionExerciseId)` existente para F2 ‚Äî se itera por cada ejercicio en el Repository. No se necesita query nuevo | Sin cambio |
| 4 | `SessionRepository` (interface) | Agregar 3 m√©todos: `getSessionHistory()`, `getSessionDetail()`, `getExerciseHistory()` | Menor |
| 5 | `SessionRepositoryImpl` | Implementar los 3 nuevos m√©todos mapeando DTOs de DAO a domain models | Medio |
| 6 | `ExerciseHistoryScreen` | Refactorizar de placeholder a implementaci√≥n completa de F3: estado progresi√≥n, gr√°fico tendencia, lista de sesiones | Mayor |
| 7 | `NavigationRoutes` | Agregar `SESSION_DETAIL` route con argumento `sessionId` y funci√≥n factory `sessionDetailRoute()` | Menor |
| 8 | `TensionNavHost` | Reemplazar placeholder de `SESSION_HISTORY` con `SessionHistoryScreen`, agregar `SESSION_DETAIL` composable, actualizar `EXERCISE_HISTORY` con ViewModel y callbacks (`onNavigateBack`, `onNavigateToExerciseDetail`), agregar condici√≥n de `showBottomBar` para `exercise-history` con origen `session-summary` | Mayor |
| 9 | `BottomNavigationBar` | Mover `exercise-history` de `childRoutePrefixes` del tab Diccionario al tab Historial. Agregar `session-detail` como `childRoutePrefix` del tab Historial. F3 pertenece a `history-graph` (Arquitectura T√©cnica ¬ß4.4), no a `catalog-graph` | Medio |
| 10 | `strings.xml` | Agregar ~20 strings para las 3 pantallas (t√≠tulos, etiquetas, estados vac√≠os, formatos) | Menor |

**Componentes NO tocados (verificado en c√≥digo):**

- Toda la capa `domain/rules/` ‚Äî no hay nuevas reglas de negocio, la clasificaci√≥n ya existe en `session_exercise.progression_classification`
- `ExerciseProgressionDao` ‚Äî se lee `status` a trav√©s de un JOIN en query de F3, no se agrega query directo
- `ProfileRepository`, `PlanRepository`, `MetricsRepository`, `ExerciseRepository` ‚Äî no participan
- `data/local/entity/` ‚Äî ninguna entidad se modifica (0 cambios de esquema, 0 migraciones)
- `data/local/database/TensionDatabase.kt` ‚Äî no se modifica (versi√≥n se mantiene en 7)
- `data/local/seed/` ‚Äî no se toca ning√∫n seeder
- `di/DatabaseModule.kt` ‚Äî no se modifica (no hay nuevos DAOs)
- `di/RepositoryModule.kt` ‚Äî no se modifica (no hay nuevo Repository)
- Flujos E (sesi√≥n activa), B (home), C (perfil), D (cat√°logo), G (m√©tricas) ‚Äî no se modifican sus pantallas

### Hitos de Implementaci√≥n

| # | Componente(s) | Descripci√≥n | Dependencias |
|---|--------------|-------------|--------------|
| 1 | Domain Models | Crear `SessionHistoryItem`, `SessionDetail`, `SessionDetailExercise`, `ExerciseHistoryEntry`, `ExerciseHistoryData` en `domain.model` | Ninguna |
| 2 | DAO Queries | Agregar queries nuevos en `SessionDao` (F1), `SessionExerciseDao` (F2, F3), `ExerciseSetDao` (F2) | Ninguna |
| 3 | Repository | Agregar 3 m√©todos a `SessionRepository` (interface) e implementarlos en `SessionRepositoryImpl` | Hitos 1, 2 |
| 4 | Use Cases | Crear `GetSessionHistoryUseCase`, `GetSessionDetailUseCase`, `GetExerciseHistoryUseCase` en `domain.usecase.history` | Hito 3 |
| 5 | F1 ‚Äî Historial de Sesiones | Crear `SessionHistoryScreen`, `SessionHistoryViewModel`, `SessionHistoryUiState`. Reemplazar PlaceholderScreen en NavHost | Hito 4 |
| 6 | F2 ‚Äî Detalle de Sesi√≥n Pasada | Crear `SessionDetailScreen`, `SessionDetailViewModel`, `SessionDetailUiState`. Agregar ruta `SESSION_DETAIL` y navegaci√≥n F1 ‚Üí F2 | Hito 4 |
| 7 | Gr√°fico Tendencia | Crear `TrendChartComposable` en `ui.components` (Canvas lineal reutilizable) | Ninguna |
| 8 | F3 ‚Äî Historial de Ejercicio | Refactorizar `ExerciseHistoryScreen` de placeholder a implementaci√≥n completa con ViewModel, estado progresi√≥n, gr√°fico tendencia y lista de sesiones | Hitos 4, 7 |
| 9 | Navegaci√≥n y Strings | Actualizar `NavigationRoutes` (SESSION_DETAIL), `TensionNavHost` (3 composables), `BottomNavigationBar` (childRoutePrefixes), `strings.xml` (~20 strings) | Hitos 5, 6, 8 |
| 10 | Tests unitarios | Tests para los 3 Use Cases y para la transformaci√≥n de datos en ViewModels | Hitos 4, 5, 6, 8 |

### Validaci√≥n de Impacto

**C√≥digo real verificado (paso 1.5):**

- `ExerciseHistoryScreen.kt`: Actualmente es un placeholder que muestra "Pr√≥ximamente" dentro de un `Scaffold` con `TensionTopAppBar`. Se refactoriza completamente para implementar F3.
- `TensionNavHost.kt`: `SESSION_HISTORY` actualmente apunta a `PlaceholderScreen`. `EXERCISE_HISTORY` apunta al placeholder `ExerciseHistoryScreen`. Ambos se reemplazan con implementaciones reales. Se agrega la ruta `SESSION_DETAIL` que no existe.
- `BottomNavigationBar.kt`: El tab "Historial" (`SESSION_HISTORY`) no tiene `childRoutePrefixes`. Se necesita agregar `"session-detail"` y mover `"exercise-history"` desde el tab Diccionario al tab Historial para que F1 ‚Üí F2 ‚Üí F3 mantengan el tab activo. Actualmente `exercise-history` es childRoutePrefix del tab Diccionario (correcto para D2 ‚Üí F3, incorrecto para F2 ‚Üí F3). La Arquitectura T√©cnica ¬ß4.4 coloca F3 en `history-graph`, lo que confirma que Historial es el tab leg√≠timo.
- `NavigationRoutes.kt`: Define `SESSION_HISTORY = "session-history"` y `EXERCISE_HISTORY = "exercise-history/{exerciseId}"`. Falta `SESSION_DETAIL = "session-detail/{sessionId}"`.
- `SessionDao.kt`: Tiene `getClosedSessionsOrdered()` que devuelve `List<SessionEntity>` ‚Äî √∫til pero no incluye m√≥dulo-versi√≥n ni tonelaje. Se necesita un query nuevo que haga JOIN con `module_version` y calcule tonelaje.
- `SessionExerciseDao.kt`: Tiene `getExercisesForSummary()` que devuelve datos similares a F2 pero con l√≥gica de se√±ales de acci√≥n (c√°lculo de `previousTotalReps`, `isMastered`). Para F2 se necesita un query m√°s simple: nombre, clasificaci√≥n, nota sustituci√≥n. Para F3 se necesita un query cross-session por `exercise_id`.
- `ExerciseSetDao.kt`: Tiene `getSetsForSessionExercise(sessionExerciseId)` que devuelve series de un √∫nico `sessionExerciseId` ‚Äî se reutiliza iterativamente en el Repository para F2 (un call por ejercicio). No se necesita query nuevo. El patr√≥n de iteraci√≥n es aceptable porque una sesi√≥n tiene m√°ximo ~10 ejercicios.
- `SessionRepositoryImpl.kt`: 664 l√≠neas. Implementa `SessionRepository`. Los 3 nuevos m√©todos se agregan al final.
- `ExerciseProgressionDao.kt`: Tiene `getByExerciseId()` que retorna `Flow<ExerciseProgressionEntity?>` ‚Äî se usa para obtener el estado de progresi√≥n actual del ejercicio (campo `status`) para F3.
- `strings.xml`: Tiene strings para `exercise_history_title` y `nav_history`. Faltan strings para F1 (estado vac√≠o, formato tonelaje), F2 (t√≠tulo, estado, etiquetas de series), F3 (subt√≠tulo, estados de progresi√≥n, estado vac√≠o, enlace a t√©cnica).
- `TonnageChartComposable.kt`: 240 l√≠neas con Canvas multil√≠nea para G2. No reutilizable para F3 (diferente estructura de datos y prop√≥sito). Se crea `TrendChartComposable` separado.

**An√°lisis de dependencias:**

- HU-16 depende de: HU-06 (registr√≥ series), HU-07 (sustituciones registradas en `session_exercise.original_exercise_id`), HU-08 (ejercicios bodyweight/isom√©tricos ‚Äî F3 muestra tendencia por reps totales para bodyweight y segundos para isom√©tricos), HU-09 (cerr√≥ sesiones con estado COMPLETED/INCOMPLETE y tonelaje), HU-10 (clasific√≥ progresi√≥n y almacen√≥ en `session_exercise.progression_classification`), HU-13 (cre√≥ `ProgressionIndicator` reutilizable y `getSessionSummaryInfo()` reutilizable para F2).
- HU-16 NO modifica datos ‚Äî es puramente de lectura. No hay riesgo de conflicto con otras HUs.
- HU-16 habilita: HU-17 (alertas navegan a F3 desde H2), HU-18 (backup incluir√° historial visible).

**Impacto en performance:**

- F1: Query con JOIN a `module_version` y subconsulta de tonelaje sobre `exercise_set`. √çndices existentes: `session.status`, `session.date`, `session_exercise.session_id`. Suficiente para < 500 sesiones.
- F2: Query de ejercicios con JOIN a `exercise` + iteraci√≥n para series. Los √≠ndices `session_exercise.session_id` y `exercise_set.session_exercise_id` cubren el caso.
- F3: Query cross-session filtrado por `exercise_id`. √çndice existente `session_exercise.exercise_id`. Para un ejercicio con 100 sesiones, el query es O(n) con n = registros del ejercicio ‚Äî rendimiento aceptable.

### Notas T√©cnicas

**Nota 1 ‚Äî Sustituciones en F2 (CA-16.10).**

`session_exercise` tiene `exercise_id` (el ejercicio realmente ejecutado) y `original_exercise_id` (el ejercicio originalmente prescrito, si hubo sustituci√≥n). En F2, se muestra el nombre del ejercicio ejecutado (`exercise_id`) y si `original_exercise_id IS NOT NULL`, se agrega la nota "Sustituy√≥ a: [nombre del ejercicio original]". Esto requiere un LEFT JOIN adicional en el query de F2 para obtener el nombre del ejercicio original.

**Nota 2 ‚Äî Formato de fecha para display.**

Las sesiones almacenan `date` como `String` en formato ISO (`yyyy-MM-dd`). Para F1 y F3, el ViewModel formatea a `"dd MMM yyyy"` (ej: "10 feb 2026") usando `LocalDate.parse()` + `DateTimeFormatter`. La locale es espa√±ol (ADR-17). Este patr√≥n ya se usa en `WeightHistoryScreen`.

**Nota 3 ‚Äî El estado de progresi√≥n en F3 se mapea desde `exercise_progression.status`.**

Los valores posibles son: `NO_HISTORY` (‚ö™ Sin Historial), `IN_PROGRESSION` (üü¢ En Progresi√≥n), `ON_PLATEAU` (üü° En Meseta), `IN_DELOAD` (üîµ En Descarga), `MASTERED` (no tiene √≠cono en wireframe ‚Äî se trata como `IN_PROGRESSION` visualmente). El ViewModel convierte el string de BD al enum/sealed class correspondiente para el UI.

**Nota 4 ‚Äî Paginaci√≥n no es necesaria para esta versi√≥n.**

El ejecutante es un √∫nico usuario que entrena 3-6 sesiones por semana. En 2 a√±os acumular√≠a ~300-600 sesiones como m√°ximo. Room + `LazyColumn` manejan esta escala sin paginaci√≥n. Si el historial creciera significativamente, se podr√≠a agregar `Paging 3` en una HU futura sin modificar la arquitectura de capas (solo cambiar el tipo de retorno del DAO de `List<>` a `PagingSource<>`).

**Nota 5 ‚Äî F3 necesita callback `onNavigateToExerciseDetail` para el link "Ver t√©cnica de ejecuci√≥n ‚Üí".**

El wireframe F3 incluye un Text Button `"Ver t√©cnica de ejecuci√≥n ‚Üí"` que navega a D2 (Detalle de Ejercicio). El composable `ExerciseHistoryScreen` actualmente solo recibe `onNavigateBack`. Se debe agregar `onNavigateToExerciseDetail: (Long) -> Unit` al composable y registrar la navegaci√≥n correspondiente en `TensionNavHost`. Esto genera un paso D2 ‚Üê F3 ya definido en el Mapa de Navegaci√≥n ¬ßF3.

**Nota 6 ‚Äî Ejercicios isom√©tricos en F3: `reps` representa segundos.**

Para ejercicios isom√©tricos (`is_isometric = 1`), la columna `exercise_set.reps` almacena segundos sostenidos, no repeticiones (Modelo de Datos ¬ß3.12). El ViewModel de F3 debe interpretar este campo seg√∫n el tipo de ejercicio: si `isIsometric` ‚Üí label "s" (segundos) y tendencia por segundos totales. Si `isBodyweight && !isIsometric` ‚Üí label "reps" y tendencia por repeticiones totales. Si est√°ndar ‚Üí label "Kg" y tendencia por peso promedio.

### Verificaci√≥n Cruzada de CAs

| CA | Mecanismo | Componente |
|----|-----------|------------|
| CA-16.01 | Query DAO que incluye fecha, peso, reps, RIR, clasificaci√≥n por sesi√≥n del ejercicio | `SessionExerciseDao.getExerciseHistoryEntries()` + `ExerciseHistoryScreen` |
| CA-16.02 | `ORDER BY s.date DESC, s.id DESC` en query de F3 | DAO query |
| CA-16.03 | Query JOIN sin filtro por `module_version_id` ‚Äî solo por `exercise_id` | DAO query |
| CA-16.04 | `TrendChartComposable` con puntos extra√≠dos del historial | `ExerciseHistoryScreen` + `TrendChartComposable` |
| CA-16.05 | `ExerciseHistoryUiState.Empty` con texto "No hay registros disponibles para este ejercicio." | `ExerciseHistoryScreen` empty state |
| CA-16.06 | Condicional en ViewModel: si `isBodyweight` ‚Üí eje Y = reps totales; si `isIsometric` ‚Üí eje Y = segundos totales; si est√°ndar ‚Üí eje Y = peso promedio (Kg) | `ExerciseHistoryViewModel` + `TrendChartComposable` |
| CA-16.07 | Query DAO con `status IN ('COMPLETED', 'INCOMPLETE')` + JOIN a `module_version` para m√≥dulo y versi√≥n | `SessionDao.getClosedSessionsWithSummary()` + `SessionHistoryScreen` |
| CA-16.08 | Query para ejercicios de sesi√≥n con series detalladas (peso, reps, RIR por serie) y clasificaci√≥n | `SessionDetailScreen` + DAO queries |
| CA-16.09 | `HAVING setCount > 0` en query de F2 filtra ejercicios sin series registradas | DAO query |
| CA-16.10 | `session_exercise.exercise_id` refleja el ejercicio real. LEFT JOIN a `exercise` con `original_exercise_id` para obtener nombre original ‚Üí nota "Sustituy√≥ a:" | `SessionDetailScreen` |
| CA-16.11 | Pantalla de solo lectura sin botones de edici√≥n/eliminaci√≥n | `SessionDetailScreen` ‚Äî no tiene acciones de escritura |
| CA-16.12 | `SessionHistoryUiState.Empty` con texto "No hay sesiones pasadas disponibles." | `SessionHistoryScreen` empty state |

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Wireframes ‚Äî [Wireframes.md](docs/architecture/Wireframes.md) (¬ßF1 Historial de Sesiones, ¬ßF2 Detalle de Sesi√≥n Pasada, ¬ßF3 Historial de Ejercicio)
- Mapa de Navegaci√≥n ‚Äî [Mapa de Navegaci√≥n.md](docs/architecture/Mapa%20de%20Navegaci√≥n.md) (¬ßFlujo F ‚Äî Historial, transiciones F1‚ÜîF2‚ÜîF3)
- Especificaci√≥n Visual ‚Äî [Especificaci√≥n Visual.md](docs/architecture/Especificaci√≥n%20Visual.md) (¬ßFlujo F ‚Äî F1, F2, F3 component specs)
- Modelo de Datos ‚Äî [Modelo de Datos.md](docs/architecture/Modelo%20de%20Datos.md) (¬ß3.10 session, ¬ß3.11 session_exercise, ¬ß3.12 exercise_set, ¬ß3.13 exercise_progression)
- Arquitectura T√©cnica ‚Äî [Arquitectura T√©cnica.md](docs/architecture/Arquitectura%20T√©cnica.md) (¬ß3.2 √°rbol de paquetes ui.history, ¬ß4.3 inventario de rutas F1/F2/F3)
- ADR ‚Äî [ADR.md](docs/architecture/ADR.md) (ADR-05 MVVM con capa Domain expl√≠cita, ADR-07 Single Activity + Navigation Compose, ADR-09 StateFlow para gesti√≥n de estado)

**Historias relacionadas:**

- Historia #6 (HU-06): Registr√≥ series de ejercicios ‚Äî los datos de `exercise_set` son la fuente primaria para F2 y F3
- Historia #7 (HU-07): Sustituciones puntuales ‚Äî `session_exercise.original_exercise_id` se usa para mostrar nota de sustituci√≥n en F2 (CA-16.10)
- Historia #9 (HU-09): Cerr√≥ sesiones con estado COMPLETED/INCOMPLETE y tonelaje ‚Äî la consulta de F1 se basa en sesiones cerradas con estos estados
- Historia #10 (HU-10): Clasific√≥ progresi√≥n post-sesi√≥n ‚Äî `session_exercise.progression_classification` se muestra en F2 y F3 como dato ya almacenado
- Historia #8 (HU-08): Ejercicios bodyweight e isom√©tricos ‚Äî F3 muestra tendencia por repeticiones totales para bodyweight (CA-16.06) y por segundos sostenidos para isom√©tricos
- Historia #13 (HU-13): Resumen post-sesi√≥n (E5) ‚Äî navega a F3 desde el resumen, cre√≥ `ProgressionIndicator` reutilizable para F2/F3, cre√≥ `getSessionSummaryInfo()` reutilizable para F2
- Historia #15 (HU-15): Panel de m√©tricas (G1) ‚Äî navega a F3 desde KPIs, usa mismos datos de tendencia
- Historia #15.5 (HU-15.5): Migraci√≥n Pull/Push/Legs ‚Äî los datos hist√≥ricos son v√°lidos post-migraci√≥n porque F3 consulta por `exercise_id` (no por `module_code`)

**Validado por:** esteban.colorado | **Fecha:** 2026-02-19 | **Enfoque:** Exploratorio
